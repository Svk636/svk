<!DOCTYPE html>
<html lang="en">
<!--
================================================================================
SVK BLUEPRINT - UNIFIED VERSION 2.4.0
================================================================================
Build Date: March 1, 2026
Status: âœ… PRODUCTION READY - Full Bug Fix Release

SYSTEM OVERVIEW:
Zen-inspired 15-year vision execution system with 90-day cycle methodology.
Bridges long-term aspirations with daily action through live EARN integrations.

ðŸŽ‰ NEW IN v2.3.0 (EARN INTEGRATIONS LIVE â€” February 25, 2026):
================================================================================
VAULT EARN IS NOW FULLY WIRED INTO THE REST OF THE APP
================================================================================

ðŸ”— 5 LIVE INTEGRATIONS:

1. STRATEGY TAB â€” Operating Rules Panel
   - Your Vault EARN Strategy items now appear directly on the Strategy tab
   - Rendered above cycle tasks as "Operating Rules" context panel
   - Domain-aware: prioritizes items linked to the cycle's dominant focus domain
   - Pin/unpin items directly from Strategy tab
   - "All N strategy items â†’" link to Vault when overflow

2. EXECUTE FULFILL â†’ CYCLE TASK AUTO-COMPLETE
   - Hitting "Fulfill" on a Vault EARN Execute item now checks if a matching
     cycle task exists (matched by title substring or linkedGoal)
   - If found and incomplete, auto-marks that cycle task as done simultaneously
   - Dual celebration: "Executed + Cycle Task Done!"

3. CONTACTS â†’ DELEGATED TASKS (AUTOMATIC)
   - Any EARN Contact with a follow-up date of today or earlier automatically
     creates a Delegated task on the Execute screen
   - Synced on every render via syncContactsToTasks()
   - When follow-up is marked done (bumped +7 days), delegated task auto-removes
   - No manual bridging needed

4. LEVERAGE â†’ GOALS (BUILD TAB)
   - Expanding any goal card now shows a "ðŸ”— Active Leverage" section
   - Surfaces incomplete EARN Leverage items linked by linkedGoal title or
     matching linkedDomain to the goal's domain
   - Shows up to 3 leverage items with overflow link to Vault

5. DOMAIN-AWARE INTELLIGENCE BRIEF
   - Brief header now shows a colored pill for the cycle's dominant domain
     (the goals_focus entry with the highest % allocation)
   - Strategy item selection and Leverage spotlight both prioritize items
     matching that dominant domain
   - Replaced first-alphabetical fallback with highest-% domain selection

ðŸŽ‰ v2.4.0 (BUG FIX RELEASE â€” March 1, 2026):
================================================================================
- FIXED: Micro-steps now delete correctly (confirm() blocked in PWA mode)
- FIXED: Replaced all 28 native window.confirm() calls with custom non-blocking dialog
         â€” critical for PWA/iOS standalone mode where confirm() returns false
- FIXED: Habit Tracker restored to System tab (was missing)
- FIXED: dailyResetHabits() name mismatch (was resetDailyHabits)
- FIXED: toggleHabit toast message was inverted (showed "done" when undone)  
- FIXED: saveMicroSteps didn't assign id to steps (broke delete-by-index)
- FIXED: deleteSubgoal / deleteGoalStage missing confirm callback parameter
- FIXED: deleteTimeblock double comma syntax error
- FIXED: Vault bulk delete callback not properly closed
- FIXED: README/UserFlow text buttons replaced with icon buttons in header
- ADDED: Custom confirm dialog (non-blocking, PWA-safe, accessible)
- IMPROVED: Null-safe guards on all filter/find operations in delete functions

================================================================================
ðŸ› BUG FIXES IN v2.3.0:
- Fixed double semicolon (;;) in vaultDailyBrief() execLog declaration
- Fixed undefined CSS variable --text-secondary â†’ replaced with --dim
- Fixed: activeDomain now uses highest goals_focus % instead of first key

================================================================================
ðŸŽ‰ v2.2.2 (PRODUCTION READY â€” February 14, 2026):
- Daily Reset functionality for habits and micro-steps
- CSV Export: 8-sheet export compatible with Excel/Google Sheets
- Removed duplicate export buttons
- Enhanced data validation on startup with auto-repair
- Production error boundaries
- Data integrity validation on load

ðŸŽ‰ v2.2.0 (WORLD-CLASS VAULT â€” February 10, 2026):
- Premium card-based Vault layout with animations
- Comprehensive analytics dashboard
- Real-time search + tag filtering
- Full CRUD for all LEARN and EARN items
- Importance levels, source attribution, starred status
- LEARN â†’ EARN promotion workflow

v2.1.x series: System tab enhancements, critical domain fixes,
intelligent task assignment, comprehensive blueprint validation.

================================================================================
CORE FEATURES:
âœ… 5-Tab Interface: EXECUTE | BUILD | STRATEGY | SYSTEM | VAULT
âœ… 15-Year Blueprint with 60 cycles (90 days each)
âœ… Custom Blueprint Generator (AI-assisted, 12-field form)
âœ… Quick Capture: 10 streamlined capture types
âœ… Universal Search: real-time across 12+ data types
âœ… 90-Day Cycles with 13-week task execution
âœ… Habit Tracking with heatmap visualization
âœ… Vault EARN: Strategy, Execute, Leverage, Contacts (all now integrated)
âœ… Vault LEARN: Notes, Quotes, Books, Ideas
âœ… Pomodoro Timer with Zen Mode
âœ… Morning/Evening Reflections
âœ… CSV + JSON Import/Export
âœ… PWA: installable, offline-capable
âœ… Undo/Redo system (20 steps)
âœ… Backup reminder (7-day interval)
âœ… Offline indicator

TECHNICAL:
- Pure JavaScript (zero dependencies)
- LocalStorage persistence
- Mobile-responsive, dark-theme optimized
- HTML-escaped all user input (XSS safe)
- Inline PWA manifest (no external files required)
- Tested: Chrome 90+, Safari 14+, Firefox 88+

FIRST-TIME SETUP:
1. Open in browser â†’ Welcome modal appears
2. Option A: SYSTEM â†’ Custom Blueprint â†’ fill 12 fields â†’ generate AI prompt
   â†’ paste into ChatGPT/Claude â†’ import returned JSON
3. Option B: BUILD â†’ Stats â†’ Import Blueprint â†’ upload existing JSON
4. STRATEGY â†’ Activate First Cycle
5. Execute daily from EXECUTE tab
================================================================================
-->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SVK Blueprint | 15-Year Vision Execution System</title>
    
    <!-- PWA: Core meta -->
    <meta name="description" content="Zen-inspired 15-year vision execution system. Transform long-term goals into daily action with frictionless execution.">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SVK Blueprint">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="SVK Blueprint">
    <meta name="msapplication-TileColor" content="#000000">
    
    <!-- PWA: Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'%3E%3Crect width='180' height='180' rx='36' fill='%23000'/%3E%3Ctext x='90' y='112' font-family='system-ui,sans-serif' font-size='60' font-weight='900' fill='%23ffd700' text-anchor='middle'%3ESVK%3C/text%3E%3Ctext x='90' y='140' font-family='system-ui,sans-serif' font-size='16' font-weight='400' fill='%23666' text-anchor='middle' letter-spacing='4'%3EBLUEPRINT%3C/text%3E%3C/svg%3E">
    
    <!-- PWA: Inline manifest (no external file needed) -->
    <script>
    (function() {
        const manifest = {
            name: "SVK Blueprint",
            short_name: "SVK",
            description: "Zen-inspired 15-year vision execution system",
            start_url: "./",
            display: "standalone",
            background_color: "#000000",
            theme_color: "#000000",
            orientation: "portrait-primary",
            categories: ["productivity", "lifestyle"],
            icons: [
                {
                    src: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Crect width='192' height='192' fill='%23000'/%3E%3Ctext x='96' y='118' font-family='system-ui' font-size='72' font-weight='900' fill='%23ffd700' text-anchor='middle'%3ESVK%3C/text%3E%3C/svg%3E",
                    sizes: "192x192",
                    type: "image/svg+xml",
                    purpose: "any maskable"
                },
                {
                    src: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' fill='%23000'/%3E%3Ctext x='256' y='310' font-family='system-ui' font-size='192' font-weight='900' fill='%23ffd700' text-anchor='middle'%3ESVK%3C/text%3E%3C/svg%3E",
                    sizes: "512x512",
                    type: "image/svg+xml",
                    purpose: "any maskable"
                }
            ]
        };
        const blob = new Blob([JSON.stringify(manifest)], {type: 'application/manifest+json'});
        const url = URL.createObjectURL(blob);
        const link = document.createElement('link');
        link.rel = 'manifest';
        link.href = url;
        document.head.appendChild(link);
    })();
    </script>

    <style>
    
        :root {
            --void: #000000; --card: #1c1c1e; --sub: #2c2c2e; --text: #ffffff;
            --dim: #8e8e93; --accent: #ffd700; --border: #38383a;
            --success: #30d158; --warn: #ffd60a; --danger: #ff453a;
            --blue: #0a84ff; --purple: #bf5af2; --zen: #c0c0c0;
            --font: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background: var(--void); color: var(--text); font-family: var(--font); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* HEADER */
        .header {
            padding: max(env(safe-area-inset-top), 16px) 14px 14px;
            background: rgba(0,0,0,0.95); backdrop-filter: blur(20px);
            position: fixed; top: 0; width: 100%; z-index: 50;
            border-bottom: 0.5px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
            gap: 8px;
        }
        /* Profile avatar button â€” replaces static SVK logo */
        .profile-avatar-btn {
            min-width: 36px; width: 36px; height: 36px; border-radius: 50%;
            background: linear-gradient(135deg, var(--accent) 0%, #ff9f0a 100%);
            border: 2px solid rgba(255,215,0,0.25);
            cursor: pointer; flex-shrink: 0;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 0 10px rgba(255,215,0,0.3);
            transition: all 0.2s;
        }
        .profile-avatar-btn:hover { transform: scale(1.08); box-shadow: 0 0 18px rgba(255,215,0,0.5); }
        .profile-avatar-btn:active { transform: scale(0.93); }
        #profile-avatar-display {
            font-family: monospace; font-weight: 900; font-size: 12px;
            color: #000; line-height: 1; max-width: 32px;
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap; text-align: center;
        }
        .header-center {
            flex: 1; min-width: 0; overflow: hidden;
        }
        .header-user-name {
            font-family: monospace; font-weight: 700; font-size: 12px;
            color: var(--accent); letter-spacing: 1.5px; text-transform: uppercase;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.2;
        }
        .header-user-name.empty { display: none; }
        .header-user-tagline {
            font-size: 9px; color: var(--dim); letter-spacing: 0.5px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            line-height: 1.2; margin-top: 1px;
        }
        .header-user-tagline:empty { display: none; }
        .logo-svk { font-family: monospace; font-weight: 700; font-size: 26px; letter-spacing: 4px; color: var(--accent); text-shadow: 0 0 20px rgba(255,215,0,0.3); }
        .header-right { display: flex; gap: 8px; align-items: center; flex-shrink: 0; }
        .header-icon-btn {
            width: 32px; height: 32px; background: var(--sub); border: 1px solid var(--border);
            border-radius: 8px; display: flex; align-items: center; justify-content: center;
            color: var(--text); cursor: pointer; transition: all 0.2s;
        }
        .header-icon-btn:active { opacity: 0.7; transform: scale(0.95); }
        .header-text-btn {
            height: 28px; background: var(--sub); border: 1px solid var(--border);
            border-radius: 7px; padding: 0 8px;
            color: var(--accent); cursor: pointer; transition: all 0.2s;
            font-family: monospace; font-size: 8px; font-weight: 800;
            letter-spacing: 1px; text-transform: uppercase; white-space: nowrap;
        }
        .header-text-btn:hover { background: rgba(255,215,0,0.1); border-color: rgba(255,215,0,0.35); }
        .header-text-btn:active { opacity: 0.7; transform: scale(0.95); }
        .cycle-badge {
            font-family: monospace; font-size: 11px; font-weight: 700;
            padding: 6px 12px; background: var(--sub); border-radius: 12px;
            border: 1px solid var(--border); color: var(--accent);
            text-transform: uppercase; letter-spacing: 1px; cursor: pointer;
        }
        .timer-badge {
            font-family: monospace; font-size: 11px; font-weight: 700;
            padding: 6px 12px; background: var(--success); color: var(--void);
            border-radius: 12px; cursor: pointer; display: none;
            animation: pulse-badge 2s infinite;
        }
        .timer-badge.active { display: block; }
        @keyframes pulse-badge { 0%,100%{opacity:1} 50%{opacity:0.7} }
        @keyframes countdown-tick { 
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        .countdown-ticking {
            animation: countdown-tick 1s ease-in-out infinite;
        }
        
        /* OFFLINE INDICATOR */
        .offline-badge {
            position: fixed; top: calc(env(safe-area-inset-top) + 70px); right: 20px;
            background: var(--danger); color: var(--text); padding: 8px 12px;
            border-radius: 8px; font-size: 11px; font-weight: 600;
            text-transform: uppercase; letter-spacing: 1px; z-index: 60;
            display: none; align-items: center; gap: 6px;
            box-shadow: 0 4px 12px rgba(255,69,58,0.3);
        }
        .offline-badge.show { display: flex; }
        
        /* BACKUP REMINDER BANNER */
        .backup-reminder {
            position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
            background: var(--warn); color: var(--void); padding: 12px 20px;
            border-radius: 12px; font-size: 13px; font-weight: 600;
            z-index: 60; display: none; align-items: center; gap: 12px;
            box-shadow: 0 4px 16px rgba(255,214,10,0.4); max-width: 90%;
        }
        .backup-reminder.show { display: flex; }
        .backup-reminder button {
            padding: 6px 12px; background: var(--void); color: var(--warn);
            border: none; border-radius: 6px; font-weight: 600; cursor: pointer;
        }
        
        /* UPDATE BANNER */
        .update-banner {
            position: fixed; top: 0; left: 0; right: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 12px 20px;
            font-size: 13px; font-weight: 600;
            z-index: 70; display: flex; align-items: center; gap: 12px;
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4);
            animation: slideDown 0.3s ease-out;
        }
        @keyframes slideDown {
            from { transform: translateY(-100%); }
            to { transform: translateY(0); }
        }
        .update-banner.show { display: flex; }
        
        /* UNDO TOAST */
        .undo-toast {
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
            background: var(--sub); color: var(--text); padding: 12px 16px;
            border-radius: 10px; font-size: 13px; z-index: 65;
            display: none; align-items: center; gap: 12px; border: 1px solid var(--border);
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        .undo-toast.show { display: flex; }
        .undo-toast button {
            padding: 6px 12px; background: var(--accent); color: var(--void);
            border: none; border-radius: 6px; font-weight: 600; cursor: pointer;
            font-size: 12px;
        }

        /* SCROLL */
        .content { flex: 1; overflow-y: auto; padding: calc(72px + env(safe-area-inset-top)) 20px calc(88px + env(safe-area-inset-bottom)); }
        .content::-webkit-scrollbar { width: 0; }

        /* NAV */
        .nav {
            position: fixed; bottom: 0; width: 100%;
            background: rgba(20,20,22,0.97); backdrop-filter: blur(24px);
            border-top: 0.5px solid var(--border);
            display: grid; grid-template-columns: repeat(5, 1fr);
            padding-bottom: env(safe-area-inset-bottom); z-index: 100;
        }
        .nav-btn {
            background: none; border: none; padding: 10px 0;
            color: var(--dim); display: flex; flex-direction: column;
            align-items: center; gap: 3px; font-size: 9px;
            font-weight: 600; cursor: pointer; transition: color 0.2s; letter-spacing: 0.5px;
        }
        .nav-btn.active { color: var(--accent); }
        .nav-icon { width: 22px; height: 22px; stroke-width: 2; }

        /* CARDS */
        .card { background: var(--card); border-radius: 14px; padding: 18px; margin-bottom: 10px; border: 0.5px solid var(--border); }
        .zen-quote { text-align: center; padding: 18px 12px; margin: 12px 0; font-style: italic; color: var(--zen); font-size: 14px; border-top: 1px solid var(--border); border-bottom: 1px solid var(--border); line-height: 1.5; }
        .btn {
            background: var(--accent); color: var(--void); border: none; border-radius: 10px;
            padding: 14px; font-weight: 700; font-size: 15px; width: 100%; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: opacity 0.2s; text-transform: uppercase; letter-spacing: 1px;
        }
        .btn:active { opacity: 0.8; }
        .btn-sec { background: var(--sub); color: var(--text); padding: 8px 14px; border-radius: 8px; border: none; font-weight: 600; font-size: 12px; cursor: pointer; white-space: nowrap; transition: opacity 0.15s; }
        .btn-sec:active { opacity: 0.7; }
        .btn-danger { background: var(--danger); color: #fff; }
        .btn-success { background: var(--success); color: var(--void); }

        /* TASKS */
        .task-row { display: flex; align-items: center; padding: 14px; background: var(--sub); border-radius: 10px; margin-bottom: 8px; border: 1px solid var(--border); gap: 12px; }
        .task-row.done { opacity: 0.4; }
        .task-title { font-weight: 600; word-break: break-word; }
        .task-row.done .task-title { text-decoration: line-through; }
        .task-meta { font-family: monospace; font-size: 10px; color: var(--dim); margin-top: 5px; display: flex; gap: 6px; align-items: center; flex-wrap: wrap; }
        .badge { font-size: 9px; font-weight: 800; padding: 2px 6px; border-radius: 4px; text-transform: uppercase; letter-spacing: 0.5px; }

        /* PROGRESS */
        .progress-bar { width: 100%; height: 6px; background: var(--sub); border-radius: 3px; overflow: hidden; margin: 10px 0; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent), #ff9f0a); border-radius: 3px; transition: width 0.6s; }

        /* STATS */
        .stat-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 16px; }
        .stat-box { background: var(--sub); border-radius: 10px; padding: 14px; text-align: center; border: 1px solid var(--border); }
        .stat-val { font-weight: 700; font-size: 22px; color: var(--accent); font-family: monospace; }
        .stat-label { font-size: 9px; color: var(--dim); text-transform: uppercase; margin-top: 3px; letter-spacing: 1px; }

        /* MODAL */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000; display: none; align-items: flex-end; backdrop-filter: blur(6px); }
        .modal.open { display: flex; }
        .modal-sheet {
            background: var(--card); width: 100%; border-radius: 20px 20px 0 0;
            padding: 20px; padding-bottom: max(32px, env(safe-area-inset-bottom));
            max-height: 88vh; overflow-y: auto;
            animation: slideUp 0.28s cubic-bezier(0.16,1,0.3,1);
            border-top: 1px solid var(--border);
        }
        .modal-handle { width: 36px; height: 4px; background: var(--border); border-radius: 2px; margin: 0 auto 16px; }
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0.6; } to { transform: translateY(0); opacity: 1; } }

        /* INPUTS */
        input, textarea, select {
            width: 100%; background: var(--sub); border: 1px solid var(--border);
            border-radius: 10px; padding: 12px; color: var(--text); font-size: 16px;
            margin-bottom: 12px; font-family: var(--font);
        }

        /* TOAST */
        .toast {
            position: fixed; top: max(env(safe-area-inset-top), 16px); left: 50%;
            transform: translateX(-50%) translateY(-8px); background: var(--card); color: var(--text);
            padding: 11px 22px; border-radius: 20px; font-size: 14px; font-weight: 600;
            z-index: 5000; border: 1px solid var(--border);
            box-shadow: 0 8px 32px rgba(0,0,0,0.5); opacity: 0;
            transition: opacity 0.25s, transform 0.25s; pointer-events: none;
        }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

        /* HABIT TIMER OVERLAY */
        .habit-timer-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 3000;
            display: none; align-items: center; justify-content: center; padding: 20px;
            backdrop-filter: blur(10px);
        }
        .habit-timer-overlay.active { display: flex; }
        .habit-timer-content { width: 100%; max-width: 480px; text-align: center; }
        
        /* ZEN MODE TIMER */
        .zen-timer-overlay {
            position: fixed; inset: 0; background: linear-gradient(135deg, #000000 0%, #0a0a0a 100%);
            z-index: 4000; display: none; align-items: center; justify-content: center;
            backdrop-filter: blur(20px);
        }
        .zen-timer-overlay.active { display: flex; }
        .zen-timer-content {
            width: 100%; max-width: 600px; padding: 40px 20px;
            text-align: center; animation: zenFadeIn 0.6s ease-out;
        }
        @keyframes zenFadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        
        .zen-title {
            font-size: 16px; font-weight: 600; color: var(--accent);
            text-transform: uppercase; letter-spacing: 2px; margin-bottom: 24px;
            opacity: 0.9;
        }
        
        .zen-intention {
            background: rgba(255, 215, 0, 0.05); padding: 20px;
            border-radius: 16px; margin-bottom: 32px;
            border: 1px solid rgba(255, 215, 0, 0.1);
        }
        .zen-intention-label {
            font-size: 10px; color: var(--dim); text-transform: uppercase;
            letter-spacing: 2px; margin-bottom: 8px;
        }
        .zen-intention-text {
            font-size: 15px; line-height: 1.6; color: rgba(255,255,255,0.9);
            font-weight: 400;
        }
        
        .zen-countdown {
            font-size: 96px; font-weight: 700; font-family: monospace;
            color: var(--text); margin: 32px 0;
            text-shadow: 0 0 40px rgba(255,215,0,0.2);
            animation: zenPulse 2s ease-in-out infinite;
        }
        @keyframes zenPulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.01); opacity: 0.95; }
        }
        
        .zen-step-card {
            background: var(--card); padding: 32px 24px; border-radius: 20px;
            margin: 40px 0; border: 1px solid var(--border);
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
        }
        
        .zen-step-number {
            display: inline-block; width: 32px; height: 32px;
            background: var(--accent); color: var(--void);
            border-radius: 50%; line-height: 32px; font-weight: 700;
            font-size: 14px; margin-bottom: 16px;
        }
        
        .zen-step-text {
            font-size: 24px; line-height: 1.5; color: var(--text);
            font-weight: 500; margin-bottom: 24px;
        }
        
        .zen-step-progress {
            font-size: 11px; color: var(--dim); text-transform: uppercase;
            letter-spacing: 2px; margin-top: 16px;
        }
        
        .zen-buttons {
            display: flex; gap: 16px; justify-content: center; margin-top: 32px;
        }
        
        .zen-btn {
            flex: 1; max-width: 200px; padding: 18px 24px;
            border: none; border-radius: 12px; font-size: 16px;
            font-weight: 600; cursor: pointer; transition: all 0.2s;
        }
        .zen-btn:active { transform: scale(0.96); }
        
        .zen-btn-skip {
            background: var(--sub); color: var(--dim);
            border: 1px solid var(--border);
        }
        .zen-btn-skip:hover { background: var(--border); color: var(--text); }
        
        .zen-btn-done {
            background: var(--success); color: var(--void);
            box-shadow: 0 4px 16px rgba(48, 209, 88, 0.3);
        }
        .zen-btn-done:hover { box-shadow: 0 6px 20px rgba(48, 209, 88, 0.4); }
        
        .zen-btn-pause {
            background: var(--warn); color: var(--void);
        }
        
        .zen-btn-stop {
            background: var(--danger); color: var(--text);
        }
        
        .zen-controls {
            display: flex; gap: 12px; justify-content: center;
            margin-top: 24px; padding-top: 24px;
            border-top: 1px solid var(--border);
        }
        
        .zen-control-btn {
            padding: 12px 20px; background: transparent;
            border: 1px solid var(--border); border-radius: 8px;
            color: var(--dim); font-size: 13px; font-weight: 600;
            cursor: pointer; transition: all 0.2s;
        }
        .zen-control-btn:hover { background: var(--sub); color: var(--text); }
        .habit-timer-title { font-size: 24px; font-weight: 700; color: var(--accent); margin-bottom: 12px; }
        .habit-timer-clock {
            font-size: 72px; font-weight: 700; font-family: monospace; color: var(--text);
            margin: 24px 0; text-shadow: 0 0 30px rgba(255,215,0,0.4);
        }
        .habit-timer-controls { display: flex; gap: 12px; margin-bottom: 32px; }
        .timer-control-btn {
            flex: 1; padding: 14px; background: var(--sub); border: 1px solid var(--border);
            border-radius: 10px; color: var(--text); font-weight: 600; font-size: 14px;
            cursor: pointer; transition: opacity 0.2s;
        }
        .timer-control-btn:active { opacity: 0.7; }
        .timer-control-btn.primary { background: var(--success); color: var(--void); }
        .timer-control-btn.danger { background: var(--danger); color: #fff; }
        .micro-steps-container {
            background: var(--card); border-radius: 14px; padding: 20px;
            margin-top: 24px; border: 1px solid var(--border);
        }
        .micro-steps-title {
            font-size: 14px; font-weight: 700; color: var(--accent);
            text-transform: uppercase; letter-spacing: 1px; margin-bottom: 16px; text-align: center;
        }
        .micro-step-item {
            background: var(--sub); padding: 16px; border-radius: 10px; margin-bottom: 10px;
            display: flex; align-items: center; justify-content: space-between; gap: 12px;
            border: 1px solid var(--border); transition: all 0.3s;
        }
        .micro-step-item.completed { opacity: 0.5; border-color: var(--success); }
        .micro-step-item.skipped { opacity: 0.3; border-color: var(--dim); }
        .micro-step-text { flex: 1; text-align: left; font-size: 15px; line-height: 1.4; }
        .micro-step-item.completed .micro-step-text { text-decoration: line-through; }
        .micro-step-actions { display: flex; gap: 8px; }
        .micro-step-btn {
            padding: 8px 16px; border-radius: 8px; font-size: 12px; font-weight: 700;
            border: none; cursor: pointer; transition: opacity 0.2s; white-space: nowrap;
        }
        .micro-step-btn:active { opacity: 0.7; }
        .micro-step-btn.skip { background: var(--sub); color: var(--dim); border: 1px solid var(--border); }
        .micro-step-btn.done { background: var(--success); color: var(--void); }
        .micro-progress { text-align: center; margin-top: 16px; font-size: 13px; color: var(--dim); }
        .micro-progress-bar {
            width: 100%; height: 8px; background: var(--sub); border-radius: 4px;
            overflow: hidden; margin: 8px 0;
        }
        .micro-progress-fill {
            height: 100%; background: linear-gradient(90deg, var(--success), #30d158);
            border-radius: 4px; transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* HABIT CARD ENHANCEMENTS */
        .habit-card {
            background: var(--card); border-radius: 10px; padding: 12px;
            margin-bottom: 8px; border: 1px solid var(--border);
        }
        .habit-header {
            display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;
        }
        .habit-info { flex: 1; }
        .habit-title { font-size: 14px; font-weight: 600; margin-bottom: 2px; }
        .habit-meta {
            font-size: 10px; color: var(--dim); display: flex; gap: 6px; align-items: center;
        }
        .habit-actions { display: flex; gap: 6px; }
        .habit-check-btn {
            width: 28px; height: 28px; border-radius: 50%; border: 2px solid var(--border);
            background: transparent; cursor: pointer; display: flex; align-items: center;
            justify-content: center; transition: all 0.2s;
        }
        .habit-check-btn.done { background: var(--success); border-color: var(--success); }
        .habit-start-btn {
            padding: 6px 10px; background: var(--accent); color: var(--void); border: none;
            border-radius: 6px; font-size: 11px; font-weight: 700; cursor: pointer;
            transition: opacity 0.2s;
        }
        .habit-start-btn:active { opacity: 0.8; }
        .streak-badge {
            font-family: monospace; font-size: 10px; font-weight: 700; padding: 3px 6px;
            background: var(--sub); border-radius: 4px; color: var(--accent);
        }

        /* FAB */
        .fab {
            position: fixed; bottom: calc(82px + env(safe-area-inset-bottom)); right: 20px;
            width: 54px; height: 54px; background: var(--accent); border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: var(--void); z-index: 90; box-shadow: 0 6px 20px rgba(255,215,0,0.35);
            cursor: pointer; border: none;
        }

        /* SEGMENT */
        .segment { display: flex; background: var(--sub); padding: 3px; border-radius: 10px; margin-bottom: 14px; gap: 2px; }
        .segment-btn { flex: 1; padding: 8px 10px; background: transparent; border: none; color: var(--dim); font-weight: 600; font-size: 12px; cursor: pointer; border-radius: 8px; }
        .segment-btn.active { background: var(--card); color: var(--text); box-shadow: 0 1px 4px rgba(0,0,0,0.3); }

        /* SECTION HEADER */
        .section-header {
            text-transform: uppercase; font-size: 10px; font-weight: 700; color: var(--accent);
            margin: 20px 0 10px; letter-spacing: 2px; display: flex;
            justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border); padding-bottom: 8px;
        }

        /* EMPTY STATE */
        .empty-state { text-align: center; padding: 48px 20px; color: var(--dim); font-size: 14px; }
        .empty-state-icon { font-size: 44px; margin-bottom: 12px; opacity: 0.6; }
        
        /* ===== VAULT ZEN REDESIGN ===== */

        /* Main tab switcher â€” LEARN / EARN */
        .vault-main-switcher {
            display: flex;
            gap: 0;
            margin-bottom: 0;
            border-bottom: 1px solid var(--zen-border);
        }
        .vault-main-btn {
            flex: 1;
            padding: 14px 12px;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
            color: var(--zen-stone);
            font-family: var(--font);
            font-size: 10px;
            letter-spacing: 5px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.25s ease;
        }
        .vault-main-btn:hover { color: rgba(245,240,232,0.6); }
        .vault-main-btn.active {
            color: rgba(245,240,232,0.9);
            border-bottom-color: rgba(245,240,232,0.5);
        }

        /* Sub-category nav pills */
        .vault-sub-nav {
            display: flex;
            gap: 4px;
            padding: 16px 0 4px;
            margin-bottom: 0;
            overflow-x: auto;
            scrollbar-width: none;
        }
        .vault-sub-nav::-webkit-scrollbar { display: none; }
        .vault-sub-btn {
            flex-shrink: 0;
            padding: 6px 14px;
            background: transparent;
            border: 1px solid var(--zen-border);
            border-radius: 1px;
            color: var(--zen-stone);
            font-family: var(--font);
            font-size: 10px;
            letter-spacing: 2px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.25s ease;
            white-space: nowrap;
        }
        .vault-sub-btn:hover {
            color: rgba(245,240,232,0.7);
            border-color: rgba(245,240,232,0.2);
        }
        .vault-sub-btn.active {
            color: rgba(245,240,232,0.9);
            border-color: rgba(245,240,232,0.35);
            background: var(--zen-mist);
        }

        /* Vault section header â€” compact, left-aligned, premium */
        .vault-section-header {
            padding: 20px 0 4px;
        }
        .vault-section-kanji {
            font-size: 9px;
            letter-spacing: 5px;
            color: var(--zen-stone);
            text-transform: uppercase;
            font-family: var(--font);
            opacity: 0.55;
            margin-bottom: 4px;
        }
        .vault-section-title {
            font-size: 20px;
            font-weight: 300;
            color: rgba(245,240,232,0.88);
            font-style: italic;
            letter-spacing: 0.5px;
            margin-bottom: 3px;
        }
        .vault-section-desc {
            font-size: 11px;
            color: var(--zen-stone);
            font-style: italic;
            opacity: 0.65;
            margin-bottom: 0;
        }

        /* Vault toolbar â€” single lean row */
        .vault-toolbar {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 14px 0 18px;
            padding: 10px 12px;
            background: var(--zen-mist);
            border: 1px solid var(--zen-border);
            border-radius: 3px;
        }
        .vault-search-input {
            flex: 1;
            padding: 10px 14px 10px 14px;
            background: transparent;
            border: 1px solid var(--zen-border);
            border-radius: 2px;
            color: rgba(245,240,232,0.8);
            font-family: var(--zen-font);
            font-size: 14px;
            font-style: italic;
            transition: border-color 0.3s;
        }
        .vault-search-input:focus { outline: none; border-color: rgba(245,240,232,0.25); }
        .vault-search-input::placeholder { color: var(--zen-stone); }
        .vault-search-icon {
            display: none; /* replaced by placeholder text */
        }
        .vault-sort-dropdown {
            padding: 10px 10px;
            background: transparent;
            border: 1px solid var(--zen-border);
            border-radius: 2px;
            color: var(--zen-stone);
            font-family: var(--font);
            font-size: 10px;
            letter-spacing: 1px;
            cursor: pointer;
            min-width: 80px;
        }
        .vault-sort-dropdown:focus { outline: none; border-color: rgba(245,240,232,0.2); }
        .vault-sort-dropdown option { background: #1c1c1e; }
        .vault-add-btn {
            padding: 10px 16px;
            background: transparent;
            border: 1px solid var(--zen-border);
            border-radius: 2px;
            color: rgba(245,240,232,0.7);
            font-family: var(--font);
            font-size: 10px;
            letter-spacing: 2px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.25s;
            white-space: nowrap;
        }
        .vault-add-btn:hover {
            background: var(--zen-mist);
            border-color: rgba(245,240,232,0.25);
            color: rgba(245,240,232,0.9);
        }

        /* Vault item card */
        .vault-item-card {
            background: transparent;
            border: 1px solid var(--zen-border);
            border-radius: 2px;
            padding: 20px 18px;
            margin-bottom: 12px;
            position: relative;
            transition: all 0.35s ease;
            overflow: hidden;
            animation: vaultFadeIn 0.35s ease forwards;
            opacity: 0;
        }
        @keyframes vaultFadeIn {
            from { opacity: 0; transform: translateY(6px); }
            to   { opacity: 1; transform: translateY(0); }
        }
        .vault-item-card::before {
            content: '';
            position: absolute;
            left: 0; top: 0; bottom: 0;
            width: 2px;
            opacity: 0;
            transition: opacity 0.35s;
            background: linear-gradient(to bottom, transparent, rgba(200,185,155,0.5), transparent);
        }
        .vault-item-card:hover {
            background: var(--zen-glow);
            border-color: rgba(245,240,232,0.18);
        }
        .vault-item-card:hover::before { opacity: 1; }

        /* Importance accents â€” subtle, not loud */
        .vault-importance-high::before {
            background: linear-gradient(to bottom, transparent, rgba(180,80,60,0.55), transparent);
            opacity: 0.7;
        }
        .vault-importance-medium::before {
            background: linear-gradient(to bottom, transparent, rgba(180,150,60,0.4), transparent);
            opacity: 0.5;
        }

        /* Pinned item */
        .vault-item-card.pinned {
            border-color: rgba(245,240,232,0.2);
            background: var(--zen-glow);
        }
        .vault-item-card.pinned::after {
            content: 'Â·';
            position: absolute;
            top: 10px; right: 16px;
            font-size: 24px;
            color: rgba(245,240,232,0.25);
            line-height: 1;
        }

        /* Item header */
        .vault-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
            gap: 12px;
        }
        .vault-item-title {
            font-family: var(--zen-title-font);
            font-size: 17px;
            font-weight: 400;
            line-height: 1.4;
            color: rgba(245,240,232,0.88);
            flex: 1;
            letter-spacing: 0.2px;
            font-style: italic;
        }
        .vault-item-meta {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 10px;
            font-family: var(--font);
            font-size: 10px;
            color: var(--zen-stone);
            letter-spacing: 1.5px;
            text-transform: uppercase;
        }
        .vault-item-content {
            font-family: var(--zen-font);
            font-size: 14px;
            line-height: 1.8;
            color: rgba(245,240,232,0.55);
            margin-bottom: 12px;
            white-space: pre-wrap;
            font-weight: 300;
        }
        .vault-item-tags {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }
        .vault-tag {
            padding: 3px 10px;
            border: 1px solid var(--zen-border);
            border-radius: 1px;
            font-family: var(--font);
            font-size: 9px;
            letter-spacing: 1.5px;
            color: var(--zen-stone);
            text-transform: uppercase;
        }

        /* Footer row */
        .vault-item-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 12px;
            border-top: 1px solid var(--zen-border);
        }
        .vault-item-actions {
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.25s;
        }
        .vault-item-card:hover .vault-item-actions { opacity: 1; }
        .vault-action-btn {
            padding: 5px 10px;
            background: transparent;
            border: 1px solid transparent;
            border-radius: 2px;
            font-family: var(--font);
            font-size: 9px;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            cursor: pointer;
            color: var(--zen-stone);
            transition: all 0.2s;
        }
        .vault-action-btn:hover {
            border-color: var(--zen-border);
            color: rgba(245,240,232,0.7);
            background: var(--zen-mist);
        }
        .vault-action-btn.danger:hover {
            border-color: rgba(180,70,60,0.3);
            color: rgba(200,90,70,0.9);
            background: transparent;
        }

        /* Promoted badge */
        .vault-promoted-badge {
            font-family: var(--font);
            font-size: 9px;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: var(--zen-stone);
            opacity: 0.6;
            margin-bottom: 8px;
        }

        /* Completed item */
        .vault-item-card.completed-item {
            opacity: 0.42;
        }

        /* Legacy / hidden stubs */
        .vault-analytics { display: none; }
        .vault-batch-bar { display: none !important; }
        .vault-filters-panel { display: none !important; }
        .vault-filter-group, .vault-filter-label, .vault-filter-chips, .vault-filter-chip {}
        .vault-view-toggle { display: none; }
        .vault-grid { display: block; }
        .vault-stat-row, .vault-stat-mini, .vault-stat-mini-val, .vault-stat-mini-label {}
        .vault-link-badge, .vault-checkbox, .vault-link-item {}
        .vault-timeline { padding-left: 0; }
        .vault-timeline::before { display: none; }
        .vault-timeline-item { position: relative; margin-bottom: 24px; }
        .vault-timeline-date { font-size: 11px; color: var(--dim); margin-bottom: 8px; font-weight: 600; }
        .vault-markdown h1, .vault-markdown h2, .vault-markdown h3 { color: rgba(245,240,232,0.7); margin: 16px 0 8px; }
        .vault-markdown code { background: var(--sub); padding: 2px 6px; border-radius: 2px; font-family: monospace; font-size: 12px; }
        .vault-markdown ul, .vault-markdown ol { margin-left: 20px; margin-bottom: 12px; }
        .vault-markdown blockquote { border-left: 2px solid var(--zen-border); padding-left: 12px; margin: 12px 0; color: var(--zen-stone); }
        .vault-color-picker { display: flex; gap: 8px; margin-top: 8px; }
        .vault-color-option { width: 28px; height: 28px; border-radius: 2px; cursor: pointer; border: 1px solid var(--zen-border); transition: all 0.2s; }
        .vault-color-option:hover { transform: scale(1.1); border-color: rgba(245,240,232,0.3); }
        .vault-color-option.selected { border-color: rgba(245,240,232,0.6); border-width: 2px; }

        /* Batch / compact legacy stubs */
        .vault-item-card.selectable { cursor: pointer; }
        .vault-item-card.compact {
            padding: 10px 14px;
            margin-bottom: 6px;
        }
        .vault-item-card.compact .vault-item-title { font-size: 14px; margin-bottom: 4px; }
        .vault-item-card.compact .vault-item-content { font-size: 12px; margin-bottom: 6px; max-height: 40px; overflow: hidden; text-overflow: ellipsis; }
        .vault-item-card.compact .vault-item-footer {
            padding-top: 8px;
        }
        
        /* Timeline view */
        .vault-timeline {
            position: relative;
            padding-left: 40px;
        }
        .vault-timeline::before {
            content: '';
            position: absolute;
            left: 20px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--border);
        }
        .vault-timeline-item {
            position: relative;
            margin-bottom: 24px;
        }
        .vault-timeline-item::before {
            content: '';
            position: absolute;
            left: -27px;
            top: 8px;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--accent);
            border: 3px solid var(--void);
            box-shadow: 0 0 0 2px var(--border);
        }
        .vault-timeline-date {
            font-size: 11px;
            color: var(--dim);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
            padding-top: 8px;
        }
        
        /* Advanced filter panel */
        .vault-filter-panel {
            background: var(--sub);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            display: none;
        }
        .vault-filter-panel.active {
            display: block;
        }
        .vault-filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 12px;
        }
        .vault-filter-label {
            font-size: 11px;
            color: var(--dim);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
            font-weight: 600;
        }
        
        /* Tag filter chips */
        .vault-tag-filters {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }
        .vault-tag-filter {
            padding: 6px 12px;
            background: var(--sub);
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .vault-tag-filter.active {
            background: var(--accent);
            color: var(--void);
            border-color: var(--accent);
        }
        .vault-tag-filter:hover {
            border-color: var(--accent);
        }
        
        /* Linked items visual */
        .vault-linked-items {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }
        .vault-linked-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: var(--sub);
            border: 1px solid var(--border);
            border-radius: 6px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 12px;
        }
        .vault-linked-item:hover {
            border-color: var(--accent);
            background: rgba(255, 215, 0, 0.05);
        }
        
        /* Batch actions bar */
        .vault-batch-bar {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--card);
            border: 2px solid var(--accent);
            border-radius: 16px;
            padding: 16px 24px;
            display: none;
            align-items: center;
            gap: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            z-index: 1000;
        }
        .vault-batch-bar.active {
            display: flex;
        }
        .vault-batch-count {
            font-weight: 700;
            color: var(--accent);
            margin-right: 12px;
        }
        
        /* Markdown content rendering */
        .vault-item-content.markdown h1,
        .vault-item-content.markdown h2,
        .vault-item-content.markdown h3 {
            color: var(--text);
            margin: 12px 0 8px;
        }
        .vault-item-content.markdown code {
            background: var(--sub);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .vault-item-content.markdown pre {
            background: var(--sub);
            padding: 12px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 8px 0;
        }
        .vault-item-content.markdown ul,
        .vault-item-content.markdown ol {
            margin: 8px 0 8px 20px;
        }
        .vault-item-content.markdown blockquote {
            border-left: 3px solid var(--accent);
            padding-left: 12px;
            margin: 8px 0;
            font-style: italic;
            color: var(--dim);
        }
        .vault-item-content.markdown a {
            color: var(--accent);
            text-decoration: underline;
        }
        
        /* Color theme badges */
        .vault-theme-badge {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid var(--border);
            cursor: pointer;
            transition: all 0.2s;
        }
        .vault-theme-badge:hover {
            transform: scale(1.2);
            border-color: var(--text);
        }
        .vault-theme-badge.active {
            border-width: 3px;
            border-color: var(--text);
        }
        
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(255, 215, 0, 0); }
        }

        /* CELEBRATION */
        .celebrate-overlay { position: fixed; inset: 0; z-index: 9999; background: rgba(0,0,0,0.92); display: none; align-items: center; justify-content: center; flex-direction: column; text-align: center; padding: 40px; animation: fadeIn 0.4s; }
        .celebrate-overlay.show { display: flex; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .celebrate-emoji { font-size: 72px; animation: bounce 0.6s ease; }
        @keyframes bounce { 0%{transform:scale(0.5)} 60%{transform:scale(1.2)} 100%{transform:scale(1)} }
        .celebrate-title { font-size: 28px; font-weight: 800; color: var(--accent); margin: 16px 0 8px; }
        .celebrate-sub { color: var(--dim); font-size: 15px; margin-bottom: 32px; }
        .celebrate-close { background: var(--accent); color: var(--void); border: none; padding: 14px 40px; border-radius: 12px; font-weight: 700; font-size: 16px; cursor: pointer; }

        /* HEATMAP - Compact single-row layout */
        .heatmap { display: flex; gap: 1.5px; margin: 6px 0; justify-content: center; }
        .heatmap-day { 
            width: 9px; 
            height: 9px; 
            background: var(--sub); 
            border-radius: 1.5px; 
            border: 1px solid var(--border);
            transition: all 0.2s;
        }
        .heatmap-day.done { background: var(--success); border-color: var(--success); }
        .heatmap-day:hover { transform: scale(1.2); }

        /* GOAL CARDS */
        .goal-card {
            background: var(--sub);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s;
        }
        .goal-card:hover {
            border-color: var(--accent);
        }
        .goal-card.expanded {
            background: var(--card);
            border-color: var(--accent);
        }

        /* CHECKBOX */
        .checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        .checkbox:hover {
            border-color: var(--accent);
        }
        .checkbox.checked {
            background: var(--success);
            border-color: var(--success);
            position: relative;
        }
        .checkbox.checked::after {
            content: 'âœ“';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--void);
            font-size: 12px;
            font-weight: 700;
        }

        /* FILTER BUTTONS */
        .filter-btn {
            padding: 8px 12px;
            background: var(--sub);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            font-size: 11px;
            white-space: nowrap;
            color: var(--text);
            font-family: var(--font);
        }
        .filter-btn:hover {
            border-color: var(--accent);
        }

        /* ========== CUSTOM BLUEPRINT GENERATOR STYLES ========== */
        .step-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            background: var(--blue);
            color: white;
            border-radius: 50%;
            font-weight: 700;
            font-size: 16px;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .helper-text {
            font-size: 12px;
            color: var(--dim);
            margin-top: 4px;
            margin-bottom: 8px;
            line-height: 1.5;
        }

        .prompt-box {
            background: var(--sub);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            font-family: monospace;
            font-size: 11px;
            line-height: 1.6;
            color: var(--text);
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 12px;
        }

        .warning-box {
            background: rgba(255, 214, 10, 0.1);
            border: 1px solid var(--warn);
            border-radius: 12px;
            padding: 16px;
            margin-top: 16px;
        }

        .warning-box ol {
            margin: 0;
            padding-left: 20px;
        }

        .warning-box li {
            margin-bottom: 8px;
        }

        /* ========== WELCOME MODAL STYLES ========== */
        .welcome-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(10px);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }

        .welcome-modal {
            background: var(--card);
            border: 2px solid var(--accent);
            border-radius: 20px;
            padding: 40px 30px;
            max-width: 500px;
            width: 100%;
            text-align: center;
            box-shadow: 0 0 60px rgba(255, 215, 0, 0.3);
            animation: slideUp 0.4s ease;
        }

        .welcome-logo {
            font-family: monospace;
            font-weight: 700;
            font-size: 42px;
            letter-spacing: 8px;
            color: var(--accent);
            text-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
            margin-bottom: 10px;
        }

        .welcome-version {
            font-size: 13px;
            color: var(--dim);
            margin-bottom: 24px;
            letter-spacing: 1px;
        }

        .welcome-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 12px;
            line-height: 1.3;
        }

        .welcome-subtitle {
            font-size: 14px;
            color: var(--dim);
            line-height: 1.6;
            margin-bottom: 32px;
        }

        .welcome-options {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .welcome-option-btn {
            background: var(--sub);
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 24px 20px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
            position: relative;
            overflow: hidden;
        }

        .welcome-option-btn:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(255, 215, 0, 0.2);
        }

        .welcome-option-btn.primary {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.15), rgba(255, 215, 0, 0.05));
            border-color: var(--accent);
        }

        .welcome-option-icon {
            font-size: 32px;
            margin-bottom: 12px;
            display: block;
        }

        .welcome-option-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 6px;
        }

        .welcome-option-desc {
            font-size: 13px;
            color: var(--dim);
            line-height: 1.5;
        }

        .welcome-option-badge {
            display: inline-block;
            background: var(--accent);
            color: var(--void);
            font-size: 10px;
            font-weight: 700;
            padding: 4px 8px;
            border-radius: 6px;
            margin-top: 8px;
            letter-spacing: 0.5px;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 600px) {
            .welcome-modal {
                padding: 30px 20px;
            }
            .welcome-logo {
                font-size: 32px;
            }
            .welcome-title {
                font-size: 20px;
            }
            .welcome-option-btn {
                padding: 20px 16px;
            }
        }
        
        /* ===== SYSTEM TAB ENHANCEMENTS - v2.1 CSS ===== */
        
        /* Action Buttons Container */
        .action-btns { 
            display: flex; 
            gap: 8px; 
            margin-top: 12px; 
            padding-top: 12px; 
            border-top: 1px solid var(--border); 
        }
        .action-btn { 
            flex: 1; 
            padding: 8px; 
            background: var(--sub); 
            color: var(--dim); 
            border: none; 
            border-radius: 8px; 
            font-size: 12px; 
            font-weight: 500; 
            cursor: pointer; 
            transition: all 0.2s; 
        }
        .action-btn:hover { 
            background: var(--border); 
        }
        .action-btn.danger { 
            color: var(--danger); 
        }
        
        /* Tag Display */
        .tags { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 6px; 
            margin-top: 8px; 
        }
        .tag { 
            padding: 4px 10px; 
            background: var(--sub); 
            border-radius: 12px; 
            font-size: 11px; 
            color: var(--accent); 
        }
        
        /* Bulk Mode */
        .bulk-toolbar { 
            position: fixed; 
            bottom: 70px; 
            left: 0; 
            right: 0; 
            background: var(--card); 
            border-top: 1px solid var(--border); 
            padding: 12px 16px; 
            display: none; 
            z-index: 25; 
        }
        .bulk-toolbar.active { 
            display: flex; 
            gap: 8px; 
            align-items: center; 
            justify-content: space-between; 
        }
        
        /* Checkbox */
        .checkbox { 
            width: 20px; 
            height: 20px; 
            border: 2px solid var(--border); 
            border-radius: 4px; 
            margin-right: 12px; 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
        }
        .checkbox.checked { 
            background: var(--accent); 
            border-color: var(--accent); 
        }
        .checkbox.checked::after { 
            content: 'âœ“'; 
            color: white; 
            font-size: 14px; 
            font-weight: bold; 
        }
        
        /* Sort Dropdown */
        .sort-bar { 
            display: flex; 
            gap: 8px; 
            margin-bottom: 16px; 
            align-items: center; 
        }
        .sort-select { 
            flex: 1; 
            padding: 10px; 
            background: var(--sub); 
            border: 1px solid var(--border); 
            border-radius: 8px; 
            color: var(--text); 
            font-size: 13px; 
        }
        
        /* ===== END SYSTEM TAB ENHANCEMENTS CSS ===== */

        /* ===== ZEN PHILOSOPHY - REFLECT Â· JOURNAL Â· REVIEWS ===== */
        @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;1,300;1,400&family=IM+Fell+English:ital@0;1&display=swap');

        :root {
            --zen-ink: #1a1814;
            --zen-rice: #f5f0e8;
            --zen-stone: #8a8070;
            --zen-ash: #3a3530;
            --zen-moss: #4a5240;
            --zen-rust: #7a4030;
            --zen-mist: rgba(245, 240, 232, 0.06);
            --zen-border: rgba(245, 240, 232, 0.12);
            --zen-glow: rgba(245, 240, 232, 0.04);
            --zen-font: 'Cormorant Garamond', 'Georgia', serif;
            --zen-title-font: 'IM Fell English', 'Georgia', serif;
        }

        /* === ZEN WRAPPER === */
        .zen-container {
            padding: 4px 0 40px;
        }

        /* === ZEN HEADER SECTION === */
        .zen-header {
            text-align: center;
            padding: 28px 0 24px;
            position: relative;
        }
        .zen-header::before {
            content: '';
            display: block;
            width: 1px;
            height: 32px;
            background: linear-gradient(to bottom, transparent, var(--zen-border));
            margin: 0 auto 20px;
        }
        .zen-header-kanji {
            font-size: 11px;
            letter-spacing: 6px;
            color: var(--zen-stone);
            text-transform: uppercase;
            margin-bottom: 8px;
            font-family: var(--font);
            opacity: 0.7;
        }
        .zen-header-title {
            font-family: var(--zen-title-font);
            font-size: 28px;
            font-weight: 400;
            color: rgba(245,240,232,0.9);
            letter-spacing: 1px;
            margin-bottom: 6px;
            font-style: italic;
        }
        .zen-header-subtitle {
            font-family: var(--zen-font);
            font-size: 13px;
            color: var(--zen-stone);
            font-style: italic;
            letter-spacing: 0.5px;
        }
        .zen-header::after {
            content: 'â€” â—‹ â€”';
            display: block;
            margin-top: 18px;
            color: var(--zen-stone);
            font-size: 11px;
            letter-spacing: 8px;
            opacity: 0.5;
        }

        /* === ZEN SEGMENT SWITCHER (Morning/Evening) === */
        .zen-segment {
            display: flex;
            background: var(--zen-mist);
            border: 1px solid var(--zen-border);
            border-radius: 3px;
            padding: 3px;
            margin-bottom: 24px;
            gap: 3px;
        }
        .zen-seg-btn {
            flex: 1;
            padding: 9px 12px;
            background: transparent;
            border: none;
            color: var(--zen-stone);
            font-family: var(--zen-font);
            font-size: 14px;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 2px;
            text-transform: uppercase;
        }
        .zen-seg-btn:hover {
            color: rgba(245,240,232,0.7);
            background: var(--zen-glow);
        }
        .zen-seg-btn.active {
            background: var(--zen-ash);
            color: rgba(245,240,232,0.9);
        }
        .zen-seg-btn.morning.active {
            background: linear-gradient(135deg, rgba(120,90,60,0.4), rgba(80,60,40,0.4));
            border: 1px solid rgba(200,160,100,0.2);
            color: rgba(220,190,140,0.9);
        }
        .zen-seg-btn.evening.active {
            background: linear-gradient(135deg, rgba(40,50,80,0.5), rgba(30,35,60,0.5));
            border: 1px solid rgba(100,120,180,0.2);
            color: rgba(160,180,220,0.9);
        }

        /* === ZEN ACTION ROW === */
        .zen-action-row {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: stretch;
        }
        .zen-primary-btn {
            flex: 1;
            padding: 13px 16px;
            background: transparent;
            border: 1px solid var(--zen-border);
            border-radius: 2px;
            color: rgba(245,240,232,0.8);
            font-family: var(--zen-font);
            font-size: 15px;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .zen-primary-btn::before {
            content: '';
            position: absolute;
            inset: 0;
            background: var(--zen-mist);
            opacity: 0;
            transition: opacity 0.3s;
        }
        .zen-primary-btn:hover::before { opacity: 1; }
        .zen-primary-btn:hover {
            border-color: rgba(245,240,232,0.25);
            color: rgba(245,240,232,0.95);
        }
        .zen-icon-btn {
            width: 44px;
            padding: 0;
            background: transparent;
            border: 1px solid var(--zen-border);
            border-radius: 2px;
            color: var(--zen-stone);
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .zen-icon-btn:hover {
            border-color: rgba(245,240,232,0.2);
            color: rgba(245,240,232,0.7);
            background: var(--zen-mist);
        }

        /* === ZEN UTILITY ROW === */
        .zen-utility-row {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }
        .zen-util-btn {
            flex: 1;
            padding: 8px;
            background: transparent;
            border: 1px solid var(--zen-border);
            border-radius: 2px;
            color: var(--zen-stone);
            font-family: var(--font);
            font-size: 11px;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s;
        }
        .zen-util-btn:hover {
            color: rgba(245,240,232,0.7);
            border-color: rgba(245,240,232,0.2);
            background: var(--zen-mist);
        }
        .zen-util-btn.active {
            color: rgba(245,240,232,0.8);
            border-color: rgba(245,240,232,0.3);
            background: var(--zen-ash);
        }

        /* === ZEN SEARCH === */
        .zen-search-wrap {
            position: relative;
            margin-bottom: 20px;
        }
        .zen-search {
            width: 100%;
            padding: 11px 40px 11px 14px;
            background: transparent;
            border: 1px solid var(--zen-border);
            border-radius: 2px;
            color: rgba(245,240,232,0.8);
            font-family: var(--zen-font);
            font-size: 14px;
            letter-spacing: 0.5px;
            transition: border-color 0.3s;
        }
        .zen-search:focus {
            outline: none;
            border-color: rgba(245,240,232,0.25);
        }
        .zen-search::placeholder { color: var(--zen-stone); font-style: italic; }
        .zen-search-clear {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--zen-stone);
            cursor: pointer;
            font-size: 18px;
            line-height: 1;
            transition: color 0.2s;
        }
        .zen-search-clear:hover { color: rgba(245,240,232,0.7); }

        /* === ZEN SORT === */
        .zen-sort-row {
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .zen-sort-label {
            font-family: var(--font);
            font-size: 10px;
            letter-spacing: 2px;
            color: var(--zen-stone);
            text-transform: uppercase;
            white-space: nowrap;
            opacity: 0.7;
        }
        .zen-sort-select {
            flex: 1;
            padding: 8px 12px;
            background: transparent;
            border: 1px solid var(--zen-border);
            border-radius: 2px;
            color: var(--zen-stone);
            font-family: var(--font);
            font-size: 12px;
        }
        .zen-sort-select:focus { outline: none; border-color: rgba(245,240,232,0.2); }
        .zen-sort-select option { background: #1c1c1e; }

        /* === ZEN CARD === */
        .zen-card {
            background: transparent;
            border: 1px solid var(--zen-border);
            border-radius: 3px;
            padding: 22px 20px;
            margin-bottom: 16px;
            position: relative;
            transition: all 0.4s ease;
            overflow: hidden;
        }
        .zen-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(to bottom, transparent, var(--zen-stone), transparent);
            opacity: 0;
            transition: opacity 0.4s;
        }
        .zen-card:hover {
            background: var(--zen-glow);
            border-color: rgba(245,240,232,0.18);
        }
        .zen-card:hover::before { opacity: 0.6; }

        .zen-card-morning { }
        .zen-card-morning::before {
            background: linear-gradient(to bottom, transparent, rgba(200,160,100,0.5), transparent);
        }
        .zen-card-evening::before {
            background: linear-gradient(to bottom, transparent, rgba(120,140,200,0.5), transparent);
        }

        /* === ZEN DATE BADGE === */
        .zen-date {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 14px;
        }
        .zen-date-line {
            flex: 1;
            height: 1px;
            background: var(--zen-border);
        }
        .zen-date-text {
            font-family: var(--font);
            font-size: 10px;
            color: var(--zen-stone);
            letter-spacing: 3px;
            text-transform: uppercase;
            white-space: nowrap;
        }

        /* === ZEN BODY TEXT === */
        .zen-body {
            font-family: var(--zen-font);
            font-size: 16px;
            line-height: 1.85;
            color: rgba(245,240,232,0.82);
            white-space: pre-wrap;
            font-weight: 300;
        }

        /* === ZEN TAGS === */
        .zen-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 16px;
        }
        .zen-tag {
            padding: 3px 10px;
            border: 1px solid var(--zen-border);
            border-radius: 1px;
            font-family: var(--font);
            font-size: 10px;
            letter-spacing: 1.5px;
            color: var(--zen-stone);
            text-transform: uppercase;
        }

        /* === ZEN EDIT MARK === */
        .zen-edited {
            font-family: var(--font);
            font-size: 10px;
            color: var(--zen-stone);
            margin-top: 12px;
            letter-spacing: 1px;
            font-style: italic;
            opacity: 0.6;
        }

        /* === ZEN CARD ACTIONS === */
        .zen-card-actions {
            display: flex;
            gap: 4px;
            margin-top: 16px;
            padding-top: 14px;
            border-top: 1px solid var(--zen-border);
            opacity: 0;
            transition: opacity 0.3s;
        }
        .zen-card:hover .zen-card-actions { opacity: 1; }
        .zen-act-btn {
            flex: 1;
            padding: 7px 4px;
            background: transparent;
            border: 1px solid transparent;
            border-radius: 2px;
            color: var(--zen-stone);
            font-family: var(--font);
            font-size: 10px;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s;
        }
        .zen-act-btn:hover {
            border-color: var(--zen-border);
            color: rgba(245,240,232,0.7);
            background: var(--zen-mist);
        }
        .zen-act-btn.danger:hover {
            border-color: rgba(200,80,60,0.3);
            color: rgba(200,100,80,0.9);
        }

        /* === ZEN REVIEW SECTIONS === */
        .zen-review-section {
            margin-bottom: 18px;
        }
        .zen-review-label {
            font-family: var(--font);
            font-size: 10px;
            letter-spacing: 4px;
            text-transform: uppercase;
            color: var(--zen-stone);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .zen-review-label::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--zen-border);
        }

        /* === ZEN EMPTY STATE === */
        .zen-empty {
            text-align: center;
            padding: 60px 20px;
            position: relative;
        }
        .zen-empty-symbol {
            font-size: 32px;
            margin-bottom: 20px;
            opacity: 0.3;
            display: block;
        }
        .zen-empty-text {
            font-family: var(--zen-title-font);
            font-size: 18px;
            color: var(--zen-stone);
            font-style: italic;
            letter-spacing: 1px;
            display: block;
            margin-bottom: 8px;
        }
        .zen-empty-sub {
            font-family: var(--font);
            font-size: 11px;
            color: var(--zen-stone);
            letter-spacing: 2px;
            text-transform: uppercase;
            opacity: 0.5;
        }

        /* === ZEN DIVIDER === */
        .zen-divider {
            display: flex;
            align-items: center;
            gap: 16px;
            margin: 24px 0;
            opacity: 0.4;
        }
        .zen-divider::before, .zen-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--zen-border);
        }
        .zen-divider-mark {
            font-size: 10px;
            color: var(--zen-stone);
            letter-spacing: 4px;
        }

        /* === ZEN CHECKBOX === */
        .zen-checkbox {
            width: 18px;
            height: 18px;
            border: 1px solid var(--zen-border);
            border-radius: 1px;
            margin-right: 12px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
            transition: all 0.2s;
        }
        .zen-checkbox.checked {
            background: var(--zen-stone);
            border-color: var(--zen-stone);
        }
        .zen-checkbox.checked::after {
            content: 'âœ“';
            color: var(--void);
            font-size: 12px;
        }

        /* Fade-in animation for zen cards */
        @keyframes zenFade {
            from { opacity: 0; transform: translateY(8px); }
            to   { opacity: 1; transform: translateY(0); }
        }
        .zen-card {
            animation: zenFade 0.4s ease forwards;
        }
        .zen-card:nth-child(1) { animation-delay: 0.05s; }
        .zen-card:nth-child(2) { animation-delay: 0.10s; }
        .zen-card:nth-child(3) { animation-delay: 0.15s; }
        .zen-card:nth-child(4) { animation-delay: 0.20s; }
        .zen-card:nth-child(5) { animation-delay: 0.25s; }

        /* ===== END ZEN PHILOSOPHY CSS ===== */
    </style>
</head>
<body>

<!-- WELCOME MODAL - Shows on first load (2-step: Profile â†’ Blueprint) -->
<div id="welcome-overlay" class="welcome-overlay" style="display: none;">
    <div class="welcome-modal">

        <!-- â”€â”€ STEP 1: Profile Setup â”€â”€ -->
        <div id="welcome-step-1">
            <div class="welcome-logo" id="welcome-avatar-preview">SVK</div>
            <div class="welcome-version">SVK Blueprint v2.3.0</div>
            <h1 class="welcome-title">Let's personalize your system</h1>
            <p class="welcome-subtitle">This system is built around <em>you</em>. Start by telling us your name and your 15-year vision â€” the north star that every task, habit, and cycle will serve.</p>

            <!-- Name -->
            <div style="text-align:left;margin-bottom:12px;">
                <label style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--dim);display:block;margin-bottom:6px;">Your Name *</label>
                <input type="text" id="welcome-name" placeholder="e.g. Sathvik, Alex, Mayaâ€¦"
                    style="font-size:16px;"
                    oninput="App._welcomePreviewAvatar()"
                    maxlength="40">
            </div>

            <!-- Tagline -->
            <div style="text-align:left;margin-bottom:12px;">
                <label style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--dim);display:block;margin-bottom:6px;">One-Line Identity <span style="font-weight:400;opacity:0.5;">(optional)</span></label>
                <input type="text" id="welcome-tagline" placeholder="e.g. Builder Â· Father Â· Lifelong Learner"
                    style="font-size:14px;"
                    maxlength="80">
            </div>

            <!-- Vision -->
            <div style="text-align:left;margin-bottom:20px;">
                <label style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--dim);display:block;margin-bottom:6px;">Your 15-Year Vision *</label>
                <div style="font-size:11px;color:var(--dim);margin-bottom:8px;line-height:1.5;">
                    Your definite chief aim. The life you are building. Be ambitious, be specific.
                </div>
                <textarea id="welcome-vision" rows="4" maxlength="2000"
                    placeholder="In 15 years, I will have builtâ€¦&#10;&#10;I will achieve this byâ€¦&#10;&#10;My legacy will beâ€¦"
                    style="font-size:13px;line-height:1.6;resize:vertical;min-height:100px;"></textarea>
            </div>

            <button class="btn" onclick="App._welcomeStep1Next()" style="margin-bottom:12px;font-size:15px;">
                Continue â†’ Choose Your Blueprint
            </button>
            <button onclick="App._welcomeSkipProfile()" 
                style="background:none;border:none;color:var(--dim);font-size:12px;cursor:pointer;width:100%;">
                Skip for now (you can set this up later from the header)
            </button>
        </div>

        <!-- â”€â”€ STEP 2: Blueprint Choice â”€â”€ -->
        <div id="welcome-step-2" style="display:none;">
            <div class="welcome-logo" id="welcome-step2-avatar" style="font-size:28px;">SVK</div>
            <div class="welcome-version">SVK Blueprint v2.3.0</div>
            <h1 class="welcome-title" id="welcome-step2-title">Welcome! Now set up your blueprint</h1>
            <p class="welcome-subtitle">Your profile is saved. Now link it to a 15-year execution blueprint â€” the engine that turns your vision into daily action.</p>
            
            <div class="welcome-options">
                <div class="welcome-option-btn primary" onclick="App.chooseCreateCustom()">
                    <span class="welcome-option-icon">âœ¨</span>
                    <div class="welcome-option-title">Create Your Custom Blueprint</div>
                    <div class="welcome-option-desc">Answer 12 questions and let AI generate your personalized 15-year plan with 60 cycles. Includes 10 streamlined capture types for daily use.</div>
                    <span class="welcome-option-badge">RECOMMENDED</span>
                </div>
                
                <div class="welcome-option-btn" onclick="App.chooseImport()">
                    <span class="welcome-option-icon">ðŸ“¥</span>
                    <div class="welcome-option-title">Import Existing Blueprint</div>
                    <div class="welcome-option-desc">Already have a blueprint JSON file? Import it to start immediately with enhanced universal search.</div>
                </div>

                <div class="welcome-option-btn" onclick="App._welcomeSkipBlueprint()">
                    <span class="welcome-option-icon">âš¡</span>
                    <div class="welcome-option-title">Start Without a Blueprint</div>
                    <div class="welcome-option-desc">Explore the app and add quick tasks, habits, notes, and vault items now. Set up the blueprint later from the SYSTEM tab.</div>
                </div>
            </div>
        </div>

    </div>
</div>

<header class="header">
    <button class="profile-avatar-btn" id="profile-avatar-btn" onclick="App.openEditProfile()" title="Edit your profile">
        <span id="profile-avatar-display">SVK</span>
    </button>
    <div class="header-center">
        <div class="header-user-name" id="header-user-name"></div>
        <div class="header-user-tagline" id="header-user-tagline"></div>
    </div>
    <div class="header-right">
        <button class="header-icon-btn" onclick="App.openReadme()" title="README â€” What this app is &amp; version history">
            <svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
                <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
            </svg>
        </button>
        <button class="header-icon-btn" onclick="App.openUserManual()" title="User Flow â€” How to use this app">
            <svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10"/>
                <path d="M12 16v-4"/>
                <path d="M12 8h.01"/>
            </svg>
        </button>
        <button class="header-icon-btn" onclick="App.openUniversalSearch()" title="Universal Search">
            <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2.5">
                <circle cx="8" cy="8" r="6"/>
                <path d="M12.5 12.5L16 16"/>
            </svg>
        </button>
        <div class="timer-badge" id="timer-badge">00:00</div>
        <div class="cycle-badge" id="cycle-indicator">NO CYCLE</div>
    </div>
</header>

<main id="app" class="content"></main>

<button class="fab" onclick="App.openCapture()">
    <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="3"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
</button>

<nav class="nav">
    <button class="nav-btn active" onclick="App.navigate(0)">
        <svg class="nav-icon" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="9"/><polyline points="12 6.5 12 12 15.5 14"/></svg>EXECUTE</button>
    <button class="nav-btn" onclick="App.navigate(1)">
        <svg class="nav-icon" fill="none" stroke="currentColor"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>BUILD</button>
    <button class="nav-btn" onclick="App.navigate(2)">
        <svg class="nav-icon" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="9"/><line x1="3" y1="12" x2="21" y2="12"/><path d="M12 3a15 15 0 0 1 4 9 15 15 0 0 1-4 9 15 15 0 0 1-4-9 15 15 0 0 1 4-9z"/></svg>STRATEGY</button>
    <button class="nav-btn" onclick="App.navigate(3)">
        <svg class="nav-icon" fill="none" stroke="currentColor"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>SYSTEM</button>
    <button class="nav-btn" onclick="App.navigate(4)">
        <svg class="nav-icon" fill="none" stroke="currentColor"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg>VAULT</button>
</nav>

<div id="modal" class="modal" onclick="if(event.target===this)App.closeModal()">
    <div class="modal-sheet">
        <div class="modal-handle"></div>
        <div id="modal-body"></div>
    </div>
</div>

<div class="habit-timer-overlay" id="habit-timer-overlay">
    <div class="habit-timer-content" id="habit-timer-content"></div>
</div>

<!-- NEW: Zen Mode Timer Overlay -->
<div class="zen-timer-overlay" id="zen-timer-overlay">
    <div class="zen-timer-content" id="zen-timer-content"></div>
</div>

<div id="toast" class="toast"></div>

<!-- Custom Confirm Dialog (replaces window.confirm for PWA compatibility) -->
<div id="confirm-overlay" style="
    display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);
    z-index:200;align-items:center;justify-content:center;padding:20px;">
    <div style="
        background:var(--card);border-radius:16px;padding:24px;
        max-width:320px;width:100%;border:1px solid var(--border);
        box-shadow:0 20px 60px rgba(0,0,0,0.5);">
        <div id="confirm-message" style="
            font-size:15px;color:var(--text);margin-bottom:20px;
            line-height:1.5;text-align:center;"></div>
        <div style="display:flex;gap:10px;">
            <button id="confirm-cancel-btn" style="
                flex:1;padding:12px;background:var(--sub);color:var(--dim);
                border:1px solid var(--border);border-radius:10px;
                font-size:14px;font-weight:600;cursor:pointer;">Cancel</button>
            <button id="confirm-ok-btn" style="
                flex:1;padding:12px;background:var(--danger);color:#fff;
                border:none;border-radius:10px;
                font-size:14px;font-weight:600;cursor:pointer;">Delete</button>
        </div>
    </div>
</div>
<div class="bulk-toolbar" id="bulk-toolbar"></div>

<!-- NEW: Offline Indicator -->
<div class="offline-badge" id="offline-badge">
    <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M1 1L13 13M8 1C11.866 1 15 4.134 15 8M4 1C0.134 1 -3 4.134 -3 8"/>
    </svg>
    Offline Mode
</div>

<!-- NEW: Backup Reminder Banner -->
<div class="backup-reminder" id="backup-reminder">
    <span>âš ï¸ You haven't backed up your data in 7+ days</span>
    <button onclick="App.exportAllData()">Backup Now</button>
    <button onclick="App.dismissBackupReminder()" style="background:transparent;color:var(--void);">Dismiss</button>
</div>

<!-- NEW: Undo Toast -->
<div class="undo-toast" id="undo-toast">
    <span id="undo-message">Item deleted</span>
    <button onclick="App.performUndo()">Undo</button>
</div>

<!-- NEW: Update Available Banner -->
<div class="update-banner" id="update-banner" style="display:none;">
    <div style="flex:1;">
        <strong id="update-banner-title">ðŸŽ‰ New version available!</strong>
        <div style="font-size:11px;margin-top:4px;" id="update-banner-text">Update to get the latest features and improvements</div>
    </div>
    <button id="update-reload-btn" onclick="App.applyUpdate()" style="background:var(--accent);color:#000;border:none;padding:8px 16px;border-radius:6px;font-weight:700;font-size:12px;cursor:pointer;display:none;">Reload Now</button>
    <button onclick="App.showUpdateInstructions()" style="background:var(--sub);color:var(--text);border:1px solid var(--border);padding:8px 14px;border-radius:6px;font-weight:600;font-size:12px;cursor:pointer;margin-left:6px;">Details</button>
    <button onclick="App.dismissUpdateBanner()" style="background:transparent;color:var(--text);border:none;padding:8px;cursor:pointer;opacity:0.6;">âœ•</button>
</div>

<div class="celebrate-overlay" id="celebrate">
    <div class="celebrate-emoji" id="celebrate-emoji">ðŸŽ‰</div>
    <div class="celebrate-title" id="celebrate-title">Great Work!</div>
    <div class="celebrate-sub" id="celebrate-sub">Keep going.</div>
    <button class="celebrate-close" onclick="App.closeCelebrate()">Continue</button>
</div>

<script>
const DB_KEY = 'svk_blueprint_15year';
const APP_VERSION = '2.3.0'; // Current app version - update this with each release
const SCHEMA = {
    blueprintMeta: null,
    allCycles: [],
    currentCycle: null,
    cycleHistory: [],
    tasks: { quick: [], scheduled: [], delegated: [] },
    system: { habits: [], reflections: { morning: [], evening: [] }, journal: [], reviews: [], labs: { experiments: [], newFailures: [], repeatedFailures: [] } },
    vault: { 
        learnings: { notes: [], quotes: [], bookSummaries: [], mindmaps: [] },
        growth: { books: [], courses: [], skills: [], mentors: [] },
        resources: { ideas: [], contacts: [], incomeStreams: [], assets: [] },
        reflections: { morning: [], evening: [] }, 
        journal: { morning: [], evening: [] } 
    },
    plan: { affirmations: [], bucketList: [] },
    goals: [],
    timeblocks: [],
    completed: [],
    userProfile: { name: '', vision: '', avatar: '', tagline: '', timezone: '' }
};

const esc = s => {
    if (s === null || s === undefined) return '';
    if (typeof s !== 'string') s = String(s);
    return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
};

const App = {
    data: null,
    tab: 0,
    sub: {},
    
    // Custom Blueprint Generator state
    customBlueprintData: {},
    customPrompt: null,
    
    // Search state
    journalSearch: '',
    reflectionSearch: '',
    noteSearch: '',
    quoteSearch: '',
    
    // SYSTEM Tab Enhancement - Sorting states
    systemSort: { reflections: 'date-desc', journal: 'date-desc', reviews: 'date-desc' },
    
    // SYSTEM Tab Enhancement - Bulk mode states
    bulkMode: { reflections: false, journal: false, reviews: false },
    selectedItems: { reflections: new Set(), journal: new Set(), reviews: new Set() },
    
    // NEW: Undo/Redo system
    undoStack: [],
    redoStack: [],
    maxUndoSteps: 20,
    
    // NEW: Backup reminder system
    lastBackupReminder: null,
    backupReminderInterval: 7 * 24 * 60 * 60 * 1000, // 7 days in milliseconds
    
    // NEW: Performance - Lazy loading flags
    tabsLoaded: { execute: false, build: false, strategy: false, system: false, vault: false },
    
    // NEW: Online/Offline status
    isOnline: true,
    
    habitTimer: {
        habitId: null,
        startTime: null,
        duration: 0,
        interval: null,
        isPaused: false
    },
    
    // NEW: Zen Mode Timer state
    zenMode: {
        active: false,
        habitId: null,
        taskId: null,
        intention: '',
        currentStepIndex: 0,
        startTime: null,
        duration: 0,
        targetDuration: 0,
        interval: null,
        isPaused: false,
        steps: []
    },

    timer: {
        running: false,
        seconds: 1500, // 25 minutes
        maxSeconds: 1500,
        interval: null,
        phase: 'work', // work, shortBreak, longBreak
        
        show() {
            const modal = document.getElementById('modal');
            const body = document.getElementById('modal-body');
            
            body.innerHTML = `
                <h3 style="margin-bottom:20px;color:var(--accent);text-align:center;">Focus Timer</h3>
                
                <div style="position:relative;width:200px;height:200px;margin:20px auto;">
                    <svg style="position:absolute;top:0;left:0;width:100%;height:100%;transform:rotate(-90deg);" viewBox="0 0 200 200">
                        <circle cx="100" cy="100" r="90" fill="none" stroke="var(--sub)" stroke-width="8"/>
                        <circle id="timer-progress" cx="100" cy="100" r="90" fill="none" stroke="var(--success)" 
                                stroke-width="8" stroke-linecap="round" stroke-dasharray="565.48" stroke-dashoffset="0"
                                style="transition:stroke-dashoffset 1s linear;"/>
                    </svg>
                    <div id="timer-display" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
                         font-family:monospace;font-size:36px;font-weight:700;">25:00</div>
                </div>
                
                <div style="text-align:center;margin-bottom:20px;">
                    <div id="timer-phase" style="color:var(--dim);font-size:13px;">Work Phase - Stay Focused</div>
                </div>
                
                <div style="display:flex;gap:8px;justify-content:center;flex-wrap:wrap;">
                    <button class="btn-sec btn-success" id="timer-start" onclick="App.timer.start()">Start</button>
                    <button class="btn-sec" id="timer-pause" onclick="App.timer.pause()" style="display:none;">Pause</button>
                    <button class="btn-sec" onclick="App.timer.reset()">Reset</button>
                    <button class="btn-sec btn-danger" onclick="App.timer.skip()">Skip</button>
                </div>
                
                <div style="text-align:center;margin-top:16px;font-size:11px;color:var(--dim);">
                    Work: 25 min | Short Break: 5 min | Long Break: 15 min
                </div>
            `;
            
            modal.classList.add('open');
            this.updateDisplay();
        },
        
        start() {
            if (this.running) return;
            
            this.running = true;
            document.getElementById('timer-start').style.display = 'none';
            document.getElementById('timer-pause').style.display = 'block';
            
            this.interval = setInterval(() => {
                if (this.seconds > 0) {
                    this.seconds--;
                    this.updateDisplay();
                } else {
                    this.complete();
                }
            }, 1000);
        },
        
        pause() {
            this.running = false;
            document.getElementById('timer-start').style.display = 'block';
            document.getElementById('timer-pause').style.display = 'none';
            
            if (this.interval) {
                clearInterval(this.interval);
                this.interval = null;
            }
        },
        
        reset() {
            this.pause();
            this.seconds = this.maxSeconds;
            this.updateDisplay();
        },
        
        skip() {
            this.seconds = 0;
            this.complete();
        },
        
        complete() {
            this.pause();
            
            // Play sound
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.frequency.value = 800;
                osc.type = 'sine';
                gain.gain.value = 0.3;
                osc.start();
                osc.stop(ctx.currentTime + 0.2);
            } catch(e) {}
            
            const phaseComplete = this.phase === 'work' ? 'Work session' : 'Break';
            App.toast(`âœ“ ${phaseComplete} complete!`);
            
            // Switch phases
            if (this.phase === 'work') {
                this.phase = 'shortBreak';
                this.maxSeconds = 300; // 5 min
            } else {
                this.phase = 'work';
                this.maxSeconds = 1500; // 25 min
            }
            
            this.seconds = this.maxSeconds;
            this.updateDisplay();
        },
        
        updateDisplay() {
            const mins = Math.floor(this.seconds / 60);
            const secs = this.seconds % 60;
            const display = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            
            const timerDisplay = document.getElementById('timer-display');
            const phaseLabel = document.getElementById('timer-phase');
            const progress = document.getElementById('timer-progress');
            
            if (timerDisplay) timerDisplay.textContent = display;
            
            if (phaseLabel) {
                const labels = {
                    'work': 'Work Phase - Stay Focused',
                    'shortBreak': 'Short Break - Rest & Recharge',
                    'longBreak': 'Long Break - Deep Rest'
                };
                phaseLabel.textContent = labels[this.phase];
            }
            
            if (progress) {
                const percentage = this.seconds / this.maxSeconds;
                const circumference = 565.48;
                const offset = circumference * (1 - percentage);
                progress.style.strokeDashoffset = offset;
                progress.style.stroke = this.phase === 'work' ? 'var(--success)' : 'var(--blue)';
            }
        }
    },

    init() {
        // ERROR BOUNDARY: Wrap entire initialization in try-catch
        try {
            const saved = localStorage.getItem(DB_KEY);
            const hasSeenWelcome = localStorage.getItem('svkWelcomeSeen');
            
            if (saved) {
                try { 
                    this.data = JSON.parse(saved);
                    // Validate data structure
                    if (!this.data || typeof this.data !== 'object') {
                        throw new Error('Invalid data structure');
                    }
                    // SYSTEM Tab Enhancement - Ensure IDs on all items for backward compatibility
                    this.ensureIds(this.data);
                }
                catch(e) { 
                    console.error('Data parse error:', e);
                    // Backup corrupted data
                    const corrupted = localStorage.getItem(DB_KEY);
                    if (corrupted) {
                        localStorage.setItem('svk_corrupted_backup_' + Date.now(), corrupted);
                    }
                    this.data = JSON.parse(JSON.stringify(SCHEMA));
                    this.toast('âš ï¸ Data restored from backup');
                }
            } else {
                this.data = JSON.parse(JSON.stringify(SCHEMA));
            }
        
        // BUG FIX: Ensure ALL data structures exist, including vault sub-properties
        if (!this.data.blueprintMeta) this.data.blueprintMeta = null;
        if (!this.data.allCycles) this.data.allCycles = [];
        if (!this.data.cycleHistory) this.data.cycleHistory = [];
        if (!this.data.tasks) this.data.tasks = { quick: [], scheduled: [], delegated: [] };
        if (!this.data.tasks.quick) this.data.tasks.quick = [];
        if (!this.data.system) this.data.system = { habits: [], reflections: { morning: [], evening: [] }, journal: [], reviews: [] };
        if (!this.data.system.habits) this.data.system.habits = [];
        if (!this.data.system.reflections) this.data.system.reflections = { morning: [], evening: [] };
        if (!this.data.system.journal) this.data.system.journal = [];
        if (!this.data.vault) this.data.vault = { learnings: {}, growth: {}, resources: {} };
        
        // Initialize learnings sub-properties
        if (!this.data.vault.learnings) this.data.vault.learnings = {};
        if (!this.data.vault.learnings.notes) this.data.vault.learnings.notes = [];
        if (!this.data.vault.learnings.quotes) this.data.vault.learnings.quotes = [];
        if (!this.data.vault.learnings.bookSummaries) this.data.vault.learnings.bookSummaries = [];
        if (!this.data.vault.learnings.mindmaps) this.data.vault.learnings.mindmaps = [];
        
        // BUG FIX: Initialize growth sub-properties (was missing)
        if (!this.data.vault.growth) this.data.vault.growth = {};
        if (!this.data.vault.growth.books) this.data.vault.growth.books = [];
        if (!this.data.vault.growth.courses) this.data.vault.growth.courses = [];
        if (!this.data.vault.growth.skills) this.data.vault.growth.skills = [];
        if (!this.data.vault.growth.mentors) this.data.vault.growth.mentors = [];
        
        // BUG FIX: Initialize resources sub-properties (was missing)
        if (!this.data.vault.resources) this.data.vault.resources = {};
        if (!this.data.vault.resources.ideas) this.data.vault.resources.ideas = [];
        if (!this.data.vault.resources.contacts) this.data.vault.resources.contacts = [];
        if (!this.data.vault.resources.incomeStreams) this.data.vault.resources.incomeStreams = [];
        if (!this.data.vault.resources.assets) this.data.vault.resources.assets = [];
        
        // Enhanced Vault LEARN/EARN structures
        if (!this.data.vaultLearn) this.data.vaultLearn = { ideas: [], notes: [], books: [], skills: [] };
        if (!this.data.vaultLearn.ideas) this.data.vaultLearn.ideas = [];
        if (!this.data.vaultLearn.notes) this.data.vaultLearn.notes = [];
        if (!this.data.vaultLearn.books) this.data.vaultLearn.books = [];
        if (!this.data.vaultLearn.skills) this.data.vaultLearn.skills = [];
        
        if (!this.data.vaultEarn) this.data.vaultEarn = { strat: [], exec: [], leverage: [], contacts: [] };
        if (!this.data.vaultEarn.strat) this.data.vaultEarn.strat = [];
        if (!this.data.vaultEarn.exec) this.data.vaultEarn.exec = [];
        if (!this.data.vaultEarn.leverage) this.data.vaultEarn.leverage = [];
        if (!this.data.vaultEarn.contacts) this.data.vaultEarn.contacts = [];
        
        // Vault metadata and settings
        if (!this.data.vaultPromotions) this.data.vaultPromotions = [];
        if (!this.data.vaultSettings) this.data.vaultSettings = {
            viewMode: 'card',
            sortBy: 'recent',
            showAnalytics: false,
            searchQuery: '',
            activeFilters: [],
            selectedTags: [],
            dateRange: { start: null, end: null },
            importanceFilter: [],
            starredOnly: false,
            pinnedOnly: false,
            batchMode: false,
            selectedItems: [],
            categoryColors: {},
            showFilters: false
        };
        
        // Ensure enhanced settings exist for existing users
        if (!this.data.vaultSettings.selectedTags) this.data.vaultSettings.selectedTags = [];
        if (!this.data.vaultSettings.dateRange) this.data.vaultSettings.dateRange = { start: null, end: null };
        if (!this.data.vaultSettings.importanceFilter) this.data.vaultSettings.importanceFilter = [];
        if (this.data.vaultSettings.starredOnly === undefined) this.data.vaultSettings.starredOnly = false;
        if (this.data.vaultSettings.pinnedOnly === undefined) this.data.vaultSettings.pinnedOnly = false;
        if (this.data.vaultSettings.batchMode === undefined) this.data.vaultSettings.batchMode = false;
        if (!this.data.vaultSettings.selectedItems) this.data.vaultSettings.selectedItems = [];
        if (!this.data.vaultSettings.categoryColors) this.data.vaultSettings.categoryColors = {};
        if (this.data.vaultSettings.showFilters === undefined) this.data.vaultSettings.showFilters = false;
        
        if (!this.data.plan) this.data.plan = { affirmations: [], bucketList: [] };
        if (!this.data.goals) this.data.goals = [];
        if (!this.data.timeblocks) this.data.timeblocks = [];
        if (!this.data.userProfile) this.data.userProfile = { name: '', vision: '', avatar: '', tagline: '', timezone: '' };
        if (!this.data.userProfile.name)     this.data.userProfile.name     = '';
        if (!this.data.userProfile.vision)   this.data.userProfile.vision   = '';
        if (!this.data.userProfile.avatar)   this.data.userProfile.avatar   = '';
        if (!this.data.userProfile.tagline)  this.data.userProfile.tagline  = '';
        if (!this.data.userProfile.timezone) this.data.userProfile.timezone = '';
        // Migrate: if blueprintMeta exists but userProfile is empty, seed profile from blueprint
        if (this.data.blueprintMeta && !this.data.userProfile.name && this.data.blueprintMeta.name) {
            this.data.userProfile.name = this.data.blueprintMeta.name;
        }
        if (this.data.blueprintMeta && !this.data.userProfile.vision && this.data.blueprintMeta.vision) {
            this.data.userProfile.vision = this.data.blueprintMeta.vision;
        }
        
        // PRODUCTION: Validate data integrity
        this.validateAndFixData();
        
        // VERSION CHECKING: Check for updates
        this.checkForUpdates();
        
        // Load custom blueprint data
        try {
            const storedCustom = localStorage.getItem('svkCustomBlueprintData');
            if (storedCustom) {
                this.customBlueprintData = JSON.parse(storedCustom);
            } else {
                this.customBlueprintData = this.getEmptyCustomBlueprintData();
            }
        } catch (e) {
            this.customBlueprintData = this.getEmptyCustomBlueprintData();
        }
        
        this.updateCycleIndicator();
        this.updateHeaderProfile();
        this.navigate(0);
        
        // Add keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // ESC to close modal
            if (e.key === 'Escape' && document.getElementById('modal').classList.contains('open')) {
                this.closeModal();
            }
            
            // Ctrl+Z / Cmd+Z for Undo
            if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
                e.preventDefault();
                this.performUndo();
            }
            
            // Ctrl+Shift+Z / Cmd+Shift+Z for Redo
            if ((e.ctrlKey || e.metaKey) && e.key === 'z' && e.shiftKey) {
                e.preventDefault();
                this.performRedo();
            }
        });
        
        // NEW: Online/Offline detection
        window.addEventListener('online', () => {
            this.isOnline = true;
            document.getElementById('offline-badge').classList.remove('show');
            this.toast('âœ“ Back online');
        });
        
        window.addEventListener('offline', () => {
            this.isOnline = false;
            document.getElementById('offline-badge').classList.add('show');
        });
        
        // Check initial online status
        this.isOnline = navigator.onLine;
        if (!this.isOnline) {
            document.getElementById('offline-badge').classList.add('show');
        }
        
        // NEW: Check for backup reminder on load
        this.checkBackupReminder();
        
        // Show welcome modal for first-time users
        // Only show if: (1) hasn't seen welcome AND (2) no blueprint data exists
        if (!hasSeenWelcome && !this.data.blueprintMeta && (!this.data.allCycles || this.data.allCycles.length === 0)) {
            setTimeout(() => {
                document.getElementById('welcome-overlay').style.display = 'flex';
            }, 300);
        }
        
        // PWA: Register inline service worker (no external file needed)
        // IMPORTANT: APP_VERSION is embedded in the SW string so every version bump
        // changes the SW bytes â†’ browser detects a new worker â†’ update flow triggers.
        if ('serviceWorker' in navigator) {
            const swCode = `
const SW_VERSION = '${APP_VERSION}';
const CACHE_NAME = 'svk-blueprint-v' + SW_VERSION;
const STATIC_ASSETS = ['/'];

// INSTALL â€” cache assets but do NOT skipWaiting.
// We let the page decide when to activate so it can show a banner first.
self.addEventListener('install', (e) => {
    e.waitUntil(
        caches.open(CACHE_NAME).then(cache => cache.addAll(STATIC_ASSETS).catch(() => {}))
    );
    // Do NOT call self.skipWaiting() here.
});

// ACTIVATE â€” delete old caches, claim all clients, then tell every open tab
// that a new version is now live so it can reload.
self.addEventListener('activate', (e) => {
    e.waitUntil(
        caches.keys()
            .then(keys => Promise.all(
                keys.filter(k => k !== CACHE_NAME).map(k => caches.delete(k))
            ))
            .then(() => self.clients.claim())
            .then(() => self.clients.matchAll({ type: 'window', includeUncontrolled: true }))
            .then(clients => {
                clients.forEach(c => c.postMessage({ type: 'SW_ACTIVATED', version: SW_VERSION }));
            })
    );
});

// FETCH â€” network-first for HTML navigation (always fresh page), cache-first for assets.
self.addEventListener('fetch', (e) => {
    if (e.request.method !== 'GET') return;
    if (e.request.mode === 'navigate') {
        e.respondWith(
            fetch(e.request).catch(() => caches.match(e.request))
        );
        return;
    }
    e.respondWith(
        caches.match(e.request).then(cached => {
            if (cached) return cached;
            return fetch(e.request).then(response => {
                if (response && response.status === 200 && response.type === 'basic') {
                    const clone = response.clone();
                    caches.open(CACHE_NAME).then(cache => cache.put(e.request, clone));
                }
                return response;
            }).catch(() => caches.match(e.request) || new Response('Offline', { status: 503 }));
        })
    );
});

// MESSAGE â€” page sends SKIP_WAITING to activate the new SW immediately.
// After skipWaiting the page's controllerchange listener will reload.
self.addEventListener('message', (e) => {
    if (e.data && e.data.type === 'SKIP_WAITING') self.skipWaiting();
});
`;
            const swBlob = new Blob([swCode], { type: 'application/javascript' });
            const swUrl  = URL.createObjectURL(swBlob);

            navigator.serviceWorker.register(swUrl, { scope: './' })
                .then(registration => {
                    console.log('SVK SW registered â€” v' + APP_VERSION);
                    App._swRegistration = registration;

                    // Helper: show the banner for a specific waiting worker
                    const notifyWaiting = (worker) => {
                        App._swWaitingWorker = worker;
                        App.showUpdateBanner(true); // true = reload required
                    };

                    // Case A: a new SW is already waiting when the page loads
                    if (registration.waiting) {
                        notifyWaiting(registration.waiting);
                    }

                    // Case B: a new SW is found while the page is open
                    registration.addEventListener('updatefound', () => {
                        const installing = registration.installing;
                        if (!installing) return;
                        installing.addEventListener('statechange', () => {
                            if (installing.state === 'installed' && navigator.serviceWorker.controller) {
                                notifyWaiting(installing);
                            }
                        });
                    });
                })
                .catch(err => console.warn('SVK SW registration failed:', err));

            // When the controller changes (new SW took over), reload the page once.
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                if (App._swReloading) return;
                App._swReloading = true;
                window.location.reload();
            });

            // Message from SW after it activates (handles the "already open tab" case).
            navigator.serviceWorker.addEventListener('message', (event) => {
                if (event.data && event.data.type === 'SW_ACTIVATED') {
                    console.log('SVK SW activated â€” v' + event.data.version);
                    // The reload already happened via controllerchange; this is a fallback.
                    // If somehow the page is still alive, offer a soft refresh.
                    if (!App._swReloading) {
                        App.showUpdateBanner(false); // false = already live, soft notification
                    }
                }
            });
        }
        
        // PWA: Install prompt handler
        window.deferredInstallPrompt = null;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevent the mini-infobar from appearing on mobile
            e.preventDefault();
            
            // Stash the event so it can be triggered later
            window.deferredInstallPrompt = e;
            
            console.log('âœ“ PWA install prompt ready');
            
            // Show install button in UI
            this.showInstallButton();
        });
        
        // Handle successful installation
        window.addEventListener('appinstalled', (evt) => {
            console.log('âœ“ SVK Blueprint PWA installed successfully');
            window.deferredInstallPrompt = null;
            this.hideInstallButton();
            this.toast('âœ“ App installed successfully!');
        });
        } catch (initError) {
            // CRITICAL ERROR HANDLER
            console.error('Critical initialization error:', initError);
            alert('âš ï¸ App failed to start. Please refresh the page. If this persists, clear your browser data.');
            // Attempt emergency data export
            try {
                const emergencyData = localStorage.getItem(DB_KEY);
                if (emergencyData) {
                    const blob = new Blob([emergencyData], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `svk_emergency_backup_${Date.now()}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                }
            } catch (e) {
                console.error('Emergency export failed:', e);
            }
        }
    },

    save() {
        try {
            // Create auto-backup every 10 saves
            if (!this.saveCount) this.saveCount = 0;
            this.saveCount++;
            
            if (this.saveCount % 10 === 0) {
                try {
                    const backupKey = 'svk_auto_backup';
                    const backups = JSON.parse(localStorage.getItem(backupKey) || '[]');
                    backups.push({
                        timestamp: Date.now(),
                        data: this.data
                    });
                    // Keep only last 3 backups
                    if (backups.length > 3) backups.shift();
                    localStorage.setItem(backupKey, JSON.stringify(backups));
                } catch (backupError) {
                    console.warn('Auto-backup failed:', backupError);
                }
            }
            
            localStorage.setItem(DB_KEY, JSON.stringify(this.data)); 
            localStorage.setItem('svkCustomBlueprintData', JSON.stringify(this.customBlueprintData));
            
            // Update last save timestamp
            localStorage.setItem('svk_last_save', Date.now().toString());
        }
        catch(e) { 
            if (e.name === 'QuotaExceededError') {
                // Try to free up space
                try {
                    localStorage.removeItem('svk_auto_backup');
                    localStorage.setItem(DB_KEY, JSON.stringify(this.data));
                    this.toast('âš ï¸ Storage full - auto-backups cleared');
                } catch (retryError) {
                    this.toast('âŒ Storage critically full - export your data NOW');
                    // Trigger emergency export
                    setTimeout(() => this.exportData(), 2000);
                }
            } else {
                this.toast('âš ï¸ Save failed: ' + e.message);
            }
            console.error('Save error:', e);
        }
    },
    
    // NEW: Undo/Redo System
    saveToUndoStack(action, data) {
        // Save current state before making changes
        this.undoStack.push({
            action: action,
            data: JSON.parse(JSON.stringify(data)), // Deep clone
            timestamp: Date.now()
        });
        
        // Limit undo stack size
        if (this.undoStack.length > this.maxUndoSteps) {
            this.undoStack.shift();
        }
        
        // Clear redo stack when new action is performed
        this.redoStack = [];
    },
    
    performUndo() {
        if (this.undoStack.length === 0) {
            this.toast('âš ï¸ Nothing to undo');
            return;
        }
        
        const lastAction = this.undoStack.pop();
        
        // Save current state to redo stack
        this.redoStack.push({
            action: lastAction.action,
            data: JSON.parse(JSON.stringify(this.data)),
            timestamp: Date.now()
        });
        
        // Restore previous state
        this.data = lastAction.data;
        this.save();
        this.render();
        
        // Show undo toast with action description
        this.showUndoToast(`Undone: ${lastAction.action}`, false);
    },
    
    performRedo() {
        if (this.redoStack.length === 0) {
            this.toast('âš ï¸ Nothing to redo');
            return;
        }
        
        const lastRedo = this.redoStack.pop();
        
        // Save current state back to undo stack
        this.undoStack.push({
            action: lastRedo.action,
            data: JSON.parse(JSON.stringify(this.data)),
            timestamp: Date.now()
        });
        
        // Restore redo state
        this.data = lastRedo.data;
        this.save();
        this.render();
        
        this.toast(`âœ“ Redone: ${lastRedo.action}`);
    },
    
    showUndoToast(message, showUndo = true) {
        const undoToast = document.getElementById('undo-toast');
        const undoMessage = document.getElementById('undo-message');
        
        undoMessage.textContent = message;
        undoToast.classList.add('show');
        
        if (!showUndo) {
            undoToast.querySelector('button').style.display = 'none';
        }
        
        setTimeout(() => {
            undoToast.classList.remove('show');
            if (!showUndo) {
                undoToast.querySelector('button').style.display = 'block';
            }
        }, 3000);
    },
    
    // NEW: Backup Reminder System
    checkBackupReminder() {
        const lastReminder = localStorage.getItem('svkLastBackupReminder');
        const lastBackupTime = lastReminder ? parseInt(lastReminder) : 0;
        const now = Date.now();
        
        // Show reminder if more than 7 days since last backup
        if (now - lastBackupTime > this.backupReminderInterval) {
            setTimeout(() => {
                document.getElementById('backup-reminder').classList.add('show');
            }, 5000); // Show 5 seconds after app loads
        }
    },
    
    dismissBackupReminder() {
        localStorage.setItem('svkLastBackupReminder', Date.now().toString());
        document.getElementById('backup-reminder').classList.remove('show');
    },
    
    exportAllData() {
        try {
            const exportData = {
                version: '2.2.2',
                exportDate: new Date().toISOString(),
                data: this.data,
                customBlueprint: this.customBlueprintData
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `svk-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            // Update last backup time
            localStorage.setItem('svkLastBackupReminder', Date.now().toString());
            document.getElementById('backup-reminder').classList.remove('show');
            
            this.toast('âœ“ Backup downloaded');
        } catch (e) {
            console.error('Export error:', e);
            this.toast('âš ï¸ Export failed');
        }
    },

    exportToCSV() {
        try {
            const sheets = [];
            
            // 1. Habits Export
            if (this.data.system?.habits?.length > 0) {
                const habitRows = [['Habit Name', 'Time Block', 'Current Streak', 'Longest Streak', 'Total Completions', 'Micro Steps', 'Created Date']];
                this.data.system.habits.forEach(h => {
                    const streaks = this.calculateStreaks(h);
                    const totalCompletions = h.completions?.filter(c => c.done !== false).length || 0;
                    const microStepsCount = h.microSteps?.length || 0;
                    habitRows.push([
                        h.title,
                        h.timeBlock || 'Anytime',
                        streaks.current,
                        streaks.longest,
                        totalCompletions,
                        microStepsCount,
                        new Date(h.created).toLocaleDateString()
                    ]);
                });
                sheets.push({ name: 'Habits', data: habitRows });
            }
            
            // 2. Goals Export
            if (this.data.goals?.length > 0) {
                const goalRows = [['Goal', 'Domain', 'Target Date', 'Progress', 'Status', 'Stages', 'Created Date']];
                this.data.goals.forEach(g => {
                    const progress = g.stages?.filter(s => s.done).length || 0;
                    const total = g.stages?.length || 0;
                    goalRows.push([
                        g.title,
                        g.domain || 'N/A',
                        g.targetDate || 'No date set',
                        total > 0 ? `${progress}/${total}` : '0/0',
                        g.done ? 'Completed' : 'In Progress',
                        total,
                        new Date(g.created).toLocaleDateString()
                    ]);
                });
                sheets.push({ name: 'Goals', data: goalRows });
            }
            
            // 3. Journal Entries Export
            if (this.data.system?.journal?.length > 0) {
                const journalRows = [['Date', 'Entry', 'Tags']];
                this.data.system.journal.forEach(j => {
                    journalRows.push([
                        new Date(j.date).toLocaleDateString(),
                        j.entry,
                        j.tags?.join(', ') || ''
                    ]);
                });
                sheets.push({ name: 'Journal', data: journalRows });
            }
            
            // 4. Cycle Tasks Export
            if (this.data.currentCycle?.tasks?.length > 0) {
                const taskRows = [['Task', 'Week', 'Domain', 'Duration (min)', 'Status', 'Created Date']];
                this.data.currentCycle.tasks.forEach(t => {
                    taskRows.push([
                        t.title,
                        t.week,
                        t.domain || 'N/A',
                        t.duration || 'N/A',
                        t.done ? 'Completed' : 'Pending',
                        new Date(t.created).toLocaleDateString()
                    ]);
                });
                sheets.push({ name: 'Cycle_Tasks', data: taskRows });
            }
            
            // 5. Quick Tasks Export
            if (this.data.tasks?.quick?.length > 0) {
                const quickRows = [['Task', 'Status', 'Created Date']];
                this.data.tasks.quick.forEach(t => {
                    quickRows.push([
                        t.title,
                        t.done ? 'Done' : 'Pending',
                        new Date(t.created).toLocaleDateString()
                    ]);
                });
                sheets.push({ name: 'Quick_Tasks', data: quickRows });
            }
            
            // 6. Timeblocks Export
            if (this.data.timeblocks?.length > 0) {
                const timeblockRows = [['Title', 'Date', 'Time', 'Duration (min)', 'Type', 'Status']];
                this.data.timeblocks.forEach(tb => {
                    timeblockRows.push([
                        tb.title,
                        tb.date,
                        tb.time || 'Anytime',
                        tb.duration || 60,
                        tb.type || 'Focus',
                        tb.completed ? 'Completed' : 'Pending'
                    ]);
                });
                sheets.push({ name: 'Timeblocks', data: timeblockRows });
            }
            
            // 7. Vault LEARN Items Export
            if (this.data.vaultLearn) {
                Object.entries(this.data.vaultLearn).forEach(([category, items]) => {
                    if (items?.length > 0) {
                        const vaultRows = [['Title', 'Content', 'Tags', 'Importance', 'Starred', 'Source', 'Created']];
                        items.forEach(item => {
                            vaultRows.push([
                                item.title,
                                item.content,
                                item.tags?.join(', ') || '',
                                item.importance || 'low',
                                item.starred ? 'Yes' : 'No',
                                item.source || '',
                                new Date(item.created).toLocaleDateString()
                            ]);
                        });
                        sheets.push({ name: `Learn_${category}`, data: vaultRows });
                    }
                });
            }
            
            // 8. Vault EARN Items Export
            if (this.data.vaultEarn) {
                Object.entries(this.data.vaultEarn).forEach(([category, items]) => {
                    if (items?.length > 0) {
                        const vaultRows = [['Title', 'Content', 'Tags', 'Importance', 'Starred', 'Source', 'Created']];
                        items.forEach(item => {
                            vaultRows.push([
                                item.title,
                                item.content,
                                item.tags?.join(', ') || '',
                                item.importance || 'low',
                                item.starred ? 'Yes' : 'No',
                                item.source || '',
                                new Date(item.created).toLocaleDateString()
                            ]);
                        });
                        sheets.push({ name: `Earn_${category}`, data: vaultRows });
                    }
                });
            }
            
            if (sheets.length === 0) {
                this.toast('âš ï¸ No data to export');
                return;
            }
            
            // Create CSV content with multiple sheets separated by blank lines
            let csvContent = '';
            sheets.forEach((sheet, idx) => {
                csvContent += `\n=== ${sheet.name} ===\n`;
                sheet.data.forEach(row => {
                    const csvRow = row.map(cell => {
                        const cellStr = String(cell || '');
                        // Escape quotes and wrap in quotes if contains comma, quote, or newline
                        if (cellStr.includes(',') || cellStr.includes('"') || cellStr.includes('\n')) {
                            return '"' + cellStr.replace(/"/g, '""') + '"';
                        }
                        return cellStr;
                    }).join(',');
                    csvContent += csvRow + '\n';
                });
                csvContent += '\n';
            });
            
            // Download CSV
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `svk-export-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            
            this.toast(`âœ“ Exported ${sheets.length} sheets to CSV`);
        } catch (e) {
            console.error('CSV Export error:', e);
            this.toast('âš ï¸ CSV export failed');
        }
    },

    getEmptyCustomBlueprintData() {
        // FIX: Pre-fill name and vision from userProfile if available
        const profile = this.data?.userProfile || {};
        return {
            name: profile.name || '',
            vision: profile.vision || '',
            years: '15',
            domain1: '',
            domain2: '',
            domain3: '',
            milestone1: '',
            milestone2: '',
            milestone3: '',
            habit1: '',
            habit2: '',
            habit3: ''
        };
    },

    // PRODUCTION: Data integrity validation and auto-repair
    validateAndFixData() {
        let fixed = false;
        
        // Fix habits without IDs
        if (this.data.system?.habits) {
            this.data.system.habits.forEach(h => {
                if (!h.id) {
                    h.id = this.genId();
                    fixed = true;
                }
                if (!h.completions) h.completions = [];
                if (!h.microSteps) h.microSteps = [];
                if (!h.created) h.created = new Date().toISOString();
            });
        }
        
        // Fix goals without IDs
        if (this.data.goals) {
            this.data.goals.forEach(g => {
                if (!g.id) {
                    g.id = this.genId();
                    fixed = true;
                }
                if (!g.stages) g.stages = [];
                if (!g.created) g.created = new Date().toISOString();
            });
        }
        
        // Fix journal entries
        if (this.data.system?.journal) {
            this.data.system.journal.forEach(j => {
                if (!j.id) {
                    j.id = this.genId();
                    fixed = true;
                }
                if (!j.tags) j.tags = [];
            });
        }
        
        // Fix cycle tasks
        if (this.data.currentCycle?.tasks) {
            this.data.currentCycle.tasks.forEach(t => {
                if (!t.id) {
                    t.id = this.genId();
                    fixed = true;
                }
                if (!t.created) t.created = new Date().toISOString();
                // Ensure week is valid (1-13)
                if (t.week < 1) t.week = 1;
                if (t.week > 13) t.week = 13;
            });
        }
        
        // Fix vault items
        ['vaultLearn', 'vaultEarn'].forEach(vaultType => {
            if (this.data[vaultType]) {
                Object.keys(this.data[vaultType]).forEach(category => {
                    if (Array.isArray(this.data[vaultType][category])) {
                        this.data[vaultType][category].forEach(item => {
                            if (!item.id) {
                                item.id = this.genId();
                                fixed = true;
                            }
                            if (!item.tags) item.tags = [];
                            if (!item.importance) item.importance = 'low';
                            if (item.starred === undefined) item.starred = false;
                            if (!item.created) item.created = new Date().toISOString();
                        });
                    }
                });
            }
        });
        
        // Fix quick tasks
        if (this.data.tasks?.quick) {
            this.data.tasks.quick.forEach(t => {
                if (!t.id) {
                    t.id = this.genId();
                    fixed = true;
                }
                if (!t.created) t.created = new Date().toISOString();
            });
        }
        
        // Fix timeblocks
        if (this.data.timeblocks) {
            this.data.timeblocks.forEach(tb => {
                if (!tb.id) {
                    tb.id = this.genId();
                    fixed = true;
                }
            });
        }
        
        if (fixed) {
            console.log('âœ“ Data integrity validated and repaired');
            this.save();
        }
    },

    // VERSION CHECKING: Check if new version available
    checkForUpdates() {
        const lastVersion      = localStorage.getItem('svk_app_version');
        const dismissedVersion = localStorage.getItem('svk_dismissed_update_version');

        // First run â€” store current version and exit
        if (!lastVersion) {
            localStorage.setItem('svk_app_version', APP_VERSION);
            return;
        }

        if (this.compareVersions(APP_VERSION, lastVersion) > 0) {
            // Update stored version first so repeated loads don't re-trigger
            localStorage.setItem('svk_app_version', APP_VERSION);

            // Don't show if user already dismissed this exact version
            if (dismissedVersion === APP_VERSION) return;

            // Direct-file-open path: page already has new code, no reload needed.
            // requiresReload=false, pass old version for display.
            setTimeout(() => this.showUpdateBanner(false, lastVersion), 1500);
        }
        // Same version â€” nothing to do
    },

    // Compare version strings (e.g., "2.2.2" vs "2.2.1")
    compareVersions(v1, v2) {
        const parts1 = v1.split('.').map(Number);
        const parts2 = v2.split('.').map(Number);
        
        for (let i = 0; i < Math.max(parts1.length, parts2.length); i++) {
            const p1 = parts1[i] || 0;
            const p2 = parts2[i] || 0;
            if (p1 > p2) return 1;
            if (p1 < p2) return -1;
        }
        return 0;
    },

    // showUpdateBanner(requiresReload, oldVersion)
    // requiresReload=true  â†’ SW is waiting; banner shows "Reload Now" button
    // requiresReload=false â†’ file was already updated; soft notification, no reload needed
    showUpdateBanner(requiresReload, oldVersion) {
        const banner    = document.getElementById('update-banner');
        const titleEl   = document.getElementById('update-banner-title');
        const text      = document.getElementById('update-banner-text');
        const reloadBtn = document.getElementById('update-reload-btn');

        if (requiresReload) {
            if (titleEl) titleEl.textContent = 'ðŸ”„ Update ready!';
            text.textContent = 'New version installed â€” reload to apply (your data is safe)';
            if (reloadBtn) { reloadBtn.style.display = ''; reloadBtn.textContent = 'Reload Now'; }
        } else {
            const from = oldVersion ? ' from v' + oldVersion : '';
            if (titleEl) titleEl.textContent = 'âœ… Updated to v' + APP_VERSION + '!';
            text.textContent = 'Updated' + from + ' â€” you\'re on the latest version';
            if (reloadBtn) reloadBtn.style.display = 'none';
            // Soft notification auto-dismisses
            setTimeout(() => { banner.style.display = 'none'; }, 9000);
        }

        banner.style.display = 'flex';
        // Safety: always auto-hide after 60s
        setTimeout(() => { banner.style.display = 'none'; }, 60000);
    },

    // Tell the waiting SW to activate; the controllerchange listener will reload the page.
    applyUpdate() {
        const btn = document.getElementById('update-reload-btn');
        if (btn) { btn.textContent = 'Reloadingâ€¦'; btn.disabled = true; }

        if (this._swWaitingWorker) {
            this._swWaitingWorker.postMessage({ type: 'SKIP_WAITING' });
        } else {
            window.location.reload(true);
        }
    },

    // Dismiss update banner
    dismissUpdateBanner() {
        const banner = document.getElementById('update-banner');
        banner.style.display = 'none';
        
        // Remember that user dismissed this version
        localStorage.setItem('svk_dismissed_update_version', APP_VERSION);
    },

    // Show update details modal
    showUpdateInstructions() {
        document.getElementById('update-banner').style.display = 'none';
        const hasWaiting = !!this._swWaitingWorker;

        document.getElementById('modal-body').innerHTML = `
            <h3 style="margin-bottom:16px;color:var(--accent);">ðŸŽ‰ New Version Available: v${APP_VERSION}</h3>

            ${hasWaiting ? `
            <div style="background:rgba(255,215,0,0.12);border:1px solid rgba(255,215,0,0.4);
                         border-radius:12px;padding:16px;margin-bottom:16px;text-align:center;">
                <div style="font-size:15px;font-weight:700;margin-bottom:8px;">âœ… Update is downloaded & ready</div>
                <div style="font-size:13px;color:var(--dim);margin-bottom:14px;">
                    Click below to reload â€” your data is safe, nothing is lost.
                </div>
                <button class="btn" onclick="App.applyUpdate()" style="font-size:15px;padding:12px 32px;">
                    ðŸ”„ Reload Now
                </button>
            </div>
            ` : `
            <div style="background:var(--sub);padding:14px;border-radius:10px;margin-bottom:16px;
                         border-left:4px solid var(--accent);font-size:13px;color:var(--dim);">
                The new version is already loaded. Hard-refresh (Ctrl+Shift+R / Cmd+Shift+R)
                if you still see old content.
            </div>
            `}

            <div style="background:var(--sub);padding:14px;border-radius:12px;margin-bottom:16px;
                         border-left:4px solid var(--accent);">
                <div style="font-weight:700;margin-bottom:8px;color:var(--accent);">What's New in v${APP_VERSION}</div>
                <ul style="margin:0;padding-left:20px;line-height:1.8;font-size:13px;color:var(--dim);">
                    <li>ðŸ”„ Micro-step delete fixed (confirm dialog z-index)</li>
                    <li>ðŸ“± All dialogs now work in PWA/iOS standalone mode</li>
                    <li>â±ï¸ Timer no longer stops when managing habits</li>
                    <li>ðŸ”” Service Worker update detection fully reliable</li>
                    <li>ðŸ”§ One-click reload from update banner</li>
                </ul>
            </div>

            <div style="background:rgba(255,100,100,0.08);padding:12px;border-radius:8px;
                         margin-bottom:16px;border-left:3px solid #ff6464;">
                <strong style="color:#ff6464;">ðŸ’¾ Your data is safe</strong>
                <div style="font-size:12px;margin-top:4px;line-height:1.6;color:var(--dim);">
                    All data lives in localStorage and survives reloads and updates.
                    Export a backup anytime from SYSTEM â†’ Export.
                </div>
            </div>

            <div style="display:flex;gap:8px;">
                ${hasWaiting ? `
                <button class="btn" onclick="App.applyUpdate()" style="flex:1;">ðŸ”„ Reload Now</button>
                ` : ''}
                <button class="btn-sec" onclick="App.closeModal()" style="flex:1;">Close</button>
            </div>
        `;
        document.getElementById('modal').classList.add('open');
    },

    navigate(i) {
        this.tab = i;
        document.querySelectorAll('.nav-btn').forEach((b, idx) => b.classList.toggle('active', idx === i));
        
        // NEW: Mark tab as loaded for lazy loading
        const tabNames = ['execute', 'build', 'strategy', 'system', 'vault'];
        this.tabsLoaded[tabNames[i]] = true;
        
        this.render();
    },

    render() {
        // â”€â”€ INTEGRATION: Sync contact follow-ups â†’ delegated tasks â”€â”€
        if (this.syncContactsToTasks) this.syncContactsToTasks();

        // NEW: Lazy loading - only render if tab has been visited
        const views = [this.viewExecute, this.viewBuild, this.viewStrategy, this.viewSystem, this.viewVault];
        
        // For performance: check if we should use pagination
        const shouldPaginate = this.shouldUsePagination();
        
        if (shouldPaginate) {
            // If large dataset, add pagination note
            console.log('Large dataset detected - consider pagination');
        }
        
        document.getElementById('app').innerHTML = views[this.tab].call(this);
    },
    
    // NEW: Check if data is large enough to warrant pagination
    shouldUsePagination() {
        const habitCount = this.data.system?.habits?.length || 0;
        const journalCount = this.data.system?.journal?.length || 0;
        const notesCount = this.data.vault?.learnings?.notes?.length || 0;
        const goalsCount = this.data.goals?.length || 0;
        
        // Consider pagination if any collection has 100+ items
        return habitCount > 100 || journalCount > 100 || notesCount > 100 || goalsCount > 100;
    },

    // Custom confirm dialog - replaces window.confirm() which fails in PWA standalone mode on iOS
    confirm(message, callback, okLabel, danger) {
        okLabel = okLabel || 'Confirm';
        const overlay = document.getElementById('confirm-overlay');
        document.getElementById('confirm-message').textContent = message;
        const okBtn = document.getElementById('confirm-ok-btn');
        const cancelBtn = document.getElementById('confirm-cancel-btn');
        okBtn.textContent = okLabel;
        okBtn.style.background = (danger === false) ? 'var(--warn)' : 'var(--danger)';
        overlay.style.display = 'flex';
        const cleanup = () => { overlay.style.display = 'none'; };
        okBtn.onclick = () => { cleanup(); callback(); };
        cancelBtn.onclick = () => { cleanup(); };
    },

    toast(msg) {
        const t = document.getElementById('toast');
        t.textContent = msg;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 2200);
    },
    
    // PWA Install Button Methods
    showInstallButton() {
        // Check if install button already exists
        if (document.getElementById('pwa-install-btn')) return;
        
        // Create floating install button
        const installBtn = document.createElement('button');
        installBtn.id = 'pwa-install-btn';
        installBtn.innerHTML = 'ðŸ“± Install App';
        installBtn.style.cssText = `
            position: fixed;
            bottom: 80px;
            right: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            z-index: 9999;
            transition: all 0.3s ease;
            animation: pulse 2s infinite;
        `;
        
        installBtn.onclick = () => this.installPWA();
        
        // Add pulsing animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes pulse {
                0%, 100% { transform: scale(1); }
                50% { transform: scale(1.05); }
            }
            #pwa-install-btn:hover {
                transform: scale(1.1) !important;
                box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6) !important;
            }
        `;
        document.head.appendChild(style);
        document.body.appendChild(installBtn);
    },
    
    hideInstallButton() {
        const btn = document.getElementById('pwa-install-btn');
        if (btn) {
            btn.style.animation = 'none';
            btn.style.opacity = '0';
            setTimeout(() => btn.remove(), 300);
        }
    },
    
    async installPWA() {
        // Check if already installed
        const isPWAInstalled = window.matchMedia('(display-mode: standalone)').matches || 
                               window.navigator.standalone;
        
        if (isPWAInstalled) {
            this.toast('âœ“ App is already installed');
            return;
        }
        
        // Check if running from file:// protocol
        if (window.location.protocol === 'file:') {
            this.toast('âš ï¸ PWA install requires HTTPS hosting. Open from a web server or use browser "Add to Home Screen" manually.');
            return;
        }
        
        // Check if install prompt is available
        if (!window.deferredInstallPrompt) {
            // Provide helpful instructions based on browser
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const isAndroid = /Android/.test(navigator.userAgent);
            
            if (isIOS) {
                this.toast('ðŸ“± Safari: Tap Share â†’ Add to Home Screen');
            } else if (isAndroid) {
                this.toast('ðŸ“± Chrome: Tap Menu (â‹®) â†’ Install app');
            } else {
                this.toast('âš ï¸ Install not available. Try: Chrome menu â†’ Install app, or Safari Share â†’ Add to Home Screen');
            }
            return;
        }
        
        try {
            // Show the install prompt
            await window.deferredInstallPrompt.prompt();
            
            // Wait for the user's response
            const { outcome } = await window.deferredInstallPrompt.userChoice;
            
            if (outcome === 'accepted') {
                console.log('âœ“ User accepted PWA install');
                this.toast('âœ“ Installing app...');
            } else {
                console.log('âœ— User dismissed PWA install');
                this.toast('Install cancelled');
            }
            
            // Clear the deferred prompt
            window.deferredInstallPrompt = null;
            this.hideInstallButton();
            
        } catch (err) {
            console.error('Install error:', err);
            this.toast('âš ï¸ Installation failed. Try browser menu â†’ Install app');
        }
    },

    celebrate(emoji, title, sub) {
        document.getElementById('celebrate-emoji').textContent = emoji;
        document.getElementById('celebrate-title').textContent = title;
        document.getElementById('celebrate-sub').textContent = sub;
        document.getElementById('celebrate').classList.add('show');
    },
    closeCelebrate() { document.getElementById('celebrate').classList.remove('show'); },

    // â”€â”€ INTELLIGENCE BRIEF ENGINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Surfaces Vault EARN items contextually on the Execute screen.
    // Called from viewExecute. Returns HTML string.
    vaultDailyBrief() {
        const earn = this.data.vaultEarn || {};
        const strat    = earn.strat    || [];
        const execLog  = earn.exec     || [];
        const leverage = earn.leverage || [];
        const contacts = earn.contacts || [];
        const today    = new Date().toISOString().split('T')[0];

        // â”€â”€ INTEGRATION: Find the dominant domain for THIS WEEK â”€â”€
        // Dominant = the goals_focus domain with highest % allocation
        const goalsF = this.data.currentCycle?.goals_focus || {};
        const activeDomain = Object.entries(goalsF)
            .sort((a,b) => b[1] - a[1])
            .map(e => e[0])[0] || '';

        // â”€â”€ 1. TODAY'S OPERATING RULE â€” domain-aware â”€â”€
        // Priority: pinned â†’ domain match high importance â†’ any high â†’ starred â†’ newest
        let todayRule = strat.find(s => s.pinnedToday) ||
                        (activeDomain ? strat.filter(s => !s.pinnedToday && s.linkedDomain === activeDomain && s.importance === 'high').sort((a,b) => new Date(b.created)-new Date(a.created))[0] : null) ||
                        (activeDomain ? strat.filter(s => !s.pinnedToday && s.linkedDomain === activeDomain).sort((a,b) => new Date(b.created)-new Date(a.created))[0] : null) ||
                        strat.filter(s => s.importance === 'high').sort((a,b) => new Date(b.created)-new Date(a.created))[0] ||
                        strat.filter(s => s.starred).sort((a,b) => new Date(b.created)-new Date(a.created))[0] ||
                        strat.sort((a,b) => new Date(b.created)-new Date(a.created))[0] || null;

        // â”€â”€ 2. LEVERAGE SPOTLIGHT â€” domain-aware â”€â”€
        let topLeverage = leverage.filter(l => !l.completed && l.importance === 'high')[0] ||
                          (activeDomain ? leverage.filter(l => !l.completed && l.linkedDomain === activeDomain)[0] : null) ||
                          leverage.filter(l => !l.completed && l.starred)[0] ||
                          leverage.filter(l => !l.completed)[0] || null;

        // â”€â”€ 3. CONTACTS DUE FOR FOLLOW-UP â”€â”€
        const dueContacts = contacts.filter(c => {
            if (c.completed) return false;
            if (!c.followUpDate) return false;
            return c.followUpDate <= today;
        }).sort((a,b) => (a.followUpDate||'').localeCompare(b.followUpDate||''));

        // â”€â”€ 4. RECENT WIN (last completed exec log item) â”€â”€
        const lastWin = execLog.filter(e => e.completed)
            .sort((a,b) => new Date(b.modified||b.created) - new Date(a.modified||a.created))[0] || null;

        // Nothing to surface
        const hasAnything = todayRule || topLeverage || dueContacts.length > 0 || lastWin;
        if (!hasAnything) return '';

        let html = `
        <div style="margin-top:28px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                <div style="display:flex;align-items:center;gap:10px;">
                    <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:2px;color:var(--accent);">
                        â—ˆ Intelligence Brief
                    </div>
                    ${activeDomain ? `<div style="font-size:9px;padding:2px 8px;background:${this.getDomainColor(activeDomain)}22;
                        border:1px solid ${this.getDomainColor(activeDomain)}55;border-radius:10px;
                        color:${this.getDomainColor(activeDomain)};font-weight:700;text-transform:uppercase;letter-spacing:1px;">
                        â¬¡ ${esc(activeDomain)}
                    </div>` : ''}
                </div>
                <button onclick="App.tab=4;App.sub.vaultMain='earn';App.sub.vault='strat';App.render()"
                    style="font-size:10px;color:var(--dim);background:none;border:none;cursor:pointer;padding:0;">
                    Open Vault â†’
                </button>
            </div>`;

        // TODAY'S OPERATING RULE
        if (todayRule) {
            const domainColor = todayRule.linkedDomain ? this.getDomainColor(todayRule.linkedDomain) : 'var(--accent)';
            html += `
            <div style="background:linear-gradient(135deg,#1a1a00,#1c1c1e);border:1px solid ${domainColor}44;
                        border-left:3px solid ${domainColor};border-radius:10px;padding:14px 14px 12px;margin-bottom:10px;">
                <div style="font-size:9px;text-transform:uppercase;letter-spacing:2px;color:${domainColor};
                            font-weight:700;margin-bottom:6px;">ðŸ“Š Today's Rule</div>
                <div style="font-size:13px;font-weight:600;color:var(--text);line-height:1.5;margin-bottom:6px;">
                    ${esc(todayRule.title)}
                </div>
                ${todayRule.content ? `<div style="font-size:12px;color:var(--dim);line-height:1.5;
                    display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;">
                    ${esc(todayRule.content)}</div>` : ''}
                <div style="display:flex;gap:8px;margin-top:10px;">
                    <button onclick="App.pinStrategyToday('${todayRule.id}')"
                        style="font-size:10px;padding:4px 10px;background:${todayRule.pinnedToday?domainColor:'var(--sub)'};
                               color:${todayRule.pinnedToday?'var(--void)':'var(--dim)'};border:1px solid ${domainColor}44;
                               border-radius:6px;cursor:pointer;font-weight:600;">
                        ${todayRule.pinnedToday ? 'ðŸ“Œ Pinned' : 'Pin Today'}
                    </button>
                    <button onclick="App.tab=4;App.sub.vaultMain='earn';App.sub.vault='strat';App.render()"
                        style="font-size:10px;padding:4px 10px;background:var(--sub);color:var(--dim);
                               border:1px solid var(--border);border-radius:6px;cursor:pointer;">
                        All Strategy â†’
                    </button>
                </div>
            </div>`;
        }

        // LEVERAGE SPOTLIGHT
        if (topLeverage) {
            const lColor = this.getDomainColor(topLeverage.linkedDomain || 'leverage');
            html += `
            <div style="background:var(--card);border:1px solid var(--border);border-left:3px solid ${lColor};
                        border-radius:10px;padding:14px;margin-bottom:10px;">
                <div style="font-size:9px;text-transform:uppercase;letter-spacing:2px;color:${lColor};
                            font-weight:700;margin-bottom:6px;">ðŸ”— Leverage Opportunity</div>
                <div style="font-size:13px;font-weight:600;color:var(--text);line-height:1.4;margin-bottom:4px;">
                    ${esc(topLeverage.title)}
                </div>
                ${topLeverage.content ? `<div style="font-size:12px;color:var(--dim);line-height:1.4;
                    display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;">
                    ${esc(topLeverage.content)}</div>` : ''}
                <div style="margin-top:8px;">
                    <button onclick="App.markLeveragePursued('${topLeverage.id}')"
                        style="font-size:10px;padding:4px 12px;background:${lColor};color:var(--void);
                               border:none;border-radius:6px;cursor:pointer;font-weight:700;">
                        Pursuing âœ“
                    </button>
                </div>
            </div>`;
        }

        // CONTACTS DUE
        if (dueContacts.length > 0) {
            html += `
            <div style="background:var(--card);border:1px solid var(--border);border-left:3px solid var(--blue);
                        border-radius:10px;padding:14px;margin-bottom:10px;">
                <div style="font-size:9px;text-transform:uppercase;letter-spacing:2px;color:var(--blue);
                            font-weight:700;margin-bottom:8px;">ðŸ‘¤ Follow Up Today</div>`;
            dueContacts.slice(0, 3).forEach(c => {
                const isOverdue = c.followUpDate < today;
                html += `
                <div style="display:flex;justify-content:space-between;align-items:center;
                            padding:8px 0;border-bottom:1px solid var(--border);">
                    <div style="flex:1;min-width:0;">
                        <div style="font-size:13px;font-weight:600;">${esc(c.title)}</div>
                        ${c.content ? `<div style="font-size:11px;color:var(--dim);margin-top:2px;
                            white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${esc(c.content)}</div>` : ''}
                    </div>
                    <div style="display:flex;gap:6px;align-items:center;margin-left:8px;">
                        ${isOverdue ? `<span style="font-size:10px;color:#ff453a;font-weight:700;">OVERDUE</span>` : 
                                      `<span style="font-size:10px;color:var(--blue);">TODAY</span>`}
                        <button onclick="App.markContactDone('${c.id}')"
                            style="font-size:11px;padding:4px 10px;background:var(--blue);color:#fff;
                                   border:none;border-radius:6px;cursor:pointer;font-weight:600;">âœ“</button>
                    </div>
                </div>`;
            });
            if (dueContacts.length > 3) {
                html += `<div style="font-size:11px;color:var(--dim);margin-top:8px;text-align:center;">
                    +${dueContacts.length - 3} more in Vault</div>`;
            }
            html += `</div>`;
        }

        // RECENT WIN
        if (lastWin) {
            html += `
            <div style="background:var(--sub);border:1px solid var(--border);border-left:3px solid var(--success);
                        border-radius:10px;padding:12px 14px;margin-bottom:10px;">
                <div style="font-size:9px;text-transform:uppercase;letter-spacing:2px;color:var(--success);
                            font-weight:700;margin-bottom:4px;">âš™ï¸ Last Win Logged</div>
                <div style="font-size:12px;color:var(--dim);font-style:italic;">${esc(lastWin.title)}</div>
            </div>`;
        }

        html += `</div>`;
        return html;
    },

    // Pin/unpin a strategy item to today's brief
    pinStrategyToday(id) {
        const strat = this.data.vaultEarn?.strat || [];
        strat.forEach(s => { s.pinnedToday = false; }); // unpin all first
        const item = strat.find(s => s.id === id);
        if (item) {
            item.pinnedToday = true;
            item.modified = new Date().toISOString();
            this.save(); this.render();
            this.toast('ðŸ“Œ Strategy pinned to today');
        }
    },

    // Mark leverage as being pursued (completes it from brief)
    markLeveragePursued(id) {
        const item = this.data.vaultEarn?.leverage?.find(l => l.id === id);
        if (item) {
            item.completed = true;
            item.modified = new Date().toISOString();
            this.save(); this.render();
            this.celebrate('ðŸ”—', 'Leverage Activated!', item.title);
        }
    },

    // Mark contact follow-up done from brief
    markContactDone(id) {
        const item = this.data.vaultEarn?.contacts?.find(c => c.id === id);
        if (item) {
            // Clear follow-up date or mark done â€” here we bump to +7 days
            const next = new Date();
            next.setDate(next.getDate() + 7);
            item.followUpDate = next.toISOString().split('T')[0];
            item.lastContactDate = new Date().toISOString().split('T')[0];
            item.modified = new Date().toISOString();
            this.save(); this.render();
            this.toast('âœ“ Follow-up done Â· Next in 7 days');
        }
    },

    // â”€â”€ INTEGRATION: Auto-create delegated tasks from due contacts â”€â”€
    syncContactsToTasks() {
        const contacts = this.data.vaultEarn?.contacts || [];
        const today = new Date().toISOString().split('T')[0];
        if (!this.data.tasks) this.data.tasks = { quick: [], scheduled: [], delegated: [] };
        if (!this.data.tasks.delegated) this.data.tasks.delegated = [];

        contacts.forEach(c => {
            if (c.completed || !c.followUpDate || c.followUpDate > today) return;
            // Check if a delegated task already exists for this contact
            const alreadyExists = this.data.tasks.delegated.some(t => t._contactId === c.id);
            if (!alreadyExists) {
                this.data.tasks.delegated.push({
                    id: 'ct_' + c.id,
                    _contactId: c.id,
                    title: `Follow up: ${c.title}`,
                    notes: c.content || '',
                    done: false,
                    created: new Date().toISOString()
                });
            }
        });
        // Remove delegated tasks whose contact was marked done (followUpDate moved to future)
        this.data.tasks.delegated = this.data.tasks.delegated.filter(t => {
            if (!t._contactId) return true; // keep non-contact tasks
            const contact = contacts.find(c => c.id === t._contactId);
            if (!contact) return false;
            return contact.followUpDate <= today && !contact.completed;
        });
    },

    // VIEW: EXECUTE
    viewExecute() {
        const quotes = ["The obstacle is the path.", "One breath. One task. Full presence.", "Empty your cup to receive."];
        const quote = quotes[Math.floor(Math.random() * quotes.length)];
        
        // â”€â”€ Personalized greeting â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const profile = this.data.userProfile || {};
        const userName = profile.name ? profile.name.split(' ')[0] : '';
        const userVision = profile.vision || '';
        const hour = new Date().getHours();
        const greeting = hour < 12 ? 'Good morning' : hour < 17 ? 'Good afternoon' : 'Good evening';
        
        let html = '';
        if (userName) {
            html += `
            <div style="padding:18px 0 4px;border-bottom:1px solid var(--border);margin-bottom:14px;">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:10px;">
                    <div>
                        <div style="font-size:20px;font-weight:700;color:var(--text);line-height:1.2;">
                            ${greeting}, <span style="color:var(--accent);">${esc(userName)}</span> ðŸ‘‹
                        </div>
                        ${profile.tagline ? `<div style="font-size:12px;color:var(--dim);margin-top:3px;letter-spacing:0.5px;">${esc(profile.tagline)}</div>` : ''}
                    </div>
                </div>
                ${userVision ? `
                <div onclick="App.openEditProfile()"
                    style="background:rgba(255,215,0,0.05);border:1px solid rgba(255,215,0,0.15);border-radius:10px;
                           padding:12px 14px;cursor:pointer;transition:all 0.2s;"
                    onmouseover="this.style.borderColor='rgba(255,215,0,0.35)'"
                    onmouseout="this.style.borderColor='rgba(255,215,0,0.15)'">
                    <div style="font-size:9px;color:var(--accent);text-transform:uppercase;letter-spacing:2px;font-weight:700;margin-bottom:5px;">
                        ðŸŽ¯ Your 15-Year Vision
                    </div>
                    <div style="font-size:12px;color:var(--zen);line-height:1.6;font-style:italic;
                                display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;">
                        "${esc(userVision)}"
                    </div>
                    <div style="font-size:10px;color:var(--dim);margin-top:6px;opacity:0.6;">Tap to edit</div>
                </div>` : `
                <div onclick="App.openEditProfile()"
                    style="background:rgba(255,215,0,0.04);border:1px dashed rgba(255,215,0,0.2);border-radius:10px;
                           padding:12px 14px;cursor:pointer;text-align:center;">
                    <div style="font-size:12px;color:var(--dim);">+ Add your 15-year vision â†’</div>
                </div>`}
            </div>`;
        } else {
            // No profile yet â€” show a prompt
            html += `
            <div style="background:rgba(255,215,0,0.05);border:1px dashed rgba(255,215,0,0.3);border-radius:12px;
                        padding:16px;margin-bottom:14px;text-align:center;cursor:pointer;"
                 onclick="App.openEditProfile()">
                <div style="font-size:22px;margin-bottom:8px;">ðŸ‘¤</div>
                <div style="font-size:14px;font-weight:700;color:var(--accent);margin-bottom:4px;">Set Up Your Profile</div>
                <div style="font-size:12px;color:var(--dim);line-height:1.5;">Add your name and 15-year vision to personalize this system</div>
                <div style="margin-top:10px;font-size:12px;font-weight:600;color:var(--accent);">Tap here â†’</div>
            </div>`;
        }

        html += `<div class="zen-quote">"${quote}"</div>`;
        
        // â”€â”€ SECTION 1: QUICK TASKS (max 3) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if (!this.data.tasks) this.data.tasks = { quick: [], scheduled: [], delegated: [] };
        if (!this.data.tasks.quick) this.data.tasks.quick = [];
        if (!this.data.tasks.scheduled) this.data.tasks.scheduled = [];
        if (!this.data.tasks.delegated) this.data.tasks.delegated = [];
        const quickTasks = this.data.tasks.quick || [];
        const canAddQuick = quickTasks.filter(t => !t.done).length < 3;
        
        html += `<div class="section-header">
            <span>âš¡ Quick Tasks (${quickTasks.filter(t=>!t.done).length}/3)</span>
            ${canAddQuick ? `<button class="btn-sec" onclick="App.addQuickTask()">+ Add</button>` : ''}
        </div>`;
        
        if (quickTasks.length > 0) {
            quickTasks.forEach(task => {
                html += `<div class="task-row ${task.done ? 'done' : ''}">
                    <div style="flex:1;min-width:0;">
                        <div class="task-title">${esc(task.title)}</div>
                    </div>
                    <div style="display:flex;gap:8px;align-items:center;">
                        ${!task.done ? `<button class="btn-sec btn-success" onclick="App.toggleQuickTask('${task.id}')" style="font-size:12px;padding:6px 12px;">âœ“</button>` : ''}
                        <button class="btn-sec" onclick="App.deleteQuickTask('${task.id}')" style="font-size:11px;padding:4px 10px;opacity:0.6;">âœ•</button>
                    </div>
                </div>`;
            });
            if (!canAddQuick) {
                html += `<div style="text-align:center;margin-top:8px;font-size:11px;color:var(--dim);">Max 3 quick tasks. Complete or delete to add more.</div>`;
            }
        } else {
            // EMPTY CUP state
            html += `<div style="margin-top:16px;text-align:center;padding:36px 20px;background:var(--sub);border-radius:12px;border:1px dashed var(--border);">
                <div style="font-size:14px;color:var(--accent);margin-bottom:16px;letter-spacing:2px;text-transform:uppercase;font-weight:600;">Empty Cup</div>
                <div style="font-size:72px;line-height:1;margin-bottom:14px;">ðŸ§˜</div>
                <div style="font-size:13px;color:var(--dim);max-width:260px;margin:0 auto;line-height:1.6;">
                    Your mind is clear, ready to receive.<br>No quick tasks pending.
                </div>
                <button class="btn-sec" onclick="App.addQuickTask()" style="margin-top:16px;font-size:12px;">+ Add Quick Task</button>
            </div>`;
        }

        // â”€â”€ SECTION 2: PLANNED TASKS FROM 15-YEAR VISION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        html += `<div class="section-header" style="margin-top:28px;">
            <span>ðŸŽ¯ Vision Plan Tasks</span>
            <button class="btn-sec" onclick="App.addCycleTask()" style="font-size:11px;padding:4px 10px;">+ Add</button>
        </div>`;
        
        if (!this.data.currentCycle) {
            html += `<div class="card" style="text-align:center;padding:28px 20px;background:var(--sub);">
                <div style="font-size:36px;margin-bottom:12px;">ðŸ—ºï¸</div>
                <div style="font-size:15px;font-weight:700;margin-bottom:8px;">No Blueprint Yet</div>
                <p style="color:var(--dim);margin-bottom:18px;font-size:13px;line-height:1.5;">
                    Link your daily execution to a 15-year vision plan.
                </p>
                <button class="btn" style="margin-bottom:8px;font-size:13px;" onclick="App.tab=3;App.sub.system='custom';App.render()">
                    ðŸ¤– Create Blueprint
                </button>
                <button class="btn-sec" onclick="App.tab=1;App.sub.build='stats';App.render()" style="font-size:13px;">
                    ðŸ“¤ Import Blueprint
                </button>
            </div>`;
        } else {
            const tasks = this.data.currentCycle.tasks || [];
            const week = this.getCurrentWeek();
            const weekTasks = tasks.filter(t => t.week === week && !t.done);
            const allPending = tasks.filter(t => !t.done);
            
            if (allPending.length === 0) {
                html += `<div class="card" style="text-align:center;padding:16px;background:var(--sub);">
                    <div style="font-size:13px;color:var(--dim);">All vision tasks completed! ðŸŽ‰</div>
                </div>`;
            } else {
                html += `<div style="font-size:11px;color:var(--dim);margin-bottom:8px;padding:0 2px;">
                    Cycle ${this.data.currentCycle.number || '?'} Â· Week ${week}/13 Â· ${weekTasks.length} this week
                </div>`;
                const displayTasks = weekTasks.length > 0 ? weekTasks : allPending.slice(0, 5);
                displayTasks.slice(0, 5).forEach(task => {
                    html += `<div class="task-row" onclick="App.startTask('${task.id}')">
                        <div style="flex:1;min-width:0;">
                            <div style="font-weight:600;">${esc(task.title)}</div>
                            <div class="task-meta">
                                ${task.duration ? `â± ${task.duration}m` : ''}
                                ${task.domain ? `<span style="color:var(--accent);">${esc(task.domain)}</span>` : ''}
                                <span>Week ${task.week}</span>
                            </div>
                        </div>
                        <button class="btn-sec btn-success" onclick="event.stopPropagation();App.toggleTask('${task.id}')">âœ“</button>
                    </div>`;
                });
                if (allPending.length > 5) {
                    html += `<div style="text-align:center;margin-top:10px;">
                        <button class="btn-sec" onclick="App.navigate(2)" style="font-size:12px;">
                            View All ${allPending.length} Tasks â†’
                        </button>
                    </div>`;
                }
            }
        }

        // â”€â”€ VAULT INTELLIGENCE BRIEF â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        html += this.vaultDailyBrief();

        // â”€â”€ SECTION 3: SCHEDULED TASKS (vertical timeline) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const scheduledTasks = (this.data.tasks.scheduled || []).filter(t => !t.done);
        html += `<div class="section-header" style="margin-top:28px;">
            <span>ðŸ“… Scheduled Tasks</span>
            <button class="btn-sec" onclick="App.addScheduledTask()" style="font-size:11px;padding:4px 10px;">+ Add</button>
        </div>`;
        
        if (scheduledTasks.length === 0) {
            html += `<div style="padding:16px;text-align:center;color:var(--dim);font-size:13px;background:var(--sub);border-radius:8px;">
                No scheduled tasks. Capture via + button or Add above.
            </div>`;
        } else {
            // Sort by scheduled date/time
            const sorted = [...scheduledTasks].sort((a,b) => {
                const da = a.scheduledDate || a.created || '';
                const db = b.scheduledDate || b.created || '';
                return da.localeCompare(db);
            });
            html += `<div style="position:relative;padding-left:20px;">
                <div style="position:absolute;left:7px;top:0;bottom:0;width:2px;background:var(--border);border-radius:2px;"></div>`;
            sorted.forEach((task, idx) => {
                const isToday = task.scheduledDate === new Date().toISOString().split('T')[0];
                html += `<div style="position:relative;margin-bottom:14px;">
                    <div style="position:absolute;left:-17px;top:10px;width:10px;height:10px;border-radius:50%;
                         background:${isToday ? 'var(--accent)' : 'var(--border)'};border:2px solid ${isToday ? 'var(--accent)' : 'var(--dim)'};">
                    </div>
                    <div class="task-row" style="margin-bottom:0;${isToday ? 'border-left:3px solid var(--accent);' : ''}">
                        <div style="flex:1;min-width:0;">
                            <div style="font-weight:600;font-size:13px;">${esc(task.title)}</div>
                            <div class="task-meta">
                                ${task.scheduledDate ? `<span style="color:${isToday ? 'var(--accent)' : 'var(--dim)'};">${isToday ? 'Today' : task.scheduledDate}</span>` : ''}
                                ${task.scheduledTime ? `<span>â° ${task.scheduledTime}</span>` : ''}
                                ${task.notes ? `<span>${esc(task.notes)}</span>` : ''}
                            </div>
                        </div>
                        <div style="display:flex;gap:6px;align-items:center;">
                            <button class="btn-sec btn-success" onclick="App.completeScheduledTask('${task.id}')" style="font-size:12px;padding:6px 10px;">âœ“</button>
                            <button class="btn-sec" onclick="App.deleteScheduledTask('${task.id}')" style="font-size:11px;padding:4px 8px;opacity:0.5;">âœ•</button>
                        </div>
                    </div>
                </div>`;
            });
            html += `</div>`;
            
            // Also show completed scheduled tasks count
            const completedSched = (this.data.tasks.scheduled || []).filter(t => t.done).length;
            if (completedSched > 0) {
                html += `<div style="font-size:11px;color:var(--dim);text-align:center;margin-top:6px;">
                    ${completedSched} completed scheduled task${completedSched>1?'s':''} hidden
                </div>`;
            }
        }

        // â”€â”€ SECTION 4: DELEGATED TASKS FOR FOLLOW-UP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const delegatedTasks = (this.data.tasks.delegated || []).filter(t => !t.done);
        html += `<div class="section-header" style="margin-top:28px;">
            <span>ðŸ¤ Delegated â€“ Follow Up</span>
            <button class="btn-sec" onclick="App.addDelegatedTask()" style="font-size:11px;padding:4px 10px;">+ Add</button>
        </div>`;
        
        if (delegatedTasks.length === 0) {
            html += `<div style="padding:16px;text-align:center;color:var(--dim);font-size:13px;background:var(--sub);border-radius:8px;margin-bottom:40px;">
                No delegated tasks awaiting follow-up.
            </div>`;
        } else {
            delegatedTasks.forEach(task => {
                const isOverdue = task.followUpDate && task.followUpDate < new Date().toISOString().split('T')[0];
                html += `<div class="task-row" style="${isOverdue ? 'border-left:3px solid #ff6b6b;' : 'border-left:3px solid var(--dim);'}">
                    <div style="flex:1;min-width:0;">
                        <div style="font-weight:600;font-size:13px;">${esc(task.title)}</div>
                        <div class="task-meta">
                            ${task.delegatedTo ? `<span>ðŸ‘¤ ${esc(task.delegatedTo)}</span>` : ''}
                            ${task.followUpDate ? `<span style="color:${isOverdue ? '#ff6b6b' : 'var(--dim)'};">${isOverdue ? 'âš ï¸ Overdue Â· ' : 'ðŸ“… '}${task.followUpDate}</span>` : ''}
                            ${task.notes ? `<span>${esc(task.notes)}</span>` : ''}
                        </div>
                    </div>
                    <div style="display:flex;gap:6px;align-items:center;">
                        <button class="btn-sec btn-success" onclick="App.completeDelegatedTask('${task.id}')" style="font-size:12px;padding:6px 10px;">âœ“</button>
                        <button class="btn-sec" onclick="App.deleteDelegatedTask('${task.id}')" style="font-size:11px;padding:4px 8px;opacity:0.5;">âœ•</button>
                    </div>
                </div>`;
            });
            html += `<div style="height:40px;"></div>`;
        }
        
        return html;
    },

    // VIEW: BUILD
    viewBuild() {
        if (!this.data.blueprintMeta) {
            return `<div class="card" style="text-align:center;padding:40px 20px;">
                <div style="font-size:48px;margin-bottom:12px;">ðŸ“œ</div>
                <div style="font-size:20px;font-weight:700;margin-bottom:8px;color:var(--accent);">Load Your 15-Year Vision</div>
                <div style="font-size:13px;color:var(--dim);margin-bottom:24px;">Import your master blueprint to begin execution.</div>
                <input type="file" id="bp-file" accept=".json" onchange="App.importBlueprint(event)" style="display:none;">
                <button class="btn" onclick="document.getElementById('bp-file').click()">Import Blueprint JSON</button>
            </div>`;
        }
        
        const meta = this.data.blueprintMeta;
        const sub = this.sub.build || 'aim';
        
        let html = `<div class="segment">
            <button class="segment-btn ${sub==='aim'?'active':''}" onclick="App.sub.build='aim';App.render()">Chief Aim</button>
            <button class="segment-btn ${sub==='goals'?'active':''}" onclick="App.sub.build='goals';App.render()">Goals</button>
            <button class="segment-btn ${sub==='affirmations'?'active':''}" onclick="App.sub.build='affirmations';App.render()">Affirmations</button>
            <button class="segment-btn ${sub==='bucketlist'?'active':''}" onclick="App.sub.build='bucketlist';App.render()">Bucket List</button>
            <button class="segment-btn ${sub==='stats'?'active':''}" onclick="App.sub.build='stats';App.render()">Stats</button>
        </div>`;
        
        if (sub === 'aim') {
            // FULL SCREEN CHIEF AIM
            html += `
                <div style="min-height:calc(100vh - 200px);display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;padding:0 20px;">
                    <div style="font-size:11px;color:var(--accent);text-transform:uppercase;letter-spacing:3px;margin-bottom:16px;font-weight:700;">DEFINITE CHIEF AIM</div>
                    <div style="font-size:18px;line-height:1.8;color:var(--zen);max-width:600px;white-space:pre-wrap;font-weight:400;">${esc(meta.vision)}</div>
                    <div style="margin-top:40px;font-size:12px;color:var(--dim);">â†“ Scroll for Blueprint Details</div>
                </div>
                
                <!-- BLUEPRINT DETAILS BELOW FOLD -->
                <div style="margin-top:60px;">
                    <div class="section-header"><span>Blueprint Overview</span></div>
                    <div class="card" style="border-left:4px solid var(--accent);">
                        <div style="font-size:18px;font-weight:700;color:var(--accent);margin-bottom:8px;">${esc(meta.name)}</div>
                        <div style="font-size:13px;color:var(--dim);">${meta.years} Years | ${meta.totalCycles} Cycles</div>
                    </div>
                    
                    <div class="stat-grid">
                        <div class="stat-box"><div class="stat-val">${this.data.allCycles.length}</div><div class="stat-label">Total Cycles</div></div>
                        <div class="stat-box"><div class="stat-val">${this.data.currentCycle?.number || 0}</div><div class="stat-label">Current Cycle</div></div>
                        <div class="stat-box"><div class="stat-val">${this.data.cycleHistory?.length || 0}</div><div class="stat-label">Completed</div></div>
                        <div class="stat-box"><div class="stat-val">${meta.totalCycles - (this.data.currentCycle?.number || 0)}</div><div class="stat-label">Remaining</div></div>
                    </div>
                    
                    <div class="section-header"><span>Domains</span></div>
                    ${Object.entries(meta.domains || {}).map(([key, domain]) => `
                        <div class="card" style="border-left:4px solid ${domain.color};">
                            <div style="font-weight:700;color:${domain.color};">${esc(domain.name)}</div>
                            ${domain.description ? `<div style="font-size:13px;color:var(--dim);margin-top:4px;">${esc(domain.description)}</div>` : ''}
                        </div>
                    `).join('')}
                </div>
            `;
        } else if (sub === 'goals') {
            html += `<div class="section-header"><span>Goals</span></div>`;
            
            // Goals UI
            if (!this.data.goals || this.data.goals.length === 0) {
                html += `
                    <div class="empty-state">
                        <div class="empty-state-icon">ðŸŽ¯</div>
                        <p>No goals yet. Set 3-5 major goals aligned with your Chief Aim.</p>
                        <button class="btn" onclick="App.addGoal()" style="max-width:240px;margin:20px auto 0;">
                            Add First Goal
                        </button>
                    </div>
                `;
            } else {
                html += `
                    <button class="btn mb-2" onclick="App.addGoal()">+ Add Goal</button>
                    <div style="font-size:12px;color:var(--dim);margin-bottom:16px;">
                        Add 3-5 major long-term goals aligned with your Chief Aim
                    </div>
                `;
                
                this.data.goals.forEach(goal => {
                    const expanded = goal.expanded || false;
                    const subgoals = goal.subgoals || [];
                    const completedSubs = subgoals.filter(s => s.done).length;
                    
                    html += `
                        <div class="goal-card ${expanded ? 'expanded' : ''}" onclick="App.toggleGoal('${goal.id}')">
                            <div style="display:flex;justify-content:space-between;align-items:flex-start;">
                                <div style="font-weight:700;font-size:16px;line-height:1.4;flex:1;">${esc(goal.title)}</div>
                                <div style="font-size:20px;color:${expanded ? 'var(--accent)' : 'var(--dim)'};
                                     transition:transform 0.2s;transform:rotate(${expanded ? '180deg' : '0deg'});">â–¼</div>
                            </div>
                            
                            ${expanded ? `
                                <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border);">
                                    <div style="display:flex;gap:12px;margin:12px 0;flex-wrap:wrap;">
                                        ${goal.timeline ? `
                                            <div style="min-width:120px;">
                                                <div style="font-size:10px;color:var(--dim);text-transform:uppercase;
                                                     letter-spacing:1px;margin-bottom:4px;">Timeline</div>
                                                <div style="font-weight:600;font-size:14px;">${esc(goal.timeline)}</div>
                                            </div>
                                        ` : ''}
                                        ${goal.domain ? `
                                            <div style="min-width:120px;">
                                                <div style="font-size:10px;color:var(--dim);text-transform:uppercase;
                                                     letter-spacing:1px;margin-bottom:4px;">Domain</div>
                                                <div style="font-weight:600;font-size:14px;">${esc(goal.domain)}</div>
                                            </div>
                                        ` : ''}
                                        ${goal.metrics ? `
                                            <div style="min-width:120px;">
                                                <div style="font-size:10px;color:var(--dim);text-transform:uppercase;
                                                     letter-spacing:1px;margin-bottom:4px;">Success Metric</div>
                                                <div style="font-weight:600;font-size:14px;">${esc(goal.metrics)}</div>
                                            </div>
                                        ` : ''}
                                    </div>
                                    
                                    <div style="margin-top:16px;">
                                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                                            <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;">
                                                Subgoals (${completedSubs}/${subgoals.length})
                                            </div>
                                            <button class="btn-sec" onclick="event.stopPropagation();App.addSubgoal('${goal.id}')">
                                                + Add
                                            </button>
                                        </div>
                                        ${subgoals.length > 0 ? `
                                            <div style="margin-top:12px;">
                                                ${subgoals.map(sub => `
                                                    <div style="padding:10px;background:var(--void);border-radius:8px;
                                                         margin-bottom:6px;display:flex;justify-content:space-between;
                                                         align-items:center;gap:8px;">
                                                        <div class="checkbox ${sub.done ? 'checked' : ''}" 
                                                             onclick="event.stopPropagation();App.toggleSubgoal('${goal.id}','${sub.id}')">
                                                        </div>
                                                        <div style="flex:1;${sub.done ? 'text-decoration:line-through;opacity:0.5;' : ''}">${esc(sub.title)}</div>
                                                        <button class="btn-sec btn-danger" style="padding:4px 8px;" 
                                                                onclick="event.stopPropagation();App.deleteSubgoal('${goal.id}','${sub.id}')">
                                                            &times;
                                                        </button>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        ` : `
                                            <div style="text-align:center;padding:12px;color:var(--dim);font-size:13px;">
                                                No subgoals yet
                                            </div>
                                        `}
                                    </div>
                                    
                                    <!-- GOAL STAGES SECTION -->
                                    ${goal.stages && goal.stages.length > 0 ? `
                                        <div style="margin-top:20px;padding-top:16px;border-top:1px solid var(--border);">
                                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                                                <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;">
                                                    Stages (${goal.stages.filter(s => s.completed).length}/${goal.stages.length})
                                                </div>
                                            </div>
                                            <div style="margin-top:12px;">
                                                ${goal.stages.map(stage => `
                                                    <div style="padding:12px;background:var(--void);border-radius:8px;
                                                         margin-bottom:8px;border-left:3px solid ${stage.completed ? 'var(--success)' : 'var(--accent)'};">
                                                        <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:6px;">
                                                            <div style="flex:1;">
                                                                <div style="font-weight:600;${stage.completed ? 'text-decoration:line-through;opacity:0.6;' : ''}">${esc(stage.title)}</div>
                                                                ${stage.target ? `<div style="font-size:11px;color:var(--dim);margin-top:4px;">ðŸŽ¯ Target: ${new Date(stage.target).toLocaleDateString()}</div>` : ''}
                                                                ${stage.description ? `<div style="font-size:12px;color:var(--dim);margin-top:6px;">${esc(stage.description)}</div>` : ''}
                                                            </div>
                                                        </div>
                                                        <div style="display:flex;gap:6px;margin-top:8px;">
                                                            <button class="btn-sec ${stage.completed ? '' : 'btn-success'}" 
                                                                    onclick="event.stopPropagation();App.toggleGoalStage('${goal.id}','${stage.id}')"
                                                                    style="font-size:11px;padding:4px 10px;">
                                                                ${stage.completed ? 'â—¯ Reopen' : 'âœ“ Complete'}
                                                            </button>
                                                            <button class="btn-sec btn-danger" style="padding:4px 10px;font-size:11px;" 
                                                                    onclick="event.stopPropagation();App.deleteGoalStage('${goal.id}','${stage.id}')">
                                                                Delete
                                                            </button>
                                                        </div>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    ` : ''}
                                    
                                    ${(() => {
                                        // â”€â”€ INTEGRATION: Surface linked Leverage items â”€â”€
                                        const leverage = this.data.vaultEarn?.leverage || [];
                                        const linked = leverage.filter(l =>
                                            !l.completed && (
                                                l.linkedGoal === goal.title ||
                                                (goal.domain && l.linkedDomain === goal.domain)
                                            )
                                        );
                                        if (linked.length === 0) return '';
                                        const lColor = 'var(--accent)';
                                        return `
                                        <div style="margin-top:16px;padding-top:14px;border-top:1px solid var(--border);">
                                            <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:${lColor};margin-bottom:8px;">ðŸ”— Active Leverage (${linked.length})</div>
                                            ${linked.slice(0,3).map(l => `
                                                <div style="padding:8px 10px;background:var(--void);border-radius:8px;margin-bottom:6px;border-left:2px solid ${lColor};">
                                                    <div style="font-size:12px;font-weight:600;">${esc(l.title)}</div>
                                                    ${l.content ? `<div style="font-size:11px;color:var(--dim);margin-top:2px;">${esc(l.content.substring(0,80))}${l.content.length>80?'â€¦':''}</div>` : ''}
                                                </div>
                                            `).join('')}
                                            ${linked.length > 3 ? `<div style="font-size:11px;color:var(--dim);margin-top:4px;">+${linked.length-3} more in Vault â†’ EARN â†’ Leverage</div>` : ''}
                                        </div>`;
                                    })()}

                                    <div style="display:flex;gap:8px;margin-top:16px;">
                                        <button class="btn-sec" onclick="event.stopPropagation();App.editGoal('${goal.id}')">
                                            Edit
                                        </button>
                                        <button class="btn-sec btn-danger" onclick="event.stopPropagation();App.deleteGoal('${goal.id}')">
                                            Delete
                                        </button>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
            }
        } else if (sub === 'affirmations') {
            html += `<div class="section-header"><span>Affirmations</span><button class="btn-sec" onclick="App.addAffirmation()">+</button></div>`;
            const affs = this.data.plan.affirmations || [];
            if (affs.length === 0) {
                html += `<div class="empty-state"><div class="empty-state-icon">âœ¨</div><p>No affirmations yet</p></div>`;
            } else {
                affs.forEach(aff => {
                    html += `<div class="card" style="border-left:3px solid var(--accent);">
                        <div style="font-weight:700;">${esc(aff.text)}</div>
                        ${aff.timestamp ? `<div class="task-meta" style="margin-top:8px;">${new Date(aff.timestamp).toLocaleDateString()}</div>` : ''}
                        <button class="btn-sec btn-danger" onclick="App.deleteAffirmation('${aff.id}')" style="margin-top:8px;font-size:11px;">Delete</button>
                    </div>`;
                });
            }
        } else if (sub === 'bucketlist') {
            html += `<div class="section-header"><span>Bucket List</span><button class="btn-sec" onclick="App.addBucketItem()">+</button></div>`;
            const items = this.data.plan.bucketList || [];
            if (items.length === 0) {
                html += `<div class="empty-state"><div class="empty-state-icon">ðŸª£</div><p>No bucket list items yet</p></div>`;
            } else {
                items.forEach(item => {
                    html += `<div class="card" style="border-left:3px solid ${item.done?'var(--success)':'var(--blue)'};">
                        <div style="display:flex;justify-content:space-between;align-items:start;">
                            <div style="flex:1;">
                                <div style="font-weight:700;${item.done?'text-decoration:line-through;color:var(--dim);':''}">${esc(item.title)}</div>
                                ${item.description ? `<div style="color:var(--dim);font-size:13px;margin-top:4px;">${esc(item.description)}</div>` : ''}
                            </div>
                            ${item.done ? `<span style="color:var(--success);font-size:18px;">âœ“</span>` : ''}
                        </div>
                        <div style="display:flex;gap:6px;margin-top:8px;">
                            ${!item.done ? `<button class="btn-sec btn-success" onclick="App.toggleBucketItem('${item.id}')">âœ“ Done</button>` : `<button class="btn-sec" onclick="App.toggleBucketItem('${item.id}')">Undo</button>`}
                            <button class="btn-sec btn-danger" onclick="App.deleteBucketItem('${item.id}')" style="margin-left:auto;">Delete</button>
                        </div>
                    </div>`;
                });
            }
        } else if (sub === 'stats') {
            html += `<div class="section-header"><span>Blueprint Stats</span></div>`;
            
            html += `<div class="card" style="background:linear-gradient(135deg,rgba(10,132,255,0.1),rgba(10,132,255,0.05));border:1px solid rgba(10,132,255,0.3);">
                <div style="font-size:16px;font-weight:700;margin-bottom:12px;color:var(--blue);">ðŸ¤– Create Custom Blueprint</div>
                <p style="font-size:13px;color:var(--dim);margin-bottom:16px;line-height:1.5;">
                    Use AI to generate your personalized 15-year blueprint with 60 cycles, tasks, habits, and milestones. 
                    Takes just 5 minutes!
                </p>
                <button class="btn" style="background:var(--blue);color:var(--text);" 
                    onclick="App.tab=3;App.sub.system='custom';App.render()">
                    âœ¨ Generate with AI
                </button>
            </div>`;
        }
        
        return html;
    },

    // VIEW: STRATEGY
    viewStrategy() {
        if (!this.data.currentCycle) {
            return `<div class="card" style="text-align:center;padding:36px 20px;">
                <div style="font-size:14px;margin-bottom:16px;color:var(--dim);">No active cycle</div>
                ${this.data.allCycles && this.data.allCycles.length > 0 ? 
                    `<button class="btn" onclick="App.loadNextCycle()">âš¡ Start First Cycle</button>` : 
                    `<p style="color:var(--dim);margin-bottom:16px;">Import blueprint first from BUILD tab</p>
                    <input type="file" id="bp-file-2" accept=".json" onchange="App.importBlueprint(event)" style="display:none;">
                    <button class="btn" onclick="document.getElementById('bp-file-2').click()">Import Blueprint</button>`}
            </div>`;
        }
        
        const c = this.data.currentCycle;
        const tasks = c.tasks || [];
        const week = this.sub._viewedWeek || this.getCurrentWeek();
        let weekTasks = tasks.filter(t => t.week === week);
        
        // Apply filters
        weekTasks = this.filterTasks(weekTasks);
        
        const weekPending = weekTasks.filter(t => !t.done);
        const weekDone = weekTasks.filter(t => t.done);
        const allDone = tasks.filter(t => t.done).length;
        const pct = tasks.length > 0 ? Math.round((allDone / tasks.length) * 100) : 0;
        
        let html = `
            <div class="card" style="background:linear-gradient(135deg,#1c1c1e,#252527);">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                    <div>
                        <div style="font-size:10px;color:var(--accent);text-transform:uppercase;letter-spacing:1px;">Current Cycle</div>
                        <div style="font-size:18px;font-weight:700;color:var(--accent);">${esc(c.title)}</div>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-size:10px;color:var(--accent);text-transform:uppercase;letter-spacing:1px;">Week</div>
                        <div style="font-size:18px;font-weight:700;">${week}<span style="color:var(--dim);font-size:14px;">/13</span></div>
                    </div>
                </div>
                <div class="progress-bar"><div class="progress-fill" style="width:${(week/13)*100}%"></div></div>
            </div>
            
            <div class="stat-grid">
                <div class="stat-box"><div class="stat-val">${weekPending.length}</div><div class="stat-label">This Week</div></div>
                <div class="stat-box"><div class="stat-val" style="color:var(--success)">${pct}%</div><div class="stat-label">Cycle Done</div></div>
            </div>
            
            <div class="section-header">
                <span>Focus â€¢ Week ${week}</span>
                <div style="display:flex;gap:6px;">
                    <button class="btn-sec" onclick="App.changeWeek(-1)" ${week <= 1 ? 'disabled style="opacity:0.3;"' : ''}>â—€</button>
                    <button class="btn-sec" onclick="App.changeWeek(1)" ${week >= 13 ? 'disabled style="opacity:0.3;"' : ''}>â–¶</button>
                </div>
            </div>
            
            ${this.renderTaskFilters()}
        `;

        // â”€â”€ EARN STRATEGY CONTEXT PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        html += this.renderStrategyContext(c);
        
        if (weekPending.length === 0 && weekDone.length === 0) {
            html += `<div class="empty-state">
                <div class="empty-state-icon">âœ¨</div>
                <p>No tasks for week ${week}</p>
                <button class="btn-sec" onclick="App.addWeekTask(${week})" style="margin-top:12px;">+ Add Task</button>
            </div>`;
        } else {
            // PENDING TASKS
            if (weekPending.length > 0) {
                weekPending.forEach(task => {
                    html += `<div class="task-row" onclick="App.viewTaskDetail('${task.id}')">
                        <div style="flex:1;min-width:0;">
                            <div style="font-weight:600;word-break:break-word;">${esc(task.title)}</div>
                            <div class="task-meta">
                                ${task.duration ? `â± ${task.duration}m` : ''}
                                <span>Week ${task.week}</span>
                            </div>
                        </div>
                        <button class="btn-sec btn-success" onclick="event.stopPropagation();App.toggleTask('${task.id}')">âœ“</button>
                    </div>`;
                });
            }
            
            // COMPLETED TASKS
            if (weekDone.length > 0) {
                html += `<div class="section-header" style="margin-top:18px;"><span>Completed</span></div>`;
                weekDone.forEach(task => {
                    html += `<div class="task-row done">
                        <div style="flex:1;min-width:0;">
                            <div style="font-weight:600;color:var(--dim);">${esc(task.title)}</div>
                        </div>
                        <span style="color:var(--success);font-size:16px;">âœ“</span>
                    </div>`;
                });
            }
            
            html += `<button class="btn-sec" onclick="App.addWeekTask(${week})" style="width:100%;margin-top:12px;">+ Add Task to Week ${week}</button>`;
        }
        
        // DOMAIN FOCUS VISUALIZATION
        html += this.renderDomainFocus();
        
        // CYCLE ACTIONS
        html += `
            <div style="margin-top:24px;padding-top:24px;border-top:1px solid var(--border);">
                <div class="section-header"><span>Cycle Management</span></div>
                
                ${c.milestones && c.milestones.length > 0 ? `
                <div class="card" style="margin-bottom:12px;">
                    <div style="font-size:10px;color:var(--accent);text-transform:uppercase;margin-bottom:8px;letter-spacing:1px;">Milestones</div>
                    ${c.milestones.map(m => `<div style="padding:8px 10px;background:var(--sub);border-radius:8px;margin-top:6px;font-size:13px;border-left:3px solid var(--accent);">âœ“ ${esc(m)}</div>`).join('')}
                </div>` : ''}
                
                <div style="display:flex;gap:8px;flex-wrap:wrap;">
                    ${this.data.allCycles && c.number > 1 ? `<button class="btn-sec" onclick="App.jumpToCycle(${c.number - 1})">â† Prev Cycle</button>` : ''}
                    <button class="btn-sec" onclick="App.showAllCycles()">All Cycles</button>
                    ${this.data.allCycles && c.number < this.data.blueprintMeta.totalCycles ? `<button class="btn-sec" style="background:var(--accent);color:var(--void);" onclick="App.loadNextCycle()">Next Cycle â†’</button>` : ''}
                    <button class="btn-sec btn-danger" onclick="App.completeCycle()" style="margin-left:auto;">Complete Cycle</button>
                </div>
            </div>
        `;
        
        // CYCLE HISTORY
        if (this.data.cycleHistory && this.data.cycleHistory.length > 0) {
            html += `<div class="section-header" style="margin-top:24px;"><span>History</span></div>`;
            this.data.cycleHistory.slice(0, 3).forEach(ch => {
                const rate = ch.tasks?.length > 0 ? Math.round((ch.tasks.filter(t=>t.done).length||0)/ch.tasks.length*100) : 0;
                html += `<div class="card" style="border-left:3px solid var(--success);">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <div>
                            <div style="font-size:10px;color:var(--dim);">Cycle #${ch.number}</div>
                            <div style="font-size:16px;font-weight:700;">${esc(ch.title)}</div>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-size:20px;font-weight:700;color:var(--success);">${rate}%</div>
                            <div style="font-size:10px;color:var(--dim);">complete</div>
                        </div>
                    </div>
                </div>`;
            });
        }
        
        return html;
    },

    // VIEW: SYSTEM
    viewSystem() {
        if (!this.data.system) this.data.system = { habits: [], reflections: { morning: [], evening: [] }, journal: [], reviews: [] };
        
        const sub = this.sub.system || 'reflections';
        const tabs = [
            { key:'reflections', label:'Reflect' },
            { key:'habits',      label:'Habits' },
            { key:'journal',     label:'Journal' },
            { key:'reviews',     label:'Reviews' },
            { key:'custom',      label:'Blueprint' },
            { key:'settings',    label:'âš™ï¸' },
        ];
        let html = `
        <div style="display:flex;border-bottom:1px solid var(--zen-border);margin-bottom:0;">
            ${tabs.map(t => `
            <button onclick="App.sub.system='${t.key}';App.render()"
                style="flex:1;padding:12px 4px;background:transparent;border:none;
                       border-bottom:2px solid ${sub===t.key?'rgba(245,240,232,0.5)':'transparent'};
                       margin-bottom:-1px;
                       color:${sub===t.key?'rgba(245,240,232,0.9)':'var(--zen-stone)'};
                       font-family:var(--font);font-size:9px;letter-spacing:2px;
                       text-transform:uppercase;cursor:pointer;transition:all 0.25s;">
                ${t.label}
            </button>`).join('')}
        </div>`;
        
        if (sub === 'settings') {
            html += this.viewSystemSettings();
        } else if (sub === 'reflections') {
            html += this.renderReflections();
        } else if (sub === 'habits') {
            html += this.renderHabitTracker();
        } else if (sub === 'journal') {
            html += this.renderJournal();
        } else if (sub === 'reviews') {
            html += this.renderReviews();
        } else if (sub === 'custom') {
            const d = this.customBlueprintData || this.getEmptyCustomBlueprintData();
            
            html += `
                <div class="info-box">
                    <div style="font-weight:700;font-size:15px;margin-bottom:8px;color:var(--blue);">ðŸ¤– Custom Blueprint Generator</div>
                    <p style="font-size:12px;color:var(--dim);line-height:1.6;">
                        Fill in your personal data below, then click "Generate Custom Prompt" to create a personalized AI prompt. 
                        Copy the prompt, paste it into ChatGPT or Claude, and get your complete 60-cycle blueprint in JSON format.
                    </p>
                </div>

                <div class="card">
                    <div style="display:flex;align-items:center;margin-bottom:20px;">
                        <span class="step-number">1</span>
                        <span style="font-weight:700;font-size:16px;">Fill Your Data</span>
                    </div>

                    <label>Your Name</label>
                    <div class="helper-text">Enter your full name or preferred identifier (e.g., "SvK", "John Smith")</div>
                    <input type="text" id="custom-name" placeholder="e.g., SvK" value="${esc(d.name)}">

                    <label>15-Year Vision Statement</label>
                    <div class="helper-text">Describe your ultimate life vision - what you want to achieve in 15 years. Be specific, ambitious, and authentic.</div>
                    <textarea id="custom-vision" placeholder="I will become... In return, I will give... My legacy will be...">${esc(d.vision)}</textarea>

                    <label>Timeline (Years)</label>
                    <div class="helper-text">Number of years for your blueprint (typically 15)</div>
                    <input type="number" id="custom-years" placeholder="15" value="${esc(d.years)}" min="1" max="30">

                    <label>Domain 1 - Primary Focus Area</label>
                    <div class="helper-text">Your main life domain (e.g., "Hollywood Career", "Tech Entrepreneurship", "Financial Independence")</div>
                    <input type="text" id="custom-domain1" placeholder="e.g., Hollywood Superstar Career" value="${esc(d.domain1)}">

                    <label>Domain 2 - Secondary Focus Area</label>
                    <div class="helper-text">Second important area of life (e.g., "Wealth Building", "Health & Fitness", "Relationships")</div>
                    <input type="text" id="custom-domain2" placeholder="e.g., Subscriber Base & Net Worth" value="${esc(d.domain2)}">

                    <label>Domain 3 - Tertiary Focus Area</label>
                    <div class="helper-text">Third area of focus (e.g., "Global Impact", "Creative Projects", "Family Legacy")</div>
                    <input type="text" id="custom-domain3" placeholder="e.g., Global Education System" value="${esc(d.domain3)}">

                    <label>Key Milestone 1 (Early Phase)</label>
                    <div class="helper-text">A major milestone you'll achieve in the first 1-3 years</div>
                    <input type="text" id="custom-milestone1" placeholder="e.g., Secure professional acting representation" value="${esc(d.milestone1)}">

                    <label>Key Milestone 2 (Mid Phase)</label>
                    <div class="helper-text">A major milestone you'll achieve in years 4-8</div>
                    <input type="text" id="custom-milestone2" placeholder="e.g., Land lead role in major production" value="${esc(d.milestone2)}">

                    <label>Key Milestone 3 (Late Phase)</label>
                    <div class="helper-text">A major milestone you'll achieve in years 9-15</div>
                    <input type="text" id="custom-milestone3" placeholder="e.g., Establish global academy network" value="${esc(d.milestone3)}">

                    <label>Daily Habit 1</label>
                    <div class="helper-text">A core daily practice that supports your vision</div>
                    <input type="text" id="custom-habit1" placeholder="e.g., 2-hour acting practice daily" value="${esc(d.habit1)}">

                    <label>Daily Habit 2</label>
                    <div class="helper-text">Second essential daily habit</div>
                    <input type="text" id="custom-habit2" placeholder="e.g., Physical training 6 days/week" value="${esc(d.habit2)}">

                    <label>Daily Habit 3</label>
                    <div class="helper-text">Third daily habit for sustained success</div>
                    <input type="text" id="custom-habit3" placeholder="e.g., Meditation 30 minutes daily" value="${esc(d.habit3)}">
                </div>

                <div class="card">
                    <div style="display:flex;align-items:center;margin-bottom:16px;">
                        <span class="step-number">2</span>
                        <span style="font-weight:700;font-size:16px;">Generate AI Prompt</span>
                    </div>
                    <button class="btn" onclick="App.generateCustomPrompt()">âœ¨ Generate Custom Prompt</button>
                </div>

                ${this.customPrompt ? `
                    <div class="card">
                        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
                            <div style="display:flex;align-items:center;">
                                <span class="step-number">3</span>
                                <span style="font-weight:700;font-size:16px;">Your Custom Prompt</span>
                            </div>
                            <button class="btn-sec" onclick="App.copyPromptToClipboard()">ðŸ“‹ Copy</button>
                        </div>
                        <div class="prompt-box" id="custom-prompt">${esc(this.customPrompt)}</div>
                    </div>

                    <div class="warning-box">
                        <div style="font-weight:700;margin-bottom:8px;color:var(--warn);">âš ï¸ Next Steps:</div>
                        <ol style="font-size:12px;color:var(--dim);line-height:1.8;padding-left:20px;">
                            <li>Copy the prompt above (click "ðŸ“‹ Copy" button)</li>
                            <li>Open ChatGPT (GPT-4) or Claude (Sonnet/Opus)</li>
                            <li>Paste the entire prompt</li>
                            <li>AI will generate your complete 60-cycle blueprint in JSON</li>
                            <li>Copy the JSON output</li>
                            <li>Go to BUILD â†’ Stats â†’ Import Blueprint</li>
                            <li>Paste JSON and start executing!</li>
                        </ol>
                    </div>
                ` : ''}

                <div class="info-box" style="margin-top:20px;">
                    <div style="font-weight:700;margin-bottom:8px;color:var(--blue);">ðŸ’¡ Pro Tips:</div>
                    <ul style="font-size:12px;color:var(--dim);line-height:1.8;padding-left:20px;">
                        <li>Be specific in your vision - the more detailed, the better the AI blueprint</li>
                        <li>Include concrete numbers and timelines in milestones</li>
                        <li>Choose habits that directly support your domains</li>
                        <li>Use ChatGPT-4 or Claude Opus for best results</li>
                        <li>Review the generated JSON before importing - you can edit it</li>
                        <li>Save your generated JSON as backup before importing</li>
                    </ul>
                </div>
            `;
        }
        
        return html;
    },
    
    // VIEW: SYSTEM SETTINGS
    viewSystemSettings() {
        const isPWAInstalled = window.matchMedia('(display-mode: standalone)').matches || 
                               window.navigator.standalone || 
                               document.referrer.includes('android-app://');
        
        let html = `
            <div class="section-header">
                <span>âš™ï¸ App Settings</span>
            </div>
            
            <!-- PWA Installation Card -->
            <div style="background:var(--card);border-radius:12px;padding:20px;margin-bottom:16px;border:1px solid var(--border);">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
                    <div style="font-size:32px;">ðŸ“±</div>
                    <div style="flex:1;">
                        <div style="font-size:16px;font-weight:700;margin-bottom:4px;">Install as App</div>
                        <div style="font-size:12px;color:var(--dim);">
                            ${isPWAInstalled ? 
                                'âœ“ App is already installed' : 
                                'Install SVK Blueprint on your device for offline access and app-like experience'}
                        </div>
                    </div>
                </div>
                
                ${!isPWAInstalled ? `
                    <button class="btn-primary" onclick="App.installPWA()" 
                            style="width:100%;padding:12px;font-size:14px;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        ðŸ“± Install App
                    </button>
                    <div style="margin-top:12px;font-size:11px;color:var(--dim);line-height:1.5;">
                        ${window.location.protocol === 'file:' ? `
                            <strong style="color:var(--warn);">Note:</strong> PWA installation requires hosting on a web server (HTTPS).<br><br>
                            <strong>For now, use browser's built-in "Add to Home Screen":</strong><br>
                            â€¢ <strong>iOS Safari:</strong> Tap Share â†’ Add to Home Screen<br>
                            â€¢ <strong>Android Chrome:</strong> Menu (â‹®) â†’ Install app<br>
                            â€¢ <strong>Desktop Chrome:</strong> Address bar install icon or Settings â†’ Install<br><br>
                            Or deploy to: GitHub Pages, Netlify, Vercel, or any HTTPS server
                        ` : `
                            <strong>Benefits:</strong><br>
                            â€¢ Works offline<br>
                            â€¢ Fast app-like performance<br>
                            â€¢ Home screen icon<br>
                            â€¢ No browser UI distractions<br><br>
                            <em>Note: If button doesn't work, use browser menu â†’ Install app or Add to Home Screen</em>
                        `}
                    </div>
                ` : `
                    <div style="padding:12px;background:var(--sub);border-radius:8px;text-align:center;">
                        <div style="font-size:32px;margin-bottom:8px;">âœ“</div>
                        <div style="font-size:14px;color:var(--success);font-weight:600;">App Installed Successfully</div>
                    </div>
                `}
            </div>
            
            <!-- Data Management Card -->
            <div style="background:var(--card);border-radius:12px;padding:20px;margin-bottom:16px;border:1px solid var(--border);">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
                    <div style="font-size:32px;">ðŸ’¾</div>
                    <div style="flex:1;">
                        <div style="font-size:16px;font-weight:700;margin-bottom:4px;">Data Management</div>
                        <div style="font-size:12px;color:var(--dim);">Export, import, and manage your data</div>
                    </div>
                </div>
                
                <div style="display:grid;gap:8px;">
                    <button class="btn-sec" onclick="App.exportAllData()" style="padding:10px;">
                        ðŸ“¤ Export All Data (JSON)
                    </button>
                    <button class="btn-sec" onclick="App.exportToCSV()" style="padding:10px;">
                        ðŸ“Š Export to CSV
                    </button>
                    <button class="btn-sec" onclick="App.importAllData()" style="padding:10px;">
                        ðŸ“¥ Import Data (JSON)
                    </button>
                    <button class="btn-sec" onclick="App.resetBlueprint()" 
                            style="padding:10px;background:var(--danger);opacity:0.8;">
                        ðŸ”„ Reset Blueprint
                    </button>
                    <button class="btn-sec" onclick="App.confirm('Clear all data? This cannot be undone!', () => { localStorage.clear(); location.reload(); }, 'Clear All')" 
                            style="padding:10px;background:var(--danger);opacity:0.8;">
                        ðŸ—‘ï¸ Clear All Data
                    </button>
                </div>
            </div>
            
            <!-- App Info Card -->
            <div style="background:var(--card);border-radius:12px;padding:20px;border:1px solid var(--border);">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
                    <div style="font-size:32px;">â„¹ï¸</div>
                    <div style="flex:1;">
                        <div style="font-size:16px;font-weight:700;margin-bottom:4px;">App Information</div>
                        <div style="font-size:12px;color:var(--dim);">Version and system details</div>
                    </div>
                </div>
                
                <div style="display:grid;gap:8px;font-size:12px;margin-bottom:16px;">
                    <div style="display:flex;justify-content:space-between;padding:8px;background:var(--sub);border-radius:6px;">
                        <span style="color:var(--dim);">Version</span>
                        <span style="font-weight:600;">v${APP_VERSION}</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;padding:8px;background:var(--sub);border-radius:6px;">
                        <span style="color:var(--dim);">Build Date</span>
                        <span style="font-weight:600;">February 14, 2026</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;padding:8px;background:var(--sub);border-radius:6px;">
                        <span style="color:var(--dim);">PWA Status</span>
                        <span style="font-weight:600;color:${isPWAInstalled ? 'var(--success)' : 'var(--warn)'};">
                            ${isPWAInstalled ? 'âœ“ Installed' : 'â—‹ Not Installed'}
                        </span>
                    </div>
                    <div style="display:flex;justify-content:space-between;padding:8px;background:var(--sub);border-radius:6px;">
                        <span style="color:var(--dim);">Service Worker</span>
                        <span style="font-weight:600;color:${navigator.serviceWorker?.controller ? 'var(--success)' : 'var(--warn)'};">
                            ${navigator.serviceWorker?.controller ? 'âœ“ Active' : 'â—‹ Inactive'}
                        </span>
                    </div>
                </div>
                
                <button class="btn-sec" onclick="App.showUpdateInstructions()" 
                        style="width:100%;padding:10px;font-size:13px;">
                    ðŸ”„ Check for Updates
                </button>
            </div>
        `;
        
        return html;
    },

    // VIEW: VAULT â€” Zen redesign
viewVault() {
    if (!this.data.vaultLearn) this.data.vaultLearn = { ideas: [], notes: [], books: [], skills: [] };
    if (!this.data.vaultEarn) this.data.vaultEarn = { strat: [], exec: [], leverage: [], contacts: [] };
    if (!this.data.vaultPromotions) this.data.vaultPromotions = [];
    if (!this.data.vaultSettings) this.data.vaultSettings = { viewMode: 'card', sortBy: 'recent', showAnalytics: false, searchQuery: '', activeFilters: [], selectedTags: [], dateRange: { start: null, end: null }, importanceFilter: [], starredOnly: false, pinnedOnly: false, batchMode: false, selectedItems: [], categoryColors: {}, showFilters: false };

    const mainTab = this.sub.vaultMain || 'learn';

    let html = `<div style="padding-top: 4px;">`;

    // Main switcher â€” LEARN / EARN
    html += `
        <div class="vault-main-switcher">
            <button class="vault-main-btn ${mainTab === 'learn' ? 'active' : ''}"
                onclick="App.sub.vaultMain='learn';App.sub.vault='ideas';App.data.vaultSettings.searchQuery='';App.render()">
                Learn
            </button>
            <button class="vault-main-btn ${mainTab === 'earn' ? 'active' : ''}"
                onclick="App.sub.vaultMain='earn';App.sub.vault='strat';App.data.vaultSettings.searchQuery='';App.render()">
                Earn
            </button>
        </div>`;

    if (mainTab === 'learn') {
        const sub = this.sub.vault || 'ideas';
        html += `
            <div class="vault-sub-nav">
                <button class="vault-sub-btn ${sub === 'ideas' ? 'active' : ''}" onclick="App.sub.vault='ideas';App.data.vaultSettings.searchQuery='';App.render()">Ideas</button>
                <button class="vault-sub-btn ${sub === 'notes' ? 'active' : ''}" onclick="App.sub.vault='notes';App.data.vaultSettings.searchQuery='';App.render()">Notes</button>
                <button class="vault-sub-btn ${sub === 'books' ? 'active' : ''}" onclick="App.sub.vault='books';App.data.vaultSettings.searchQuery='';App.render()">Books</button>
                <button class="vault-sub-btn ${sub === 'skills' ? 'active' : ''}" onclick="App.sub.vault='skills';App.data.vaultSettings.searchQuery='';App.render()">Skills</button>
            </div>`;
        html += this.renderLearnSectionEnhanced(sub);
    } else {
        const sub = this.sub.vault || 'strat';
        html += `
            <div class="vault-sub-nav">
                <button class="vault-sub-btn ${sub === 'strat' ? 'active' : ''}" onclick="App.sub.vault='strat';App.data.vaultSettings.searchQuery='';App.render()">Strategy</button>
                <button class="vault-sub-btn ${sub === 'exec' ? 'active' : ''}" onclick="App.sub.vault='exec';App.data.vaultSettings.searchQuery='';App.render()">Execute</button>
                <button class="vault-sub-btn ${sub === 'leverage' ? 'active' : ''}" onclick="App.sub.vault='leverage';App.data.vaultSettings.searchQuery='';App.render()">Leverage</button>
                <button class="vault-sub-btn ${sub === 'contacts' ? 'active' : ''}" onclick="App.sub.vault='contacts';App.data.vaultSettings.searchQuery='';App.render()">Contacts</button>
            </div>`;
        html += this.renderEarnSectionEnhanced(sub);
    }

    html += `</div>`;
    return html;
},

// ENHANCED LEARN SECTION RENDERING
renderLearnSectionEnhanced(sub) {
    let html = '';
    let items = this.data.vaultLearn[sub] || [];
    const settings = this.data.vaultSettings;

    const meta = {
        ideas:  { kanji: 'æ€æƒ³ Â· ShisÅ',   title: 'Ideas',  desc: 'seeds of original thought'         },
        notes:  { kanji: 'è¦³å¯Ÿ Â· Kansatsu', title: 'Notes',  desc: 'observations, raw and unfolded'     },
        books:  { kanji: 'çŸ¥è­˜ Â· Chishiki', title: 'Books',  desc: 'compressed wisdom from other minds' },
        skills: { kanji: 'æŠ€ Â· Waza',       title: 'Skills', desc: 'the path of deliberate practice'    }
    };
    const m = meta[sub] || { kanji: '', title: sub, desc: '' };

    // Section header
    html += `
        <div class="vault-section-header">
            <div class="vault-section-kanji">${m.kanji}</div>
            <div class="vault-section-title">${m.title}</div>
            <div class="vault-section-desc">${m.desc}</div>
        </div>
    `;

    // Toolbar
    html += `
        <div class="vault-toolbar">
            <input type="text" class="vault-search-input" placeholder="seek withinâ€¦"
                   oninput="App.searchVault(this.value, 'learn', '${sub}')" value="${esc(settings.searchQuery || '')}">
            <select class="vault-sort-dropdown" onchange="App.sortVault(this.value, 'learn', '${sub}')">
                <option value="recent"     ${settings.sortBy === 'recent'     ? 'selected' : ''}>Recent</option>
                <option value="oldest"     ${settings.sortBy === 'oldest'     ? 'selected' : ''}>Oldest</option>
                <option value="title"      ${settings.sortBy === 'title'      ? 'selected' : ''}>A â€“ Z</option>
                <option value="importance" ${settings.sortBy === 'importance' ? 'selected' : ''}>Weight</option>
            </select>
            <button class="vault-add-btn" onclick="App.addLearnItemEnhanced('${sub}')">+ Add</button>
        </div>`;

    // Filter
    if (settings.searchQuery) {
        const q = settings.searchQuery.toLowerCase();
        items = items.filter(i =>
            i.title.toLowerCase().includes(q) ||
            (i.content && i.content.toLowerCase().includes(q)) ||
            (i.tags && i.tags.some(t => t.toLowerCase().includes(q)))
        );
    }

    items = this.sortVaultItems(items, settings.sortBy);

    if (items.length === 0) {
        html += `
            <div class="zen-empty">
                <span class="zen-empty-symbol">â—‡</span>
                <span class="zen-empty-text">${settings.searchQuery ? 'Nothing surfaces' : 'The vault is empty here'}</span>
                <span class="zen-empty-sub">${settings.searchQuery ? 'try different words' : 'add the first entry'}</span>
                ${settings.searchQuery ? `<div style="margin-top:20px;"><button class="zen-util-btn" onclick="App.clearVaultSearch('learn', '${sub}')">clear search</button></div>` : ''}
            </div>`;
        return html;
    }

    items.forEach((item, idx) => {
        const date = new Date(item.created).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        const importance = item.importance || 'low';
        const importanceClass = importance !== 'low' ? `vault-importance-${importance}` : '';
        const pinnedClass = item.pinned ? 'pinned' : '';

        html += `
            <div class="vault-item-card ${importanceClass} ${pinnedClass}" style="animation-delay:${idx * 0.045}s;">
                <div class="vault-item-header">
                    <div class="vault-item-title">${esc(item.title)}</div>
                </div>
                <div class="vault-item-meta">
                    <span>${date}</span>
                    ${item.starred ? `<span>starred</span>` : ''}
                    ${item.source ? `<span>${esc(item.source)}</span>` : ''}
                    ${importance !== 'low' ? `<span>${importance}</span>` : ''}
                </div>
                ${item.content ? `<div class="vault-item-content">${esc(item.content)}</div>` : ''}
                ${item.tags && item.tags.length > 0 ? `
                    <div class="vault-item-tags">
                        ${item.tags.map(tag => `<span class="vault-tag">${esc(tag)}</span>`).join('')}
                    </div>` : ''}
                <div class="vault-item-footer">
                    <div class="vault-item-meta" style="margin:0;">
                        ${item.starred ? `<span style="opacity:0.5;">âœ¦ starred</span>` : ''}
                    </div>
                    <div class="vault-item-actions">
                        <button class="vault-action-btn" onclick="App.editLearnItem('${sub}', '${item.id}')">Edit</button>
                        <button class="vault-action-btn" onclick="App.starLearnItem('${sub}', '${item.id}')">${item.starred ? 'Unstar' : 'Star'}</button>
                        <button class="vault-action-btn" onclick="App.promoteToEarn('learn', '${sub}', '${item.id}')">â†’ Earn</button>
                        <button class="vault-action-btn danger" onclick="App.deleteLearnItem('${sub}', '${item.id}')">Release</button>
                    </div>
                </div>
            </div>`;
    });

    return html;
},

// EARN SECTION RENDERING â€” Zen
renderEarnSectionEnhanced(sub) {
    let html = '';
    let items = this.data.vaultEarn[sub] || [];
    const settings = this.data.vaultSettings;

    const meta = {
        strat:    { kanji: 'æˆ¦ç•¥ Â· Senryaku',  title: 'Strategy',  desc: 'playbooks, rules, systems of action'  },
        exec:     { kanji: 'å®Ÿè¡Œ Â· JikkÅ',      title: 'Execute',   desc: 'action logs, wins, post-mortems'      },
        leverage: { kanji: 'æ¢ƒå­ Â· Tetsujo',    title: 'Leverage',  desc: 'opportunities and multipliers'        },
        contacts: { kanji: 'ç¸ Â· En',           title: 'Contacts',  desc: 'relationships, the web of connection' }
    };
    const m = meta[sub] || { kanji: '', title: sub, desc: '' };

    // Section header
    html += `
        <div class="vault-section-header">
            <div class="vault-section-kanji">${m.kanji}</div>
            <div class="vault-section-title">${m.title}</div>
            <div class="vault-section-desc">${m.desc}</div>
        </div>
    `;

    // Toolbar
    html += `
        <div class="vault-toolbar">
            <input type="text" class="vault-search-input" placeholder="seek withinâ€¦"
                   oninput="App.searchVault(this.value, 'earn', '${sub}')" value="${esc(settings.searchQuery || '')}">
            <select class="vault-sort-dropdown" onchange="App.sortVault(this.value, 'earn', '${sub}')">
                <option value="recent"     ${settings.sortBy === 'recent'     ? 'selected' : ''}>Recent</option>
                <option value="oldest"     ${settings.sortBy === 'oldest'     ? 'selected' : ''}>Oldest</option>
                <option value="title"      ${settings.sortBy === 'title'      ? 'selected' : ''}>A â€“ Z</option>
                <option value="importance" ${settings.sortBy === 'importance' ? 'selected' : ''}>Weight</option>
            </select>
            <button class="vault-add-btn" onclick="App.addEarnItemEnhanced('${sub}')">+ Add</button>
        </div>`;

    // Filter
    if (settings.searchQuery) {
        const q = settings.searchQuery.toLowerCase();
        items = items.filter(i =>
            i.title.toLowerCase().includes(q) ||
            (i.content && i.content.toLowerCase().includes(q)) ||
            (i.tags && i.tags.some(t => t.toLowerCase().includes(q)))
        );
    }

    items = this.sortVaultItems(items, settings.sortBy);

    if (items.length === 0) {
        html += `
            <div class="zen-empty">
                <span class="zen-empty-symbol">â—‡</span>
                <span class="zen-empty-text">${settings.searchQuery ? 'Nothing surfaces' : 'The vault is empty here'}</span>
                <span class="zen-empty-sub">${settings.searchQuery ? 'try different words' : 'add the first entry'}</span>
                ${settings.searchQuery ? `<div style="margin-top:20px;"><button class="zen-util-btn" onclick="App.clearVaultSearch('earn', '${sub}')">clear search</button></div>` : ''}
            </div>`;
        return html;
    }

    const isExec     = sub === 'exec';
    const isContacts = sub === 'contacts';
    const isStrat    = sub === 'strat';
    const today      = new Date().toISOString().split('T')[0];

    items.forEach((item, idx) => {
        const date = new Date(item.created).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        const importance = item.importance || 'low';
        const importanceClass = importance !== 'low' ? `vault-importance-${importance}` : '';
        const completedClass = item.completed ? 'completed-item' : '';
        const domainColor = item.linkedDomain ? App.getDomainColor(item.linkedDomain) : null;
        const isFollowUpDue = isContacts && item.followUpDate && item.followUpDate <= today && !item.completed;
        const isOverdue     = isContacts && item.followUpDate && item.followUpDate < today && !item.completed;
        const borderColor   = domainColor || (isOverdue ? '#ff453a' : isFollowUpDue ? 'var(--blue)' : 'transparent');

        html += `
            <div class="vault-item-card ${importanceClass} ${completedClass}"
                 style="animation-delay:${idx * 0.045}s;${borderColor !== 'transparent' ? `border-left:3px solid ${borderColor};` : ''}">
                ${item.pinnedToday ? `<div style="font-size:9px;color:var(--accent);font-weight:700;letter-spacing:1px;
                    text-transform:uppercase;margin-bottom:6px;">ðŸ“Œ Pinned to Today</div>` : ''}
                ${item.promotedFrom ? `<div class="vault-promoted-badge">distilled from ${esc(item.promotedFrom)}</div>` : ''}
                <div class="vault-item-header">
                    <div class="vault-item-title">${esc(item.title)}</div>
                </div>
                <div class="vault-item-meta">
                    <span>${date}</span>
                    ${item.starred ? `<span>â­</span>` : ''}
                    ${importance !== 'low' ? `<span style="color:${importance==='high'?'#ff9f0a':'var(--dim)'};">${importance}</span>` : ''}
                    ${item.linkedDomain ? `<span style="color:${domainColor};font-weight:600;">${esc(item.linkedDomain)}</span>` : ''}
                    ${item.linkedGoal   ? `<span style="color:var(--dim);">ðŸŽ¯ ${esc(item.linkedGoal)}</span>` : ''}
                    ${isContacts && item.followUpDate ? `<span style="color:${isOverdue?'#ff453a':isFollowUpDue?'var(--blue)':'var(--dim)'};">
                        ${isOverdue ? 'âš ï¸ OVERDUE' : isFollowUpDue ? 'ðŸ“… TODAY' : `ðŸ“… ${item.followUpDate}`}</span>` : ''}
                    ${isContacts && item.lastContactDate ? `<span style="color:var(--dim);">Last: ${item.lastContactDate}</span>` : ''}
                    ${isExec && item.completed ? `<span style="color:var(--success);">âœ“ fulfilled</span>` : ''}
                </div>
                ${item.content ? `<div class="vault-item-content">${esc(item.content)}</div>` : ''}
                ${item.tags && item.tags.length > 0 ? `
                    <div class="vault-item-tags">
                        ${item.tags.map(tag => `<span class="vault-tag">${esc(tag)}</span>`).join('')}
                    </div>` : ''}
                <div class="vault-item-footer">
                    <div></div>
                    <div class="vault-item-actions">
                        <button class="vault-action-btn" onclick="App.editEarnItem('${sub}', '${item.id}')">Edit</button>
                        <button class="vault-action-btn" onclick="App.toggleStar('earn', '${sub}', '${item.id}')">${item.starred ? 'Unstar' : 'Star'}</button>
                        ${isStrat && !item.pinnedToday ? `<button class="vault-action-btn" onclick="App.pinStrategyToday('${item.id}')">ðŸ“Œ Pin Today</button>` : ''}
                        ${isStrat && item.pinnedToday  ? `<button class="vault-action-btn" onclick="App.pinStrategyToday('${item.id}')">Unpin</button>` : ''}
                        ${isContacts ? `<button class="vault-action-btn" onclick="App.markContactDone('${item.id}')">âœ“ Contacted</button>` : ''}
                        ${isExec && !item.completed ? `<button class="vault-action-btn" onclick="App.markExecComplete('${item.id}')">Fulfill</button>` : ''}
                        <button class="vault-action-btn danger" onclick="App.deleteEarnItem('${sub}', '${item.id}')">Release</button>
                    </div>
                </div>
            </div>`;
    });

    return html;
},

// ENHANCED ADD LEARN ITEM WITH METADATA
addLearnItemEnhanced(type) {
    document.getElementById('modal-body').innerHTML = `
        <h3 style="margin-bottom:12px;color:var(--accent);">Add ${type.charAt(0).toUpperCase() + type.slice(1)}</h3>
        <input id="learn-title" placeholder="Title..." style="margin-bottom:12px;">
        <textarea id="learn-content" placeholder="Content (Markdown supported)..." rows="6" style="margin-bottom:12px;"></textarea>
        
        <input id="learn-tags" placeholder="Tags (comma-separated)..." style="margin-bottom:12px;">
        
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px;">
            <select id="learn-importance" style="margin:0;">
                <option value="low">Low Priority</option>
                <option value="medium">Medium Priority</option>
                <option value="high">High Priority</option>
            </select>
            <div style="display:flex;align-items:center;gap:8px;background:var(--sub);padding:10px;border-radius:8px;border:1px solid var(--border);">
                <input type="checkbox" id="learn-starred" style="margin:0;width:auto;">
                <label for="learn-starred" style="margin:0;font-size:13px;">â­ Star Item</label>
            </div>
        </div>
        
        <div style="display:flex;align-items:center;gap:8px;background:var(--sub);padding:10px;border-radius:8px;border:1px solid var(--border);margin-bottom:12px;">
            <input type="checkbox" id="learn-pinned" style="margin:0;width:auto;">
            <label for="learn-pinned" style="margin:0;font-size:13px;">ðŸ“Œ Pin to Top</label>
        </div>
        
        <input id="learn-source" placeholder="Source (optional)..." style="margin-bottom:12px;">
        
        <button class="btn" onclick="App.saveLearnItemEnhanced('${type}')">Save</button>`;
    document.getElementById('modal').classList.add('open');
    setTimeout(() => document.getElementById('learn-title')?.focus(), 80);
},

saveLearnItemEnhanced(type) {
    const title = document.getElementById('learn-title')?.value?.trim();
    const content = document.getElementById('learn-content')?.value?.trim();
    const tagsInput = document.getElementById('learn-tags')?.value?.trim();
    const importance = document.getElementById('learn-importance')?.value || 'low';
    const starred = document.getElementById('learn-starred')?.checked || false;
    const pinned = document.getElementById('learn-pinned')?.checked || false;
    const source = document.getElementById('learn-source')?.value?.trim();
    
    if (!title || !content) { this.toast('âš ï¸ Fill title and content'); return; }
    
    const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(t => t) : [];
    
    if (!this.data.vaultLearn[type]) this.data.vaultLearn[type] = [];
    this.data.vaultLearn[type].push({
        id: this.genId(),
        title,
        content,
        tags,
        importance,
        starred,
        pinned,
        source: source || '',
        created: new Date().toISOString(),
        modified: null,
        linkedTo: []
    });
    
    this.save(); this.closeModal(); this.render();
    this.toast('âœ“ Added to LEARN');
},

// ENHANCED ADD EARN ITEM
addEarnItemEnhanced(type) {
    const goals   = this.data.goals || [];
    const domains = this.getAllDomains();
    const goalOptions   = goals.map(g   => `<option value="${esc(g.title)}">${esc(g.title)}</option>`).join('');
    const domainOptions = domains.map(d => `<option value="${esc(d)}">${esc(d)}</option>`).join('');
    const labels = { strat:'Strategy', exec:'Execute', leverage:'Leverage', contacts:'Contact' };
    const icons  = { strat:'ðŸ“Š', exec:'âš™ï¸', leverage:'ðŸ”—', contacts:'ðŸ‘¤' };
    const label  = labels[type] || type;
    const icon   = icons[type]  || 'â—ˆ';

    const today = new Date().toISOString().split('T')[0];
    const nextWeek = (() => { const d=new Date(); d.setDate(d.getDate()+7); return d.toISOString().split('T')[0]; })();

    document.getElementById('modal-body').innerHTML = `
        <h3 style="margin-bottom:4px;color:var(--success);">${icon} Add ${label}</h3>
        ${type === 'strat' ? `<div style="font-size:11px;color:var(--dim);margin-bottom:14px;">A rule, playbook, or system you operate by</div>` : ''}
        ${type === 'exec'  ? `<div style="font-size:11px;color:var(--dim);margin-bottom:14px;">An action taken, win logged, or lesson from failure</div>` : ''}
        ${type === 'leverage' ? `<div style="font-size:11px;color:var(--dim);margin-bottom:14px;">An opportunity or multiplier that could accelerate your vision</div>` : ''}
        ${type === 'contacts' ? `<div style="font-size:11px;color:var(--dim);margin-bottom:14px;">A relationship to cultivate on your path to the vision</div>` : ''}
        <input id="earn-title" placeholder="Title..." style="margin-bottom:10px;">
        <textarea id="earn-content" placeholder="Details..." rows="4" style="margin-bottom:10px;"></textarea>
        ${domains.length > 0 ? `
        <select id="earn-domain" style="margin-bottom:10px;">
            <option value="">Link to domain (optional)</option>
            ${domainOptions}
        </select>` : ''}
        ${goals.length > 0 ? `
        <select id="earn-goal" style="margin-bottom:10px;">
            <option value="">Link to goal (optional)</option>
            ${goalOptions}
        </select>` : ''}
        ${type === 'contacts' ? `
        <input id="earn-followup" type="date" value="${nextWeek}"
            style="margin-bottom:10px;" title="Follow-up date">` : ''}
        ${type === 'strat' ? `
        <div style="display:flex;align-items:center;gap:8px;background:var(--sub);padding:10px;
                    border-radius:8px;border:1px solid var(--border);margin-bottom:10px;">
            <input type="checkbox" id="earn-pin" style="margin:0;width:auto;">
            <label for="earn-pin" style="margin:0;font-size:13px;">ðŸ“Œ Pin as Today's Rule</label>
        </div>` : ''}
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px;">
            <select id="earn-importance" style="margin:0;">
                <option value="low">Low</option>
                <option value="medium">Medium</option>
                <option value="high">High Impact</option>
            </select>
            <div style="display:flex;align-items:center;gap:8px;background:var(--sub);padding:10px;
                        border-radius:8px;border:1px solid var(--border);">
                <input type="checkbox" id="earn-starred" style="margin:0;width:auto;">
                <label for="earn-starred" style="margin:0;font-size:13px;">â­ Star</label>
            </div>
        </div>
        <button class="btn" onclick="App.saveEarnItemEnhanced('${type}')">Save to Earn</button>`;
    document.getElementById('modal').classList.add('open');
    setTimeout(() => document.getElementById('earn-title')?.focus(), 80);
},

saveEarnItemEnhanced(type) {
    const title       = document.getElementById('earn-title')?.value?.trim();
    const content     = document.getElementById('earn-content')?.value?.trim();
    const importance  = document.getElementById('earn-importance')?.value || 'low';
    const starred     = document.getElementById('earn-starred')?.checked  || false;
    const linkedDomain= document.getElementById('earn-domain')?.value     || '';
    const linkedGoal  = document.getElementById('earn-goal')?.value       || '';
    const followUpDate= document.getElementById('earn-followup')?.value   || '';
    const pinnedToday = document.getElementById('earn-pin')?.checked      || false;
    const tagsInput   = document.getElementById('earn-tags')?.value?.trim() || '';

    if (!title) { this.toast('âš ï¸ Enter a title'); return; }

    const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(Boolean) : [];

    if (!this.data.vaultEarn[type]) this.data.vaultEarn[type] = [];
    this.data.vaultEarn[type].push({
        id: this.genId(),
        title,
        content: content || '',
        tags,
        importance,
        starred,
        pinnedToday: pinnedToday || false,
        linkedDomain: linkedDomain || '',
        linkedGoal:   linkedGoal  || '',
        followUpDate: followUpDate || '',
        completed: false,
        promotedFrom: null,
        created: new Date().toISOString(),
        modified: null,
        linkedTo: []
    });

    this.save(); this.closeModal(); this.render();
    this.toast(`âœ“ Added to ${type.toUpperCase()}`);
},

// EDIT LEARN ITEM
editLearnItem(type, itemId) {
    const item = this.data.vaultLearn[type]?.find(i => i.id === itemId);
    if (!item) return;
    
    document.getElementById('modal-body').innerHTML = `
        <h3 style="margin-bottom:12px;color:var(--accent);">Edit ${type.charAt(0).toUpperCase() + type.slice(1)}</h3>
        <input id="learn-title" placeholder="Title..." value="${esc(item.title)}" style="margin-bottom:12px;">
        <textarea id="learn-content" placeholder="Content..." rows="6" style="margin-bottom:12px;">${esc(item.content || '')}</textarea>
        
        <input id="learn-tags" placeholder="Tags (comma-separated)..." value="${(item.tags || []).join(', ')}" style="margin-bottom:12px;">
        
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px;">
            <select id="learn-importance" style="margin:0;">
                <option value="low" ${item.importance === 'low' ? 'selected' : ''}>Low Priority</option>
                <option value="medium" ${item.importance === 'medium' ? 'selected' : ''}>Medium Priority</option>
                <option value="high" ${item.importance === 'high' ? 'selected' : ''}>High Priority</option>
            </select>
            <div style="display:flex;align-items:center;gap:8px;background:var(--sub);padding:10px;border-radius:8px;border:1px solid var(--border);">
                <input type="checkbox" id="learn-starred" ${item.starred ? 'checked' : ''} style="margin:0;width:auto;">
                <label for="learn-starred" style="margin:0;font-size:13px;">â­ Star Item</label>
            </div>
        </div>
        
        <input id="learn-source" placeholder="Source (optional)..." value="${esc(item.source || '')}" style="margin-bottom:12px;">
        
        <button class="btn" onclick="App.updateLearnItem('${type}', '${itemId}')">Update</button>`;
    document.getElementById('modal').classList.add('open');
    setTimeout(() => document.getElementById('learn-title')?.focus(), 80);
},

updateLearnItem(type, itemId) {
    const item = this.data.vaultLearn[type]?.find(i => i.id === itemId);
    if (!item) return;
    
    const title = document.getElementById('learn-title')?.value?.trim();
    const content = document.getElementById('learn-content')?.value?.trim();
    const tagsInput = document.getElementById('learn-tags')?.value?.trim();
    const importance = document.getElementById('learn-importance')?.value || 'low';
    const starred = document.getElementById('learn-starred')?.checked || false;
    const source = document.getElementById('learn-source')?.value?.trim();
    
    if (!title || !content) { this.toast('âš ï¸ Fill title and content'); return; }
    
    const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(t => t) : [];
    
    item.title = title;
    item.content = content;
    item.tags = tags;
    item.importance = importance;
    item.starred = starred;
    item.source = source;
    item.modified = new Date().toISOString();
    
    this.save(); this.closeModal(); this.render();
    this.toast('âœ“ Item updated');
},

// EDIT EARN ITEM
editEarnItem(type, itemId) {
    const item = this.data.vaultEarn[type]?.find(i => i.id === itemId);
    if (!item) return;
    
    document.getElementById('modal-body').innerHTML = `
        <h3 style="margin-bottom:12px;color:var(--success);">Edit ${type.charAt(0).toUpperCase() + type.slice(1)}</h3>
        <input id="earn-title" placeholder="Title..." value="${esc(item.title)}" style="margin-bottom:12px;">
        <textarea id="earn-content" placeholder="Content..." rows="6" style="margin-bottom:12px;">${esc(item.content || '')}</textarea>
        
        <input id="earn-tags" placeholder="Tags (comma-separated)..." value="${(item.tags || []).join(', ')}" style="margin-bottom:12px;">
        
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px;">
            <select id="earn-importance" style="margin:0;">
                <option value="low" ${item.importance === 'low' ? 'selected' : ''}>Low Priority</option>
                <option value="medium" ${item.importance === 'medium' ? 'selected' : ''}>Medium Priority</option>
                <option value="high" ${item.importance === 'high' ? 'selected' : ''}>High Priority</option>
            </select>
            <div style="display:flex;align-items:center;gap:8px;background:var(--sub);padding:10px;border-radius:8px;border:1px solid var(--border);">
                <input type="checkbox" id="earn-starred" ${item.starred ? 'checked' : ''} style="margin:0;width:auto;">
                <label for="earn-starred" style="margin:0;font-size:13px;">â­ Star Item</label>
            </div>
        </div>
        
        <input id="earn-source" placeholder="Source (optional)..." value="${esc(item.source || '')}" style="margin-bottom:12px;">
        
        <button class="btn" onclick="App.updateEarnItem('${type}', '${itemId}')">Update</button>`;
    document.getElementById('modal').classList.add('open');
    setTimeout(() => document.getElementById('earn-title')?.focus(), 80);
},

updateEarnItem(type, itemId) {
    const item = this.data.vaultEarn[type]?.find(i => i.id === itemId);
    if (!item) return;
    
    const title = document.getElementById('earn-title')?.value?.trim();
    const content = document.getElementById('earn-content')?.value?.trim();
    const tagsInput = document.getElementById('earn-tags')?.value?.trim();
    const importance = document.getElementById('earn-importance')?.value || 'low';
    const starred = document.getElementById('earn-starred')?.checked || false;
    const source = document.getElementById('earn-source')?.value?.trim();
    
    if (!title || !content) { this.toast('âš ï¸ Fill title and content'); return; }
    
    const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(t => t) : [];
    
    item.title = title;
    item.content = content;
    item.tags = tags;
    item.importance = importance;
    item.starred = starred;
    item.source = source;
    item.modified = new Date().toISOString();
    
    this.save(); this.closeModal(); this.render();
    this.toast('âœ“ Item updated');
},

// DELETE FUNCTIONS
deleteLearnItem(type, itemId) {
    this.confirm('Release this item from your vault?', () => {
        this.data.vaultLearn[type] = (this.data.vaultLearn[type] || []).filter(i => i.id !== itemId);
        this.save(); this.render();
        this.toast('âœ“ Item released');
    }, 'Release');
},

deleteEarnItem(type, itemId) {
    this.confirm('Release this item from your vault?', () => {
        this.data.vaultEarn[type] = (this.data.vaultEarn[type] || []).filter(i => i.id !== itemId);
        this.save(); this.render();
        this.toast('âœ“ Item released');
    }, 'Release');
},

// TOGGLE STAR (Zen aliases)
starLearnItem(type, itemId) {
    this.toggleStar('learn', type, itemId);
},

promoteToEarn(section, type, itemId) {
    this.promoteToEarnEnhanced(type, itemId);
},

// TOGGLE STAR
toggleStar(section, type, itemId) {
    const item = section === 'learn' ? 
        this.data.vaultLearn[type]?.find(i => i.id === itemId) :
        this.data.vaultEarn[type]?.find(i => i.id === itemId);
    
    if (!item) return;
    
    item.starred = !item.starred;
    item.modified = new Date().toISOString();
    
    this.save(); this.render();
    this.toast(item.starred ? 'â­ Item starred' : 'â˜† Star removed');
},

// ENHANCED PROMOTE TO EARN â€” smart chooser with goal/domain linking
promoteToEarnEnhanced(fromType, itemId) {
    const item = this.data.vaultLearn[fromType]?.find(i => i.id === itemId);
    if (!item) return;

    // Suggested default based on source type
    const suggestionMap = { ideas: 'strat', notes: 'exec', books: 'leverage', skills: 'strat' };
    const suggested = suggestionMap[fromType] || 'strat';

    // Build goal options
    const goals = this.data.goals || [];
    const goalOptions = goals.map(g =>
        `<option value="${esc(g.id)}">${esc(g.title)}</option>`
    ).join('');

    // Build domain options
    const domains = this.getAllDomains();
    const domainOptions = domains.map(d =>
        `<option value="${esc(d)}">${esc(d)}</option>`
    ).join('');

    document.getElementById('modal-body').innerHTML = `
        <h3 style="margin-bottom:4px;color:var(--accent);">â†’ Promote to Earn</h3>
        <div style="font-size:12px;color:var(--dim);margin-bottom:16px;">
            Moving: <strong style="color:var(--text);">${esc(item.title)}</strong>
        </div>
        <label style="font-size:11px;color:var(--dim);text-transform:uppercase;letter-spacing:1px;display:block;margin-bottom:6px;">
            Earn Bucket
        </label>
        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:16px;">
            ${[
                {key:'strat',    icon:'ðŸ“Š', label:'Strategy',  desc:'Playbooks & rules'},
                {key:'exec',     icon:'âš™ï¸', label:'Execute',   desc:'Action logs & wins'},
                {key:'leverage', icon:'ðŸ”—', label:'Leverage',  desc:'Multipliers & opps'},
                {key:'contacts', icon:'ðŸ‘¤', label:'Contact',   desc:'Relationships'},
            ].map(b => `
                <label style="cursor:pointer;display:block;">
                    <input type="radio" name="earn-bucket" value="${b.key}"
                        ${b.key === suggested ? 'checked' : ''}
                        style="display:none;">
                    <div class="earn-bucket-btn" data-bucket="${b.key}"
                        style="padding:12px;border-radius:10px;border:2px solid ${b.key===suggested?'var(--accent)':'var(--border)'};
                               background:${b.key===suggested?'#1a1500':'var(--sub)'};text-align:center;
                               cursor:pointer;transition:all 0.15s;"
                        onclick="App.selectEarnBucket('${b.key}')">
                        <div style="font-size:20px;margin-bottom:4px;">${b.icon}</div>
                        <div style="font-size:12px;font-weight:700;">${b.label}</div>
                        <div style="font-size:10px;color:var(--dim);margin-top:2px;">${b.desc}</div>
                    </div>
                </label>
            `).join('')}
        </div>
        ${domains.length > 0 ? `
        <label style="font-size:11px;color:var(--dim);text-transform:uppercase;letter-spacing:1px;display:block;margin-bottom:6px;">
            Link to Domain (optional)
        </label>
        <select id="promote-domain" style="margin-bottom:12px;">
            <option value="">No domain link</option>
            ${domainOptions}
        </select>` : ''}
        ${goals.length > 0 ? `
        <label style="font-size:11px;color:var(--dim);text-transform:uppercase;letter-spacing:1px;display:block;margin-bottom:6px;">
            Link to Goal (optional)
        </label>
        <select id="promote-goal" style="margin-bottom:16px;">
            <option value="">No goal link</option>
            ${goalOptions}
        </select>` : ''}
        <button class="btn" onclick="App.executePromotion('${fromType}','${itemId}')">
            Promote â†’
        </button>`;
    document.getElementById('modal').classList.add('open');
},

selectEarnBucket(bucket) {
    // Visual feedback for bucket selection
    document.querySelectorAll('.earn-bucket-btn').forEach(el => {
        const isSelected = el.dataset.bucket === bucket;
        el.style.borderColor = isSelected ? 'var(--accent)' : 'var(--border)';
        el.style.background   = isSelected ? '#1a1500' : 'var(--sub)';
    });
    document.querySelector(`input[value="${bucket}"]`).checked = true;
},

executePromotion(fromType, itemId) {
    const item = this.data.vaultLearn[fromType]?.find(i => i.id === itemId);
    if (!item) return;

    const bucketRadio = document.querySelector('input[name="earn-bucket"]:checked');
    const toType = bucketRadio ? bucketRadio.value : 'strat';
    const linkedDomain = document.getElementById('promote-domain')?.value || '';
    const linkedGoalId = document.getElementById('promote-goal')?.value || '';

    const linkedGoal = linkedGoalId
        ? (this.data.goals || []).find(g => g.id === linkedGoalId)?.title || ''
        : '';

    if (!this.data.vaultEarn[toType]) this.data.vaultEarn[toType] = [];
    this.data.vaultEarn[toType].push({
        ...item,
        id: this.genId(),
        promotedFrom: fromType,
        linkedDomain: linkedDomain || '',
        linkedGoal:   linkedGoal  || '',
        completed: false,
        pinnedToday: false,
        followUpDate: toType === 'contacts' ? (() => {
            const d = new Date(); d.setDate(d.getDate()+7);
            return d.toISOString().split('T')[0];
        })() : '',
        created: new Date().toISOString(),
        modified: null
    });

    // Remove from LEARN
    this.data.vaultLearn[fromType] = this.data.vaultLearn[fromType].filter(i => i.id !== itemId);

    // Track promotion
    if (!this.data.vaultPromotions) this.data.vaultPromotions = [];
    this.data.vaultPromotions.push({
        from: fromType, to: toType,
        linkedDomain, linkedGoal,
        created: new Date().toISOString()
    });

    this.save(); this.closeModal();
    this.tab = 4; this.sub.vaultMain = 'earn'; this.sub.vault = toType;
    this.render();
    this.toast(`âœ“ Promoted to ${toType.toUpperCase()}`);
},

// SEARCH VAULT
searchVault(query, section, type) {
    this.data.vaultSettings.searchQuery = query;
    this.render();
},

clearVaultSearch(section, type) {
    this.data.vaultSettings.searchQuery = '';
    this.render();
},

// SORT VAULT
sortVault(sortBy, section, type) {
    this.data.vaultSettings.sortBy = sortBy;
    this.save(); this.render();
},

sortVaultItems(items, sortBy) {
    const sorted = [...items];
    
    switch(sortBy) {
        case 'recent':
            return sorted.sort((a, b) => new Date(b.created) - new Date(a.created));
        case 'oldest':
            return sorted.sort((a, b) => new Date(a.created) - new Date(b.created));
        case 'title':
            return sorted.sort((a, b) => a.title.localeCompare(b.title));
        case 'importance': {
            const priority = { high: 3, medium: 2, low: 1 };
            return sorted.sort((a, b) => priority[b.importance || 'low'] - priority[a.importance || 'low']);
        }
        default:
            return sorted;
    }
},

// TOGGLE ANALYTICS
toggleVaultAnalytics() {
    this.data.vaultSettings.showAnalytics = !this.data.vaultSettings.showAnalytics;
    this.save(); this.render();
},

// EXPORT VAULT ITEM
exportVaultItem(section, type, itemId) {
    const item = section === 'learn' ?
        this.data.vaultLearn[type]?.find(i => i.id === itemId) :
        this.data.vaultEarn[type]?.find(i => i.id === itemId);
    
    if (!item) return;
    
    const blob = new Blob([JSON.stringify(item, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `vault-${type}-${item.title.replace(/[^a-z0-9]/gi, '-').toLowerCase()}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    this.toast('ðŸ“¤ Item exported');
},

    markExecComplete(itemId) {
        const item = this.data.vaultEarn.exec?.find(i => i.id === itemId);
        if (!item) return;
        
        item.completed = true;
        item.modified = new Date().toISOString();
        
        // â”€â”€ INTEGRATION: Auto-complete linked cycle task â”€â”€
        let linkedTaskTitle = '';
        if (item.linkedGoal && this.data.currentCycle?.tasks) {
            const cycleTask = this.data.currentCycle.tasks.find(t =>
                !t.done && (
                    t.title.toLowerCase().includes(item.title.toLowerCase().substring(0,20)) ||
                    (item.linkedGoal && t.title.toLowerCase().includes(item.linkedGoal.toLowerCase().substring(0,15)))
                )
            );
            if (cycleTask) {
                cycleTask.done = true;
                cycleTask.doneDate = new Date().toISOString();
                linkedTaskTitle = cycleTask.title;
            }
        }
        
        this.save(); this.render();
        if (linkedTaskTitle) {
            this.celebrate('ðŸŽ¯', 'Executed + Cycle Task Done!', `"${item.title}" â€” also closed: "${linkedTaskTitle.substring(0,40)}"`);
        } else {
            this.celebrate('ðŸŽ¯', 'Executed!', 'Another win logged');
        }
    },

    
    // BLUEPRINT IMPORT
    // CUSTOM BLUEPRINT GENERATOR FUNCTIONS
    generateCustomPrompt() {
        // Collect data from inputs
        this.customBlueprintData = {
            name: document.getElementById('custom-name')?.value || '',
            vision: document.getElementById('custom-vision')?.value || '',
            years: document.getElementById('custom-years')?.value || '15',
            domain1: document.getElementById('custom-domain1')?.value || '',
            domain2: document.getElementById('custom-domain2')?.value || '',
            domain3: document.getElementById('custom-domain3')?.value || '',
            milestone1: document.getElementById('custom-milestone1')?.value || '',
            milestone2: document.getElementById('custom-milestone2')?.value || '',
            milestone3: document.getElementById('custom-milestone3')?.value || '',
            habit1: document.getElementById('custom-habit1')?.value || '',
            habit2: document.getElementById('custom-habit2')?.value || '',
            habit3: document.getElementById('custom-habit3')?.value || ''
        };

        const d = this.customBlueprintData;

        // Validate required fields
        if (!d.name || !d.vision || !d.domain1) {
            this.toast('âš ï¸ Please fill at least: Name, Vision, and Domain 1');
            return;
        }

        // Generate the AI prompt
        this.customPrompt = `You are a strategic life planning expert. Create a comprehensive ${d.years}-year blueprint for ${d.name} following the SVK Blueprint methodology.

**PERSON'S VISION:**
${d.vision}

**DOMAINS (Life Focus Areas):**
1. ${d.domain1}
${d.domain2 ? `2. ${d.domain2}` : ''}
${d.domain3 ? `3. ${d.domain3}` : ''}

**KEY MILESTONES:**
- Early Phase: ${d.milestone1 || 'To be determined'}
- Mid Phase: ${d.milestone2 || 'To be determined'}
- Late Phase: ${d.milestone3 || 'To be determined'}

**CORE DAILY HABITS:**
${d.habit1 ? `- ${d.habit1}` : ''}
${d.habit2 ? `- ${d.habit2}` : ''}
${d.habit3 ? `- ${d.habit3}` : ''}

---

**YOUR TASK:**
Create a complete ${d.years}-year blueprint broken into 60 cycles (90 days each). Each cycle should include:
- Cycle number and title
- Domain focus percentages (total must equal 100%)
- 3-5 specific milestones
- 5-7 daily/weekly habits
- 15-25 concrete tasks

**IMPORTANT RULES:**
1. Early cycles focus on foundation building
2. Mid cycles focus on momentum and scaling
3. Late cycles focus on mastery and legacy
4. Each cycle builds on previous cycles
5. Milestones should be SMART (Specific, Measurable, Achievable, Relevant, Time-bound)
6. Tasks should be actionable and concrete
7. Habits should directly support the domains
8. Domain focus should shift naturally over time (early = heavy domain 1, later = more balanced)

**OUTPUT FORMAT (STRICT JSON):**
\`\`\`json
{
  "name": "${d.name} Life Blueprint ${new Date().getFullYear()}-${new Date().getFullYear() + parseInt(d.years)}",
  "vision": "${d.vision}",
  "years": ${d.years},
  "domains": {
    "domain1": { "name": "${d.domain1}", "color": "#0a84ff" },
    "domain2": { "name": "${d.domain2 || 'Secondary Domain'}", "color": "#ffd700" },
    "domain3": { "name": "${d.domain3 || 'Tertiary Domain'}", "color": "#30d158" }
  },
  "cycles": [
    {
      "number": 1,
      "title": "Foundation: [Specific Focus] (Q1 ${new Date().getFullYear()})",
      "goals_focus": {
        "${d.domain1}": 70,
        "${d.domain2 || 'Secondary Domain'}": 25,
        "${d.domain3 || 'Tertiary Domain'}": 5
      },
      "milestones": [
        "[Specific milestone 1]",
        "[Specific milestone 2]",
        "[Specific milestone 3]"
      ],
      "habits": [
        "${d.habit1 || 'Daily practice in domain 1'}",
        "${d.habit2 || 'Daily practice in domain 2'}",
        "${d.habit3 || 'Daily mindfulness practice'}",
        "[Additional habit]",
        "[Additional habit]"
      ],
      "tasks": [
        "[Concrete action task 1]",
        "[Concrete action task 2]",
        "[Concrete action task 3]",
        "... 15-25 total tasks"
      ]
    },
    ... [Continue for all 60 cycles, progressively building on each other]
  ]
}
\`\`\`

**CRITICAL:** 
- Output ONLY the JSON, no other text
- Ensure all 60 cycles are included
- Each cycle should have unique, progressive content
- Focus percentages in "goals_focus" must total 100%
- Use exact domain names in "goals_focus"
- Make it realistic and achievable
- Include specific numbers, dates, and metrics where possible

Generate the complete JSON now.`;

        this.save();
        this.toast('âœ¨ Custom prompt generated! Scroll down to copy.');
        this.render();
        
        // Scroll to prompt
        setTimeout(() => {
            document.getElementById('custom-prompt')?.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 100);
    },

    copyPromptToClipboard() {
        if (!this.customPrompt) return;
        
        navigator.clipboard.writeText(this.customPrompt).then(() => {
            this.toast('ðŸ“‹ Prompt copied! Paste into ChatGPT or Claude');
        }).catch(() => {
            // Fallback for older browsers
            const textArea = document.createElement('textarea');
            textArea.value = this.customPrompt;
            textArea.style.position = 'fixed';
            textArea.style.opacity = '0';
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            this.toast('ðŸ“‹ Prompt copied! Paste into ChatGPT or Claude');
        });
    },

    // IMPORT BLUEPRINT
    importBlueprint(event) {
        const file = event.target.files?.[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = e => {
            try {
                const json = JSON.parse(e.target.result);
                
                // FIX: Add comprehensive validation
                if (!json.name || !json.vision || !json.cycles || !Array.isArray(json.cycles)) {
                    throw new Error('Invalid blueprint format: missing required fields');
                }
                
                if (json.cycles.length === 0) {
                    throw new Error('Blueprint must contain at least one cycle');
                }
                
                // Validate each cycle
                json.cycles.forEach((c, idx) => {
                    if (!c.title) {
                        throw new Error(`Cycle ${idx + 1}: missing title`);
                    }
                    
                    if (!c.goals_focus || typeof c.goals_focus !== 'object') {
                        throw new Error(`Cycle ${idx + 1}: missing or invalid goals_focus`);
                    }
                    
                    // Validate goals_focus percentages sum to 100%
                    const focusValues = Object.values(c.goals_focus);
                    if (focusValues.length === 0) {
                        throw new Error(`Cycle ${idx + 1}: goals_focus cannot be empty`);
                    }
                    
                    const focusSum = focusValues.reduce((a, b) => a + b, 0);
                    if (Math.abs(focusSum - 100) > 1) {  // Allow 1% tolerance for rounding
                        throw new Error(`Cycle ${idx + 1}: goals_focus must sum to 100% (got ${focusSum}%)`);
                    }
                    
                    // Validate domain names are non-empty strings
                    Object.keys(c.goals_focus).forEach(domain => {
                        if (typeof domain !== 'string' || domain.trim() === '') {
                            throw new Error(`Cycle ${idx + 1}: invalid domain name`);
                        }
                    });
                    
                    // Ensure required arrays exist
                    if (!Array.isArray(c.milestones)) c.milestones = [];
                    if (!Array.isArray(c.habits)) c.habits = [];
                    if (!Array.isArray(c.tasks)) c.tasks = [];
                });
                
                this.data.blueprintMeta = {
                    name: json.name,
                    vision: json.vision,
                    years: json.years,
                    totalCycles: json.cycles?.length || 0,
                    domains: json.domains
                };
                
                // â”€â”€ PERSONALIZATION: Seed userProfile from blueprint if not set â”€â”€
                if (!this.data.userProfile) this.data.userProfile = {};
                if (!this.data.userProfile.name && json.name) {
                    this.data.userProfile.name = json.name;
                }
                if (!this.data.userProfile.vision && json.vision) {
                    this.data.userProfile.vision = json.vision;
                }
                
                this.data.allCycles = json.cycles.map((c, idx) => ({
                    number: c.number || (idx + 1),
                    title: c.title,
                    goals_focus: c.goals_focus,
                    milestones: c.milestones,
                    habits: c.habits,
                    rawTasks: c.tasks
                }));
                
                this.save();
                this.updateHeaderProfile();
                this.toast('âœ“ Blueprint imported successfully');
                this.render();
            } catch(err) {
                this.toast(`âš ï¸ Import failed: ${err.message}`);
                console.error('Blueprint import error:', err);
            }
        };
        reader.readAsText(file);
    },

    // LOAD NEXT CYCLE
    loadNextCycle() {
        if (!this.data.allCycles || this.data.allCycles.length === 0) {
            this.toast('âš ï¸ No cycles available');
            return;
        }
        
        const currentNum = this.data.currentCycle?.number || 0;
        const nextCycle = this.data.allCycles.find(c => c.number === currentNum + 1);
        
        if (!nextCycle) {
            this.toast('ðŸŽ‰ All cycles completed!');
            return;
        }
        
        if (this.data.currentCycle) {
            if (!this.data.cycleHistory) this.data.cycleHistory = [];
            this.data.cycleHistory.push({
                ...this.data.currentCycle,
                completedDate: new Date().toISOString()
            });
        }
        
        this.data.currentCycle = {
            number: nextCycle.number,
            title: nextCycle.title,
            startDate: new Date().toISOString().split('T')[0],
            goals_focus: nextCycle.goals_focus,
            milestones: nextCycle.milestones,
            habits: nextCycle.habits,
            tasks: this.convertTasks(nextCycle.rawTasks, nextCycle.number)
        };
        
        this.save();
        this.updateCycleIndicator();
        this.render();
        this.toast(`âœ“ Started Cycle ${nextCycle.number}`);
    },

    convertTasks(rawTasks, cycleNumber) {
        if (!Array.isArray(rawTasks)) return [];
        
        const tasksPerWeek = Math.ceil(rawTasks.length / 13);
        
        // FIX: Intelligently assign domains to imported tasks based on goals_focus
        const domains = this.getAllDomains();
        const cycle = this.data.allCycles?.find(c => c.number === cycleNumber);
        const goalsFocus = cycle?.goals_focus || {};
        
        // Create weighted domain pool based on percentages
        const domainPool = [];
        if (Object.keys(goalsFocus).length > 0) {
            Object.entries(goalsFocus).forEach(([domain, percentage]) => {
                const count = Math.round((percentage / 100) * rawTasks.length);
                for (let i = 0; i < count; i++) {
                    domainPool.push(domain);
                }
            });
        }
        
        // Fill remaining slots if pool is too small
        while (domainPool.length < rawTasks.length && domains.length > 0) {
            domainPool.push(domains[0]);
        }
        
        return rawTasks.map((task, idx) => {
            const week = Math.min(Math.floor(idx / tasksPerWeek) + 1, 13);
            const domain = domainPool[idx] || domains[0] || '';
            
            return {
                id: this.genId(),
                title: task,
                done: false,
                week: week,
                domain: domain,  // FIX: Now assigns domain intelligently
                duration: null,
                cycleNumber: cycleNumber
            };
        });
    },

    completeCycle() {
        this.confirm('Archive this cycle and move to the next?', () => this._doCompleteCycle(), 'Archive');
    },
    _doCompleteCycle() {
        
        const c = { 
            ...this.data.currentCycle, 
            completedAt: new Date().toISOString(), 
            completedTasks: (this.data.currentCycle.tasks||[]).filter(t=>t.done).length, 
            totalTasks: (this.data.currentCycle.tasks||[]).length 
        };
        
        if (!this.data.cycleHistory) this.data.cycleHistory = [];
        this.data.cycleHistory.unshift(c);
        this.data.currentCycle = null;
        
        this.save();
        this.updateCycleIndicator();
        this.celebrate('ðŸ†', 'Cycle Complete!', `${c.completedTasks}/${c.totalTasks} tasks done`);
        this.render();
    },

    getCurrentWeek() {
        if (!this.data.currentCycle || !this.data.currentCycle.startDate) return 1;
        const start = new Date(this.data.currentCycle.startDate + 'T00:00:00');
        const now = new Date();
        const diff = Math.floor((now - start) / 86400000);
        return Math.min(Math.max(Math.floor(diff / 7) + 1, 1), 13);
    },

    toggleTask(id) {
        const task = this.data.currentCycle?.tasks?.find(t => t.id === id);
        if (!task) return;
        task.done = !task.done;
        this.save();
        this.render();
        if (task.done) this.toast('âœ“ Task completed');
    },

    startTask(id) {
        const task = this.data.currentCycle?.tasks?.find(t => t.id === id);
        if (!task) {
            this.timer.show();
            return;
        }
        
        // Check if task has micro-steps
        if (!task.microSteps || task.microSteps.length === 0) {
            // Prompt to add micro-steps or start simple timer
            document.getElementById('modal-body').innerHTML = `
                <h3 style="margin-bottom:12px;color:var(--accent);">â±ï¸ Start "${esc(task.title)}"</h3>
                <p style="font-size:13px;color:var(--dim);margin-bottom:16px;">
                    Break this task into micro-steps for Zen Mode, or use a simple timer.
                </p>
                <textarea id="task-micro-steps" placeholder="Enter each step on a new line:
Review requirements
Create outline
Write first draft
Review and edit..." rows="6" style="margin-bottom:12px;"></textarea>
                <button class="btn" onclick="App.saveTaskMicroSteps('${id}')">Add Steps & Start Zen Mode</button>
                <button class="btn-sec" onclick="App.timer.show(); App.closeModal();" style="margin-top:8px;">
                    Use Simple Timer
                </button>
            `;
            document.getElementById('modal').classList.add('open');
            return;
        }
        
        // Task has micro-steps - prompt for Zen Mode
        document.getElementById('modal-body').innerHTML = `
            <h3 style="margin-bottom:12px;color:var(--accent);">â±ï¸ Set Timer for "${esc(task.title)}"</h3>
            
            <div style="margin-bottom:16px;">
                <label style="display:block;font-size:12px;color:var(--dim);margin-bottom:6px;">Timer Mode</label>
                <select id="timer-mode" style="margin-bottom:0;">
                    <option value="zen">ðŸ§˜ Zen Mode - One step at a time</option>
                    <option value="simple">â±ï¸ Simple Timer</option>
                </select>
            </div>
            
            <div style="margin-bottom:16px;">
                <label style="display:block;font-size:12px;color:var(--dim);margin-bottom:6px;">Duration (minutes)</label>
                <input type="number" id="timer-duration" value="25" min="1" max="180" style="margin-bottom:0;">
            </div>
            
            <div style="margin-bottom:16px;">
                <label style="display:block;font-size:12px;color:var(--dim);margin-bottom:6px;">Intention</label>
                <textarea id="timer-intention" placeholder="What will you accomplish?" rows="2" style="margin-bottom:0;"></textarea>
            </div>
            
            <button class="btn" onclick="App.startTaskTimer('${id}')">Start Timer</button>
        `;
        document.getElementById('modal').classList.add('open');
    },
    
    saveTaskMicroSteps(taskId) {
        const task = this.data.currentCycle?.tasks?.find(t => t.id === taskId);
        if (!task) return;
        
        const stepsText = document.getElementById('task-micro-steps')?.value?.trim();
        if (!stepsText) {
            this.toast('âš ï¸ Enter at least one step');
            return;
        }
        
        const steps = stepsText.split('\n')
            .filter(s => s.trim())
            .map(s => ({
                title: s.trim(),
                status: 'pending'
            }));
        
        task.microSteps = steps;
        this.save();
        this.closeModal();
        
        // Now start the task timer
        this.startTask(taskId);
    },
    
    startTaskTimer(taskId) {
        const task = this.data.currentCycle?.tasks?.find(t => t.id === taskId);
        if (!task) return;
        
        const mode = document.getElementById('timer-mode')?.value || 'zen';
        const duration = parseInt(document.getElementById('timer-duration')?.value) || 25;
        const intention = document.getElementById('timer-intention')?.value?.trim() || '';
        
        if (mode === 'zen' && task.microSteps && task.microSteps.length > 0) {
            // Reset all micro steps to pending
            task.microSteps.forEach(step => {
                if (step.status !== 'done') {
                    step.status = 'pending';
                }
            });
            this.save();
            
            this.zenMode = {
                active: true,
                habitId: null,
                taskId: taskId,
                intention: intention,
                currentStepIndex: 0,
                startTime: Date.now(),
                duration: 0,
                targetDuration: duration * 60,
                interval: null,
                isPaused: false,
                steps: task.microSteps
            };
            
            this.closeModal();
            this.showZenTimerForTask();
            
            // Start interval
            this.zenMode.interval = setInterval(() => {
                if (!this.zenMode.isPaused) {
                    this.zenMode.duration = Math.floor((Date.now() - this.zenMode.startTime) / 1000);
                    this.updateZenTimerForTask();
                }
            }, 1000);
            
            this.updateZenTimerForTask();
        } else {
            this.closeModal();
            this.timer.show();
        }
    },
    
    showZenTimerForTask() {
        document.getElementById('zen-timer-overlay').classList.add('active');
        this.updateZenTimerForTask();
    },
    
    updateZenTimerForTask() {
        const task = this.data.currentCycle?.tasks?.find(t => t.id === this.zenMode.taskId);
        if (!task) return;
        
        // Calculate countdown
        const timeRemaining = Math.max(0, this.zenMode.targetDuration - this.zenMode.duration);
        const remainingMins = Math.floor(timeRemaining / 60);
        const remainingSecs = timeRemaining % 60;
        const countdownStr = `${String(remainingMins).padStart(2, '0')}:${String(remainingSecs).padStart(2, '0')}`;
        
        // Get current step
        const currentStep = this.zenMode.steps[this.zenMode.currentStepIndex];
        const completedSteps = this.zenMode.steps.filter(s => s.status === 'done').length;
        const totalSteps = this.zenMode.steps.length;
        
        // Check if all steps are done
        if (this.zenMode.currentStepIndex >= totalSteps) {
            this.completeZenTaskSession();
            return;
        }
        
        const html = `
            <div class="zen-title">${esc(task.title)}</div>
            
            ${this.zenMode.intention ? `
                <div class="zen-intention">
                    <div class="zen-intention-label">Your Intention</div>
                    <div class="zen-intention-text">${esc(this.zenMode.intention)}</div>
                </div>
            ` : ''}
            
            <div class="zen-countdown ${this.zenMode.isPaused ? '' : 'zen-pulse'}">
                ${countdownStr}
            </div>
            
            <div class="zen-step-card">
                <div class="zen-step-number">${this.zenMode.currentStepIndex + 1}</div>
                <div class="zen-step-text">${esc(currentStep.title)}</div>
                <div class="zen-step-progress">${completedSteps} of ${totalSteps} completed</div>
                
                <div class="zen-buttons">
                    <button class="zen-btn zen-btn-skip" onclick="App.zenSkipTaskStep()">
                        Skip
                    </button>
                    <button class="zen-btn zen-btn-done" onclick="App.zenCompleteTaskStep()">
                        âœ“ Done
                    </button>
                </div>
            </div>
            
            <div class="zen-controls">
                <button class="zen-control-btn" onclick="App.zenTogglePause()">
                    ${this.zenMode.isPaused ? 'â–¶ï¸ Resume' : 'â¸ï¸ Pause'}
                </button>
                <button class="zen-control-btn" onclick="App.zenStopTimer()">
                    âœ• Stop
                </button>
            </div>
        `;
        
        document.getElementById('zen-timer-content').innerHTML = html;
        
        // Update header badge
        const badge = document.getElementById('timer-badge');
        if (badge) {
            badge.textContent = countdownStr;
            badge.classList.add('active');
        }
    },
    
    zenCompleteTaskStep() {
        const task = this.data.currentCycle?.tasks?.find(t => t.id === this.zenMode.taskId);
        if (!task) return;
        
        const currentIndex = this.zenMode.currentStepIndex;
        if (currentIndex < this.zenMode.steps.length) {
            this.zenMode.steps[currentIndex].status = 'done';
            task.microSteps[currentIndex].status = 'done';
            this.save();
        }
        
        this.zenMode.currentStepIndex++;
        this.updateZenTimerForTask();
        
        if (navigator.vibrate) {
            navigator.vibrate(50);
        }
    },
    
    zenSkipTaskStep() {
        const task = this.data.currentCycle?.tasks?.find(t => t.id === this.zenMode.taskId);
        if (!task) return;
        
        const currentIndex = this.zenMode.currentStepIndex;
        if (currentIndex < this.zenMode.steps.length) {
            this.zenMode.steps[currentIndex].status = 'skipped';
            task.microSteps[currentIndex].status = 'skipped';
            this.save();
        }
        
        this.zenMode.currentStepIndex++;
        this.updateZenTimerForTask();
    },
    
    completeZenTaskSession() {
        const task = this.data.currentCycle?.tasks?.find(t => t.id === this.zenMode.taskId);
        if (!task) return;
        
        const completedSteps = this.zenMode.steps.filter(s => s.status === 'done').length;
        const totalSteps = this.zenMode.steps.length;
        const minutes = Math.floor(this.zenMode.duration / 60);
        
        this.celebrate('ðŸŽ¯', 'Task Complete!', `${completedSteps}/${totalSteps} steps â€¢ ${minutes} min`);
        
        // Mark task as done
        task.done = true;
        this.save();
        
        setTimeout(() => {
            this.zenStopTimerAutomatic();
        }, 2500);
    },

    updateCycleIndicator() {
        const el = document.getElementById('cycle-indicator');
        if (el) el.textContent = this.data.currentCycle ? `CYCLE ${this.data.currentCycle.number}` : 'NO CYCLE';
    },

    // â”€â”€ PERSONALIZATION: Update header with user profile â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    updateHeaderProfile() {
        const p = this.data.userProfile || {};
        const name = p.name ? p.name.trim() : '';
        const tagline = p.tagline ? p.tagline.trim() : '';
        const avatar = p.avatar ? p.avatar.trim() : '';

        // Avatar display: emoji > initials > "SVK"
        const avatarEl = document.getElementById('profile-avatar-display');
        if (avatarEl) {
            if (avatar) {
                avatarEl.textContent = avatar;
                avatarEl.style.fontSize = '20px';
            } else if (name) {
                const initials = name.split(' ').map(w => w[0]).join('').toUpperCase().slice(0, 3);
                avatarEl.textContent = initials;
                avatarEl.style.fontSize = initials.length > 2 ? '10px' : '13px';
            } else {
                avatarEl.textContent = 'SVK';
                avatarEl.style.fontSize = '11px';
            }
        }

        // Name in header center
        const nameEl = document.getElementById('header-user-name');
        if (nameEl) {
            nameEl.textContent = name || '';
            nameEl.classList.toggle('empty', !name);
        }

        // Tagline in header center
        const taglineEl = document.getElementById('header-user-tagline');
        if (taglineEl) {
            taglineEl.textContent = tagline || (name ? 'Tap avatar to edit profile' : '');
        }
    },

    changeWeek(dir) {
        const current = this.sub._viewedWeek || this.getCurrentWeek();
        const next = Math.max(1, Math.min(13, current + dir));
        this.sub._viewedWeek = next;
        this.render();
    },

    addWeekTask(week) {
        // Get domains from current cycle's goals_focus
        const goalsFocus = this.data.currentCycle?.goals_focus || {};
        const domains = Object.keys(goalsFocus);
        
        let domainOptions = '';
        if (domains.length > 0) {
            domainOptions = `
                <select id="task-domain" style="margin-bottom:12px;">
                    <option value="">Select domain...</option>
                    ${domains.map(d => `<option value="${esc(d)}">${esc(d)}</option>`).join('')}
                </select>`;
        }
        
        document.getElementById('modal-body').innerHTML = `
            <h3 style="margin-bottom:12px;color:var(--accent);">Add Task - Week ${week}</h3>
            <input id="task-title" placeholder="Task description..." style="margin-bottom:12px;">
            ${domainOptions}
            <input id="task-duration" type="number" placeholder="Duration (minutes)" value="30" style="margin-bottom:12px;">
            <button class="btn" onclick="App.saveWeekTask(${week})">Add Task</button>`;
        document.getElementById('modal').classList.add('open');
        setTimeout(() => document.getElementById('task-title')?.focus(), 80);
    },

    saveWeekTask(week) {
        const title = document.getElementById('task-title')?.value?.trim();
        const domain = document.getElementById('task-domain')?.value || null;
        const duration = parseInt(document.getElementById('task-duration')?.value) || null;
        if (!title) { this.toast('âš ï¸ Enter task'); return; }
        
        if (!this.data.currentCycle.tasks) this.data.currentCycle.tasks = [];
        this.data.currentCycle.tasks.push({
            id: this.genId(),
            title,
            domain,
            duration,
            week,
            done: false
        });
        
        this.save(); this.closeModal(); this.render(); this.toast('âœ“ Task added');
    },

    viewTaskDetail(id) {
        const task = this.data.currentCycle?.tasks?.find(t => t.id === id);
        if (!task) return;
        
        document.getElementById('modal-body').innerHTML = `
            <h3 style="margin-bottom:16px;color:var(--accent);">${esc(task.title)}</h3>
            <div class="stat-grid" style="margin-bottom:16px;">
                <div class="stat-box"><div class="stat-val">${task.week}</div><div class="stat-label">Week</div></div>
                <div class="stat-box"><div class="stat-val">${task.duration || 'â€”'}</div><div class="stat-label">Minutes</div></div>
            </div>
            <button class="btn" onclick="App.startTask('${id}')">â±ï¸ Start Timer</button>
            <div style="display:flex;gap:8px;margin-top:12px;">
                ${!task.done ? `<button class="btn-sec btn-success" style="flex:1;" onclick="App.toggleTask('${id}');App.closeModal();">âœ“ Mark Done</button>` : ''}
                <button class="btn-sec btn-danger" style="flex:1;" onclick="App.deleteTask('${id}');App.closeModal();">Delete</button>
            </div>`;
        document.getElementById('modal').classList.add('open');
    },

    deleteTask(id) {
        this.confirm('Delete this task?', () => {
            if (this.data.currentCycle?.tasks) {
                this.data.currentCycle.tasks = this.data.currentCycle.tasks.filter(t => t.id !== id);
                this.save(); this.closeModal(); this.render();
            }
        }, 'Delete');
    },

    showAllCycles() {
        if (!this.data.allCycles || this.data.allCycles.length === 0) {
            this.toast('No cycles available');
            return;
        }
        
        const currentNum = this.data.currentCycle?.number || 0;
        let html = `<h3 style="margin-bottom:16px;color:var(--accent);">All Cycles (${this.data.allCycles.length})</h3>`;
        
        this.data.allCycles.forEach(cycle => {
            const isCurrent = cycle.number === currentNum;
            const isPast = cycle.number < currentNum;
            
            html += `<div class="task-row" style="${isCurrent?'border-color:var(--accent);':''}" onclick="App.jumpToCycle(${cycle.number})">
                <div style="flex:1;">
                    <div style="font-weight:700;display:flex;align-items:center;gap:8px;">
                        <span style="color:var(--accent);">Cycle ${cycle.number}</span>
                        ${isCurrent ? '<span style="font-size:10px;padding:2px 6px;background:var(--accent);color:var(--void);border-radius:4px;">ACTIVE</span>' : ''}
                        ${isPast ? '<span style="font-size:10px;padding:2px 6px;background:var(--success);color:var(--void);border-radius:4px;">DONE</span>' : ''}
                    </div>
                    <div style="font-size:14px;margin-top:4px;">${esc(cycle.title)}</div>
                </div>
            </div>`;
        });
        
        document.getElementById('modal-body').innerHTML = html;
        document.getElementById('modal').classList.add('open');
    },

    jumpToCycle(cycleNumber) {
        if (!this.data.allCycles || this.data.allCycles.length === 0) {
            this.toast('âš ï¸ No cycles available');
            return;
        }
        
        const targetCycle = this.data.allCycles.find(c => c.number === cycleNumber);
        if (!targetCycle) {
            this.toast('âš ï¸ Cycle not found');
            return;
        }
        
        this.confirm(`Switch to Cycle ${cycleNumber}? Current progress will be saved.`, () => {
            if (this.data.currentCycle) {
                if (!this.data.cycleHistory) this.data.cycleHistory = [];
                this.data.cycleHistory.push({
                    ...this.data.currentCycle,
                    switchedDate: new Date().toISOString()
                });
            }
            
            this.data.currentCycle = {
                number: targetCycle.number,
                title: targetCycle.title,
                startDate: new Date().toISOString().split('T')[0],
                goals_focus: targetCycle.goals_focus,
                milestones: targetCycle.milestones,
                habits: targetCycle.habits,
                tasks: this.convertTasks(targetCycle.rawTasks, targetCycle.number)
            };
            
            this.sub._viewedWeek = null;
            this.save();
            this.updateCycleIndicator();
            this.closeModal();
            this.render();
            this.toast(`âœ“ Switched to Cycle ${cycleNumber}`);
        }, "Switch");
    },

    // AFFIRMATIONS
    addAffirmation() {
        document.getElementById('modal-body').innerHTML = `
            <h3 style="margin-bottom:12px;color:var(--accent);">âœ¨ Add Affirmation</h3>
            <textarea id="aff-text" placeholder="I am..." rows="4" style="margin-bottom:12px;"></textarea>
            <button class="btn" onclick="App.saveAffirmation()">Add Affirmation</button>`;
        document.getElementById('modal').classList.add('open');
        setTimeout(() => document.getElementById('aff-text')?.focus(), 80);
    },

    saveAffirmation() {
        const text = document.getElementById('aff-text')?.value?.trim();
        if (!text) { this.toast('âš ï¸ Enter text'); return; }
        if (!this.data.plan.affirmations) this.data.plan.affirmations = [];
        this.data.plan.affirmations.push({ id: this.genId(), text, timestamp: new Date().toISOString() });
        this.save(); this.closeModal(); this.render(); this.toast('âœ¨ Affirmation added');
    },

    deleteAffirmation(id) {
        this.confirm('Delete this affirmation?', () => {
            this.data.plan.affirmations = (this.data.plan.affirmations || []).filter(a => a.id !== id);
            this.save(); this.render();
        }, 'Delete');
    },

    // BUCKET LIST
    addBucketItem() {
        document.getElementById('modal-body').innerHTML = `
            <h3 style="margin-bottom:12px;color:var(--blue);">ðŸª£ Add Bucket List Item</h3>
            <input id="bucket-title" placeholder="Dream or goal..." style="margin-bottom:12px;">
            <textarea id="bucket-desc" placeholder="Description (optional)..." rows="3" style="margin-bottom:12px;"></textarea>
            <button class="btn" onclick="App.saveBucketItem()">Add to Bucket List</button>`;
        document.getElementById('modal').classList.add('open');
        setTimeout(() => document.getElementById('bucket-title')?.focus(), 80);
    },

    saveBucketItem() {
        const title = document.getElementById('bucket-title')?.value?.trim();
        const description = document.getElementById('bucket-desc')?.value?.trim();
        if (!title) { this.toast('âš ï¸ Enter title'); return; }
        if (!this.data.plan.bucketList) this.data.plan.bucketList = [];
        this.data.plan.bucketList.push({ 
            id: this.genId(), 
            title, 
            description: description || '', 
            done: false,
            timestamp: new Date().toISOString() 
        });
        this.save(); this.closeModal(); this.render(); this.toast('ðŸª£ Added to bucket list');
    },

    toggleBucketItem(id) {
        const item = this.data.plan.bucketList.find(i => i.id === id);
        if (item) {
            item.done = !item.done;
            this.save(); this.render();
            this.toast(item.done ? 'âœ… Dream achieved!' : 'ðŸ”„ Unmarked');
        }
    },

    deleteBucketItem(id) {
        this.confirm('Remove from bucket list?', () => {
            this.data.plan.bucketList = (this.data.plan.bucketList || []).filter(i => i.id !== id);
            this.save(); this.render();
        }, 'Remove');
    },

    // EXPORT / RESET
    exportData() {
        const dataStr = JSON.stringify(this.data, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `svk-blueprint-export-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
        this.toast('âœ“ Data exported');
    },

    importAllData() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (evt) => {
                try {
                    const imported = JSON.parse(evt.target.result);
                    // Validate it's an SVK Blueprint export
                    if (typeof imported !== 'object' || Array.isArray(imported)) {
                        this.toast('âš ï¸ Invalid file â€” expected SVK Blueprint JSON export');
                        return;
                    }
                    // REPLACE all current data
                    this.data = Object.assign({}, SCHEMA, imported);
                    this.save();
                    this.render();
                    this.toast('âœ“ Data imported successfully');
                } catch (err) {
                    this.toast('âš ï¸ Failed to parse file: ' + err.message);
                }
            };
            reader.readAsText(file);
        };
        input.click();
    },

    resetBlueprint() {
        this.confirm('âš ï¸ Reset entire blueprint? This cannot be undone.', () => {
            localStorage.clear();
            location.reload();
        }, 'Reset Everything');
    },

    // QUICK CAPTURE - Primary capture interface accessible via FAB button
    // Provides 6 capture options: Quick Task, Note, Idea, Quote, Journal Entry, Reflection
    // This is the main capture function used throughout the app
    openCapture() {
        // Quick Capture Menu - Ideas/Notes/Journal/Goals/Affirmations + all Vault categories
        document.getElementById('modal-body').innerHTML = `
            <h3 style="margin-bottom:4px;color:var(--accent);">âš¡ Quick Capture</h3>
            <div style="max-height:70vh;overflow-y:auto;padding:2px;">
            <div style="font-size:10px;color:var(--dim);margin-bottom:14px;text-transform:uppercase;letter-spacing:1px;">Daily</div>
            <div style="display:grid;gap:8px;grid-template-columns:repeat(2, 1fr);margin-bottom:16px;">
                <button class="btn" onclick="App.addIdea()" style="background:var(--success);padding:12px;">
                    ðŸ’¡ Idea
                </button>
                <button class="btn" onclick="App.addNote()" style="padding:12px;">
                    ðŸ“ Note
                </button>
                <button class="btn" onclick="App.addQuote()" style="padding:12px;">
                    ðŸ’¬ Quote
                </button>
                <button class="btn" onclick="App.addJournalEntry()" style="padding:12px;">
                    ðŸ“” Journal
                </button>
                <button class="btn" onclick="App.addGoal()" style="padding:12px;">
                    ðŸŽ¯ Goal
                </button>
                <button class="btn" onclick="App.addAffirmation()" style="padding:12px;">
                    âœ¨ Affirmation
                </button>
            </div>
            <div style="font-size:10px;color:var(--dim);margin-bottom:10px;text-transform:uppercase;letter-spacing:1px;">Vault â€” Learn</div>
            <div style="display:grid;gap:8px;grid-template-columns:repeat(2, 1fr);margin-bottom:16px;">
                <button class="btn" onclick="App.addBookSummary()" style="padding:12px;">
                    ðŸ“– Book
                </button>
                <button class="btn" onclick="App.addSkill()" style="padding:12px;">
                    ðŸ›  Skill
                </button>
            </div>
            <div style="font-size:10px;color:var(--dim);margin-bottom:10px;text-transform:uppercase;letter-spacing:1px;">Vault â€” Earn</div>
            <div style="display:grid;gap:8px;grid-template-columns:repeat(2, 1fr);">
                <button class="btn" onclick="App.closeModal();App.addEarnItemEnhanced('strat')" style="padding:12px;">
                    ðŸ“Š Strategy
                </button>
                <button class="btn" onclick="App.closeModal();App.addEarnItemEnhanced('exec')" style="padding:12px;">
                    âš™ï¸ Execute
                </button>
                <button class="btn" onclick="App.closeModal();App.addEarnItemEnhanced('leverage')" style="padding:12px;">
                    ðŸ”— Leverage
                </button>
                <button class="btn" onclick="App.addContact()" style="padding:12px;">
                    ðŸ‘¤ Contact
                </button>
            </div>
            </div>`;
        document.getElementById('modal').classList.add('open');
    },

    closeModal() {
        // Clean up Pomodoro timer if running
        if (this.timer.interval) {
            clearInterval(this.timer.interval);
            this.timer.interval = null;
            this.timer.running = false;
        }
        
        // Clean up habit timer if running
        if (this.habitTimer.interval) {
            clearInterval(this.habitTimer.interval);
            this.habitTimer.interval = null;
        }

        // FIX: Reset avatar temp state so stale emoji doesn't persist across modal opens
        this._selectedAvatarTemp = null;
        
        document.getElementById('modal').classList.remove('open');
    },

    genId() {
        return Date.now().toString(36) + Math.random().toString(36).slice(2,7);
    },

    // Get all unique domains from blueprint and current cycle
    getAllDomains() {
        const domains = new Set();
        
        // Get from current cycle's goals_focus (primary source)
        if (this.data.currentCycle?.goals_focus) {
            Object.keys(this.data.currentCycle.goals_focus).forEach(d => domains.add(d));
        }
        
        // Get from all cycles' goals_focus (for comprehensive list)
        if (this.data.allCycles) {
            this.data.allCycles.forEach(cycle => {
                if (cycle.goals_focus) {
                    Object.keys(cycle.goals_focus).forEach(d => domains.add(d));
                }
            });
        }
        
        // Get from existing goals
        if (this.data.goals) {
            this.data.goals.forEach(g => {
                if (g.domain) domains.add(g.domain);
            });
        }
        
        // Get from existing tasks
        if (this.data.currentCycle?.tasks) {
            this.data.currentCycle.tasks.forEach(t => {
                if (t.domain) domains.add(t.domain);
            });
        }
        
        // Default domains if none found
        if (domains.size === 0) {
            return ['Career', 'Wealth', 'Health', 'Relationships', 'Learning'];
        }
        
        return Array.from(domains).sort();
    },
    
    // FIX: Add consistent color assignment based on domain name hash
    getDomainColor(domainName) {
        const colorPalette = ['#30d158', '#ffd60a', '#bf5af2', '#0a84ff', '#ff453a', '#ff9f0a', '#64d2ff', '#ff375f'];
        
        // Simple string hash function for consistent color assignment
        let hash = 0;
        for (let i = 0; i < domainName.length; i++) {
            hash = ((hash << 5) - hash) + domainName.charCodeAt(i);
            hash = hash & hash; // Convert to 32-bit integer
        }
        
        const index = Math.abs(hash) % colorPalette.length;
        return colorPalette[index];
    },

    // HABITS
    addHabit() {
        document.getElementById('modal-body').innerHTML = `
            <h3 style="margin-bottom:12px;color:var(--accent);">Add Habit</h3>
            <div style="margin-bottom:12px;">
                <input id="habit-title" placeholder="Habit name..." 
                       oninput="App.validateHabitTitle(this)"
                       style="margin-bottom:4px;">
                <div id="habit-title-error" style="font-size:11px;color:var(--danger);display:none;"></div>
            </div>
            <select id="habit-time" style="margin-bottom:12px;">
                <option value="">Time block (optional)</option>
                <option value="Morning">Morning</option>
                <option value="Work">Work</option>
                <option value="Evening">Evening</option>
            </select>
            <button class="btn" id="save-habit-btn" onclick="App.saveHabit()">Add Habit</button>`;
        document.getElementById('modal').classList.add('open');
        setTimeout(() => document.getElementById('habit-title')?.focus(), 80);
    },
    
    // NEW: Real-time validation for habit title
    validateHabitTitle(input) {
        const value = input.value.trim();
        const errorDiv = document.getElementById('habit-title-error');
        const saveBtn = document.getElementById('save-habit-btn');
        
        if (!value) {
            errorDiv.textContent = 'Habit name is required';
            errorDiv.style.display = 'block';
            input.style.borderColor = 'var(--danger)';
            if (saveBtn) saveBtn.disabled = true;
            return false;
        } else if (value.length < 3) {
            errorDiv.textContent = 'Habit name must be at least 3 characters';
            errorDiv.style.display = 'block';
            input.style.borderColor = 'var(--warn)';
            if (saveBtn) saveBtn.disabled = true;
            return false;
        } else if (value.length > 50) {
            errorDiv.textContent = 'Habit name must be less than 50 characters';
            errorDiv.style.display = 'block';
            input.style.borderColor = 'var(--warn)';
            if (saveBtn) saveBtn.disabled = true;
            return false;
        } else {
            errorDiv.style.display = 'none';
            input.style.borderColor = 'var(--border)';
            if (saveBtn) saveBtn.disabled = false;
            return true;
        }
    },

    saveHabit() {
        const title = document.getElementById('habit-title')?.value?.trim();
        const timeBlock = document.getElementById('habit-time')?.value;
        
        // Enhanced validation with specific messages
        if (!title) { 
            this.toast('âš ï¸ Habit name is required'); 
            document.getElementById('habit-title').focus();
            return; 
        }
        if (title.length < 3) {
            this.toast('âš ï¸ Habit name must be at least 3 characters');
            document.getElementById('habit-title').focus();
            return;
        }
        if (title.length > 50) {
            this.toast('âš ï¸ Habit name too long (max 50 characters)');
            document.getElementById('habit-title').focus();
            return;
        }
        
        if (!this.data.system.habits) this.data.system.habits = [];
        this.data.system.habits.push({
            id: this.genId(),
            title,
            timeBlock: timeBlock || null,
            completions: [],
            microSteps: [],
            created: new Date().toISOString()
        });
        this.save(); this.closeModal(); this.render();
        this.toast('âœ“ Habit added');
    },

    editHabit(id) {
        const habit = this.data.system.habits.find(h => h.id === id);
        if (!habit) return;
        
        document.getElementById('modal-body').innerHTML = `
            <h3 style="margin-bottom:12px;color:var(--accent);">Edit Habit</h3>
            <input id="edit-habit-title" placeholder="Habit name..." value="${esc(habit.title)}" style="margin-bottom:12px;">
            <select id="edit-habit-time" style="margin-bottom:12px;">
                <option value="">Time block (optional)</option>
                <option value="Morning" ${habit.timeBlock === 'Morning' ? 'selected' : ''}>Morning</option>
                <option value="Work" ${habit.timeBlock === 'Work' ? 'selected' : ''}>Work</option>
                <option value="Evening" ${habit.timeBlock === 'Evening' ? 'selected' : ''}>Evening</option>
            </select>
            <button class="btn" onclick="App.updateHabit('${id}')">Save Changes</button>
            <button class="btn-sec" onclick="App.closeModal()" style="margin-top:8px;">Cancel</button>`;
        document.getElementById('modal').classList.add('open');
        setTimeout(() => document.getElementById('edit-habit-title')?.focus(), 80);
    },

    updateHabit(id) {
        const habit = this.data.system.habits.find(h => h.id === id);
        if (!habit) return;
        
        const title = document.getElementById('edit-habit-title')?.value?.trim();
        const timeBlock = document.getElementById('edit-habit-time')?.value;
        
        if (!title) { this.toast('âš ï¸ Enter title'); return; }
        
        habit.title = title;
        habit.timeBlock = timeBlock || null;
        
        this.save(); this.closeModal(); this.render();
        this.toast('âœ“ Habit updated');
    },

    deleteHabit(id) {
        const habit = this.data.system.habits.find(h => h.id === id);
        if (!habit) return;
        this.confirm(`Delete habit "${habit.title}"? All history and micro-steps will be removed.`, () => {
            this.saveToUndoStack(`Delete habit: ${habit.title}`, this.data);
            this.data.system.habits = this.data.system.habits.filter(h => h.id !== id);
            this.save(); this.render();
            this.showUndoToast(`Habit "${habit.title}" deleted`, true);
        }, 'Delete');
    },

    dailyResetHabits() { return this.resetDailyHabits(); },
    resetDailyHabits() {
        if (!this.data.system?.habits || this.data.system.habits.length === 0) {
            this.toast('âš ï¸ No habits to reset');
            return;
        }
        this.confirm("Reset today's habit completions? History and habit definitions are kept.", () => this._doResetDailyHabits(), 'Reset', false);
    },
    _doResetDailyHabits() {
        
        const today = new Date().toISOString().split('T')[0];
        let resetCount = 0;
        let microStepResetCount = 0;
        
        // Reset habit completions for today
        this.data.system.habits.forEach(habit => {
            if (!habit.completions) habit.completions = [];
            
            const todayLog = habit.completions.find(c => c.date === today);
            if (todayLog && todayLog.done === true) {
                todayLog.done = false;
                resetCount++;
            }
            
            // Reset micro-steps to pending
            if (habit.microSteps && habit.microSteps.length > 0) {
                habit.microSteps.forEach(step => {
                    if (step.status !== 'pending') {
                        step.status = 'pending';
                        microStepResetCount++;
                    }
                });
            }
        });
        
        this.save();
        this.render();
        
        if (resetCount > 0 || microStepResetCount > 0) {
            this.toast(`ðŸ”„ Reset ${resetCount} habit${resetCount !== 1 ? 's' : ''} and ${microStepResetCount} micro-step${microStepResetCount !== 1 ? 's' : ''}`);
        } else {
            this.toast('âœ“ No habits to reset for today');
        }
    },

    manageMicroSteps(habitId) {
        const habit = this.data.system.habits.find(h => h.id === habitId);
        if (!habit) return;
        
        if (!habit.microSteps) habit.microSteps = [];
        
        let html = `
            <h3 style="margin-bottom:12px;color:var(--accent);">ðŸŽ¯ Micro-Steps: ${esc(habit.title)}</h3>
            <p style="font-size:12px;color:var(--dim);margin-bottom:16px;">
                Break down your habit into small, actionable steps
            </p>`;
        
        if (habit.microSteps.length === 0) {
            html += `<div style="text-align:center;padding:20px;color:var(--dim);font-size:13px;">
                No micro-steps yet. Add your first step below.
            </div>`;
        } else {
            html += `<div style="max-height:300px;overflow-y:auto;margin-bottom:16px;">`;
            habit.microSteps.forEach((step, index) => {
                const statusIcon = step.status === 'done' ? 'âœ…' : step.status === 'active' ? 'ðŸ”„' : 'â—‹';
                html += `
                    <div style="display:flex;align-items:center;gap:8px;padding:10px;background:var(--sub);
                         border-radius:8px;margin-bottom:8px;border:1px solid var(--border);">
                        <button onclick="App.toggleMicroStepStatus('${habitId}', ${index})" 
                                style="background:none;border:none;font-size:18px;cursor:pointer;padding:4px;">
                            ${statusIcon}
                        </button>
                        <div style="flex:1;font-size:13px;color:${step.status === 'done' ? 'var(--dim)' : 'var(--text)'};
                             text-decoration:${step.status === 'done' ? 'line-through' : 'none'};">
                            ${esc(step.title)}
                        </div>
                        <button onclick="App.deleteMicroStep('${habitId}', ${index})" 
                                style="background:none;border:none;color:var(--danger);cursor:pointer;
                                font-size:16px;padding:4px;">
                            ðŸ—‘ï¸
                        </button>
                    </div>`;
            });
            html += `</div>`;
        }
        
        html += `
            <div style="border-top:1px solid var(--border);padding-top:16px;">
                <input id="new-microstep" placeholder="Add new micro-step..." 
                       style="margin-bottom:12px;"
                       onkeypress="if(event.key==='Enter')App.addMicroStep('${habitId}')">
                <div style="display:flex;gap:8px;">
                    <button class="btn" style="flex:1;" onclick="App.addMicroStep('${habitId}')">
                        âž• Add Step
                    </button>
                    <button class="btn-sec" onclick="App.closeModal()">
                        Done
                    </button>
                </div>
            </div>`;
        
        document.getElementById('modal-body').innerHTML = html;
        document.getElementById('modal').classList.add('open');
        setTimeout(() => document.getElementById('new-microstep')?.focus(), 80);
    },

    addMicroStep(habitId) {
        const habit = this.data.system.habits.find(h => h.id === habitId);
        if (!habit) return;
        
        const title = document.getElementById('new-microstep')?.value?.trim();
        if (!title) { this.toast('âš ï¸ Enter step name'); return; }
        
        if (!habit.microSteps) habit.microSteps = [];
        habit.microSteps.push({
            id: this.genId(),
            title,
            status: 'pending', // pending, active, done
            created: new Date().toISOString()
        });
        
        this.save();
        this.manageMicroSteps(habitId); // Refresh the modal
        this.toast('âœ“ Step added');
    },

    toggleMicroStepStatus(habitId, index) {
        const habit = this.data.system.habits.find(h => h.id === habitId);
        if (!habit || !habit.microSteps || !habit.microSteps[index]) return;
        
        const step = habit.microSteps[index];
        
        // Cycle through: pending â†’ active â†’ done â†’ pending
        if (step.status === 'pending') {
            step.status = 'active';
        } else if (step.status === 'active') {
            step.status = 'done';
        } else {
            step.status = 'pending';
        }
        
        this.save();
        this.manageMicroSteps(habitId); // Refresh the modal
    },

    deleteMicroStep(habitId, index) {
        const habit = this.data.system.habits.find(h => h.id === habitId);
        if (!habit || !habit.microSteps || !habit.microSteps[index]) return;
        const step = habit.microSteps[index];
        this.confirm(`Delete "${step.title}"?`, () => {
            habit.microSteps.splice(index, 1);
            this.save();
            this.manageMicroSteps(habitId);
            this.toast('âœ“ Step deleted');
        }, 'Delete');
    },

    toggleHabit(id) {
        const habit = this.data.system.habits.find(h => h.id === id);
        if (!habit) return;
        const today = new Date().toISOString().split('T')[0];
        if (!habit.completions) habit.completions = [];
        const todayLog = habit.completions.find(c => c.date === today);
        if (todayLog) {
            todayLog.done = !todayLog.done;
        } else {
            habit.completions.push({ date: today, done: true });
        }
        const wasDone = todayLog ? !todayLog.done : false; // after toggle, new state
        // todayLog was mutated: if it existed and done was true->false, it's undone
        const newDone = todayLog ? todayLog.done : true; // pushed true if no log existed
        this.save(); this.render();
        this.toast(newDone ? 'âœ“ Habit done!' : 'â—‹ Marked undone');
    },

    calcStreak(completions) {
        // Legacy function - use calculateStreaks instead
        const result = this.calculateStreaks({ completions });
        return result.current;
    },

    calculateStreaks(habit) {
        if (!habit.completions || habit.completions.length === 0) {
            return { current: 0, longest: 0 };
        }
        
        // Extract dates from completions (handle both old and new format)
        const dates = habit.completions
            .filter(c => c.done !== false)
            .map(c => {
                if (typeof c === 'string') return new Date(c);
                return new Date(c.date);
            })
            .sort((a, b) => a - b);
        
        if (dates.length === 0) {
            return { current: 0, longest: 0 };
        }
        
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        // Calculate current streak
        let currentStreak = 0;
        let checkDate = new Date(today);
        
        while (true) {
            const dateStr = checkDate.toISOString().split('T')[0];
            const hasCompletion = habit.completions.some(c => {
                if (typeof c === 'string') {
                    return c.startsWith(dateStr);
                }
                return c.date && c.date.startsWith(dateStr) && c.done !== false;
            });
            
            if (hasCompletion) {
                currentStreak++;
                checkDate.setDate(checkDate.getDate() - 1);
            } else {
                break;
            }
        }
        
        // Calculate longest streak
        let longestStreak = 0;
        let tempStreak = 1;
        
        for (let i = 1; i < dates.length; i++) {
            const diff = (dates[i] - dates[i-1]) / (1000 * 60 * 60 * 24);
            
            if (diff === 1) {
                tempStreak++;
                longestStreak = Math.max(longestStreak, tempStreak);
            } else {
                tempStreak = 1;
            }
        }
        
        longestStreak = Math.max(longestStreak, currentStreak, 1);
        
        return { current: currentStreak, longest: longestStreak };
    },

    renderHeatmap(completions) {
        const days = [];
        const today = new Date();
        for (let i = 29; i >= 0; i--) {
            const date = new Date(today);
            date.setDate(date.getDate() - i);
            const dateStr = date.toISOString().split('T')[0];
            const displayDate = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            const log = completions?.find(c => c.date === dateStr);
            const done = log?.done || false;
            days.push(`<div class="heatmap-day ${done ? 'done' : ''}" title="${displayDate}${done ? ' âœ“' : ''}"></div>`);
        }
        return `<div class="heatmap">${days.join('')}</div>`;
    },

    // HABIT TIMER SYSTEM
    startHabitTimer(habitId) {
        const habit = this.data.system.habits.find(h => h.id === habitId);
        if (!habit) return;

        // Initialize micro steps if not present
        if (!habit.microSteps || habit.microSteps.length === 0) {
            this.promptMicroSteps(habitId);
            return;
        }

        // Prompt for duration, intention, and timer mode
        document.getElementById('modal-body').innerHTML = `
            <h3 style="margin-bottom:12px;color:var(--accent);">â±ï¸ Set Timer for "${esc(habit.title)}"</h3>
            
            <div style="margin-bottom:16px;">
                <label style="display:block;font-size:12px;color:var(--dim);margin-bottom:6px;">Timer Mode</label>
                <select id="timer-mode" style="margin-bottom:0;">
                    <option value="zen">ðŸ§˜ Zen Mode - One step at a time (Recommended)</option>
                    <option value="classic">ðŸ“‹ Classic Mode - All steps visible</option>
                </select>
            </div>
            
            <div style="margin-bottom:16px;">
                <label style="display:block;font-size:12px;color:var(--dim);margin-bottom:6px;">Duration (minutes)</label>
                <input type="number" id="timer-duration" value="25" min="1" max="180" 
                       placeholder="e.g., 25" style="margin-bottom:0;">
            </div>
            
            <div style="margin-bottom:16px;">
                <label style="display:block;font-size:12px;color:var(--dim);margin-bottom:6px;">Intention (What will you accomplish?)</label>
                <textarea id="timer-intention" placeholder="e.g., Complete full morning routine without distractions" 
                          rows="3" style="margin-bottom:0;"></textarea>
            </div>
            
            <button class="btn" onclick="App.startHabitTimerWithIntent('${habitId}')">Start Timer</button>
        `;
        document.getElementById('modal').classList.add('open');
        setTimeout(() => document.getElementById('timer-mode')?.focus(), 80);
    },

    startHabitTimerWithIntent(habitId) {
        const habit = this.data.system.habits.find(h => h.id === habitId);
        if (!habit) return;

        const duration = parseInt(document.getElementById('timer-duration')?.value) || 25;
        const intention = document.getElementById('timer-intention')?.value?.trim() || '';
        const mode = document.getElementById('timer-mode')?.value || 'zen';

        // Reset all micro steps to pending at start
        habit.microSteps.forEach(step => {
            if (step.status !== 'done') {
                step.status = 'pending';
            }
        });
        this.save();

        // NEW: Route to Zen Mode or Classic Mode
        if (mode === 'zen') {
            this.startZenTimer(habitId, duration, intention);
        } else {
            this.startClassicTimer(habitId, duration, intention);
        }
    },
    
    // NEW: Zen Mode Timer - One step at a time
    startZenTimer(habitId, duration, intention) {
        const habit = this.data.system.habits.find(h => h.id === habitId);
        if (!habit) return;
        
        this.zenMode = {
            active: true,
            habitId: habitId,
            taskId: null,
            intention: intention,
            currentStepIndex: 0,
            startTime: Date.now(),
            duration: 0,
            targetDuration: duration * 60,
            interval: null,
            isPaused: false,
            steps: habit.microSteps || []
        };
        
        this.closeModal();
        this.showZenTimer();
        
        // Start interval
        this.zenMode.interval = setInterval(() => {
            if (!this.zenMode.isPaused) {
                this.zenMode.duration = Math.floor((Date.now() - this.zenMode.startTime) / 1000);
                this.updateZenTimerDisplay();
            }
        }, 1000);
        
        // Initial display
        this.updateZenTimerDisplay();
    },
    
    // Classic Timer (existing functionality)
    startClassicTimer(habitId, duration, intention) {
        const habit = this.data.system.habits.find(h => h.id === habitId);
        if (!habit) return;

        this.habitTimer = {
            habitId: habitId,
            startTime: Date.now(),
            duration: 0,
            targetDuration: duration * 60, // Convert to seconds
            intention: intention,
            interval: null,
            isPaused: false
        };

        this.showHabitTimerOverlay();
        
        // FIXED: Force immediate display update BEFORE starting interval
        this.updateHabitTimerDisplay();
        
        // FIXED: Start interval - timer will tick every second
        this.habitTimer.interval = setInterval(() => {
            if (!this.habitTimer.isPaused) {
                this.habitTimer.duration = Math.floor((Date.now() - this.habitTimer.startTime) / 1000);
                this.updateHabitTimerDisplay();
            }
        }, 1000);
    },

    promptMicroSteps(habitId) {
        const habit = this.data.system.habits.find(h => h.id === habitId);
        if (!habit) return;

        document.getElementById('modal-body').innerHTML = `
            <h3 style="margin-bottom:12px;color:var(--accent);">Break "${esc(habit.title)}" into Micro-Steps</h3>
            <p style="font-size:13px;color:var(--dim);margin-bottom:12px;">Enter each tiny step on a new line. Make them as small as possible!</p>
            <textarea id="micro-steps" placeholder="Example for 'Workout':
Lay out yoga mat
Put on workout clothes
Do 5 push-ups
Drink water
..." rows="8" style="margin-bottom:12px;"></textarea>
            <button class="btn" onclick="App.saveMicroSteps('${habitId}')">Save & Start Timer</button>`;
        document.getElementById('modal').classList.add('open');
        setTimeout(() => document.getElementById('micro-steps')?.focus(), 80);
    },

    saveMicroSteps(habitId) {
        const stepsText = document.getElementById('micro-steps')?.value?.trim();
        if (!stepsText) {
            this.toast('âš ï¸ Enter at least one step');
            return;
        }

        const habit = this.data.system.habits.find(h => h.id === habitId);
        if (!habit) return;

        const steps = stepsText.split('\n')
            .filter(s => s.trim())
            .map(s => ({
                id: this.genId(),
                title: s.trim(),
                status: 'pending' // pending, active, done
            }));

        habit.microSteps = steps;
        this.save();
        this.closeModal();
        this.startHabitTimer(habitId);
    },

    showHabitTimerOverlay() {
        const habit = this.data.system.habits.find(h => h.id === this.habitTimer.habitId);
        if (!habit) return;

        document.getElementById('habit-timer-overlay').classList.add('active');
        this.updateHabitTimerDisplay();
    },

    updateHabitTimerDisplay() {
        const habit = this.data.system.habits.find(h => h.id === this.habitTimer.habitId);
        if (!habit) return;

        // Calculate time remaining (COUNTDOWN)
        const timeRemaining = Math.max(0, this.habitTimer.targetDuration - this.habitTimer.duration);
        const remainingMins = Math.floor(timeRemaining / 60);
        const remainingSecs = timeRemaining % 60;
        const countdownStr = `${String(remainingMins).padStart(2, '0')}:${String(remainingSecs).padStart(2, '0')}`;

        // Calculate elapsed time (for secondary display)
        const minutes = Math.floor(this.habitTimer.duration / 60);
        const seconds = this.habitTimer.duration % 60;
        const elapsedStr = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

        const completedSteps = habit.microSteps?.filter(s => s.status === 'done').length || 0;
        const totalSteps = habit.microSteps?.length || 0;
        const progress = totalSteps > 0 ? Math.round((completedSteps / totalSteps) * 100) : 0;

        // Calculate time progress
        const timeProgress = this.habitTimer.targetDuration > 0 
            ? Math.min(Math.round((this.habitTimer.duration / this.habitTimer.targetDuration) * 100), 100) 
            : 0;
        const targetMinutes = Math.floor(this.habitTimer.targetDuration / 60);

        // FIXED: Use wrapper div with flex column layout for proper structure
        let html = `
            <div style="display:flex;flex-direction:column;height:100%;max-height:85vh;">
                <!-- TOP: Title, Intention & Countdown (Fixed Position) -->
                <div style="flex-shrink:0;text-align:center;padding:16px;">
                    <div class="habit-timer-title" style="margin-bottom:12px;">${esc(habit.title)}</div>
                    
                    ${this.habitTimer.intention ? `
                        <div style="background:var(--sub);padding:12px;border-radius:8px;margin-bottom:16px;
                             border-left:3px solid var(--accent);">
                            <div style="font-size:11px;color:var(--dim);text-transform:uppercase;
                                 letter-spacing:1px;margin-bottom:4px;">INTENTION</div>
                            <div style="font-size:13px;line-height:1.5;">${esc(this.habitTimer.intention)}</div>
                        </div>
                    ` : ''}
                    
                    <div class="habit-timer-clock countdown-ticking" style="margin:16px 0 8px 0;position:relative;">
                        ${countdownStr}
                        <div style="position:absolute;bottom:-20px;left:50%;transform:translateX(-50%);
                                    font-size:10px;color:var(--success);font-weight:600;
                                    text-transform:uppercase;letter-spacing:2px;">
                            ${this.habitTimer.isPaused ? 'â¸ PAUSED' : 'â–¶ RUNNING'}
                        </div>
                    </div>
                    <div style="font-size:11px;color:var(--dim);letter-spacing:2px;margin-top:24px;">REMAINING</div>
                    
                    ${this.habitTimer.targetDuration > 0 ? `
                        <div style="margin:16px 0 0 0;">
                            <span style="color:rgba(255,255,255,0.4);font-size:12px;">Spent: </span>
                            <span style="color:rgba(255,255,255,0.6);font-size:14px;font-weight:500;font-family:monospace;">
                                ${elapsedStr}
                            </span>
                            <span style="color:rgba(255,255,255,0.4);font-size:12px;"> / ${targetMinutes}:00</span>
                        </div>
                        <div style="margin:12px 0;">
                            <div style="height:6px;background:var(--void);border-radius:3px;overflow:hidden;
                                 border:1px solid var(--border);">
                                <div style="width:${timeProgress}%;height:100%;background:var(--accent);
                                     border-radius:3px;transition:width 1s linear;"></div>
                            </div>
                        </div>
                    ` : ''}
                </div>
                
                <!-- MIDDLE: Scrollable Micro-Steps List -->
                <div style="flex:1;overflow-y:auto;padding:0 16px;margin-bottom:16px;">
                    ${habit.microSteps?.length > 0 ? `
                        <div style="margin-bottom:16px;">
                            <div style="font-size:13px;font-weight:600;color:var(--accent);margin-bottom:12px;text-transform:uppercase;letter-spacing:1px;">
                                Micro-Steps Checklist
                            </div>
                            
                            ${habit.microSteps.map((step, idx) => {
                                const isCompleted = step.status === 'done';
                                const isSkipped = step.status === 'skipped';
                                
                                return `
                                    <div style="display:flex;align-items:center;justify-content:space-between;
                                                padding:12px;background:var(--sub);border-radius:8px;
                                                margin-bottom:8px;border:1px solid var(--border);
                                                ${isCompleted ? 'opacity:0.6;' : ''}">
                                        <div style="flex:1;color:${isCompleted || isSkipped ? 'var(--dim)' : 'var(--text)'};
                                                    text-decoration:${isCompleted ? 'line-through' : 'none'};
                                                    font-size:14px;">
                                            ${esc(step.title)}
                                        </div>
                                        
                                        ${!isCompleted && !isSkipped ? `
                                            <div style="display:flex;gap:6px;">
                                                <button onclick="App.skipMicroStep(${idx})" 
                                                        style="padding:6px 12px;background:var(--border);
                                                               border:none;border-radius:6px;color:var(--dim);
                                                               font-size:12px;cursor:pointer;">
                                                    Skip
                                                </button>
                                                <button onclick="App.completeMicroStep(${idx})" 
                                                        style="padding:6px 12px;background:var(--success);
                                                               border:none;border-radius:6px;color:var(--void);
                                                               font-size:12px;font-weight:600;cursor:pointer;">
                                                    Done
                                                </button>
                                            </div>
                                        ` : isCompleted ? `
                                            <div style="font-size:18px;color:var(--success);">âœ“</div>
                                        ` : `
                                            <div style="font-size:12px;color:var(--dim);">Skipped</div>
                                        `}
                                    </div>
                                `;
                            }).join('')}
                            
                            <div style="margin-top:16px;height:4px;background:var(--void);border-radius:2px;overflow:hidden;border:1px solid var(--border);">
                                <div style="width:${progress}%;height:100%;background:var(--success);transition:width 0.3s;"></div>
                            </div>
                            <div style="text-align:center;margin-top:8px;font-size:13px;color:var(--dim);">
                                ${completedSteps}/${totalSteps} completed (${progress}%)
                            </div>
                        </div>
                    ` : ''}
                </div>
                
                <!-- BOTTOM: Buttons on Same Line (Fixed Position) -->
                <div style="flex-shrink:0;display:flex;gap:12px;padding:16px;border-top:1px solid var(--border);">
                    <button onclick="App.pauseHabitTimer()" 
                            style="flex:1;padding:14px;background:var(--warn);color:var(--void);
                                   border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;">
                        ${this.habitTimer.isPaused ? 'â–¶ï¸ Resume' : 'â¸ï¸ Pause'}
                    </button>
                    <button onclick="App.completeHabitSession()" 
                            style="flex:1;padding:14px;background:var(--success);color:var(--void);
                                   border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;">
                        âœ“ Complete
                    </button>
                    <button onclick="App.stopHabitTimer()" 
                            style="flex:1;padding:14px;background:var(--danger);color:var(--text);
                                   border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;">
                        âœ• Stop
                    </button>
                </div>
            </div>
        `;

        document.getElementById('habit-timer-content').innerHTML = html;

        // FIXED: Update header badge with countdown string (not undefined timeStr)
        const badge = document.getElementById('timer-badge');
        if (badge) {
            badge.textContent = countdownStr;
            badge.classList.add('active');
        }

        // Auto-complete if all steps done
        if (totalSteps > 0 && completedSteps === totalSteps) {
            setTimeout(() => this.completeHabitSession(), 1000);
        }
    },

    pauseHabitTimer() {
        this.habitTimer.isPaused = !this.habitTimer.isPaused;
        this.updateHabitTimerDisplay();
    },

    stopHabitTimer() {
        this.confirm('Stop this habit session?', () => this._doStopHabitTimer(), 'Stop');
    },
    _doStopHabitTimer() {
        
        if (this.habitTimer.interval) {
            clearInterval(this.habitTimer.interval);
        }

        document.getElementById('habit-timer-overlay').classList.remove('active');
        document.getElementById('timer-badge').classList.remove('active');
        
        this.habitTimer = {
            habitId: null,
            startTime: null,
            duration: 0,
            interval: null,
            isPaused: false
        };

        this.render();
    },

    completeMicroStep(stepIdx) {
        const habit = this.data.system.habits.find(h => h.id === this.habitTimer.habitId);
        if (!habit || !habit.microSteps[stepIdx]) return;

        habit.microSteps[stepIdx].status = 'done';
        this.save();
        this.updateHabitTimerDisplay();
        this.toast('âœ“ Step completed');
    },

    skipMicroStep(stepIdx) {
        const habit = this.data.system.habits.find(h => h.id === this.habitTimer.habitId);
        if (!habit || !habit.microSteps[stepIdx]) return;

        habit.microSteps[stepIdx].status = 'skipped';
        this.save();
        this.updateHabitTimerDisplay();
        this.toast('â†’ Step skipped');
    },

    completeHabitSession() {
        const habit = this.data.system.habits.find(h => h.id === this.habitTimer.habitId);
        if (!habit) return;

        const completedSteps = habit.microSteps?.filter(s => s.status === 'done').length || 0;
        const totalSteps = habit.microSteps?.length || 0;

        this.celebrate('ðŸŽ‰', 'Habit Session Complete!', `${completedSteps}/${totalSteps} steps completed in ${Math.floor(this.habitTimer.duration / 60)} min`);
        
        // Mark habit as done for today
        this.toggleHabit(this.habitTimer.habitId);
        
        // Stop timer
        setTimeout(() => {
            this.stopHabitTimer();
        }, 2000);
    },
    
    // ========== ZEN MODE TIMER FUNCTIONS ==========
    
    showZenTimer() {
        document.getElementById('zen-timer-overlay').classList.add('active');
        this.updateZenTimerDisplay();
    },
    
    updateZenTimerDisplay() {
        const habit = this.data.system.habits.find(h => h.id === this.zenMode.habitId);
        if (!habit) return;
        
        // Calculate countdown
        const timeRemaining = Math.max(0, this.zenMode.targetDuration - this.zenMode.duration);
        const remainingMins = Math.floor(timeRemaining / 60);
        const remainingSecs = timeRemaining % 60;
        const countdownStr = `${String(remainingMins).padStart(2, '0')}:${String(remainingSecs).padStart(2, '0')}`;
        
        // Get current step
        const currentStep = this.zenMode.steps[this.zenMode.currentStepIndex];
        const completedSteps = this.zenMode.steps.filter(s => s.status === 'done').length;
        const totalSteps = this.zenMode.steps.length;
        
        // Check if all steps are done
        if (this.zenMode.currentStepIndex >= totalSteps) {
            this.completeZenSession();
            return;
        }
        
        const html = `
            <div class="zen-title">${esc(habit.title)}</div>
            
            ${this.zenMode.intention ? `
                <div class="zen-intention">
                    <div class="zen-intention-label">Your Intention</div>
                    <div class="zen-intention-text">${esc(this.zenMode.intention)}</div>
                </div>
            ` : ''}
            
            <div class="zen-countdown ${this.zenMode.isPaused ? '' : 'zen-pulse'}">
                ${countdownStr}
            </div>
            
            <div class="zen-step-card">
                <div class="zen-step-number">${this.zenMode.currentStepIndex + 1}</div>
                <div class="zen-step-text">${esc(currentStep.title)}</div>
                <div class="zen-step-progress">${completedSteps} of ${totalSteps} completed</div>
                
                <div class="zen-buttons">
                    <button class="zen-btn zen-btn-skip" onclick="App.zenSkipStep()">
                        Skip
                    </button>
                    <button class="zen-btn zen-btn-done" onclick="App.zenCompleteStep()">
                        âœ“ Done
                    </button>
                </div>
            </div>
            
            <div class="zen-controls">
                <button class="zen-control-btn" onclick="App.zenTogglePause()">
                    ${this.zenMode.isPaused ? 'â–¶ï¸ Resume' : 'â¸ï¸ Pause'}
                </button>
                <button class="zen-control-btn" onclick="App.zenStopTimer()">
                    âœ• Stop
                </button>
            </div>
        `;
        
        document.getElementById('zen-timer-content').innerHTML = html;
        
        // Update header badge
        const badge = document.getElementById('timer-badge');
        if (badge) {
            badge.textContent = countdownStr;
            badge.classList.add('active');
        }
    },
    
    zenCompleteStep() {
        const habit = this.data.system.habits.find(h => h.id === this.zenMode.habitId);
        if (!habit) return;
        
        // Mark current step as done
        const currentIndex = this.zenMode.currentStepIndex;
        if (currentIndex < this.zenMode.steps.length) {
            this.zenMode.steps[currentIndex].status = 'done';
            habit.microSteps[currentIndex].status = 'done';
            this.save();
        }
        
        // Move to next step
        this.zenMode.currentStepIndex++;
        
        // Update display
        this.updateZenTimerDisplay();
        
        // Haptic feedback (if available)
        if (navigator.vibrate) {
            navigator.vibrate(50);
        }
    },
    
    zenSkipStep() {
        const habit = this.data.system.habits.find(h => h.id === this.zenMode.habitId);
        if (!habit) return;
        
        // Mark current step as skipped
        const currentIndex = this.zenMode.currentStepIndex;
        if (currentIndex < this.zenMode.steps.length) {
            this.zenMode.steps[currentIndex].status = 'skipped';
            habit.microSteps[currentIndex].status = 'skipped';
            this.save();
        }
        
        // Move to next step
        this.zenMode.currentStepIndex++;
        
        // Update display
        this.updateZenTimerDisplay();
    },
    
    zenTogglePause() {
        this.zenMode.isPaused = !this.zenMode.isPaused;
        
        if (this.zenMode.isPaused) {
            // Store pause time
            this.zenMode.pausedAt = Date.now();
        } else {
            // Adjust start time to account for pause duration
            const pauseDuration = Date.now() - this.zenMode.pausedAt;
            this.zenMode.startTime += pauseDuration;
        }
        
        this.updateZenTimerDisplay();
    },
    
    zenStopTimer() {
        this.confirm('Stop this Zen session?', () => this._doZenStopTimer(), 'Stop');
    },
    _doZenStopTimer() {
        
        if (this.zenMode.interval) {
            clearInterval(this.zenMode.interval);
        }
        
        document.getElementById('zen-timer-overlay').classList.remove('active');
        document.getElementById('timer-badge').classList.remove('active');
        
        // Reset zen mode
        this.zenMode = {
            active: false,
            habitId: null,
            taskId: null,
            intention: '',
            currentStepIndex: 0,
            startTime: null,
            duration: 0,
            targetDuration: 0,
            interval: null,
            isPaused: false,
            steps: []
        };
        
        this.render();
    },
    
    completeZenSession() {
        const habit = this.data.system.habits.find(h => h.id === this.zenMode.habitId);
        if (!habit) return;
        
        const completedSteps = this.zenMode.steps.filter(s => s.status === 'done').length;
        const totalSteps = this.zenMode.steps.length;
        const minutes = Math.floor(this.zenMode.duration / 60);
        
        this.celebrate('ðŸ§˜', 'Zen Session Complete!', `${completedSteps}/${totalSteps} steps â€¢ ${minutes} min`);
        
        // Mark habit as done for today (this will increment streak)
        this.toggleHabit(this.zenMode.habitId);
        
        // Stop timer after celebration - NO CONFIRM DIALOG
        setTimeout(() => {
            this.zenStopTimerAutomatic();
        }, 2500);
    },
    
    // New function: Stop timer without confirmation (for auto-completion)
    zenStopTimerAutomatic() {
        if (this.zenMode.interval) {
            clearInterval(this.zenMode.interval);
        }
        
        document.getElementById('zen-timer-overlay').classList.remove('active');
        document.getElementById('timer-badge').classList.remove('active');
        
        // Reset zen mode
        this.zenMode = {
            active: false,
            habitId: null,
            taskId: null,
            intention: '',
            currentStepIndex: 0,
            startTime: null,
            duration: 0,
            targetDuration: 0,
            interval: null,
            isPaused: false,
            steps: []
        };
        
        this.render();
    },

    // MICROHABITS

    // REFLECTIONS
    addReflection(type) {
        const title = type === 'morning' ? 'ðŸŒ… Morning Reflection' : 'ðŸŒ™ Evening Reflection';
        const placeholder = type === 'morning' 
            ? 'What are my intentions for today?\nWhat am I grateful for?\nWhat will I focus on?'
            : 'What did I learn today?\nWhat am I grateful for?\nWhat will I do differently tomorrow?';
        
        document.getElementById('modal-body').innerHTML = `
            <h3 style="margin-bottom:12px;color:var(--accent);">${title}</h3>
            <textarea id="ref-text" placeholder="${placeholder}" rows="8" style="margin-bottom:12px;"></textarea>
            <button class="btn" onclick="App.saveReflection('${type}')">Save Reflection</button>`;
        document.getElementById('modal').classList.add('open');
        setTimeout(() => document.getElementById('ref-text')?.focus(), 80);
    },

    saveReflection(type) {
        const text = document.getElementById('ref-text')?.value?.trim();
        if (!text) { this.toast('âš ï¸ Enter text'); return; }
        if (!this.data.system.reflections[type]) this.data.system.reflections[type] = [];
        this.data.system.reflections[type].push({
            id: this.genId(),
            text,
            date: new Date().toISOString()
        });
        this.save(); this.closeModal(); this.render();
        this.toast('âœ“ Reflection saved');
    },

    // JOURNAL
    addJournalEntry() {
        document.getElementById('modal-body').innerHTML = `
            <h3 style="margin-bottom:12px;color:var(--accent);">âœï¸ Journal Entry</h3>
            <textarea id="journal-text" placeholder="What's on your mind?" rows="10" style="margin-bottom:12px;"></textarea>
            <button class="btn" onclick="App.saveJournalEntry()">Save Entry</button>`;
        document.getElementById('modal').classList.add('open');
        setTimeout(() => document.getElementById('journal-text')?.focus(), 80);
    },

    saveJournalEntry() {
        const text = document.getElementById('journal-text')?.value?.trim();
        if (!text) { this.toast('âš ï¸ Enter text'); return; }
        if (!this.data.system.journal) this.data.system.journal = [];
        this.data.system.journal.push({
            id: this.genId(),
            text,
            date: new Date().toISOString()
        });
        this.save(); this.closeModal(); this.render();
        this.toast('âœ“ Journal entry saved');
    },

    // REVIEWS
    addWeeklyReview() {
        document.getElementById('modal-body').innerHTML = `
            <h3 style="margin-bottom:12px;color:var(--accent);">ðŸ“Š Weekly Review</h3>
            <textarea id="review-wins" placeholder="Wins this week..." rows="4" style="margin-bottom:12px;"></textarea>
            <textarea id="review-lessons" placeholder="Lessons learned..." rows="4" style="margin-bottom:12px;"></textarea>
            <textarea id="review-next" placeholder="Focus for next week..." rows="4" style="margin-bottom:12px;"></textarea>
            <button class="btn" onclick="App.saveWeeklyReview()">Save Review</button>`;
        document.getElementById('modal').classList.add('open');
        setTimeout(() => document.getElementById('review-wins')?.focus(), 80);
    },

    saveWeeklyReview() {
        const wins = document.getElementById('review-wins')?.value?.trim();
        const lessons = document.getElementById('review-lessons')?.value?.trim();
        const nextWeek = document.getElementById('review-next')?.value?.trim();
        if (!wins && !lessons && !nextWeek) { this.toast('âš ï¸ Enter at least one field'); return; }
        if (!this.data.system.reviews) this.data.system.reviews = [];
        this.data.system.reviews.push({
            id: this.genId(),
            wins,
            lessons,
            nextWeek,
            date: new Date().toISOString()
        });
        this.save(); this.closeModal(); this.render();
        this.toast('âœ“ Review saved');
    },

    // ============================================================================
    // SYSTEM TAB ENHANCEMENTS - v2.1
    // ============================================================================
    
    // Data Migration - Ensure IDs on all items
    ensureIds(data) {
        // Reflections
        if (data.system?.reflections) {
            ['morning', 'evening'].forEach(type => {
                if (data.system.reflections[type]) {
                    data.system.reflections[type] = data.system.reflections[type].map(r => ({
                        ...r,
                        id: r.id || this.genId(),
                        tags: r.tags || []
                    }));
                }
            });
        }
        
        // Journal
        if (data.system?.journal) {
            data.system.journal = data.system.journal.map(j => ({
                ...j,
                id: j.id || this.genId(),
                tags: j.tags || []
            }));
        }
        
        // Reviews
        if (data.system?.reviews) {
            data.system.reviews = data.system.reviews.map(r => ({
                ...r,
                id: r.id || this.genId(),
                tags: r.tags || []
            }));
        }
        
        // Notes (vault)
        if (data.vault?.learnings?.notes) {
            data.vault.learnings.notes = data.vault.learnings.notes.map(n => ({
                ...n,
                id: n.id || this.genId(),
                tags: n.tags || []
            }));
        }
    },
    
    // ========== ENHANCED REFLECTION CRUD ==========
    
    editReflection(type, id) {
        const ref = this.data.system.reflections[type]?.find(r => r.id === id);
        if (!ref) return;
        
        const title = type === 'morning' ? 'ðŸŒ… Edit Morning Reflection' : 'ðŸŒ™ Edit Evening Reflection';
        document.getElementById('modal-body').innerHTML = `
            <h3 style="margin-bottom:12px;color:var(--accent);">${title}</h3>
            <div style="font-size:11px;color:var(--dim);margin-bottom:8px;">Original: ${new Date(ref.date).toLocaleDateString()}</div>
            <textarea id="ref-text-edit" rows="8" style="margin-bottom:12px;">${esc(ref.text)}</textarea>
            <button class="btn" onclick="App.updateReflection('${type}', '${id}')">Update Reflection</button>
            <button class="btn-sec" onclick="App.closeModal()" style="margin-top:8px;">Cancel</button>`;
        document.getElementById('modal').classList.add('open');
        setTimeout(() => document.getElementById('ref-text-edit')?.focus(), 80);
    },
    
    updateReflection(type, id) {
        const text = document.getElementById('ref-text-edit')?.value?.trim();
        if (!text) { this.toast('âš ï¸ Enter text'); return; }
        
        const ref = this.data.system.reflections[type]?.find(r => r.id === id);
        if (ref) {
            ref.text = text;
            ref.modified = new Date().toISOString();
            this.save(); this.closeModal(); this.render();
            this.toast('âœ“ Reflection updated');
        }
    },
    
    deleteReflection(type, id) {
        this.confirm('Delete this reflection?', () => {
            this.data.system.reflections[type] = (this.data.system.reflections[type] || []).filter(r => r.id !== id);
            this.save(); this.render();
            this.toast('âœ“ Reflection deleted');
        }, 'Delete');
    },
    
    // ========== ENHANCED JOURNAL CRUD ==========
    
    editJournalEntry(id) {
        const entry = this.data.system.journal?.find(e => e.id === id);
        if (!entry) return;
        
        document.getElementById('modal-body').innerHTML = `
            <h3 style="margin-bottom:12px;color:var(--accent);">âœï¸ Edit Journal Entry</h3>
            <div style="font-size:11px;color:var(--dim);margin-bottom:8px;">Original: ${new Date(entry.date).toLocaleDateString()}</div>
            <textarea id="journal-text-edit" rows="10" style="margin-bottom:12px;">${esc(entry.text)}</textarea>
            <button class="btn" onclick="App.updateJournalEntry('${id}')">Update Entry</button>
            <button class="btn-sec" onclick="App.closeModal()" style="margin-top:8px;">Cancel</button>`;
        document.getElementById('modal').classList.add('open');
        setTimeout(() => document.getElementById('journal-text-edit')?.focus(), 80);
    },
    
    updateJournalEntry(id) {
        const text = document.getElementById('journal-text-edit')?.value?.trim();
        if (!text) { this.toast('âš ï¸ Enter text'); return; }
        
        const entry = this.data.system.journal?.find(e => e.id === id);
        if (entry) {
            entry.text = text;
            entry.modified = new Date().toISOString();
            this.save(); this.closeModal(); this.render();
            this.toast('âœ“ Entry updated');
        }
    },
    
    deleteJournalEntry(id) {
        this.confirm('Delete this journal entry?', () => {
            this.data.system.journal = (this.data.system.journal || []).filter(e => e.id !== id);
            this.save(); this.render();
            this.toast('âœ“ Entry deleted');
        }, 'Delete');
    },
    
    // ========== ENHANCED REVIEW CRUD ==========
    
    editReview(id) {
        const review = this.data.system.reviews?.find(r => r.id === id);
        if (!review) return;
        
        document.getElementById('modal-body').innerHTML = `
            <h3 style="margin-bottom:12px;color:var(--accent);">ðŸ“Š Edit Weekly Review</h3>
            <div style="font-size:11px;color:var(--dim);margin-bottom:8px;">Week of ${new Date(review.date).toLocaleDateString()}</div>
            <label style="font-size:12px;font-weight:600;margin-bottom:4px;display:block;">Wins</label>
            <textarea id="review-wins-edit" rows="4" style="margin-bottom:12px;">${esc(review.wins || '')}</textarea>
            <label style="font-size:12px;font-weight:600;margin-bottom:4px;display:block;">Lessons</label>
            <textarea id="review-lessons-edit" rows="4" style="margin-bottom:12px;">${esc(review.lessons || '')}</textarea>
            <label style="font-size:12px;font-weight:600;margin-bottom:4px;display:block;">Next Week</label>
            <textarea id="review-next-edit" rows="4" style="margin-bottom:12px;">${esc(review.nextWeek || '')}</textarea>
            <button class="btn" onclick="App.updateReview('${id}')">Update Review</button>
            <button class="btn-sec" onclick="App.closeModal()" style="margin-top:8px;">Cancel</button>`;
        document.getElementById('modal').classList.add('open');
        setTimeout(() => document.getElementById('review-wins-edit')?.focus(), 80);
    },
    
    updateReview(id) {
        const wins = document.getElementById('review-wins-edit')?.value?.trim();
        const lessons = document.getElementById('review-lessons-edit')?.value?.trim();
        const nextWeek = document.getElementById('review-next-edit')?.value?.trim();
        if (!wins && !lessons && !nextWeek) { this.toast('âš ï¸ Enter at least one field'); return; }
        
        const review = this.data.system.reviews?.find(r => r.id === id);
        if (review) {
            review.wins = wins;
            review.lessons = lessons;
            review.nextWeek = nextWeek;
            review.modified = new Date().toISOString();
            this.save(); this.closeModal(); this.render();
            this.toast('âœ“ Review updated');
        }
    },
    
    deleteReview(id) {
        this.confirm('Delete this review?', () => {
            this.data.system.reviews = (this.data.system.reviews || []).filter(r => r.id !== id);
            this.save(); this.render();
            this.toast('âœ“ Review deleted');
        }, 'Delete');
    },
    
    // ========== SORTING SYSTEM ==========
    
    setSystemSort(section, sortType) {
        this.systemSort[section] = sortType;
        this.render();
    },
    
    sortSystemItems(items, sortType) {
        const sorted = [...items];
        
        switch(sortType) {
            case 'date-desc':
                return sorted.sort((a, b) => new Date(b.date) - new Date(a.date));
            case 'date-asc':
                return sorted.sort((a, b) => new Date(a.date) - new Date(b.date));
            case 'modified-desc':
                return sorted.sort((a, b) => {
                    const aTime = new Date(a.modified || a.date).getTime();
                    const bTime = new Date(b.modified || b.date).getTime();
                    return bTime - aTime;
                });
            case 'length-desc':
                return sorted.sort((a, b) => {
                    const aLen = (a.text || a.wins || '').length;
                    const bLen = (b.text || b.wins || '').length;
                    return bLen - aLen;
                });
            case 'tags':
                return sorted.sort((a, b) => {
                    const aTags = (a.tags || []).length;
                    const bTags = (b.tags || []).length;
                    return bTags - aTags;
                });
            default:
                return sorted;
        }
    },
    
    // ========== TAG SYSTEM ==========
    
    promptAddSystemTag(section, type, id) {
        const tag = prompt('Enter tag:')?.trim();
        if (!tag) return;
        this.addSystemTag(section, type, id, tag);
    },
    
    addSystemTag(section, type, id, tag) {
        let item;
        if (section === 'reflections') {
            item = this.data.system.reflections[type]?.find(r => r.id === id);
        } else if (section === 'journal') {
            item = this.data.system.journal?.find(e => e.id === id);
        } else if (section === 'reviews') {
            item = this.data.system.reviews?.find(r => r.id === id);
        }
        
        if (item) {
            if (!item.tags) item.tags = [];
            if (!item.tags.includes(tag)) {
                item.tags.push(tag);
                this.save(); this.render();
                this.toast(`âœ“ Tagged: ${tag}`);
            }
        }
    },
    
    removeSystemTag(section, type, id, tag) {
        let item;
        if (section === 'reflections') {
            item = this.data.system.reflections[type]?.find(r => r.id === id);
        } else if (section === 'journal') {
            item = this.data.system.journal?.find(e => e.id === id);
        } else if (section === 'reviews') {
            item = this.data.system.reviews?.find(r => r.id === id);
        }
        
        if (item && item.tags) {
            item.tags = item.tags.filter(t => t !== tag);
            this.save(); this.render();
            this.toast('âœ“ Tag removed');
        }
    },
    
    // ========== BULK OPERATIONS ==========
    
    toggleSystemBulkMode(section) {
        this.bulkMode[section] = !this.bulkMode[section];
        if (!this.bulkMode[section]) {
            this.selectedItems[section].clear();
        }
        this.render();
    },
    
    toggleSystemItemSelection(section, id) {
        if (this.selectedItems[section].has(id)) {
            this.selectedItems[section].delete(id);
        } else {
            this.selectedItems[section].add(id);
        }
        this.render();
    },
    
    renderBulkToolbar(section, type) {
        const count = this.selectedItems[section].size;
        const toolbar = document.getElementById('bulk-toolbar');
        if (!toolbar) return;
        
        if (count > 0) {
            toolbar.innerHTML = `
                <div style="color:var(--text);font-size:13px;font-weight:600;">${count} selected</div>
                <div style="display:flex;gap:8px;">
                    <button class="btn-sec" onclick="App.bulkTag('${section}', '${type}')">ðŸ·ï¸ Tag All</button>
                    <button class="btn-sec" onclick="App.bulkExport('${section}', '${type}')">ðŸ“¥ Export</button>
                    <button class="btn-sec btn-danger" onclick="App.bulkDelete('${section}', '${type}')">ðŸ—‘ï¸ Delete</button>
                    <button class="btn-sec" onclick="App.toggleSystemBulkMode('${section}')">Cancel</button>
                </div>
            `;
            toolbar.classList.add('active');
        } else {
            toolbar.classList.remove('active');
        }
    },
    
    bulkTag(section, type) {
        const tag = prompt('Enter tag for selected items:')?.trim();
        if (!tag) return;
        
        this.selectedItems[section].forEach(id => {
            this.addSystemTag(section, type, id, tag);
        });
        
        this.selectedItems[section].clear();
        this.bulkMode[section] = false;
        this.render();
    },
    
    bulkExport(section, type) {
        const items = [];
        
        this.selectedItems[section].forEach(id => {
            let item;
            if (section === 'reflections') {
                item = this.data.system.reflections[type]?.find(r => r.id === id);
            } else if (section === 'journal') {
                item = this.data.system.journal?.find(e => e.id === id);
            } else if (section === 'reviews') {
                item = this.data.system.reviews?.find(r => r.id === id);
            }
            if (item) items.push(item);
        });
        
        try {
            const blob = new Blob([JSON.stringify(items, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${section}-bulk-export-${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            
            // Clean up blob URL to prevent memory leak
            setTimeout(() => URL.revokeObjectURL(url), 100);
            
            this.toast(`âœ“ Exported ${items.length} items`);
        } catch (e) {
            this.toast('âš ï¸ Export failed');
            console.error('Export error:', e);
        }
    },
    
    bulkDelete(section, type) {
        const count = this.selectedItems[section].size;
        this.confirm(`Delete ${count} selected items?`, () => this._doBulkDelete(section, type), 'Delete All');
    },
    _doBulkDelete(section, type) {
        if (section === 'reflections') {
            this.data.system.reflections[type] = this.data.system.reflections[type].filter(
                r => !this.selectedItems[section].has(r.id)
            );
        } else if (section === 'journal') {
            this.data.system.journal = this.data.system.journal.filter(
                e => !this.selectedItems[section].has(e.id)
            );
        } else if (section === 'reviews') {
            this.data.system.reviews = this.data.system.reviews.filter(
                r => !this.selectedItems[section].has(r.id)
            );
        }
        
        this.selectedItems[section].clear();
        this.bulkMode[section] = false;
        this.save(); this.render();
        this.toast('âœ“ Items deleted');
    },
    
    // ========== EXPORT SYSTEM ==========
    
    exportSystemItem(section, type, id) {
        let item;
        if (section === 'reflections') {
            item = this.data.system.reflections[type]?.find(r => r.id === id);
        } else if (section === 'journal') {
            item = this.data.system.journal?.find(e => e.id === id);
        } else if (section === 'reviews') {
            item = this.data.system.reviews?.find(r => r.id === id);
        }
        
        if (!item) return;
        
        try {
            const blob = new Blob([JSON.stringify(item, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${section}-${id}-${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            
            // Clean up blob URL to prevent memory leak
            setTimeout(() => URL.revokeObjectURL(url), 100);
            
            this.toast('âœ“ Exported');
        } catch (e) {
            this.toast('âš ï¸ Export failed');
            console.error('Export error:', e);
        }
    },
    
    exportAllSystemItems(section, type) {
        let items = [];
        if (section === 'reflections') {
            items = this.data.system.reflections[type] || [];
        } else if (section === 'journal') {
            items = this.data.system.journal || [];
        } else if (section === 'reviews') {
            items = this.data.system.reviews || [];
        }
        
        try {
            const blob = new Blob([JSON.stringify(items, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${section}-all-${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            
            // Clean up blob URL to prevent memory leak
            setTimeout(() => URL.revokeObjectURL(url), 100);
            
            this.toast(`âœ“ Exported ${items.length} items`);
        } catch (e) {
            this.toast('âš ï¸ Export failed');
            console.error('Export error:', e);
        }
    },
    
    // ========== TEMPLATES SYSTEM ==========
    
    showSystemTemplates(section, type) {
        let templates = [];
        let title = '';
        
        if (section === 'reflections') {
            title = type === 'morning' ? 'ðŸŒ… Morning Templates' : 'ðŸŒ™ Evening Templates';
            if (type === 'morning') {
                templates = [
                    { name: 'Gratitude Focus', content: 'Today I\'m grateful for:\n1. \n2. \n3. \n\nMy intentions for today:\n1. \n2. \n3. ' },
                    { name: 'Goal-Oriented', content: 'Top priority today:\n\nThree actions to move forward:\n1. \n2. \n3. \n\nPotential obstacles:\n\nHow I\'ll overcome them:' },
                    { name: 'Mindful Start', content: 'How I feel right now:\n\nWhat I need today:\n\nOne thing I\'ll do for myself:\n\nAffirmation:' }
                ];
            } else {
                templates = [
                    { name: 'Daily Review', content: 'Today\'s wins:\n1. \n2. \n3. \n\nLessons learned:\n\nTomorrow I\'ll:' },
                    { name: 'Gratitude Closure', content: 'Three things that went well:\n1. \n2. \n3. \n\nWhat I learned about myself:\n\nOne thing to improve:' },
                    { name: 'Progress Tracker', content: 'Goals I worked on:\n\nProgress made:\n\nChallenges faced:\n\nNext steps:' }
                ];
            }
        } else if (section === 'journal') {
            title = 'âœï¸ Journal Templates';
            templates = [
                { name: 'Free Flow', content: 'Stream of consciousness - write without stopping...\n\n' },
                { name: 'Problem Solving', content: 'Current challenge:\n\nWhy it matters:\n\nPossible solutions:\n1. \n2. \n3. \n\nNext action:' },
                { name: 'Creative Ideas', content: 'Idea:\n\nWhy it excites me:\n\nFirst steps:\n\nResources needed:' },
                { name: 'Life Update', content: 'What\'s happening:\n\nHow I feel about it:\n\nWhat I\'m learning:\n\nWhat\'s next:' }
            ];
        } else if (section === 'reviews') {
            title = 'ðŸ“Š Review Templates';
            templates = [
                { wins: 'Win 1:\nWin 2:\nWin 3:', lessons: 'Lesson 1:\nLesson 2:', nextWeek: 'Priority 1:\nPriority 2:\nPriority 3:' },
                { wins: 'Professional wins:\n\nPersonal wins:\n\nHealth wins:', lessons: 'What worked:\n\nWhat didn\'t:\n\nInsights:', nextWeek: 'Must do:\n\nShould do:\n\nCould do:' },
                { wins: '', lessons: '', nextWeek: '' }
            ];
        }
        
        let html = `<h3 style="margin-bottom:20px;color:var(--accent);">${title}</h3>`;
        
        if (section === 'reviews') {
            html += templates.map((t, i) => `
                <button class="btn-sec" onclick="App.useSystemTemplate('${section}', '${type}', ${i})" 
                        style="width:100%;margin-bottom:8px;">
                    ${i === 0 ? 'Standard Review' : i === 1 ? 'Detailed Review' : 'Simple Review'}
                </button>
            `).join('');
        } else {
            html += templates.map((t, i) => `
                <button class="btn-sec" onclick="App.useSystemTemplate('${section}', '${type}', ${i})" 
                        style="width:100%;margin-bottom:8px;">
                    ${t.name}
                </button>
            `).join('');
        }
        
        html += `<button class="btn-sec" onclick="App.closeModal()" style="width:100%;margin-top:12px;">Cancel</button>`;
        
        document.getElementById('modal-body').innerHTML = html;
        document.getElementById('modal').classList.add('open');
    },
    
    useSystemTemplate(section, type, templateIndex) {
        this.closeModal();
        
        if (section === 'reflections') {
            const templates = type === 'morning' ? [
                'Today I\'m grateful for:\n1. \n2. \n3. \n\nMy intentions for today:\n1. \n2. \n3. ',
                'Top priority today:\n\nThree actions to move forward:\n1. \n2. \n3. \n\nPotential obstacles:\n\nHow I\'ll overcome them:',
                'How I feel right now:\n\nWhat I need today:\n\nOne thing I\'ll do for myself:\n\nAffirmation:'
            ] : [
                'Today\'s wins:\n1. \n2. \n3. \n\nLessons learned:\n\nTomorrow I\'ll:',
                'Three things that went well:\n1. \n2. \n3. \n\nWhat I learned about myself:\n\nOne thing to improve:',
                'Goals I worked on:\n\nProgress made:\n\nChallenges faced:\n\nNext steps:'
            ];
            
            this.addReflection(type);
            setTimeout(() => {
                const textarea = document.getElementById('ref-text');
                if (textarea) textarea.value = templates[templateIndex];
            }, 100);
        } else if (section === 'journal') {
            const templates = [
                'Stream of consciousness - write without stopping...\n\n',
                'Current challenge:\n\nWhy it matters:\n\nPossible solutions:\n1. \n2. \n3. \n\nNext action:',
                'Idea:\n\nWhy it excites me:\n\nFirst steps:\n\nResources needed:',
                'What\'s happening:\n\nHow I feel about it:\n\nWhat I\'m learning:\n\nWhat\'s next:'
            ];
            
            this.addJournalEntry();
            setTimeout(() => {
                const textarea = document.getElementById('journal-text');
                if (textarea) textarea.value = templates[templateIndex];
            }, 100);
        } else if (section === 'reviews') {
            const templates = [
                { wins: 'Win 1:\nWin 2:\nWin 3:', lessons: 'Lesson 1:\nLesson 2:', nextWeek: 'Priority 1:\nPriority 2:\nPriority 3:' },
                { wins: 'Professional wins:\n\nPersonal wins:\n\nHealth wins:', lessons: 'What worked:\n\nWhat didn\'t:\n\nInsights:', nextWeek: 'Must do:\n\nShould do:\n\nCould do:' },
                { wins: '', lessons: '', nextWeek: '' }
            ];
            
            this.addWeeklyReview();
            setTimeout(() => {
                const template = templates[templateIndex];
                const winsField = document.getElementById('review-wins');
                const lessonsField = document.getElementById('review-lessons');
                const nextField = document.getElementById('review-next');
                if (winsField) winsField.value = template.wins;
                if (lessonsField) lessonsField.value = template.lessons;
                if (nextField) nextField.value = template.nextWeek;
            }, 100);
        }
    },
    
    // ========== NOTES ANALYTICS (FIX) ==========
    
    showNotesAnalytics() {
        const notes = this.data.vault.learnings.notes || [];
        const stats = this.getNotesStats(notes);
        
        document.getElementById('modal-body').innerHTML = `
            <h3 style="margin-bottom:20px;color:var(--accent);">ðŸ“Š Notes Analytics</h3>
            
            <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:20px;">
                <div style="padding:16px;background:var(--sub);border-radius:12px;text-align:center;">
                    <div style="font-size:32px;font-weight:700;color:var(--accent);">${stats.total}</div>
                    <div style="font-size:12px;color:var(--dim);margin-top:4px;">Total Notes</div>
                </div>
                <div style="padding:16px;background:var(--sub);border-radius:12px;text-align:center;">
                    <div style="font-size:32px;font-weight:700;color:var(--success);">${stats.thisMonth}</div>
                    <div style="font-size:12px;color:var(--dim);margin-top:4px;">This Month</div>
                </div>
                <div style="padding:16px;background:var(--sub);border-radius:12px;text-align:center;">
                    <div style="font-size:24px;font-weight:700;color:var(--blue);">${stats.avgPerWeek}</div>
                    <div style="font-size:12px;color:var(--dim);margin-top:4px;">Avg/Week</div>
                </div>
                <div style="padding:16px;background:var(--sub);border-radius:12px;text-align:center;">
                    <div style="font-size:24px;font-weight:700;color:var(--purple);">${stats.totalWords}</div>
                    <div style="font-size:12px;color:var(--dim);margin-top:4px;">Total Words</div>
                </div>
            </div>
            
            ${stats.topTags.length > 0 ? `
                <div style="margin-bottom:20px;">
                    <h4 style="margin-bottom:12px;color:var(--dim);font-size:13px;font-weight:600;">TOP TAGS</h4>
                    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;">
                        ${stats.topTags.map(([tag, count]) => `
                            <div style="padding:10px;background:var(--sub);border-radius:8px;display:flex;justify-content:space-between;">
                                <span style="color:var(--text);">ðŸ·ï¸ ${esc(tag)}</span>
                                <span style="color:var(--accent);font-weight:600;">${count}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : ''}
            
            ${stats.longest.length > 0 ? `
                <div style="margin-bottom:20px;">
                    <h4 style="margin-bottom:12px;color:var(--dim);font-size:13px;font-weight:600;">LONGEST NOTES</h4>
                    ${stats.longest.map(n => `
                        <div style="padding:10px;background:var(--sub);border-radius:8px;margin-bottom:6px;">
                            <div style="font-weight:600;color:var(--text);">${esc(n.title)}</div>
                            <div style="font-size:11px;color:var(--dim);margin-top:4px;">${n.words} words</div>
                        </div>
                    `).join('')}
                </div>
            ` : ''}
            
            ${stats.recent.length > 0 ? `
                <div style="margin-bottom:20px;">
                    <h4 style="margin-bottom:12px;color:var(--dim);font-size:13px;font-weight:600;">RECENT ACTIVITY</h4>
                    ${stats.recent.map(n => `
                        <div style="padding:10px;background:var(--sub);border-radius:8px;margin-bottom:6px;">
                            <div style="font-weight:600;color:var(--text);">${esc(n.title)}</div>
                            <div style="font-size:11px;color:var(--dim);margin-top:4px;">${new Date(n.date).toLocaleDateString()}</div>
                        </div>
                    `).join('')}
                </div>
            ` : ''}
            
            <div style="margin-bottom:20px;">
                <h4 style="margin-bottom:12px;color:var(--dim);font-size:13px;font-weight:600;">ACTIVITY TIMELINE (Last 12 Months)</h4>
                <div id="notes-timeline" style="height:100px;background:var(--sub);border-radius:8px;padding:12px;"></div>
            </div>
            
            <button class="btn-sec" onclick="App.closeModal()" style="width:100%;">Close</button>
        `;
        
        document.getElementById('modal').classList.add('open');
        setTimeout(() => this.renderNotesTimeline(notes), 50);
    },
    
    getNotesStats(notes) {
        const now = new Date();
        const monthAgo = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
        const thisMonth = notes.filter(n => new Date(n.date) > monthAgo).length;
        
        const weeks = Math.ceil((now - new Date(notes[0]?.date || now)) / (1000 * 60 * 60 * 24 * 7)) || 1;
        const avgPerWeek = Math.round(notes.length / weeks);
        
        const totalWords = notes.reduce((sum, n) => sum + (n.content?.split(/\s+/).length || 0), 0);
        
        const tagCounts = {};
        notes.forEach(n => {
            (n.tags || []).forEach(tag => {
                tagCounts[tag] = (tagCounts[tag] || 0) + 1;
            });
        });
        const topTags = Object.entries(tagCounts).sort((a, b) => b[1] - a[1]).slice(0, 8);
        
        const longest = [...notes]
            .map(n => ({ ...n, words: (n.content?.split(/\s+/).length || 0) }))
            .sort((a, b) => b.words - a.words)
            .slice(0, 5);
        
        const recent = [...notes]
            .sort((a, b) => new Date(b.date) - new Date(a.date))
            .slice(0, 5);
        
        return {
            total: notes.length,
            thisMonth,
            avgPerWeek,
            totalWords,
            topTags,
            longest,
            recent
        };
    },
    
    renderNotesTimeline(notes) {
        const container = document.getElementById('notes-timeline');
        if (!container) return;
        
        const monthCounts = {};
        const now = new Date();
        
        for (let i = 11; i >= 0; i--) {
            const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
            const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
            monthCounts[key] = 0;
        }
        
        notes.forEach(n => {
            const d = new Date(n.date);
            const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
            if (monthCounts[key] !== undefined) {
                monthCounts[key]++;
            }
        });
        
        const counts = Object.values(monthCounts);
        const max = Math.max(...counts, 1);
        
        container.innerHTML = `
            <div style="display:flex;gap:4px;height:100%;align-items:flex-end;">
                ${counts.map(count => {
                    const height = (count / max) * 100;
                    return `
                        <div style="flex:1;background:var(--accent);opacity:${count > 0 ? 0.3 + (count/max)*0.7 : 0.1};
                                    border-radius:4px 4px 0 0;height:${height}%;min-height:4px;"></div>
                    `;
                }).join('')}
            </div>
        `;
    },
    
    // ========== REFLECTION ANALYTICS ==========
    
    showReflectionAnalytics() {
        const morning = this.data.system.reflections.morning || [];
        const evening = this.data.system.reflections.evening || [];
        const total = morning.length + evening.length;
        
        const now = new Date();
        const monthAgo = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
        const thisMonthMorning = morning.filter(r => new Date(r.date) > monthAgo).length;
        const thisMonthEvening = evening.filter(r => new Date(r.date) > monthAgo).length;
        
        let currentStreak = 0;
        const today = new Date().toDateString();
        const allDates = [...morning, ...evening].map(r => new Date(r.date).toDateString());
        const uniqueDates = [...new Set(allDates)].sort((a, b) => new Date(b) - new Date(a));
        
        for (let i = 0; i < uniqueDates.length; i++) {
            const checkDate = new Date();
            checkDate.setDate(checkDate.getDate() - i);
            if (uniqueDates.includes(checkDate.toDateString())) {
                currentStreak++;
            } else {
                break;
            }
        }
        
        document.getElementById('modal-body').innerHTML = `
            <h3 style="margin-bottom:20px;color:var(--accent);">ðŸ“Š Reflection Analytics</h3>
            
            <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:20px;">
                <div style="padding:16px;background:var(--sub);border-radius:12px;text-align:center;">
                    <div style="font-size:32px;font-weight:700;color:var(--accent);">${total}</div>
                    <div style="font-size:12px;color:var(--dim);margin-top:4px;">Total Reflections</div>
                </div>
                <div style="padding:16px;background:var(--sub);border-radius:12px;text-align:center;">
                    <div style="font-size:32px;font-weight:700;color:var(--success);">${currentStreak}</div>
                    <div style="font-size:12px;color:var(--dim);margin-top:4px;">Day Streak</div>
                </div>
            </div>
            
            <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:20px;">
                <div style="padding:16px;background:var(--sub);border-radius:12px;">
                    <div style="font-size:24px;font-weight:700;color:var(--blue);">ðŸŒ… ${morning.length}</div>
                    <div style="font-size:11px;color:var(--dim);margin-top:4px;">Morning (${thisMonthMorning} this month)</div>
                </div>
                <div style="padding:16px;background:var(--sub);border-radius:12px;">
                    <div style="font-size:24px;font-weight:700;color:var(--purple);">ðŸŒ™ ${evening.length}</div>
                    <div style="font-size:11px;color:var(--dim);margin-top:4px;">Evening (${thisMonthEvening} this month)</div>
                </div>
            </div>
            
            <button class="btn-sec" onclick="App.closeModal()" style="width:100%;">Close</button>
        `;
        
        document.getElementById('modal').classList.add('open');
    },
    
    // ========== JOURNAL ANALYTICS ==========
    
    showJournalAnalytics() {
        const entries = this.data.system.journal || [];
        
        const now = new Date();
        const monthAgo = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
        const thisMonth = entries.filter(e => new Date(e.date) > monthAgo).length;
        
        const totalWords = entries.reduce((sum, e) => sum + (e.text?.split(/\s+/).length || 0), 0);
        const avgWords = entries.length > 0 ? Math.round(totalWords / entries.length) : 0;
        
        const tagCounts = {};
        entries.forEach(e => {
            (e.tags || []).forEach(tag => {
                tagCounts[tag] = (tagCounts[tag] || 0) + 1;
            });
        });
        const topTags = Object.entries(tagCounts).sort((a, b) => b[1] - a[1]).slice(0, 5);
        
        document.getElementById('modal-body').innerHTML = `
            <h3 style="margin-bottom:20px;color:var(--accent);">ðŸ“Š Journal Analytics</h3>
            
            <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:20px;">
                <div style="padding:16px;background:var(--sub);border-radius:12px;text-align:center;">
                    <div style="font-size:32px;font-weight:700;color:var(--accent);">${entries.length}</div>
                    <div style="font-size:12px;color:var(--dim);margin-top:4px;">Total Entries</div>
                </div>
                <div style="padding:16px;background:var(--sub);border-radius:12px;text-align:center;">
                    <div style="font-size:32px;font-weight:700;color:var(--success);">${thisMonth}</div>
                    <div style="font-size:12px;color:var(--dim);margin-top:4px;">This Month</div>
                </div>
                <div style="padding:16px;background:var(--sub);border-radius:12px;text-align:center;">
                    <div style="font-size:32px;font-weight:700;color:var(--blue);">${totalWords}</div>
                    <div style="font-size:12px;color:var(--dim);margin-top:4px;">Total Words</div>
                </div>
                <div style="padding:16px;background:var(--sub);border-radius:12px;text-align:center;">
                    <div style="font-size:32px;font-weight:700;color:var(--purple);">${avgWords}</div>
                    <div style="font-size:12px;color:var(--dim);margin-top:4px;">Avg Words/Entry</div>
                </div>
            </div>
            
            ${topTags.length > 0 ? `
                <div style="margin-bottom:20px;">
                    <h4 style="margin-bottom:12px;color:var(--dim);font-size:13px;font-weight:600;">TOP TAGS</h4>
                    <div style="display:flex;flex-wrap:wrap;gap:6px;">
                        ${topTags.map(([tag, count]) => `
                            <span style="padding:6px 12px;background:var(--sub);border-radius:16px;font-size:12px;">
                                ðŸ·ï¸ ${esc(tag)} <span style="color:var(--dim);">(${count})</span>
                            </span>
                        `).join('')}
                    </div>
                </div>
            ` : ''}
            
            <button class="btn-sec" onclick="App.closeModal()" style="width:100%;">Close</button>
        `;
        
        document.getElementById('modal').classList.add('open');
    },
    
    // ========== REVIEW ANALYTICS ==========
    
    showReviewAnalytics() {
        const reviews = this.data.system.reviews || [];
        
        const completeReviews = reviews.filter(r => r.wins && r.lessons && r.nextWeek).length;
        const completionRate = reviews.length > 0 ? Math.round((completeReviews / reviews.length) * 100) : 0;
        
        const allText = reviews.map(r => `${r.wins} ${r.lessons} ${r.nextWeek}`).join(' ').toLowerCase();
        const words = allText.split(/\s+/).filter(w => w.length > 4);
        const wordCounts = {};
        words.forEach(w => {
            wordCounts[w] = (wordCounts[w] || 0) + 1;
        });
        const commonWords = Object.entries(wordCounts)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 10)
            .filter(([word, count]) => count > 1);
        
        document.getElementById('modal-body').innerHTML = `
            <h3 style="margin-bottom:20px;color:var(--accent);">ðŸ“Š Review Analytics</h3>
            
            <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:20px;">
                <div style="padding:16px;background:var(--sub);border-radius:12px;text-align:center;">
                    <div style="font-size:32px;font-weight:700;color:var(--accent);">${reviews.length}</div>
                    <div style="font-size:12px;color:var(--dim);margin-top:4px;">Total Reviews</div>
                </div>
                <div style="padding:16px;background:var(--sub);border-radius:12px;text-align:center;">
                    <div style="font-size:32px;font-weight:700;color:var(--success);">${completionRate}%</div>
                    <div style="font-size:12px;color:var(--dim);margin-top:4px;">Completion Rate</div>
                </div>
            </div>
            
            ${commonWords.length > 0 ? `
                <div style="margin-bottom:20px;">
                    <h4 style="margin-bottom:12px;color:var(--dim);font-size:13px;font-weight:600;">COMMON THEMES</h4>
                    <div style="padding:16px;background:var(--sub);border-radius:12px;">
                        ${commonWords.map(([word, count]) => `
                            <div style="padding:8px 0;border-bottom:1px solid var(--border);">
                                <span style="color:var(--text);">${esc(word)}</span>
                                <span style="float:right;color:var(--dim);font-size:11px;">${count}x</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : ''}
            
            <button class="btn-sec" onclick="App.closeModal()" style="width:100%;">Close</button>
        `;
        
        document.getElementById('modal').classList.add('open');
    },
    
    // ========== ENHANCED RENDER FUNCTIONS ==========
    
    renderHabitTracker() {
        if (!this.data.system) this.data.system = { habits: [], reflections: { morning: [], evening: [] }, journal: [], reviews: [] };
        if (!this.data.system.habits) this.data.system.habits = [];
        const habits = this.data.system.habits;
        const today = new Date().toISOString().split('T')[0];

        let html = `<div style="padding:20px 0;">`;

        // Header
        html += `
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
            <div>
                <div style="font-size:11px;color:var(--dim);text-transform:uppercase;letter-spacing:3px;margin-bottom:4px;">Daily Practice</div>
                <div style="font-size:20px;font-weight:300;color:var(--text);">Habit Tracker</div>
            </div>
            <div style="display:flex;gap:8px;">
                <button class="btn-sec" onclick="App.dailyResetHabits()" style="font-size:11px;padding:6px 10px;" title="Reset today's completions">â†º Reset</button>
                <button class="btn" onclick="App.addHabit()" style="font-size:12px;padding:8px 14px;">+ Add Habit</button>
            </div>
        </div>`;

        if (habits.length === 0) {
            html += `
            <div style="text-align:center;padding:48px 20px;background:var(--sub);border-radius:16px;border:1px dashed var(--border);">
                <div style="font-size:48px;margin-bottom:14px;">ðŸŒ±</div>
                <div style="font-size:16px;font-weight:600;color:var(--accent);margin-bottom:8px;">No Habits Yet</div>
                <div style="font-size:13px;color:var(--dim);line-height:1.6;max-width:260px;margin:0 auto 20px;">
                    Build consistency by tracking your daily practices.
                </div>
                <button class="btn" onclick="App.addHabit()">+ Add First Habit</button>
            </div>`;
        } else {
            // Group by time block
            const groups = { Morning: [], Work: [], Evening: [], Other: [] };
            habits.forEach(h => {
                const g = h.timeBlock && groups[h.timeBlock] ? h.timeBlock : 'Other';
                groups[g].push(h);
            });

            const todayDone = habits.filter(h => {
                const log = (h.completions || []).find(c => c.date === today);
                return log && log.done;
            }).length;

            // Progress bar
            html += `
            <div style="margin-bottom:20px;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                    <span style="font-size:11px;color:var(--dim);text-transform:uppercase;letter-spacing:1px;">Today's Progress</span>
                    <span style="font-family:monospace;font-size:13px;font-weight:700;color:var(--accent);">${todayDone}/${habits.length}</span>
                </div>
                <div style="height:6px;background:var(--sub);border-radius:3px;overflow:hidden;">
                    <div style="height:100%;width:${habits.length ? Math.round((todayDone/habits.length)*100) : 0}%;background:var(--success);border-radius:3px;transition:width 0.4s;"></div>
                </div>
            </div>`;

            // Render each group
            Object.entries(groups).forEach(([group, items]) => {
                if (items.length === 0) return;
                const groupLabel = group === 'Other' ? 'Anytime' : group;
                const icon = group === 'Morning' ? 'ðŸŒ…' : group === 'Work' ? 'ðŸ’¼' : group === 'Evening' ? 'ðŸŒ™' : 'âš¡';
                html += `<div style="font-size:10px;font-weight:700;color:var(--dim);text-transform:uppercase;letter-spacing:2px;margin:18px 0 8px;">${icon} ${groupLabel}</div>`;

                items.forEach(habit => {
                    const todayLog = (habit.completions || []).find(c => c.date === today);
                    const isDone = todayLog && todayLog.done;
                    const streak = this.calculateStreaks ? this.calculateStreaks(habit).current : 0;
                    const microSteps = habit.microSteps || [];
                    const doneMicro = microSteps.filter(s => s.status === 'done').length;

                    html += `
                    <div class="habit-card" style="${isDone ? 'opacity:0.65;border-color:var(--success);' : ''}">
                        <div class="habit-header">
                            <div class="habit-info">
                                <div class="habit-title" style="${isDone ? 'text-decoration:line-through;color:var(--dim);' : ''}">${esc(habit.title)}</div>
                                <div class="habit-meta">
                                    ${streak > 0 ? `<span class="streak-badge">ðŸ”¥ ${streak}d</span>` : ''}
                                    ${microSteps.length > 0 ? `<span>${doneMicro}/${microSteps.length} steps</span>` : ''}
                                </div>
                            </div>
                            <div class="habit-actions">
                                <button class="btn-sec" onclick="App.manageMicroSteps('${habit.id}')" style="font-size:10px;padding:4px 8px;" title="Micro-steps">Steps</button>
                                <button class="btn-sec" onclick="App.startHabitTimer('${habit.id}')" style="font-size:10px;padding:4px 8px;" title="Start timer">â±</button>
                                <button class="habit-check-btn ${isDone ? 'done' : ''}" onclick="App.toggleHabit('${habit.id}')">
                                    ${isDone ? `<svg width="14" height="14" fill="none" stroke="#000" stroke-width="3"><polyline points="2,7 6,11 12,3"/></svg>` : ''}
                                </button>
                            </div>
                        </div>
                        ${this.renderHeatmap ? this.renderHeatmap(habit.completions || []) : ''}
                        <div style="display:flex;gap:6px;margin-top:8px;justify-content:flex-end;">
                            <button class="btn-sec" onclick="App.editHabit('${habit.id}')" style="font-size:10px;padding:3px 8px;opacity:0.7;">Edit</button>
                            <button class="btn-sec" onclick="App.deleteHabit('${habit.id}')" style="font-size:10px;padding:3px 8px;opacity:0.5;color:var(--danger);">Delete</button>
                        </div>
                    </div>`;
                });
            });
        }

        html += `</div>`;
        return html;
    },

    renderReflections() {
        const refType = this.sub._refType || 'morning';
        const isMorning = refType === 'morning';
        const accentColor = isMorning ? 'rgba(200,160,100,0.85)' : 'rgba(140,160,220,0.85)';
        const accentBorder = isMorning ? 'rgba(200,160,100,0.2)' : 'rgba(140,160,220,0.2)';

        let html = `<div class="zen-container">`;

        // â”€â”€ HEADER: title + dawn/dusk toggle inline â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        html += `
        <div style="padding:24px 0 20px;text-align:center;position:relative;">
            <div style="font-size:9px;letter-spacing:6px;color:var(--zen-stone);text-transform:uppercase;
                        opacity:0.6;margin-bottom:10px;">
                ${isMorning ? 'æœã®æ€ç´¢' : 'å¤œã®æ€ç´¢'}
            </div>
            <div style="font-size:24px;font-weight:300;color:rgba(245,240,232,0.9);
                        font-style:italic;letter-spacing:1px;margin-bottom:4px;">
                ${isMorning ? 'Morning Reflection' : 'Evening Reflection'}
            </div>
            <div style="font-size:12px;color:var(--zen-stone);font-style:italic;margin-bottom:18px;">
                ${isMorning ? 'set the tone with intention' : 'let the day settle into understanding'}
            </div>
            <div style="display:inline-flex;background:var(--zen-mist);border:1px solid var(--zen-border);
                        border-radius:3px;padding:3px;gap:3px;">
                <button onclick="App.sub._refType='morning';App.render()"
                    style="padding:7px 20px;background:${isMorning?'linear-gradient(135deg,rgba(120,90,60,0.5),rgba(80,60,40,0.5))':'transparent'};
                           border:${isMorning?'1px solid rgba(200,160,100,0.25)':'1px solid transparent'};
                           border-radius:2px;color:${isMorning?'rgba(220,190,140,0.9)':'var(--zen-stone)'};
                           font-size:11px;letter-spacing:2px;text-transform:uppercase;cursor:pointer;
                           font-family:var(--font);transition:all 0.3s;">Dawn</button>
                <button onclick="App.sub._refType='evening';App.render()"
                    style="padding:7px 20px;background:${!isMorning?'linear-gradient(135deg,rgba(40,50,80,0.5),rgba(30,35,60,0.5))':'transparent'};
                           border:${!isMorning?'1px solid rgba(100,120,180,0.25)':'1px solid transparent'};
                           border-radius:2px;color:${!isMorning?'rgba(160,180,220,0.9)':'var(--zen-stone)'};
                           font-size:11px;letter-spacing:2px;text-transform:uppercase;cursor:pointer;
                           font-family:var(--font);transition:all 0.3s;">Dusk</button>
            </div>
        </div>`;

        // â”€â”€ COMMAND BAR: single row, new entry dominant â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        html += `
        <div style="display:flex;gap:8px;align-items:stretch;margin-bottom:20px;">
            <button onclick="App.addReflection('${refType}')"
                style="flex:1;padding:12px 16px;background:transparent;
                       border:1px solid ${accentBorder};border-radius:2px;
                       color:${accentColor};font-size:13px;letter-spacing:1px;
                       cursor:pointer;transition:all 0.3s;font-style:italic;
                       font-family:var(--zen-font);">
                ${isMorning ? 'â€” begin the morning â€”' : 'â€” close the evening â€”'}
            </button>
            <div style="display:flex;gap:4px;">
                <button onclick="App.showSystemTemplates('reflections','${refType}')"
                    style="padding:12px;background:transparent;border:1px solid var(--zen-border);
                           border-radius:2px;color:var(--zen-stone);font-size:13px;
                           cursor:pointer;transition:all 0.25s;" title="Templates">â‰¡</button>
                <button onclick="App.exportAllSystemItems('reflections','${refType}')"
                    style="padding:12px;background:transparent;border:1px solid var(--zen-border);
                           border-radius:2px;color:var(--zen-stone);font-size:11px;letter-spacing:1px;
                           cursor:pointer;transition:all 0.25s;" title="Export">â†‘</button>
            </div>
        </div>`;

        // â”€â”€ SEARCH (minimal, only border, no label clutter) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        html += `
        <div style="position:relative;margin-bottom:20px;">
            <input type="text" placeholder="search reflectionsâ€¦"
                   value="${esc(this.reflectionSearch)}"
                   oninput="App.reflectionSearch=this.value;App.render();"
                   style="width:100%;padding:10px 36px 10px 14px;background:transparent;
                          border:1px solid var(--zen-border);border-radius:2px;
                          color:rgba(245,240,232,0.8);font-size:13px;font-style:italic;
                          font-family:var(--zen-font);box-sizing:border-box;transition:border-color 0.3s;"
                   onfocus="this.style.borderColor='rgba(245,240,232,0.2)'"
                   onblur="this.style.borderColor='var(--zen-border)'">
            ${this.reflectionSearch
                ? `<button onclick="App.reflectionSearch='';App.render()"
                     style="position:absolute;right:12px;top:50%;transform:translateY(-50%);
                            background:none;border:none;color:var(--zen-stone);font-size:16px;cursor:pointer;">Ã—</button>`
                : ''}
        </div>`;

        // â”€â”€ SORT + COUNT (one compact line, no label noise) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let refs = this.data.system.reflections[refType] || [];
        if (this.reflectionSearch) {
            const s = this.reflectionSearch.toLowerCase();
            refs = refs.filter(r =>
                r.text.toLowerCase().includes(s) ||
                new Date(r.date).toLocaleDateString().toLowerCase().includes(s) ||
                (r.tags || []).some(t => t.toLowerCase().includes(s))
            );
        }
        refs = this.sortSystemItems(refs, this.systemSort.reflections);

        if (refs.length > 0) {
            html += `
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                <span style="font-size:10px;color:var(--zen-stone);letter-spacing:2px;text-transform:uppercase;opacity:0.7;">
                    ${refs.length} entr${refs.length===1?'y':'ies'}
                </span>
                <select onchange="App.setSystemSort('reflections',this.value)"
                    style="background:transparent;border:none;color:var(--zen-stone);font-size:10px;
                           letter-spacing:1px;cursor:pointer;text-transform:uppercase;">
                    <option value="date-desc"  ${this.systemSort.reflections==='date-desc'?'selected':''}>Newest</option>
                    <option value="date-asc"   ${this.systemSort.reflections==='date-asc'?'selected':''}>Oldest</option>
                    <option value="length-desc" ${this.systemSort.reflections==='length-desc'?'selected':''}>Deepest</option>
                </select>
            </div>`;}


        if (refs.length === 0) {
            html += `
                <div class="zen-empty">
                    <span class="zen-empty-symbol">${isMorning ? 'â˜€' : 'â˜½'}</span>
                    <span class="zen-empty-text">${this.reflectionSearch ? 'No echoes found' : 'The page awaits your first words'}</span>
                    <span class="zen-empty-sub">stillness precedes clarity</span>
                </div>
            `;
        } else {
            refs.forEach(r => {
                const isSelected = this.selectedItems.reflections.has(r.id);
                const dateStr = new Date(r.date).toLocaleDateString('en-US', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
                html += `
                    <div class="zen-card zen-card-${refType}" style="display:flex;flex-direction:column;">
                        ${this.bulkMode.reflections ? `
                            <div style="display:flex;align-items:flex-start;gap:12px;">
                                <div class="zen-checkbox ${isSelected ? 'checked' : ''}"
                                     onclick="App.toggleSystemItemSelection('reflections', '${r.id}')"></div>
                                <div style="flex:1;">
                        ` : ''}
                        <div class="zen-date">
                            <div class="zen-date-line"></div>
                            <div class="zen-date-text">${dateStr}</div>
                            <div class="zen-date-line"></div>
                        </div>
                        <div class="zen-body">${esc(r.text)}</div>
                        ${(r.tags || []).length > 0 ? `
                            <div class="zen-tags">
                                ${r.tags.map(t => `<span class="zen-tag">${esc(t)}</span>`).join('')}
                            </div>
                        ` : ''}
                        ${r.modified ? `<div class="zen-edited">revised ${new Date(r.modified).toLocaleDateString()}</div>` : ''}
                        <div class="zen-card-actions">
                            <button class="zen-act-btn" onclick="App.editReflection('${refType}', '${r.id}')">Edit</button>
                            <button class="zen-act-btn" onclick="App.promptAddSystemTag('reflections', '${refType}', '${r.id}')">Tag</button>
                            <button class="zen-act-btn" onclick="App.exportSystemItem('reflections', '${refType}', '${r.id}')">Export</button>
                            <button class="zen-act-btn danger" onclick="App.deleteReflection('${refType}', '${r.id}')">Release</button>
                        </div>
                        ${this.bulkMode.reflections ? `</div></div>` : ''}
                    </div>
                `;
            });
        }

        html += `</div>`;

        if (this.bulkMode.reflections && this.selectedItems.reflections.size > 0) {
            this.renderBulkToolbar('reflections', refType);
        }

        return html;
    },
    
    renderJournal() {
        let html = `<div class="zen-container">`;

        // â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        html += `
        <div style="padding:24px 0 20px;text-align:center;">
            <div style="font-size:9px;letter-spacing:6px;color:var(--zen-stone);text-transform:uppercase;
                        opacity:0.6;margin-bottom:10px;">æ—¥è¨˜ Â· Nikki</div>
            <div style="font-size:24px;font-weight:300;color:rgba(245,240,232,0.9);
                        font-style:italic;letter-spacing:1px;margin-bottom:4px;">The Journal</div>
            <div style="font-size:12px;color:var(--zen-stone);font-style:italic;">
                where the unnamed becomes word
            </div>
        </div>`;

        // â”€â”€ COMMAND BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        html += `
        <div style="display:flex;gap:8px;align-items:stretch;margin-bottom:20px;">
            <button onclick="App.addJournalEntry()"
                style="flex:1;padding:12px 16px;background:transparent;
                       border:1px solid var(--zen-border);border-radius:2px;
                       color:rgba(245,240,232,0.7);font-size:13px;letter-spacing:1px;
                       cursor:pointer;transition:all 0.3s;font-style:italic;
                       font-family:var(--zen-font);">
                â€” open a new page â€”
            </button>
            <button onclick="App.showSystemTemplates('journal','')"
                style="padding:12px;background:transparent;border:1px solid var(--zen-border);
                       border-radius:2px;color:var(--zen-stone);font-size:13px;
                       cursor:pointer;" title="Templates">â‰¡</button>
            <button onclick="App.exportAllSystemItems('journal','')"
                style="padding:12px;background:transparent;border:1px solid var(--zen-border);
                       border-radius:2px;color:var(--zen-stone);font-size:11px;
                       cursor:pointer;" title="Export">â†‘</button>
        </div>`;

        // â”€â”€ SEARCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        html += `
        <div style="position:relative;margin-bottom:20px;">
            <input type="text" placeholder="wander through your pagesâ€¦"
                   value="${esc(this.journalSearch)}"
                   oninput="App.journalSearch=this.value;App.render();"
                   style="width:100%;padding:10px 36px 10px 14px;background:transparent;
                          border:1px solid var(--zen-border);border-radius:2px;
                          color:rgba(245,240,232,0.8);font-size:13px;font-style:italic;
                          font-family:var(--zen-font);box-sizing:border-box;"
                   onfocus="this.style.borderColor='rgba(245,240,232,0.2)'"
                   onblur="this.style.borderColor='var(--zen-border)'">
            ${this.journalSearch
                ? `<button onclick="App.journalSearch='';App.render()"
                     style="position:absolute;right:12px;top:50%;transform:translateY(-50%);
                            background:none;border:none;color:var(--zen-stone);font-size:16px;cursor:pointer;">Ã—</button>`
                : ''}
        </div>`;

        let entries = this.data.system.journal || [];
        if (this.journalSearch) {
            const s = this.journalSearch.toLowerCase();
            entries = entries.filter(e =>
                e.text.toLowerCase().includes(s) ||
                new Date(e.date).toLocaleDateString().toLowerCase().includes(s) ||
                (e.tags || []).some(t => t.toLowerCase().includes(s))
            );
        }
        entries = this.sortSystemItems(entries, this.systemSort.journal);

        if (entries.length > 0) {
            html += `
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                <span style="font-size:10px;color:var(--zen-stone);letter-spacing:2px;text-transform:uppercase;opacity:0.7;">
                    ${entries.length} page${entries.length===1?'':'s'}
                </span>
                <select onchange="App.setSystemSort('journal',this.value)"
                    style="background:transparent;border:none;color:var(--zen-stone);font-size:10px;
                           letter-spacing:1px;cursor:pointer;text-transform:uppercase;">
                    <option value="date-desc"  ${this.systemSort.journal==='date-desc'?'selected':''}>Newest</option>
                    <option value="date-asc"   ${this.systemSort.journal==='date-asc'?'selected':''}>Oldest</option>
                    <option value="length-desc" ${this.systemSort.journal==='length-desc'?'selected':''}>Deepest</option>
                </select>
            </div>`;}


        if (entries.length === 0) {
            html += `
                <div class="zen-empty">
                    <span class="zen-empty-symbol">âœ¦</span>
                    <span class="zen-empty-text">${this.journalSearch ? 'No pages match your search' : 'Your journal holds no words yet'}</span>
                    <span class="zen-empty-sub">emptiness is the first sentence</span>
                </div>
            `;
        } else {
            entries.forEach(e => {
                const isSelected = this.selectedItems.journal.has(e.id);
                const dateStr = new Date(e.date).toLocaleDateString('en-US', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
                html += `
                    <div class="zen-card">
                        ${this.bulkMode.journal ? `
                            <div style="display:flex;align-items:flex-start;gap:12px;">
                                <div class="zen-checkbox ${isSelected ? 'checked' : ''}"
                                     onclick="App.toggleSystemItemSelection('journal', '${e.id}')"></div>
                                <div style="flex:1;">
                        ` : ''}
                        <div class="zen-date">
                            <div class="zen-date-line"></div>
                            <div class="zen-date-text">${dateStr}</div>
                            <div class="zen-date-line"></div>
                        </div>
                        <div class="zen-body">${esc(e.text)}</div>
                        ${(e.tags || []).length > 0 ? `
                            <div class="zen-tags">
                                ${e.tags.map(t => `<span class="zen-tag">${esc(t)}</span>`).join('')}
                            </div>
                        ` : ''}
                        ${e.modified ? `<div class="zen-edited">revised ${new Date(e.modified).toLocaleDateString()}</div>` : ''}
                        <div class="zen-card-actions">
                            <button class="zen-act-btn" onclick="App.editJournalEntry('${e.id}')">Edit</button>
                            <button class="zen-act-btn" onclick="App.promptAddSystemTag('journal', '', '${e.id}')">Tag</button>
                            <button class="zen-act-btn" onclick="App.exportSystemItem('journal', '', '${e.id}')">Export</button>
                            <button class="zen-act-btn danger" onclick="App.deleteJournalEntry('${e.id}')">Release</button>
                        </div>
                        ${this.bulkMode.journal ? `</div></div>` : ''}
                    </div>
                `;
            });
        }

        html += `</div>`;

        if (this.bulkMode.journal && this.selectedItems.journal.size > 0) {
            this.renderBulkToolbar('journal', '');
        }

        return html;
    },
    
    renderReviews() {
        let html = `<div class="zen-container">`;

        // â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        html += `
        <div style="padding:24px 0 20px;text-align:center;">
            <div style="font-size:9px;letter-spacing:6px;color:var(--zen-stone);text-transform:uppercase;
                        opacity:0.6;margin-bottom:10px;">é€±æ¬¡çœå¯Ÿ</div>
            <div style="font-size:24px;font-weight:300;color:rgba(245,240,232,0.9);
                        font-style:italic;letter-spacing:1px;margin-bottom:4px;">Weekly Review</div>
            <div style="font-size:12px;color:var(--zen-stone);font-style:italic;">
                harvest what was, sow what shall be
            </div>
        </div>`;

        // â”€â”€ COMMAND BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        html += `
        <div style="display:flex;gap:8px;align-items:stretch;margin-bottom:20px;">
            <button onclick="App.addWeeklyReview()"
                style="flex:1;padding:12px 16px;background:transparent;
                       border:1px solid var(--zen-border);border-radius:2px;
                       color:rgba(245,240,232,0.7);font-size:13px;letter-spacing:1px;
                       cursor:pointer;font-style:italic;font-family:var(--zen-font);">
                â€” begin this week's review â€”
            </button>
            <button onclick="App.exportAllSystemItems('reviews','')"
                style="padding:12px;background:transparent;border:1px solid var(--zen-border);
                       border-radius:2px;color:var(--zen-stone);font-size:11px;cursor:pointer;" title="Export">â†‘</button>
        </div>`;

        let reviews = this.data.system.reviews || [];
        reviews = this.sortSystemItems(reviews, this.systemSort.reviews);

        if (reviews.length > 0) {
            html += `
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                <span style="font-size:10px;color:var(--zen-stone);letter-spacing:2px;text-transform:uppercase;opacity:0.7;">
                    ${reviews.length} review${reviews.length===1?'':'s'}
                </span>
                <select onchange="App.setSystemSort('reviews',this.value)"
                    style="background:transparent;border:none;color:var(--zen-stone);font-size:10px;
                           letter-spacing:1px;cursor:pointer;text-transform:uppercase;">
                    <option value="date-desc"  ${this.systemSort.reviews==='date-desc'?'selected':''}>Newest</option>
                    <option value="date-asc"   ${this.systemSort.reviews==='date-asc'?'selected':''}>Oldest</option>
                    <option value="length-desc" ${this.systemSort.reviews==='length-desc'?'selected':''}>Deepest</option>
                </select>
            </div>`;}


        if (reviews.length === 0) {
            html += `
                <div class="zen-empty">
                    <span class="zen-empty-symbol">â—Ž</span>
                    <span class="zen-empty-text">No reviews written yet</span>
                    <span class="zen-empty-sub">the examined life begins here</span>
                </div>
            `;
        } else {
            reviews.forEach(r => {
                const isSelected = this.selectedItems.reviews.has(r.id);
                const weekStr = new Date(r.date).toLocaleDateString('en-US', { year:'numeric', month:'long', day:'numeric' });
                html += `
                    <div class="zen-card">
                        ${this.bulkMode.reviews ? `
                            <div style="display:flex;align-items:flex-start;gap:12px;">
                                <div class="zen-checkbox ${isSelected ? 'checked' : ''}"
                                     onclick="App.toggleSystemItemSelection('reviews', '${r.id}')"></div>
                                <div style="flex:1;">
                        ` : ''}
                        <div class="zen-date">
                            <div class="zen-date-line"></div>
                            <div class="zen-date-text">Week of ${weekStr}</div>
                            <div class="zen-date-line"></div>
                        </div>

                        ${r.wins ? `
                            <div class="zen-review-section">
                                <div class="zen-review-label">Victories</div>
                                <div class="zen-body" style="font-size:15px;">${esc(r.wins)}</div>
                            </div>
                        ` : ''}

                        ${r.lessons ? `
                            <div class="zen-review-section">
                                <div class="zen-review-label">Lessons</div>
                                <div class="zen-body" style="font-size:15px;">${esc(r.lessons)}</div>
                            </div>
                        ` : ''}

                        ${r.nextWeek ? `
                            <div class="zen-review-section">
                                <div class="zen-review-label">Intentions Ahead</div>
                                <div class="zen-body" style="font-size:15px;">${esc(r.nextWeek)}</div>
                            </div>
                        ` : ''}

                        ${(r.tags || []).length > 0 ? `
                            <div class="zen-tags">
                                ${r.tags.map(t => `<span class="zen-tag">${esc(t)}</span>`).join('')}
                            </div>
                        ` : ''}
                        ${r.modified ? `<div class="zen-edited">revised ${new Date(r.modified).toLocaleDateString()}</div>` : ''}
                        <div class="zen-card-actions">
                            <button class="zen-act-btn" onclick="App.editReview('${r.id}')">Edit</button>
                            <button class="zen-act-btn" onclick="App.promptAddSystemTag('reviews', '', '${r.id}')">Tag</button>
                            <button class="zen-act-btn" onclick="App.exportSystemItem('reviews', '', '${r.id}')">Export</button>
                            <button class="zen-act-btn danger" onclick="App.deleteReview('${r.id}')">Release</button>
                        </div>
                        ${this.bulkMode.reviews ? `</div></div>` : ''}
                    </div>
                `;
            });
        }

        html += `</div>`;

        if (this.bulkMode.reviews && this.selectedItems.reviews.size > 0) {
            this.renderBulkToolbar('reviews', '');
        }

        return html;
    },
    
    // ============================================================================
    // END OF SYSTEM TAB ENHANCEMENTS
    // ============================================================================
    
    // ============================================================================
    // VAULT ENHANCEMENTS v2.3 - ADVANCED FEATURES
    // ============================================================================
    
    // Toggle Pin Status
    togglePin(vaultType, category, itemId) {
        const item = this.data[vaultType][category]?.find(i => i.id === itemId);
        if (!item) return;
        
        item.pinned = !item.pinned;
        item.modified = new Date().toISOString();
        this.save(); this.render();
        this.toast(item.pinned ? 'ðŸ“Œ Item pinned' : 'âœ“ Item unpinned');
    },
    
    // Toggle Batch Mode
    toggleBatchMode() {
        const settings = this.data.vaultSettings;
        settings.batchMode = !settings.batchMode;
        if (!settings.batchMode) {
            settings.selectedItems = [];
        }
        this.save(); this.render();
    },
    
    // Toggle Item Selection in Batch Mode
    toggleItemSelection(vaultType, category, itemId) {
        const settings = this.data.vaultSettings;
        if (!settings.batchMode) return;
        
        const key = `${vaultType}-${category}-${itemId}`;
        const index = settings.selectedItems.indexOf(key);
        
        if (index > -1) {
            settings.selectedItems.splice(index, 1);
        } else {
            settings.selectedItems.push(key);
        }
        
        this.save(); this.render();
    },
    
    // Batch Delete Selected Items
    batchDelete() {
        const settings = this.data.vaultSettings;
        if (settings.selectedItems.length === 0) {
            this.toast('âš ï¸ No items selected');
            return;
        }
        
        const delCount = settings.selectedItems.length;
        this.confirm(`Delete ${delCount} selected item(s)?`, () => {
            settings.selectedItems.forEach(key => {
                const [vaultType, category, itemId] = key.split('-');
                const items = this.data[vaultType][category];
                if (!items) return;
                const index = items.findIndex(i => i.id === itemId);
                if (index > -1) items.splice(index, 1);
            });
            settings.selectedItems = [];
            settings.batchMode = false;
            this.save(); this.render();
            this.toast('âœ“ Items deleted');
        }, 'Delete All');
    },
    
    // Batch Tag Selected Items
    batchTag() {
        const settings = this.data.vaultSettings;
        if (settings.selectedItems.length === 0) {
            this.toast('âš ï¸ No items selected');
            return;
        }
        
        document.getElementById('modal-body').innerHTML = `
            <h3 style="margin-bottom:12px;color:var(--accent);">Add Tags to ${settings.selectedItems.length} Items</h3>
            <input id="batch-tags" placeholder="Tags (comma-separated)..." style="margin-bottom:12px;">
            <button class="btn" onclick="App.saveBatchTags()">Apply Tags</button>`;
        document.getElementById('modal').classList.add('open');
        setTimeout(() => document.getElementById('batch-tags')?.focus(), 80);
    },
    
    saveBatchTags() {
        const settings = this.data.vaultSettings;
        const tagsInput = document.getElementById('batch-tags')?.value?.trim();
        if (!tagsInput) { this.toast('âš ï¸ Enter tags'); return; }
        
        const newTags = tagsInput.split(',').map(t => t.trim()).filter(t => t);
        
        settings.selectedItems.forEach(key => {
            const [vaultType, category, itemId] = key.split('-');
            const item = this.data[vaultType][category]?.find(i => i.id === itemId);
            if (item) {
                if (!item.tags) item.tags = [];
                newTags.forEach(tag => {
                    if (!item.tags.includes(tag)) {
                        item.tags.push(tag);
                    }
                });
                item.modified = new Date().toISOString();
            }
        });
        
        settings.selectedItems = [];
        settings.batchMode = false;
        this.save(); this.closeModal(); this.render();
        this.toast('âœ“ Tags applied');
    },
    
    // Batch Export Selected Items
    batchExport() {
        const settings = this.data.vaultSettings;
        if (settings.selectedItems.length === 0) {
            this.toast('âš ï¸ No items selected');
            return;
        }
        
        const exportData = [];
        settings.selectedItems.forEach(key => {
            const [vaultType, category, itemId] = key.split('-');
            const item = this.data[vaultType][category]?.find(i => i.id === itemId);
            if (item) {
                exportData.push({ ...item, vaultType, category });
            }
        });
        
        const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `vault-export-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        
        this.toast(`âœ“ ${exportData.length} items exported`);
    },
    
    // Link Items Together
    linkItems(fromVaultType, fromCategory, fromItemId) {
        const fromItem = this.data[fromVaultType][fromCategory]?.find(i => i.id === fromItemId);
        if (!fromItem) return;
        
        // Get all items from both vaults for linking
        const allItems = [];
        ['vaultLearn', 'vaultEarn'].forEach(vaultType => {
            const categories = vaultType === 'vaultLearn' ? ['ideas', 'notes', 'books', 'skills'] : ['strat', 'exec', 'leverage', 'contacts'];
            categories.forEach(cat => {
                (this.data[vaultType][cat] || []).forEach(item => {
                    if (item.id !== fromItemId) {
                        allItems.push({ ...item, vaultType, category: cat });
                    }
                });
            });
        });
        
        const itemOptions = allItems.map(item => 
            `<option value="${item.vaultType}-${item.category}-${item.id}">${esc(item.title)} (${item.category})</option>`
        ).join('');
        
        document.getElementById('modal-body').innerHTML = `
            <h3 style="margin-bottom:12px;color:var(--accent);">ðŸ”— Link "${esc(fromItem.title)}"</h3>
            <p style="font-size:13px;color:var(--dim);margin-bottom:12px;">Select items to link with this one:</p>
            <select id="link-item" style="margin-bottom:12px;">
                <option value="">Select an item...</option>
                ${itemOptions}
            </select>
            <button class="btn" onclick="App.saveLinkItem('${fromVaultType}', '${fromCategory}', '${fromItemId}')">Link Item</button>`;
        document.getElementById('modal').classList.add('open');
    },
    
    saveLinkItem(fromVaultType, fromCategory, fromItemId) {
        const linkKey = document.getElementById('link-item')?.value;
        if (!linkKey) { this.toast('âš ï¸ Select an item'); return; }
        
        const [toVaultType, toCategory, toItemId] = linkKey.split('-');
        
        const fromItem = this.data[fromVaultType][fromCategory]?.find(i => i.id === fromItemId);
        const toItem = this.data[toVaultType][toCategory]?.find(i => i.id === toItemId);
        
        if (!fromItem || !toItem) return;
        
        // Add bidirectional links
        if (!fromItem.linkedTo) fromItem.linkedTo = [];
        if (!toItem.linkedTo) toItem.linkedTo = [];
        
        const fromLink = `${toVaultType}-${toCategory}-${toItemId}`;
        const toLink = `${fromVaultType}-${fromCategory}-${fromItemId}`;
        
        if (!fromItem.linkedTo.includes(fromLink)) {
            fromItem.linkedTo.push(fromLink);
        }
        if (!toItem.linkedTo.includes(toLink)) {
            toItem.linkedTo.push(toLink);
        }
        
        fromItem.modified = new Date().toISOString();
        toItem.modified = new Date().toISOString();
        
        this.save(); this.closeModal(); this.render();
        this.toast('ðŸ”— Items linked');
    },
    
    // Navigate to Linked Item
    navigateToLinkedItem(linkKey) {
        const [vaultType, category, itemId] = linkKey.split('-');
        
        // Navigate to correct vault tab
        this.sub.vault = category;
        this.vaultMainTab = vaultType === 'vaultLearn' ? 'learn' : 'earn';
        
        this.render();
        
        // Scroll to item
        setTimeout(() => {
            const element = document.querySelector(`[data-item-id="${itemId}"]`);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                element.style.animation = 'none';
                setTimeout(() => {
                    element.style.animation = 'pulse 0.5s ease';
                }, 10);
            }
        }, 200);
    },
    
    // Toggle Advanced Filters Panel
    toggleFiltersPanel() {
        const panel = document.getElementById('vault-filters-panel');
        if (panel) {
            panel.classList.toggle('active');
        }
    },
    
    // Apply Advanced Filters
    applyAdvancedFilters() {
        const settings = this.data.vaultSettings;
        
        const startDate = document.getElementById('filter-start-date')?.value;
        const endDate = document.getElementById('filter-end-date')?.value;
        const importance = Array.from(document.querySelectorAll('input[name="filter-importance"]:checked')).map(el => el.value);
        const starredOnly = document.getElementById('filter-starred')?.checked;
        const pinnedOnly = document.getElementById('filter-pinned')?.checked;
        
        settings.dateRange = { start: startDate || null, end: endDate || null };
        settings.importanceFilter = importance;
        settings.starredOnly = starredOnly || false;
        settings.pinnedOnly = pinnedOnly || false;
        
        this.save(); this.render();
        this.toast('âœ“ Filters applied');
    },
    
    // Clear All Filters
    clearAllFilters() {
        const settings = this.data.vaultSettings;
        settings.dateRange = { start: null, end: null };
        settings.importanceFilter = [];
        settings.starredOnly = false;
        settings.pinnedOnly = false;
        settings.selectedTags = [];
        settings.searchQuery = '';
        
        this.save(); this.render();
        this.toast('âœ“ Filters cleared');
    },
    
    // Toggle Tag Filter
    toggleTagFilter(tag) {
        const settings = this.data.vaultSettings;
        if (!settings.selectedTags) settings.selectedTags = [];
        
        const index = settings.selectedTags.indexOf(tag);
        if (index > -1) {
            settings.selectedTags.splice(index, 1);
        } else {
            settings.selectedTags.push(tag);
        }
        
        this.save(); this.render();
    },
    
    // Get All Unique Tags
    getAllTags(vaultType, category) {
        const items = this.data[vaultType][category] || [];
        const tags = new Set();
        items.forEach(item => {
            (item.tags || []).forEach(tag => tags.add(tag));
        });
        return Array.from(tags).sort();
    },
    
    // Bulk Import from JSON
    bulkImportVault() {
        document.getElementById('modal-body').innerHTML = `
            <h3 style="margin-bottom:12px;color:var(--accent);">ðŸ“¥ Bulk Import</h3>
            <p style="font-size:13px;color:var(--dim);margin-bottom:12px;">
                Upload a JSON file containing vault items to import.
            </p>
            <input type="file" id="import-file" accept=".json" style="margin-bottom:12px;">
            <button class="btn" onclick="App.processVaultImport()">Import Items</button>`;
        document.getElementById('modal').classList.add('open');
    },
    
    processVaultImport() {
        const fileInput = document.getElementById('import-file');
        const file = fileInput?.files[0];
        
        if (!file) {
            this.toast('âš ï¸ Select a file');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = JSON.parse(e.target.result);
                
                if (!Array.isArray(data)) {
                    this.toast('âš ï¸ Invalid format');
                    return;
                }
                
                let imported = 0;
                data.forEach(item => {
                    if (item.vaultType && item.category && item.title && item.content) {
                        const newItem = {
                            id: this.genId(),
                            title: item.title,
                            content: item.content,
                            tags: item.tags || [],
                            importance: item.importance || 'low',
                            starred: item.starred || false,
                            pinned: item.pinned || false,
                            source: item.source || '',
                            created: new Date().toISOString(),
                            modified: null,
                            linkedTo: []
                        };
                        
                        if (!this.data[item.vaultType][item.category]) {
                            this.data[item.vaultType][item.category] = [];
                        }
                        
                        this.data[item.vaultType][item.category].push(newItem);
                        imported++;
                    }
                });
                
                this.save(); this.closeModal(); this.render();
                this.toast(`âœ“ Imported ${imported} items`);
            } catch (error) {
                this.toast('âš ï¸ Error parsing file');
            }
        };
        
        reader.readAsText(file);
    },
    
    // Render Markdown Content
    renderMarkdown(content) {
        if (!content) return '';
        
        // Simple markdown rendering
        let html = content;
        
        // Headers
        html = html.replace(/^### (.*$)/gim, '<h3>$1</h3>');
        html = html.replace(/^## (.*$)/gim, '<h2>$1</h2>');
        html = html.replace(/^# (.*$)/gim, '<h1>$1</h1>');
        
        // Bold
        html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        
        // Italic
        html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
        
        // Code
        html = html.replace(/`(.*?)`/g, '<code>$1</code>');
        
        // Links
        html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
        
        // Blockquotes
        html = html.replace(/^> (.*$)/gim, '<blockquote>$1</blockquote>');
        
        // Lists
        html = html.replace(/^\* (.*$)/gim, '<li>$1</li>');
        html = html.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
        
        return html;
    },
    
    // Toggle View Mode (card/compact/timeline)
    toggleViewMode(mode) {
        this.data.vaultSettings.viewMode = mode;
        this.save(); this.render();
    },
    
    // ============================================================================
    // END OF VAULT ENHANCEMENTS v2.3
    // ============================================================================

    // VAULT - LEARNINGS
    addNote() {
        document.getElementById('modal-body').innerHTML = `
            <h3 style="margin-bottom:12px;color:var(--accent);">ðŸ“ Add Note</h3>
            <input id="note-title" placeholder="Note title..." style="margin-bottom:12px;">
            <textarea id="note-content" placeholder="Note content..." rows="8" style="margin-bottom:12px;"></textarea>
            <button class="btn" onclick="App.saveNote()">Save Note</button>`;
        document.getElementById('modal').classList.add('open');
        setTimeout(() => document.getElementById('note-title')?.focus(), 80);
    },

    saveNote() {
        const title = document.getElementById('note-title')?.value?.trim();
        const content = document.getElementById('note-content')?.value?.trim();
        if (!title || !content) { this.toast('âš ï¸ Enter title and content'); return; }
        if (!this.data.vaultLearn) this.data.vaultLearn = { ideas: [], notes: [], books: [], skills: [] };
        if (!this.data.vaultLearn.notes) this.data.vaultLearn.notes = [];
        this.data.vaultLearn.notes.push({
            id: this.genId(),
            title,
            content,
            tags: [],
            importance: 'low',
            starred: false,
            pinned: false,
            source: '',
            created: new Date().toISOString(),
            modified: null,
            linkedTo: []
        });
        this.save(); this.closeModal(); this.navigate(4); this.sub.vaultMain = 'learn'; this.sub.vault = 'notes'; this.render();
        this.toast('âœ“ Note saved');
    },

    addQuote() {
        document.getElementById('modal-body').innerHTML = `
            <h3 style="margin-bottom:12px;color:var(--accent);">ðŸ’¬ Add Quote</h3>
            <textarea id="quote-text" placeholder="Quote text..." rows="4" style="margin-bottom:12px;"></textarea>
            <input id="quote-author" placeholder="Author (optional)" style="margin-bottom:12px;">
            <button class="btn" onclick="App.saveQuote()">Save Quote</button>`;
        document.getElementById('modal').classList.add('open');
        setTimeout(() => document.getElementById('quote-text')?.focus(), 80);
    },

    saveQuote() {
        const text = document.getElementById('quote-text')?.value?.trim();
        const author = document.getElementById('quote-author')?.value?.trim();
        if (!text) { this.toast('âš ï¸ Enter quote text'); return; }
        if (!this.data.vault.learnings.quotes) this.data.vault.learnings.quotes = [];
        this.data.vault.learnings.quotes.push({
            id: this.genId(),
            text,
            author: author || '',
            date: new Date().toISOString()
        });
        this.save(); this.closeModal(); this.render();
        this.toast('âœ“ Quote saved');
    },

    addBookSummary() {
        document.getElementById('modal-body').innerHTML = `
            <h3 style="margin-bottom:12px;color:var(--accent);">ðŸ“– Book Summary</h3>
            <input id="book-title" placeholder="Book title..." style="margin-bottom:12px;">
            <input id="book-author" placeholder="Author..." style="margin-bottom:12px;">
            <textarea id="book-summary" placeholder="Key insights and summary..." rows="8" style="margin-bottom:12px;"></textarea>
            <button class="btn" onclick="App.saveBookSummary()">Save Summary</button>`;
        document.getElementById('modal').classList.add('open');
        setTimeout(() => document.getElementById('book-title')?.focus(), 80);
    },

    saveBookSummary() {
        const title = document.getElementById('book-title')?.value?.trim();
        const author = document.getElementById('book-author')?.value?.trim();
        const summary = document.getElementById('book-summary')?.value?.trim();
        if (!title || !summary) { this.toast('âš ï¸ Enter title and summary'); return; }
        if (!this.data.vault.learnings.bookSummaries) this.data.vault.learnings.bookSummaries = [];
        this.data.vault.learnings.bookSummaries.push({
            id: this.genId(),
            title,
            author: author || '',
            summary,
            date: new Date().toISOString()
        });
        this.save(); this.closeModal(); this.render();
        this.toast('âœ“ Book summary saved');
    },

    // MINDMAPS
    addMindmap() {
        document.getElementById('modal-body').innerHTML = `
            <h3 style="margin-bottom:12px;color:var(--accent);">ðŸ§  Create Mindmap</h3>
            <input id="mindmap-title" placeholder="Central topic..." style="margin-bottom:12px;">
            <textarea id="mindmap-nodes" placeholder="Main branches (one per line)..." rows="6" style="margin-bottom:12px;"></textarea>
            <div style="font-size:11px;color:var(--dim);margin-bottom:12px;">
                Enter the main branches of your mindmap. You can add sub-branches later.
            </div>
            <button class="btn" onclick="App.saveMindmap()">Create Mindmap</button>`;
        document.getElementById('modal').classList.add('open');
        setTimeout(() => document.getElementById('mindmap-title')?.focus(), 80);
    },

    saveMindmap() {
        const title = document.getElementById('mindmap-title')?.value?.trim();
        const nodesText = document.getElementById('mindmap-nodes')?.value?.trim();
        if (!title) { this.toast('âš ï¸ Enter central topic'); return; }
        
        const nodes = nodesText
            ? nodesText.split('\n').filter(n => n.trim()).map(n => ({
                id: this.genId(),
                text: n.trim(),
                children: []
            }))
            : [];
        
        if (!this.data.vault.learnings.mindmaps) this.data.vault.learnings.mindmaps = [];
        this.data.vault.learnings.mindmaps.push({
            id: this.genId(),
            title,
            nodes,
            created: new Date().toISOString()
        });
        
        this.save(); this.closeModal(); this.render();
        this.toast('âœ“ Mindmap created');
    },

    viewMindmap(id) {
        const map = this.data.vault.learnings.mindmaps?.find(m => m.id === id);
        if (!map) return;
        
        const renderNode = (node, level = 0) => {
            const indent = level * 24;
            const hasChildren = node.children && node.children.length > 0;
            
            return `
                <div style="margin-left:${indent}px;margin-bottom:8px;">
                    <div style="padding:10px;background:var(--sub);border-radius:8px;
                         border-left:3px solid var(--accent);display:flex;justify-content:space-between;
                         align-items:center;gap:8px;">
                        <div style="flex:1;font-size:14px;">${esc(node.text)}</div>
                        <div style="display:flex;gap:4px;">
                            <button class="btn-sec" onclick="App.addChildNode('${map.id}','${node.id}')" 
                                    style="padding:4px 8px;font-size:11px;">+ Sub</button>
                            <button class="btn-sec btn-danger" onclick="App.deleteNode('${map.id}','${node.id}')" 
                                    style="padding:4px 8px;font-size:11px;">Ã—</button>
                        </div>
                    </div>
                    ${hasChildren ? node.children.map(child => renderNode(child, level + 1)).join('') : ''}
                </div>
            `;
        };
        
        document.getElementById('modal-body').innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                <h3 style="color:var(--accent);margin:0;">ðŸ§  ${esc(map.title)}</h3>
                <button class="btn-sec" onclick="App.addBranchNode('${map.id}')">+ Branch</button>
            </div>
            
            <div style="max-height:60vh;overflow-y:auto;">
                ${map.nodes && map.nodes.length > 0 
                    ? map.nodes.map(node => renderNode(node)).join('') 
                    : '<div style="text-align:center;padding:40px;color:var(--dim);">No branches yet. Add your first branch!</div>'}
            </div>
            
            <button class="btn-sec" onclick="App.closeModal()" style="margin-top:16px;width:100%;">Close</button>
        `;
        
        document.getElementById('modal').classList.add('open');
    },

    addBranchNode(mapId) {
        const text = prompt('Branch text:');
        if (!text?.trim()) return;
        
        const map = this.data.vault.learnings.mindmaps?.find(m => m.id === mapId);
        if (!map) return;
        
        if (!map.nodes) map.nodes = [];
        map.nodes.push({
            id: this.genId(),
            text: text.trim(),
            children: []
        });
        
        map.modified = new Date().toISOString();
        this.save();
        this.viewMindmap(mapId);
        this.toast('âœ“ Branch added');
    },

    addChildNode(mapId, parentNodeId) {
        const text = prompt('Sub-branch text:');
        if (!text?.trim()) return;
        
        const map = this.data.vault.learnings.mindmaps?.find(m => m.id === mapId);
        if (!map) return;
        
        const findAndAddChild = (nodes) => {
            for (let node of nodes) {
                if (node.id === parentNodeId) {
                    if (!node.children) node.children = [];
                    node.children.push({
                        id: this.genId(),
                        text: text.trim(),
                        children: []
                    });
                    return true;
                }
                if (node.children && findAndAddChild(node.children)) {
                    return true;
                }
            }
            return false;
        };
        
        if (findAndAddChild(map.nodes)) {
            map.modified = new Date().toISOString();
            this.save();
            this.viewMindmap(mapId);
            this.toast('âœ“ Sub-branch added');
        }
    },

    deleteNode(mapId, nodeId) {
        // node deletion confirmed via UI (no dialog needed for sub-action)
        
        const map = this.data.vault.learnings.mindmaps?.find(m => m.id === mapId);
        if (!map) return;
        
        const removeNode = (nodes, targetId) => {
            for (let i = 0; i < nodes.length; i++) {
                if (nodes[i].id === targetId) {
                    nodes.splice(i, 1);
                    return true;
                }
                if (nodes[i].children && removeNode(nodes[i].children, targetId)) {
                    return true;
                }
            }
            return false;
        };
        
        if (removeNode(map.nodes, nodeId)) {
            map.modified = new Date().toISOString();
            this.save();
            this.viewMindmap(mapId);
            this.toast('âœ“ Node deleted');
        }
    },

    deleteMindmap(id) {
        this.confirm('Delete this mindmap and all branches?', () => {
            this.data.vault.learnings.mindmaps = (this.data.vault.learnings.mindmaps || []).filter(m => m.id !== id);
            this.save(); this.render();
            this.toast('âœ“ Mindmap deleted');
        }, 'Delete');
    },

    // VAULT - GROWTH
    addGrowthBook() {
        document.getElementById('modal-body').innerHTML = `
            <h3 style="margin-bottom:12px;color:var(--accent);">ðŸ“š Track Book</h3>
            <input id="gb-title" placeholder="Book title..." style="margin-bottom:12px;">
            <input id="gb-author" placeholder="Author..." style="margin-bottom:12px;">
            <label style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
                <input type="checkbox" id="gb-completed" style="width:auto;margin:0;">
                <span>Completed</span>
            </label>
            <button class="btn" onclick="App.saveGrowthBook()">Track Book</button>`;
        document.getElementById('modal').classList.add('open');
        setTimeout(() => document.getElementById('gb-title')?.focus(), 80);
    },

    saveGrowthBook() {
        const title = document.getElementById('gb-title')?.value?.trim();
        const author = document.getElementById('gb-author')?.value?.trim();
        const completed = document.getElementById('gb-completed')?.checked;
        if (!title) { this.toast('âš ï¸ Enter title'); return; }
        if (!this.data.vault.growth.books) this.data.vault.growth.books = [];
        this.data.vault.growth.books.push({
            id: this.genId(),
            title,
            author: author || '',
            completed,
            date: new Date().toISOString()
        });
        this.save(); this.closeModal(); this.render();
        this.toast('âœ“ Book tracked');
    },

    addCourse() {
        document.getElementById('modal-body').innerHTML = `
            <h3 style="margin-bottom:12px;color:var(--accent);">ðŸŽ“ Track Course</h3>
            <input id="course-title" placeholder="Course title..." style="margin-bottom:12px;">
            <input id="course-platform" placeholder="Platform (e.g., Coursera)" style="margin-bottom:12px;">
            <input id="course-progress" type="number" min="0" max="100" placeholder="Progress %" style="margin-bottom:12px;">
            <button class="btn" onclick="App.saveCourse()">Track Course</button>`;
        document.getElementById('modal').classList.add('open');
        setTimeout(() => document.getElementById('course-title')?.focus(), 80);
    },

    saveCourse() {
        const title = document.getElementById('course-title')?.value?.trim();
        const platform = document.getElementById('course-platform')?.value?.trim();
        const progress = document.getElementById('course-progress')?.value;
        if (!title) { this.toast('âš ï¸ Enter title'); return; }
        if (!this.data.vault.growth.courses) this.data.vault.growth.courses = [];
        this.data.vault.growth.courses.push({
            id: this.genId(),
            title,
            platform: platform || '',
            progress: progress ? parseInt(progress) : 0,
            date: new Date().toISOString()
        });
        this.save(); this.closeModal(); this.render();
        this.toast('âœ“ Course tracked');
    },

    addSkill() {
        document.getElementById('modal-body').innerHTML = `
            <h3 style="margin-bottom:12px;color:var(--accent);">âš¡ Track Skill</h3>
            <input id="skill-name" placeholder="Skill name..." style="margin-bottom:12px;">
            <select id="skill-level" style="margin-bottom:12px;">
                <option value="Beginner">Beginner</option>
                <option value="Intermediate">Intermediate</option>
                <option value="Advanced">Advanced</option>
                <option value="Expert">Expert</option>
            </select>
            <input id="skill-progress" type="number" min="0" max="100" placeholder="Progress %" style="margin-bottom:12px;">
            <button class="btn" onclick="App.saveSkill()">Track Skill</button>`;
        document.getElementById('modal').classList.add('open');
        setTimeout(() => document.getElementById('skill-name')?.focus(), 80);
    },

    saveSkill() {
        const name = document.getElementById('skill-name')?.value?.trim();
        const level = document.getElementById('skill-level')?.value;
        const progress = document.getElementById('skill-progress')?.value;
        if (!name) { this.toast('âš ï¸ Enter skill name'); return; }
        if (!this.data.vault.growth.skills) this.data.vault.growth.skills = [];
        this.data.vault.growth.skills.push({
            id: this.genId(),
            name,
            level,
            progress: progress ? parseInt(progress) : 0,
            date: new Date().toISOString()
        });
        this.save(); this.closeModal(); this.render();
        this.toast('âœ“ Skill tracked');
    },

    addMentor() {
        document.getElementById('modal-body').innerHTML = `
            <h3 style="margin-bottom:12px;color:var(--accent);">ðŸ§‘â€ðŸ« Add Mentor</h3>
            <input id="mentor-name" placeholder="Mentor name..." style="margin-bottom:12px;">
            <input id="mentor-expertise" placeholder="Expertise area..." style="margin-bottom:12px;">
            <button class="btn" onclick="App.saveMentor()">Add Mentor</button>`;
        document.getElementById('modal').classList.add('open');
        setTimeout(() => document.getElementById('mentor-name')?.focus(), 80);
    },

    saveMentor() {
        const name = document.getElementById('mentor-name')?.value?.trim();
        const expertise = document.getElementById('mentor-expertise')?.value?.trim();
        if (!name) { this.toast('âš ï¸ Enter name'); return; }
        if (!this.data.vault.growth.mentors) this.data.vault.growth.mentors = [];
        this.data.vault.growth.mentors.push({
            id: this.genId(),
            name,
            expertise: expertise || '',
            date: new Date().toISOString()
        });
        this.save(); this.closeModal(); this.render();
        this.toast('âœ“ Mentor added');
    },

    // VAULT - RESOURCES
    addIdea() {
        document.getElementById('modal-body').innerHTML = `
            <h3 style="margin-bottom:12px;color:var(--accent);">ðŸ’¡ Capture Idea</h3>
            <input id="idea-title" placeholder="Idea title..." style="margin-bottom:12px;">
            <textarea id="idea-desc" placeholder="Description..." rows="6" style="margin-bottom:12px;"></textarea>
            <button class="btn" onclick="App.saveIdea()">Capture Idea</button>`;
        document.getElementById('modal').classList.add('open');
        setTimeout(() => document.getElementById('idea-title')?.focus(), 80);
    },

    saveIdea() {
        const title = document.getElementById('idea-title')?.value?.trim();
        const description = document.getElementById('idea-desc')?.value?.trim();
        if (!title) { this.toast('âš ï¸ Enter title'); return; }
        if (!this.data.vaultLearn) this.data.vaultLearn = { ideas: [], notes: [], books: [], skills: [] };
        if (!this.data.vaultLearn.ideas) this.data.vaultLearn.ideas = [];
        this.data.vaultLearn.ideas.push({
            id: this.genId(),
            title,
            content: description || '',
            tags: [],
            importance: 'low',
            starred: false,
            pinned: false,
            source: '',
            created: new Date().toISOString(),
            modified: null,
            linkedTo: []
        });
        this.save(); this.closeModal(); this.navigate(4); this.sub.vaultMain = 'learn'; this.sub.vault = 'ideas'; this.render();
        this.toast('âœ“ Idea captured');
    },

    addContact() {
        document.getElementById('modal-body').innerHTML = `
            <h3 style="margin-bottom:12px;color:var(--accent);">ðŸ‘¤ Add Contact</h3>
            <input id="contact-name" placeholder="Name..." style="margin-bottom:12px;">
            <input id="contact-role" placeholder="Role/Title..." style="margin-bottom:12px;">
            <textarea id="contact-notes" placeholder="Notes..." rows="4" style="margin-bottom:12px;"></textarea>
            <button class="btn" onclick="App.saveContact()">Add Contact</button>`;
        document.getElementById('modal').classList.add('open');
        setTimeout(() => document.getElementById('contact-name')?.focus(), 80);
    },

    saveContact() {
        const name = document.getElementById('contact-name')?.value?.trim();
        const role = document.getElementById('contact-role')?.value?.trim();
        const notes = document.getElementById('contact-notes')?.value?.trim();
        if (!name) { this.toast('âš ï¸ Enter name'); return; }
        if (!this.data.vault.resources.contacts) this.data.vault.resources.contacts = [];
        this.data.vault.resources.contacts.push({
            id: this.genId(),
            name,
            role: role || '',
            notes: notes || '',
            date: new Date().toISOString()
        });
        this.save(); this.closeModal(); this.render();
        this.toast('âœ“ Contact added');
    },

    addIncomeStream() {
        document.getElementById('modal-body').innerHTML = `
            <h3 style="margin-bottom:12px;color:var(--accent);">ðŸ’° Track Income Stream</h3>
            <input id="income-name" placeholder="Stream name..." style="margin-bottom:12px;">
            <input id="income-amount" type="number" placeholder="Monthly amount" style="margin-bottom:12px;">
            <select id="income-status" style="margin-bottom:12px;">
                <option value="Active">Active</option>
                <option value="In Progress">In Progress</option>
                <option value="Planned">Planned</option>
            </select>
            <button class="btn" onclick="App.saveIncomeStream()">Track Stream</button>`;
        document.getElementById('modal').classList.add('open');
        setTimeout(() => document.getElementById('income-name')?.focus(), 80);
    },

    saveIncomeStream() {
        const name = document.getElementById('income-name')?.value?.trim();
        const amount = document.getElementById('income-amount')?.value;
        const status = document.getElementById('income-status')?.value;
        if (!name) { this.toast('âš ï¸ Enter name'); return; }
        if (!this.data.vault.resources.incomeStreams) this.data.vault.resources.incomeStreams = [];
        this.data.vault.resources.incomeStreams.push({
            id: this.genId(),
            name,
            amount: amount || '',
            status,
            date: new Date().toISOString()
        });
        this.save(); this.closeModal(); this.render();
        this.toast('âœ“ Income stream tracked');
    },

    addAsset() {
        document.getElementById('modal-body').innerHTML = `
            <h3 style="margin-bottom:12px;color:var(--accent);">ðŸ† Track Asset</h3>
            <input id="asset-name" placeholder="Asset name..." style="margin-bottom:12px;">
            <input id="asset-value" type="number" placeholder="Current value" style="margin-bottom:12px;">
            <button class="btn" onclick="App.saveAsset()">Track Asset</button>`;
        document.getElementById('modal').classList.add('open');
        setTimeout(() => document.getElementById('asset-name')?.focus(), 80);
    },

    saveAsset() {
        const name = document.getElementById('asset-name')?.value?.trim();
        const value = document.getElementById('asset-value')?.value;
        if (!name) { this.toast('âš ï¸ Enter name'); return; }
        if (!this.data.vault.resources.assets) this.data.vault.resources.assets = [];
        this.data.vault.resources.assets.push({
            id: this.genId(),
            name,
            value: value || '',
            date: new Date().toISOString()
        });
        this.save(); this.closeModal(); this.render();
        this.toast('âœ“ Asset tracked');
    },

    // GOALS
    addGoal() {
        const domains = this.getAllDomains();
        const domainOptions = domains.map(d => `<option value="${esc(d)}">${esc(d)}</option>`).join('');
        
        document.getElementById('modal-body').innerHTML = `
            <h3 style="margin-bottom:12px;color:var(--accent);">ðŸŽ¯ Add Goal</h3>
            <input id="goal-title" placeholder="Goal title..." style="margin-bottom:12px;">
            <input id="goal-timeline" placeholder="Timeline (e.g., 2025-2028)" style="margin-bottom:12px;">
            <input id="goal-metrics" placeholder="Success metrics..." style="margin-bottom:12px;">
            <select id="goal-domain" style="margin-bottom:12px;">
                <option value="">Domain (optional)</option>
                ${domainOptions}
            </select>
            <textarea id="goal-subgoals" placeholder="Subgoals (one per line)..." rows="6" style="margin-bottom:12px;"></textarea>
            <button class="btn" onclick="App.saveGoal()">Add Goal</button>`;
        document.getElementById('modal').classList.add('open');
        setTimeout(() => document.getElementById('goal-title')?.focus(), 80);
    },

    saveGoal() {
        const title = document.getElementById('goal-title')?.value?.trim();
        const timeline = document.getElementById('goal-timeline')?.value?.trim();
        const metrics = document.getElementById('goal-metrics')?.value?.trim();
        const domain = document.getElementById('goal-domain')?.value;
        const subgoalsText = document.getElementById('goal-subgoals')?.value?.trim();
        
        if (!title) { this.toast('âš ï¸ Enter title'); return; }
        
        const subgoals = subgoalsText 
            ? subgoalsText.split('\n').filter(s => s.trim()).map(s => ({ 
                id: this.genId(), 
                title: s.trim(), 
                done: false 
            }))
            : [];
        
        if (!this.data.goals) this.data.goals = [];
        this.data.goals.push({
            id: this.genId(),
            title,
            timeline: timeline || '',
            metrics: metrics || '',
            domain: domain || '',
            subgoals,
            created: new Date().toISOString()
        });
        
        this.save(); this.closeModal(); this.render();
        this.toast('âœ“ Goal added');
    },

    editGoal(id) {
        const goal = this.data.goals?.find(g => g.id === id);
        if (!goal) return;
        
        const domains = this.getAllDomains();
        const domainOptions = domains.map(d => 
            `<option value="${esc(d)}" ${goal.domain === d ? 'selected' : ''}>${esc(d)}</option>`
        ).join('');
        
        const subgoalsText = goal.subgoals?.map(s => s.title).join('\n') || '';
        
        document.getElementById('modal-body').innerHTML = `
            <h3 style="margin-bottom:12px;color:var(--accent);">Edit Goal</h3>
            <input id="goal-title" value="${esc(goal.title)}" placeholder="Goal title..." style="margin-bottom:12px;">
            <input id="goal-timeline" value="${esc(goal.timeline || '')}" placeholder="Timeline" style="margin-bottom:12px;">
            <input id="goal-metrics" value="${esc(goal.metrics || '')}" placeholder="Success metrics..." style="margin-bottom:12px;">
            <select id="goal-domain" style="margin-bottom:12px;">
                <option value="">Domain (optional)</option>
                ${domainOptions}
            </select>
            <textarea id="goal-subgoals" placeholder="Subgoals (one per line)..." rows="6" style="margin-bottom:12px;">${esc(subgoalsText)}</textarea>
            <button class="btn" onclick="App.updateGoal('${id}')">Update Goal</button>`;
        document.getElementById('modal').classList.add('open');
        setTimeout(() => document.getElementById('goal-title')?.focus(), 80);
    },

    updateGoal(id) {
        const goal = this.data.goals?.find(g => g.id === id);
        if (!goal) return;
        
        const title = document.getElementById('goal-title')?.value?.trim();
        const timeline = document.getElementById('goal-timeline')?.value?.trim();
        const metrics = document.getElementById('goal-metrics')?.value?.trim();
        const domain = document.getElementById('goal-domain')?.value;
        const subgoalsText = document.getElementById('goal-subgoals')?.value?.trim();
        
        if (!title) { this.toast('âš ï¸ Enter title'); return; }
        
        goal.title = title;
        goal.timeline = timeline || '';
        goal.metrics = metrics || '';
        goal.domain = domain || '';
        goal.subgoals = subgoalsText 
            ? subgoalsText.split('\n').filter(s => s.trim()).map(s => ({ 
                id: this.genId(), 
                title: s.trim(), 
                done: false 
            }))
            : [];
        
        this.save(); this.closeModal(); this.render();
        this.toast('âœ“ Goal updated');
    },

    deleteGoal(id) {
        this.confirm('Delete this goal and all its subgoals?', () => {
            this.data.goals = (this.data.goals || []).filter(g => g.id !== id);
            this.save(); this.render();
            this.toast('âœ“ Goal deleted');
        }, 'Delete');
    },

    toggleGoal(id) {
        const goal = this.data.goals?.find(g => g.id === id);
        if (goal) {
            goal.expanded = !goal.expanded;
            this.render();
        }
    },

    addSubgoal(goalId) {
        const title = prompt('Subgoal:');
        if (!title?.trim()) return;
        
        const goal = this.data.goals?.find(g => g.id === goalId);
        if (goal) {
            if (!goal.subgoals) goal.subgoals = [];
            goal.subgoals.push({
                id: this.genId(),
                title: title.trim(),
                done: false
            });
            this.save();
            this.render();
            this.toast('âœ“ Subgoal added');
        }
    },

    toggleSubgoal(goalId, subgoalId) {
        const goal = this.data.goals?.find(g => g.id === goalId);
        if (goal) {
            const subgoal = goal.subgoals?.find(s => s.id === subgoalId);
            if (subgoal) {
                subgoal.done = !subgoal.done;
                this.save();
                this.render();
            }
        }
    },

    deleteSubgoal(goalId, subgoalId) {
        const goal = this.data.goals?.find(g => g.id === goalId);
        if (!goal) return;
        this.confirm('Delete this subgoal?', () => {
            goal.subgoals = (goal.subgoals || []).filter(s => s.id !== subgoalId);
            this.save(); this.render();
            this.toast('âœ“ Subgoal deleted');
        }, 'Delete');
    },

    // GOAL STAGE MANAGEMENT
    toggleGoalStage(goalId, stageId) {
        const goal = this.data.goals?.find(g => g.id === goalId);
        if (!goal || !goal.stages) return;
        
        const stage = goal.stages.find(s => s.id === stageId);
        if (stage) {
            stage.completed = !stage.completed;
            if (stage.completed) {
                stage.completedAt = new Date().toISOString();
            } else {
                delete stage.completedAt;
            }
            this.save();
            this.render();
            this.toast(stage.completed ? 'âœ“ Stage completed' : 'â—¯ Stage reopened');
        }
    },

    deleteGoalStage(goalId, stageId) {
        const goal = this.data.goals?.find(g => g.id === goalId);
        if (!goal) return;
        this.confirm('Delete this stage?', () => {
            goal.stages = (goal.stages || []).filter(s => s.id !== stageId);
            this.save(); this.render();
            this.toast('âœ“ Stage deleted');
        }, 'Delete');
    },

    // TIMEBLOCK MANAGEMENT
    viewTimeblocks() {
        const timeblocks = this.data.timeblocks || [];
        const today = new Date().toISOString().split('T')[0];
        
        // Filter to show today and future timeblocks
        const upcoming = timeblocks.filter(tb => tb.date >= today).sort((a, b) => {
            const dateCompare = a.date.localeCompare(b.date);
            if (dateCompare !== 0) return dateCompare;
            return (a.time || '').localeCompare(b.time || '');
        });
        
        document.getElementById('modal-body').innerHTML = `
            <h3 style="margin-bottom:16px;color:var(--accent);">ðŸ“… Scheduled Timeblocks</h3>
            
            ${upcoming.length === 0 ? `
                <div style="text-align:center;padding:40px 20px;color:var(--dim);">
                    <div style="font-size:48px;margin-bottom:12px;">ðŸ“…</div>
                    <div style="font-size:14px;">No upcoming timeblocks</div>
                    <button class="btn" onclick="App.closeModal();App.addTimeblock()" style="margin-top:20px;">
                        Schedule First Timeblock
                    </button>
                </div>
            ` : `
                <div style="max-height:60vh;overflow-y:auto;">
                    ${upcoming.map(tb => {
                        const date = new Date(tb.date + 'T00:00:00');
                        const dateStr = date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                        const isToday = tb.date === today;
                        
                        return `
                            <div class="card" style="border-left:4px solid ${tb.completed ? 'var(--dim)' : 'var(--accent)'};">
                                <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px;">
                                    <div style="flex:1;">
                                        <div style="font-weight:700;font-size:16px;${tb.completed ? 'text-decoration:line-through;opacity:0.6;' : ''}">${esc(tb.title)}</div>
                                        <div style="font-size:12px;color:var(--dim);margin-top:4px;">
                                            ${isToday ? 'ðŸ”” ' : ''}${dateStr}
                                            ${tb.time ? ` â€¢ ${tb.time}` : ''}
                                            ${tb.duration ? ` â€¢ ${tb.duration} min` : ''}
                                        </div>
                                    </div>
                                    <div style="padding:4px 10px;background:var(--sub);border-radius:6px;font-size:11px;font-weight:600;">
                                        ${tb.type || 'Focus'}
                                    </div>
                                </div>
                                ${tb.notes ? `<div style="font-size:13px;color:var(--dim);margin-top:8px;">${esc(tb.notes)}</div>` : ''}
                                <div style="display:flex;gap:8px;margin-top:12px;">
                                    ${!tb.completed ? `
                                        <button class="btn-sec btn-success" onclick="App.toggleTimeblock('${tb.id}', true)" style="font-size:12px;">
                                            âœ“ Complete
                                        </button>
                                    ` : `
                                        <button class="btn-sec" onclick="App.toggleTimeblock('${tb.id}', true)" style="font-size:12px;">
                                            â—¯ Reopen
                                        </button>
                                    `}
                                    <button class="btn-sec btn-danger" onclick="App.deleteTimeblock('${tb.id}', true)" style="font-size:12px;">
                                        Delete
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
                
                <button class="btn" onclick="App.closeModal();App.addTimeblock()" style="margin-top:16px;width:100%;">
                    + Add Another Timeblock
                </button>
            `}
        `;
        
        document.getElementById('modal').classList.add('open');
    },

    toggleTimeblock(id, fromModal = false) {
        const tb = this.data.timeblocks?.find(t => t.id === id);
        if (tb) {
            tb.completed = !tb.completed;
            if (tb.completed) {
                tb.completedAt = new Date().toISOString();
            } else {
                delete tb.completedAt;
            }
            this.save();
            
            // Refresh appropriate view based on context
            if (fromModal) {
                this.viewTimeblocks();
            } else {
                this.render();
            }
            
            this.toast(tb.completed ? 'âœ“ Timeblock completed' : 'â—¯ Timeblock reopened');
        }
    },

    deleteTimeblock(id, fromModal = false) {
        this.confirm('Delete this timeblock?', () => {
            this.data.timeblocks = (this.data.timeblocks || []).filter(t => t.id !== id);
            this.save();
            if (fromModal) { this.viewTimeblocks(); } else { this.render(); }
            this.toast('âœ“ Timeblock deleted');
        }, 'Delete');
    },

    // TASK FILTERING
    // â”€â”€ INTEGRATION: Render EARN Strategy context on Strategy tab â”€â”€
    renderStrategyContext(cycle) {
        const strat = this.data.vaultEarn?.strat || [];
        if (strat.length === 0) return '';

        const goalsF = cycle?.goals_focus || {};
        const activeDomain = Object.entries(goalsF).sort((a,b) => b[1]-a[1]).map(e=>e[0])[0] || '';
        const week = this.sub._viewedWeek || this.getCurrentWeek();

        // Surface: pinned > domain-matched high importance > starred
        const contextItems = [
            ...strat.filter(s => s.pinnedToday),
            ...(activeDomain ? strat.filter(s => !s.pinnedToday && s.linkedDomain === activeDomain && s.importance === 'high') : []),
            ...(activeDomain ? strat.filter(s => !s.pinnedToday && s.linkedDomain === activeDomain && !s.pinnedToday && s.importance !== 'high').slice(0,1) : []),
        ].filter((item, idx, arr) => arr.findIndex(i=>i.id===item.id)===idx).slice(0,3);

        if (contextItems.length === 0) return '';

        let html = `<div style="margin-top:20px;margin-bottom:4px;">
            <div style="font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:2px;color:var(--accent);margin-bottom:8px;">
                ðŸ“Š Operating Rules ${activeDomain ? `Â· <span style="color:${this.getDomainColor(activeDomain)};">${esc(activeDomain)}</span>` : ''}
            </div>`;

        contextItems.forEach(s => {
            const col = s.linkedDomain ? this.getDomainColor(s.linkedDomain) : 'var(--accent)';
            html += `
            <div style="background:linear-gradient(135deg,#1a1a00,#1c1c1e);border:1px solid ${col}33;
                        border-left:2px solid ${col};border-radius:8px;padding:10px 12px;margin-bottom:8px;">
                <div style="font-size:12px;font-weight:600;color:var(--text);line-height:1.4;">${esc(s.title)}</div>
                ${s.content ? `<div style="font-size:11px;color:var(--dim);margin-top:3px;line-height:1.4;
                    display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;">
                    ${esc(s.content)}</div>` : ''}
                <div style="display:flex;gap:6px;margin-top:8px;align-items:center;">
                    ${s.pinnedToday ? `<span style="font-size:9px;color:${col};font-weight:700;">ðŸ“Œ PINNED</span>` : ''}
                    ${s.linkedDomain ? `<span style="font-size:9px;color:${col};opacity:0.8;">${esc(s.linkedDomain)}</span>` : ''}
                    <button onclick="App.pinStrategyToday('${s.id}')"
                        style="font-size:9px;padding:2px 8px;background:var(--sub);color:var(--dim);
                               border:1px solid ${col}33;border-radius:4px;cursor:pointer;margin-left:auto;">
                        ${s.pinnedToday ? 'Unpin' : 'Pin Today'}
                    </button>
                </div>
            </div>`;
        });

        if (strat.length > contextItems.length) {
            html += `<div style="text-align:right;margin-bottom:12px;">
                <button onclick="App.tab=4;App.sub.vaultMain='earn';App.sub.vault='strat';App.render()"
                    style="font-size:10px;color:var(--dim);background:none;border:none;cursor:pointer;padding:0;">
                    All ${strat.length} strategy items â†’
                </button>
            </div>`;
        }

        html += `</div>`;
        return html;
    },

    renderTaskFilters() {
        if (!this.data.currentCycle) return '';
        
        const tasks = this.data.currentCycle.tasks || [];
        const goals = [...new Set(tasks.map(t => t.goal).filter(Boolean))];
        const domains = [...new Set(tasks.map(t => t.domain).filter(Boolean))];
        
        if (!this.taskFilters) {
            this.taskFilters = { goal: 'All', domain: 'All', status: 'All' };
        }
        
        return `
            <div style="display:flex;gap:8px;overflow-x:auto;padding-bottom:4px;margin-bottom:16px;">
                <select class="filter-btn" onchange="App.updateFilter('goal', this.value)">
                    <option ${this.taskFilters.goal === 'All' ? 'selected' : ''}>All Goals</option>
                    ${goals.map(g => `<option ${this.taskFilters.goal === g ? 'selected' : ''}>${esc(g)}</option>`).join('')}
                </select>
                
                <select class="filter-btn" onchange="App.updateFilter('domain', this.value)">
                    <option ${this.taskFilters.domain === 'All' ? 'selected' : ''}>All Domains</option>
                    ${domains.map(d => `<option ${this.taskFilters.domain === d ? 'selected' : ''}>${esc(d)}</option>`).join('')}
                </select>
                
                <select class="filter-btn" onchange="App.updateFilter('status', this.value)">
                    <option ${this.taskFilters.status === 'All' ? 'selected' : ''}>All</option>
                    <option ${this.taskFilters.status === 'Todo' ? 'selected' : ''}>Todo</option>
                    <option ${this.taskFilters.status === 'Done' ? 'selected' : ''}>Done</option>
                </select>
            </div>
        `;
    },

    updateFilter(type, value) {
        this.taskFilters[type] = value;
        this.render();
    },

    filterTasks(tasks) {
        if (!this.taskFilters) return tasks;
        
        return tasks.filter(task => {
            if (this.taskFilters.goal !== 'All' && this.taskFilters.goal !== 'All Goals') {
                if (task.goal !== this.taskFilters.goal) return false;
            }
            
            if (this.taskFilters.domain !== 'All' && this.taskFilters.domain !== 'All Domains') {
                if (task.domain !== this.taskFilters.domain) return false;
            }
            
            if (this.taskFilters.status === 'Todo' && task.done) return false;
            if (this.taskFilters.status === 'Done' && !task.done) return false;
            
            return true;
        });
    },

    renderDomainFocus() {
        if (!this.data.currentCycle) return '';
        
        const tasks = this.data.currentCycle.tasks || [];
        const goalsFocus = this.data.currentCycle.goals_focus || {};
        
        // Dynamic color palette for any number of domains
        const colorPalette = ['#30d158', '#ffd60a', '#bf5af2', '#0a84ff', '#ff453a', '#ff9f0a', '#64d2ff', '#ff375f'];
        
        // Initialize domain counts from goals_focus (planned domains)
        const domainCounts = {};
        Object.keys(goalsFocus).forEach(domain => {
            domainCounts[domain] = 0;
        });
        
        // Also include any domains from actual tasks (in case tasks have domains not in goals_focus)
        tasks.forEach(task => {
            if (task.domain && !domainCounts.hasOwnProperty(task.domain)) {
                domainCounts[task.domain] = 0;
            }
        });
        
        // Count tasks per domain
        tasks.forEach(task => {
            if (task.domain && domainCounts.hasOwnProperty(task.domain)) {
                domainCounts[task.domain]++;
            }
        });
        
        const total = Object.values(domainCounts).reduce((a, b) => a + b, 0);
        
        // If no tasks yet, show only planned percentages
        if (total === 0 && Object.keys(goalsFocus).length > 0) {
            return `
                <div style="margin:16px 0;padding:16px;background:var(--sub);border-radius:12px;border:1px solid var(--border);">
                    <h3 style="font-size:13px;font-weight:700;margin-bottom:12px;color:var(--accent);">Domain Focus % (Planned)</h3>
                    ${Object.entries(goalsFocus).map(([domain, planned], index) => {
                        const color = this.getDomainColor(domain);  // FIX: Use consistent color hash
                        return `
                            <div style="display:flex;justify-content:space-between;align-items:center;
                                 margin-bottom:10px;gap:12px;">
                                <div style="min-width:100px;font-size:13px;font-weight:600;">${esc(domain)}</div>
                                <div style="flex:1;height:10px;background:var(--void);border-radius:5px;
                                     overflow:hidden;border:1px solid var(--border);">
                                    <div style="width:${planned}%;height:100%;background:${color};
                                         border-radius:5px;opacity:0.5;"></div>
                                </div>
                                <div style="min-width:60px;text-align:right;font-weight:700;font-size:13px;
                                     color:${color};">
                                    ${planned}%
                                </div>
                            </div>
                        `;
                    }).join('')}
                    <div style="margin-top:12px;padding:8px;background:var(--void);border-radius:8px;font-size:11px;color:var(--dim);text-align:center;">
                        Add tasks to see actual distribution
                    </div>
                </div>
            `;
        }
        
        if (total === 0) return '';
        
        // Show actual percentages with planned comparison
        return `
            <div style="margin:16px 0;padding:16px;background:var(--sub);border-radius:12px;border:1px solid var(--border);">
                <h3 style="font-size:13px;font-weight:700;margin-bottom:12px;color:var(--accent);">Domain Focus %</h3>
                ${Object.entries(domainCounts).map(([domain, count]) => {
                    const actualPct = ((count / total) * 100).toFixed(0);
                    const plannedPct = goalsFocus[domain] || null;
                    const color = this.getDomainColor(domain);  // FIX: Use consistent color hash
                    
                    // Determine alignment status
                    let alignmentIcon = '';
                    let alignmentColor = 'var(--dim)';
                    if (plannedPct !== null) {
                        const diff = Math.abs(parseFloat(actualPct) - plannedPct);
                        if (diff <= 5) {
                            alignmentIcon = 'âœ“';
                            alignmentColor = '#30d158';
                        } else if (diff <= 15) {
                            alignmentIcon = 'âš ';
                            alignmentColor = '#ffd60a';
                        } else {
                            alignmentIcon = '!';
                            alignmentColor = '#ff453a';
                        }
                    }
                    
                    return `
                        <div style="display:flex;justify-content:space-between;align-items:center;
                             margin-bottom:12px;gap:12px;">
                            <div style="min-width:100px;">
                                <div style="font-size:13px;font-weight:600;">${esc(domain)}</div>
                                ${plannedPct !== null ? `<div style="font-size:10px;color:var(--dim);">Target: ${plannedPct}%</div>` : ''}
                            </div>
                            <div style="flex:1;height:14px;background:var(--void);border-radius:7px;
                                 overflow:hidden;border:1px solid var(--border);position:relative;">
                                ${plannedPct !== null ? `
                                    <div style="position:absolute;left:${plannedPct}%;top:0;bottom:0;width:2px;
                                         background:var(--dim);opacity:0.5;z-index:1;"></div>
                                ` : ''}
                                <div style="width:${actualPct}%;height:100%;background:${color};
                                     border-radius:7px;transition:width 0.3s;position:relative;z-index:2;"></div>
                            </div>
                            <div style="min-width:80px;text-align:right;display:flex;align-items:center;justify-content:flex-end;gap:6px;">
                                <span style="font-weight:700;font-size:13px;color:${color};">
                                    ${actualPct}%
                                </span>
                                ${alignmentIcon ? `<span style="font-size:14px;color:${alignmentColor};">${alignmentIcon}</span>` : ''}
                            </div>
                        </div>
                    `;
                }).join('')}
                ${Object.keys(goalsFocus).length > 0 ? `
                    <div style="margin-top:12px;padding:8px;background:var(--void);border-radius:8px;font-size:10px;color:var(--dim);display:flex;gap:12px;justify-content:center;">
                        <span>âœ“ On target (Â±5%)</span>
                        <span>âš  Close (Â±15%)</span>
                        <span>! Off target (>15%)</span>
                    </div>
                ` : ''}
            </div>
        `;
    },

    // USER MANUAL - Comprehensive guide to using SVK Blueprint
    // â”€â”€ PROFILE: Open the user profile edit modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    openEditProfile() {
        const p = this.data.userProfile || {};
        const AVATAR_OPTIONS = ['','ðŸ§ ','ðŸš€','âš¡','ðŸŽ¯','ðŸ¦','ðŸ‰','ðŸŒŠ','ðŸ”¥','ðŸ’Ž','ðŸŒ™','â­','ðŸ”','ðŸŒ¿','ðŸ¦…','ðŸŽ­','ðŸ’«','ðŸ›¡','ðŸŒ','âœ¨'];

        // FIX: Reset stale temp state every time modal opens
        this._selectedAvatarTemp = null;

        document.getElementById('modal-body').innerHTML = `
            <div style="max-height:80vh;overflow-y:auto;padding-bottom:4px;">

                <!-- HEADER -->
                <div style="text-align:center;padding:10px 0 18px;">
                    <div id="profile-preview-avatar" style="
                        width:72px;height:72px;border-radius:50%;
                        background:linear-gradient(135deg,var(--accent),#ff9f0a);
                        margin:0 auto 12px;display:flex;align-items:center;justify-content:center;
                        font-size:28px;font-weight:900;color:#000;
                        box-shadow:0 0 24px rgba(255,215,0,0.4);
                        font-family:monospace;letter-spacing:0;
                    ">${esc(p.avatar || this._getInitialsOrDefault(p.name))}</div>
                    <div style="font-size:17px;font-weight:700;color:var(--accent);">Your Profile</div>
                    <div style="font-size:12px;color:var(--dim);margin-top:2px;">Personalize your SVK Blueprint</div>
                </div>

                <!-- NAME -->
                <label style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--dim);display:block;margin-bottom:6px;">Your Name *</label>
                <input type="text" id="profile-name" placeholder="e.g. Sathvik, Alex, Mayaâ€¦"
                    value="${esc(p.name || '')}"
                    oninput="App._livePreviewAvatar()"
                    style="margin-bottom:16px;"
                    maxlength="40">

                <!-- TAGLINE -->
                <label style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--dim);display:block;margin-bottom:6px;">One-Line Identity <span style="font-weight:400;opacity:0.6;">(optional)</span></label>
                <input type="text" id="profile-tagline" placeholder="e.g. Builder Â· Father Â· Lifelong Learner"
                    value="${esc(p.tagline || '')}"
                    style="margin-bottom:16px;"
                    maxlength="80">

                <!-- AVATAR EMOJI -->
                <label style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--dim);display:block;margin-bottom:8px;">Avatar Emoji <span style="font-weight:400;opacity:0.6;">(or leave blank for initials)</span></label>
                <div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px;">
                    ${AVATAR_OPTIONS.map(em => `
                        <button onclick="App._selectAvatar('${em}')" id="avatar-opt-${em || 'none'}"
                            style="width:40px;height:40px;border-radius:10px;border:2px solid ${(p.avatar||'')===(em)?'var(--accent)':'var(--border)'};
                                   background:${(p.avatar||'')===(em)?'rgba(255,215,0,0.15)':'var(--sub)'};
                                   font-size:${em?'20px':'11px'};cursor:pointer;transition:all 0.15s;
                                   color:${em?'inherit':'var(--dim)'};font-family:monospace;font-weight:700;">
                            ${em || 'ABC'}
                        </button>`).join('')}
                </div>

                <!-- 15-YEAR VISION -->
                <label style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--dim);display:block;margin-bottom:6px;">Your 15-Year Vision *</label>
                <div style="font-size:11px;color:var(--dim);margin-bottom:8px;line-height:1.5;">
                    Write your definite chief aim â€” the life you are building. Be specific. Be ambitious. This will appear as your daily anchor on the Execute screen.
                </div>
                <textarea id="profile-vision" rows="5" placeholder="In 15 years, I will have builtâ€¦&#10;&#10;I will achieve this byâ€¦&#10;&#10;My legacy will beâ€¦"
                    style="margin-bottom:16px;resize:vertical;min-height:110px;font-size:14px;line-height:1.6;"
                    maxlength="2000">${esc(p.vision || '')}</textarea>

                <!-- SAVE -->
                <button class="btn" onclick="App.saveProfile()" style="margin-bottom:10px;">
                    âœ“ Save Profile
                </button>
                ${p.name ? `
                <button class="btn-sec" onclick="App.closeModal()" style="width:100%;padding:12px;font-size:13px;">
                    Cancel
                </button>` : ''}

                <!-- TIP -->
                <div style="margin-top:14px;background:rgba(255,215,0,0.05);border:1px solid rgba(255,215,0,0.15);border-radius:10px;padding:12px;font-size:11px;color:var(--dim);line-height:1.6;">
                    ðŸ’¡ <strong style="color:var(--accent);">Pro Tip:</strong> Your vision is your most important asset. Return here quarterly to refine it as you grow. It also auto-populates your Blueprint when you generate one.
                </div>
            </div>
        `;
        document.getElementById('modal').classList.add('open');
        setTimeout(() => document.getElementById('profile-name')?.focus(), 80);
    },

    // Live-preview initials in the profile modal avatar
    _livePreviewAvatar() {
        const nameVal = document.getElementById('profile-name')?.value || '';
        const avatarEl = document.getElementById('profile-preview-avatar');
        if (!avatarEl) return;
        // Only update if no emoji is selected
        const currentEmoji = this._selectedAvatarTemp;
        if (!currentEmoji) {
            const initials = this._getInitialsOrDefault(nameVal);
            avatarEl.textContent = initials;
            avatarEl.style.fontSize = initials.length > 2 ? '12px' : (initials.length === 1 ? '30px' : '20px');
        }
    },

    _selectedAvatarTemp: null,

    _selectAvatar(em) {
        this._selectedAvatarTemp = em;
        // Update button styles
        document.querySelectorAll('[id^="avatar-opt-"]').forEach(btn => {
            btn.style.borderColor = 'var(--border)';
            btn.style.background = 'var(--sub)';
        });
        const selected = document.getElementById(`avatar-opt-${em || 'none'}`);
        if (selected) {
            selected.style.borderColor = 'var(--accent)';
            selected.style.background = 'rgba(255,215,0,0.15)';
        }
        // Live preview
        const previewEl = document.getElementById('profile-preview-avatar');
        if (previewEl) {
            if (em) {
                previewEl.textContent = em;
                previewEl.style.fontSize = '28px';
            } else {
                const nameVal = document.getElementById('profile-name')?.value || '';
                const initials = this._getInitialsOrDefault(nameVal);
                previewEl.textContent = initials;
                previewEl.style.fontSize = initials.length > 2 ? '12px' : '22px';
            }
        }
    },

    _getInitialsOrDefault(name) {
        if (!name || !name.trim()) return 'SVK';
        return name.trim().split(/\s+/).map(w => w[0]).join('').toUpperCase().slice(0, 3);
    },

    saveProfile() {
        const name = document.getElementById('profile-name')?.value?.trim() || '';
        const tagline = document.getElementById('profile-tagline')?.value?.trim() || '';
        const vision = document.getElementById('profile-vision')?.value?.trim() || '';
        const avatar = this._selectedAvatarTemp !== null
            ? this._selectedAvatarTemp
            : (this.data.userProfile?.avatar || '');

        if (!name) {
            this.toast('âš ï¸ Please enter your name');
            document.getElementById('profile-name')?.focus();
            return;
        }
        if (!vision) {
            this.toast('âš ï¸ Please write your 15-year vision');
            document.getElementById('profile-vision')?.focus();
            return;
        }

        if (!this.data.userProfile) this.data.userProfile = {};

        // Capture old values before overwriting (used for blueprintMeta sync check)
        const oldName   = this.data.userProfile.name   || '';
        const oldVision = this.data.userProfile.vision || '';

        this.data.userProfile.name    = name;
        this.data.userProfile.tagline = tagline;
        this.data.userProfile.vision  = vision;
        this.data.userProfile.avatar  = avatar;

        // Sync blueprintMeta only if its name/vision still matches what the profile HAD
        // (i.e. they were seeded from the blueprint and haven't diverged independently)
        if (this.data.blueprintMeta) {
            if (!this.data.blueprintMeta.name || this.data.blueprintMeta.name === oldName) {
                this.data.blueprintMeta.name = name;
            }
            if (!this.data.blueprintMeta.vision || this.data.blueprintMeta.vision === oldVision) {
                this.data.blueprintMeta.vision = vision;
            }
        }

        // Reset temp avatar state
        this._selectedAvatarTemp = null;

        this.save();
        this.updateHeaderProfile();
        this.render();
        this.closeModal();
        this.toast(`âœ“ Profile saved â€” Welcome, ${name}!`);
    },

    // README â€” System overview, changelog, first-time setup guide
    openReadme() {
        const modalBody = document.getElementById('modal-body');
        modalBody.innerHTML = `
            <div style="max-height:72vh;overflow-y:auto;padding-bottom:8px;">
                <!-- HEADER -->
                <div style="text-align:center;padding:16px 0 20px;border-bottom:1px solid var(--border);margin-bottom:20px;">
                    <div style="font-family:monospace;font-size:36px;font-weight:900;color:var(--accent);letter-spacing:6px;text-shadow:0 0 24px rgba(255,215,0,0.4);">SVK</div>
                    <div style="font-size:12px;color:var(--dim);letter-spacing:3px;text-transform:uppercase;margin-top:2px;">Blueprint System</div>
                    <div style="display:inline-block;margin-top:10px;font-size:11px;font-family:monospace;font-weight:700;padding:4px 12px;background:var(--success);color:var(--void);border-radius:10px;">v2.3.0 Â· PRODUCTION</div>
                    <div style="font-size:11px;color:var(--dim);margin-top:8px;">February 25, 2026</div>
                </div>

                <!-- WHAT IS THIS -->
                <div style="background:rgba(255,215,0,0.06);border:1px solid rgba(255,215,0,0.25);border-radius:12px;padding:16px;margin-bottom:20px;">
                    <div style="font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:2px;color:var(--accent);margin-bottom:10px;">ðŸŽ¯ What Is This?</div>
                    <p style="font-size:13px;color:var(--dim);line-height:1.7;margin-bottom:10px;">
                        <strong style="color:var(--text);">SVK Blueprint</strong> is a zero-dependency, offline-capable personal execution system that bridges your 15-year vision with today's tasks.
                    </p>
                    <p style="font-size:13px;color:var(--dim);line-height:1.7;margin-bottom:10px;">
                        Built on a <strong style="color:var(--text);">90-day cycle methodology</strong> (60 cycles Ã— 13 weeks), the system pre-plans every task across your life domains â€” so you never decide <em>what</em> to work on. You only decide <em>when</em>.
                    </p>
                    <p style="font-size:13px;color:var(--dim);line-height:1.7;">
                        <strong style="color:var(--accent);">"The System Decides. You Execute."</strong>
                    </p>
                </div>

                <!-- CORE FEATURES -->
                <div style="margin-bottom:20px;">
                    <div style="font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:2px;color:var(--accent);margin-bottom:12px;padding-bottom:6px;border-bottom:1px solid var(--border);">âœ… Core Features</div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:12px;">
                        ${[
                          ['âš¡','Execute','Daily HQ + Pomodoro focus'],
                          ['ðŸŽ¯','Build','15-year goals + domain chart'],
                          ['ðŸ—ºï¸','Strategy','60-cycle roadmap view'],
                          ['âš™ï¸','System','Habits Â· Journal Â· Reflections'],
                          ['ðŸ“š','Vault LEARN','Notes Â· Quotes Â· Books Â· Ideas'],
                          ['ðŸ’°','Vault EARN','Strategy Â· Execute Â· Leverage Â· Contacts'],
                          ['ðŸ”','Universal Search','12+ data types, real-time'],
                          ['âš¡','Quick Capture','10 capture types, 1 tap'],
                          ['â±ï¸','Pomodoro + Zen Mode','Focus timer with intention'],
                          ['ðŸ“Š','CSV Export','8-sheet spreadsheet export'],
                          ['â†©ï¸','Undo / Redo','20-step history'],
                          ['ðŸ“±','PWA','Installable, offline-capable']
                        ].map(([icon,name,desc]) => `
                          <div style="background:var(--sub);border:1px solid var(--border);border-radius:8px;padding:8px 10px;">
                              <div style="font-weight:700;color:var(--text);margin-bottom:2px;">${icon} ${name}</div>
                              <div style="color:var(--dim);font-size:11px;">${desc}</div>
                          </div>`).join('')}
                    </div>
                </div>

                <!-- FIRST-TIME SETUP -->
                <div style="margin-bottom:20px;">
                    <div style="font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:2px;color:var(--accent);margin-bottom:12px;padding-bottom:6px;border-bottom:1px solid var(--border);">ðŸš€ First-Time Setup</div>
                    <div style="background:var(--card);border-radius:10px;padding:14px;margin-bottom:8px;border-left:3px solid var(--success);">
                        <div style="font-size:11px;font-weight:700;color:var(--success);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;">Option A â€” AI-Generated Blueprint (Recommended)</div>
                        <ol style="margin-left:16px;font-size:12px;color:var(--dim);line-height:2;">
                            <li>SYSTEM tab â†’ <strong style="color:var(--text);">Custom Blueprint</strong></li>
                            <li>Fill in all 12 fields (name, vision, domains, goalsâ€¦)</li>
                            <li>Tap <strong style="color:var(--text);">Generate AI Prompt</strong> â†’ copy the prompt</li>
                            <li>Paste into ChatGPT or Claude â†’ receive JSON output</li>
                            <li>Paste the JSON back â†’ tap <strong style="color:var(--text);">Import JSON</strong></li>
                            <li>STRATEGY â†’ <strong style="color:var(--text);">Activate First Cycle</strong></li>
                            <li>EXECUTE â†’ start your first task</li>
                        </ol>
                    </div>
                    <div style="background:var(--card);border-radius:10px;padding:14px;border-left:3px solid var(--blue);">
                        <div style="font-size:11px;font-weight:700;color:var(--blue);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;">Option B â€” Import Existing Blueprint</div>
                        <ol style="margin-left:16px;font-size:12px;color:var(--dim);line-height:2;">
                            <li>BUILD tab â†’ Stats â†’ <strong style="color:var(--text);">Import Blueprint</strong></li>
                            <li>Upload your <code style="background:var(--sub);padding:1px 5px;border-radius:4px;">.json</code> blueprint file</li>
                            <li>STRATEGY â†’ <strong style="color:var(--text);">Activate First Cycle</strong></li>
                        </ol>
                    </div>
                </div>

                <!-- TECHNICAL -->
                <div style="margin-bottom:20px;">
                    <div style="font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:2px;color:var(--accent);margin-bottom:12px;padding-bottom:6px;border-bottom:1px solid var(--border);">ðŸ”§ Technical</div>
                    <div style="background:var(--sub);border-radius:10px;padding:14px;font-size:12px;color:var(--dim);line-height:1.9;">
                        <div>ðŸ“¦ <strong style="color:var(--text);">Zero dependencies</strong> â€” pure HTML/CSS/JS, no frameworks</div>
                        <div>ðŸ’¾ <strong style="color:var(--text);">LocalStorage persistence</strong> â€” data never leaves your device</div>
                        <div>ðŸ“± <strong style="color:var(--text);">PWA</strong> â€” Add to Home Screen for offline use (no app store needed)</div>
                        <div>ðŸ”’ <strong style="color:var(--text);">XSS-safe</strong> â€” all user input HTML-escaped</div>
                        <div>âœ… <strong style="color:var(--text);">Tested on</strong> Chrome 90+, Safari 14+, Firefox 88+</div>
                        <div>ðŸ“¤ <strong style="color:var(--text);">Backup</strong> â€” Export JSON weekly from BUILD â†’ Stats</div>
                    </div>
                </div>

                <!-- CHANGELOG -->
                <div style="margin-bottom:20px;">
                    <div style="font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:2px;color:var(--accent);margin-bottom:12px;padding-bottom:6px;border-bottom:1px solid var(--border);">ðŸ“‹ Changelog</div>

                    <div style="border-left:2px solid var(--accent);padding-left:14px;margin-bottom:16px;">
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                            <span style="font-family:monospace;font-weight:700;font-size:12px;color:var(--accent);">v2.3.0</span>
                            <span style="font-size:10px;background:var(--success);color:var(--void);padding:2px 8px;border-radius:8px;font-weight:700;">LATEST</span>
                            <span style="font-size:11px;color:var(--dim);">Feb 25, 2026</span>
                        </div>
                        <div style="font-size:12px;color:var(--dim);line-height:1.8;">
                            <div>ðŸ”— <strong style="color:var(--text);">5 live EARN integrations</strong> wired across all tabs</div>
                            <div>ðŸ“Š Strategy items â†’ STRATEGY tab Operating Rules panel</div>
                            <div>âœ… Execute Fulfill â†’ auto-complete matching cycle task</div>
                            <div>ðŸ‘¤ Contacts â†’ auto-create Delegated Tasks on due date</div>
                            <div>ðŸŽ¯ Leverage â†’ surfaces in BUILD goal expansion</div>
                            <div>ðŸ§  Domain-aware Intelligence Brief with dominant domain pill</div>
                            <div>ðŸ› Fixed: double semicolons, --text-secondary â†’ --dim, activeDomain logic</div>
                        </div>
                    </div>

                    <div style="border-left:2px solid var(--border);padding-left:14px;margin-bottom:16px;">
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                            <span style="font-family:monospace;font-weight:700;font-size:12px;color:var(--dim);">v2.2.2</span>
                            <span style="font-size:11px;color:var(--dim);">Feb 14, 2026</span>
                        </div>
                        <div style="font-size:12px;color:var(--dim);line-height:1.8;">
                            <div>ðŸ”„ Daily Reset for habits + micro-steps</div>
                            <div>ðŸ“Š CSV Export (8 sheets â€” Excel/Google Sheets compatible)</div>
                            <div>ðŸ›¡ï¸ Production error boundaries + data integrity validation</div>
                            <div>ðŸ› Removed duplicate export buttons</div>
                        </div>
                    </div>

                    <div style="border-left:2px solid var(--border);padding-left:14px;margin-bottom:16px;">
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                            <span style="font-family:monospace;font-weight:700;font-size:12px;color:var(--dim);">v2.2.0</span>
                            <span style="font-size:11px;color:var(--dim);">Feb 10, 2026</span>
                        </div>
                        <div style="font-size:12px;color:var(--dim);line-height:1.8;">
                            <div>ðŸ† World-class Vault with card-based layout + animations</div>
                            <div>ðŸ“Š Comprehensive vault analytics dashboard</div>
                            <div>ðŸ” Real-time search + tag filtering in Vault</div>
                            <div>â­ Importance levels, source attribution, starred items</div>
                            <div>ðŸ” LEARN â†’ EARN promotion workflow</div>
                        </div>
                    </div>

                    <div style="border-left:2px solid var(--border);padding-left:14px;">
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                            <span style="font-family:monospace;font-weight:700;font-size:12px;color:var(--dim);">v2.1.x</span>
                            <span style="font-size:11px;color:var(--dim);">Jan 2026</span>
                        </div>
                        <div style="font-size:12px;color:var(--dim);line-height:1.8;">
                            <div>âš™ï¸ System tab overhaul + intelligent task assignment</div>
                            <div>ðŸ”§ Critical domain fixes + blueprint validation</div>
                            <div>ðŸ” Universal Search across 15+ data types</div>
                            <div>âš¡ 10-type Quick Capture system</div>
                        </div>
                    </div>
                </div>

                <!-- FOOTER -->
                <div style="background:rgba(255,215,0,0.06);border:1px solid rgba(255,215,0,0.2);border-radius:10px;padding:14px;text-align:center;">
                    <div style="font-size:13px;font-weight:700;color:var(--accent);margin-bottom:4px;">Tap USER FLOW for step-by-step usage guide</div>
                    <div style="font-size:11px;color:var(--dim);">SVK Blueprint v2.3.0 Â· Pure JavaScript Â· Offline-First Â· Zero Dependencies</div>
                </div>
            </div>
        `;
        document.getElementById('modal').classList.add('open');
    },

    openUserManual() {
        const modalBody = document.getElementById('modal-body');
        modalBody.innerHTML = `
            <div style="max-height:70vh;overflow-y:auto;padding-bottom:8px;">
                <div style="display:flex;align-items:center;gap:10px;margin-bottom:4px;">
                    <h2 style="color:var(--accent);font-size:22px;">ðŸ“– SVK Blueprint</h2>
                    <span style="font-size:11px;color:var(--dim);padding:3px 8px;background:var(--sub);border-radius:8px;font-family:monospace;">v2.3.0</span>
                </div>
                <p style="color:var(--dim);font-size:12px;margin-bottom:20px;font-style:italic;">The System Decides. You Execute.</p>

                <!-- PURPOSE -->
                <div style="background:rgba(255,215,0,0.06);border:1px solid rgba(255,215,0,0.2);border-radius:10px;padding:16px;margin-bottom:20px;">
                    <h3 style="color:var(--accent);margin-bottom:8px;font-size:14px;text-transform:uppercase;letter-spacing:1px;">ðŸŽ¯ What This Is</h3>
                    <p style="line-height:1.6;color:var(--dim);font-size:13px;">
                        SVK Blueprint converts your 15-year vision into executable 90-day cycles. Each cycle contains 13 weeks of pre-planned tasks across your life domains. You never decide what to work on â€” the system already decided. You execute.
                    </p>
                </div>

                <!-- HEADER BAR -->
                <h3 style="color:var(--accent);font-size:15px;margin-bottom:10px;border-bottom:1px solid var(--border);padding-bottom:6px;">ðŸ” Top Bar â€” Every Element Explained</h3>

                <div style="background:var(--card);border-radius:10px;padding:14px;margin-bottom:8px;border-left:3px solid var(--accent);">
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
                        <span style="font-family:monospace;font-weight:900;font-size:18px;color:var(--accent);">SVK</span>
                        <span style="font-size:12px;color:var(--dim);">â€” Logo</span>
                    </div>
                    <p style="font-size:12px;color:var(--dim);line-height:1.5;">Your identity anchor. Decorative â€” a reminder this system belongs to you.</p>
                </div>

                <div style="background:var(--card);border-radius:10px;padding:14px;margin-bottom:8px;border-left:3px solid var(--blue);">
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
                        <span style="font-size:16px;">â“˜</span>
                        <span style="font-size:13px;font-weight:600;">Info / Manual</span>
                    </div>
                    <p style="font-size:12px;color:var(--dim);line-height:1.5;">Opens this manual. Always accessible from any tab.</p>
                </div>

                <div style="background:var(--card);border-radius:10px;padding:14px;margin-bottom:8px;border-left:3px solid var(--blue);">
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
                        <span style="font-size:16px;">ðŸ”</span>
                        <span style="font-size:13px;font-weight:600;">Universal Search</span>
                    </div>
                    <p style="font-size:12px;color:var(--dim);line-height:1.5;">Real-time search across all data: tasks, goals, habits, notes, quotes, ideas, journal entries, reflections, timeblocks, affirmations, books, contacts, and EARN items. Tap any result to jump directly to it.</p>
                </div>

                <div style="background:var(--card);border-radius:10px;padding:14px;margin-bottom:8px;border-left:3px solid var(--success);">
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
                        <span style="font-family:monospace;font-weight:700;font-size:12px;background:var(--success);color:var(--void);padding:4px 10px;border-radius:8px;">25:00</span>
                        <span style="font-size:13px;font-weight:600;">Timer badge</span>
                        <span style="font-size:11px;color:var(--dim);">(hidden until active)</span>
                    </div>
                    <p style="font-size:12px;color:var(--dim);line-height:1.5;">Appears in green when a Pomodoro session is running. Shows live countdown. Tap anytime to open full timer controls â€” pause, stop, or see your current focus intention. Pulses to confirm a session is active.</p>
                    <div style="font-size:11px;color:var(--accent);margin-top:6px;">ðŸ’¡ Start a session: EXECUTE tab â†’ tap any task â†’ Start Focus</div>
                </div>

                <div style="background:var(--card);border-radius:10px;padding:14px;margin-bottom:20px;border-left:3px solid var(--accent);">
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
                        <span style="font-family:monospace;font-weight:700;font-size:11px;background:var(--sub);color:var(--accent);padding:5px 10px;border-radius:10px;border:1px solid var(--border);">C4 Â· W07</span>
                        <span style="font-size:13px;font-weight:600;">Cycle badge</span>
                    </div>
                    <p style="font-size:12px;color:var(--dim);line-height:1.5;">Shows your active cycle number and current week â€” e.g. C4 = Cycle 4 of 60, W07 = Week 7 of 13 in that cycle. Tap to jump to STRATEGY tab. Shows "NO CYCLE" until you activate your first cycle.</p>
                    <div style="font-size:11px;color:var(--accent);margin-top:6px;">ðŸ’¡ Tap every Monday to review the week's tasks.</div>
                </div>

                <!-- THE 5 TABS -->
                <h3 style="color:var(--accent);font-size:15px;margin-bottom:10px;border-bottom:1px solid var(--border);padding-bottom:6px;">ðŸ“± The 5 Tabs</h3>

                <div style="background:var(--card);border-radius:10px;padding:14px;margin-bottom:8px;">
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
                        <span style="font-size:18px;">âš¡</span><div style="font-weight:700;font-size:14px;">EXECUTE â€” Daily HQ</div>
                    </div>
                    <p style="font-size:12px;color:var(--dim);line-height:1.5;margin-bottom:6px;">Quick Tasks (3 max), this week's Vision Plan Tasks, Scheduled Tasks, Delegated Tasks (auto-populated from Contacts), Time Blocks, and the Intelligence Brief â€” which surfaces your active Strategy rule, a Leverage spotlight, overdue Contacts, and your last logged win.</p>
                    <div style="font-size:11px;color:var(--accent);">ðŸ’¡ Open here every morning. Quick Tasks first, always.</div>
                </div>

                <div style="background:var(--card);border-radius:10px;padding:14px;margin-bottom:8px;">
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
                        <span style="font-size:18px;">ðŸŽ¯</span><div style="font-weight:700;font-size:14px;">BUILD â€” Goals & Identity</div>
                    </div>
                    <p style="font-size:12px;color:var(--dim);line-height:1.5;margin-bottom:6px;">Long-term goals with subgoals and stages. Domain focus chart (planned vs. actual %). Affirmations, bucket list, stats, data export. Expanding a goal now shows linked Leverage items from EARN Vault.</p>
                    <div style="font-size:11px;color:var(--accent);">ðŸ’¡ Weekly review: check domain alignment and leverage panel per goal.</div>
                </div>

                <div style="background:var(--card);border-radius:10px;padding:14px;margin-bottom:8px;">
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
                        <span style="font-size:18px;">ðŸ—ºï¸</span><div style="font-weight:700;font-size:14px;">STRATEGY â€” 15-Year Roadmap</div>
                    </div>
                    <p style="font-size:12px;color:var(--dim);line-height:1.5;margin-bottom:6px;">60-cycle overview, current cycle week navigator (1â€“13), cycle activation. Now also shows the Operating Rules panel â€” EARN Strategy items filtered by your cycle's dominant focus domain â€” directly above the week's tasks.</p>
                    <div style="font-size:11px;color:var(--accent);">ðŸ’¡ Pin a strategy rule here to lock it as today's focus anchor.</div>
                </div>

                <div style="background:var(--card);border-radius:10px;padding:14px;margin-bottom:8px;">
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
                        <span style="font-size:18px;">âš™ï¸</span><div style="font-weight:700;font-size:14px;">SYSTEM â€” Daily Practice</div>
                    </div>
                    <p style="font-size:12px;color:var(--dim);line-height:1.5;margin-bottom:6px;">Habits with heatmaps and Zen Mode timer. Morning/evening reflections. Journal. Weekly reviews. Custom Blueprint Generator (12-field AI-assisted form to build your 60-cycle roadmap).</p>
                    <div style="font-size:11px;color:var(--accent);">ðŸ’¡ Morning reflection before Execute. Evening journal after.</div>
                </div>

                <div style="background:var(--card);border-radius:10px;padding:14px;margin-bottom:20px;">
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
                        <span style="font-size:18px;">ðŸ“š</span><div style="font-weight:700;font-size:14px;">VAULT â€” Knowledge & Resources</div>
                    </div>
                    <p style="font-size:12px;color:var(--dim);line-height:1.5;margin-bottom:6px;"><strong style="color:var(--text);">LEARN:</strong> Notes, Quotes, Books, Ideas â€” knowledge you collect. <strong style="color:var(--text);">EARN:</strong> Strategy, Execute, Leverage, Contacts â€” resources you deploy. All 4 EARN buckets are now live-wired into Execute, Strategy, Build, and the Intelligence Brief.</p>
                    <div style="font-size:11px;color:var(--accent);">ðŸ’¡ EARN is your strategic layer. Use it actively, not just as storage.</div>
                </div>

                <!-- EARN INTEGRATIONS -->
                <h3 style="color:var(--accent);font-size:15px;margin-bottom:10px;border-bottom:1px solid var(--border);padding-bottom:6px;">ðŸ”— EARN Vault Live Integrations (v2.3.0)</h3>

                <div style="background:linear-gradient(135deg,#1a1a00,#1c1c1e);border:1px solid rgba(255,215,0,0.25);border-radius:10px;padding:14px;margin-bottom:8px;">
                    <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--accent);margin-bottom:6px;">ðŸ“Š Strategy â†’ STRATEGY tab</div>
                    <p style="font-size:12px;color:var(--dim);line-height:1.5;">Appears as Operating Rules panel above cycle tasks. Items matching your cycle's dominant domain appear first. Pin any item to make it today's rule. Also surfaces in the Intelligence Brief on Execute.</p>
                </div>

                <div style="background:var(--sub);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:8px;">
                    <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--accent);margin-bottom:6px;">âš™ï¸ Execute Log â†’ Cycle Tasks</div>
                    <p style="font-size:12px;color:var(--dim);line-height:1.5;">Hitting "Fulfill" on an Execute item auto-completes any matching cycle task in your blueprint (matched by title or linkedGoal). One action closes both. Last win appears in the Intelligence Brief.</p>
                </div>

                <div style="background:var(--sub);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:8px;">
                    <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--accent);margin-bottom:6px;">ðŸ”— Leverage â†’ BUILD Goals</div>
                    <p style="font-size:12px;color:var(--dim);line-height:1.5;">Expanding any goal in BUILD â†’ Goals shows linked Leverage items (matched by linkedGoal or domain). Up to 3 shown inline, remainder linked. Top item also in the domain-aware Intelligence Brief.</p>
                </div>

                <div style="background:var(--sub);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:20px;">
                    <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--accent);margin-bottom:6px;">ðŸ‘¤ Contacts â†’ EXECUTE Delegated Tasks</div>
                    <p style="font-size:12px;color:var(--dim);line-height:1.5;">Any contact whose follow-up date is today or past automatically creates a Delegated Task on the Execute screen. No manual action needed. Marking it done bumps follow-up +7 days and removes the task. Overdue contacts appear in the Intelligence Brief.</p>
                </div>

                <!-- QUICK CAPTURE -->
                <h3 style="color:var(--accent);font-size:15px;margin-bottom:10px;border-bottom:1px solid var(--border);padding-bottom:6px;">âš¡ Quick Capture (+ button)</h3>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:12px;margin-bottom:20px;">
                    <div style="background:var(--sub);padding:8px 10px;border-radius:6px;">ðŸ’¡ <strong>Idea</strong> â†’ Vault Ideas</div>
                    <div style="background:var(--sub);padding:8px 10px;border-radius:6px;">âš¡ <strong>Quick Task</strong> â†’ Execute (max 3)</div>
                    <div style="background:var(--sub);padding:8px 10px;border-radius:6px;">ðŸ“ <strong>Note</strong> â†’ Vault Notes</div>
                    <div style="background:var(--sub);padding:8px 10px;border-radius:6px;">âœ“ <strong>Cycle Task</strong> â†’ Current cycle week</div>
                    <div style="background:var(--sub);padding:8px 10px;border-radius:6px;">ðŸ’¬ <strong>Quote</strong> â†’ Vault Quotes</div>
                    <div style="background:var(--sub);padding:8px 10px;border-radius:6px;">ðŸ“… <strong>Timeblock</strong> â†’ Execute schedule</div>
                    <div style="background:var(--sub);padding:8px 10px;border-radius:6px;">ðŸ”„ <strong>Habit</strong> â†’ System Habits</div>
                    <div style="background:var(--sub);padding:8px 10px;border-radius:6px;">ðŸ“” <strong>Journal</strong> â†’ System Journal</div>
                    <div style="background:var(--sub);padding:8px 10px;border-radius:6px;">ðŸŽ¯ <strong>Goal</strong> â†’ Build Goals</div>
                    <div style="background:var(--sub);padding:8px 10px;border-radius:6px;">âœ¨ <strong>Affirmation</strong> â†’ Build Affirmations</div>
                </div>

                <!-- WORKFLOWS -->
                <h3 style="color:var(--accent);font-size:15px;margin-bottom:10px;border-bottom:1px solid var(--border);padding-bottom:6px;">ðŸ“… Workflows</h3>

                <div style="background:var(--card);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:8px;">
                    <div style="font-weight:600;margin-bottom:8px;color:var(--accent);font-size:11px;text-transform:uppercase;letter-spacing:1px;">Daily (5 min)</div>
                    <ol style="margin-left:18px;font-size:12px;color:var(--dim);line-height:1.8;">
                        <li>SYSTEM â†’ Morning Reflection</li>
                        <li>EXECUTE â†’ check Intelligence Brief (today's strategy rule)</li>
                        <li>EXECUTE â†’ review Delegated Tasks (auto-synced from Contacts)</li>
                        <li>Pick one Vision Task â†’ Start Focus (Pomodoro)</li>
                        <li>Capture anything with + button as it arises</li>
                    </ol>
                </div>

                <div style="background:var(--card);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:8px;">
                    <div style="font-weight:600;margin-bottom:8px;color:var(--accent);font-size:11px;text-transform:uppercase;letter-spacing:1px;">Weekly (15 min)</div>
                    <ol style="margin-left:18px;font-size:12px;color:var(--dim);line-height:1.8;">
                        <li>STRATEGY â†’ review Operating Rules panel</li>
                        <li>STRATEGY â†’ navigate weeks, close straggler tasks</li>
                        <li>BUILD â†’ Goals â†’ expand each, review Leverage panel</li>
                        <li>VAULT â†’ EARN â†’ add new rules or opportunities from the week</li>
                        <li>SYSTEM â†’ Weekly Review</li>
                        <li>BUILD â†’ Stats â†’ Export JSON backup</li>
                    </ol>
                </div>

                <div style="background:var(--card);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:20px;">
                    <div style="font-weight:600;margin-bottom:8px;color:var(--accent);font-size:11px;text-transform:uppercase;letter-spacing:1px;">Cycle Transition (every 90 days)</div>
                    <ol style="margin-left:18px;font-size:12px;color:var(--dim);line-height:1.8;">
                        <li>STRATEGY â†’ complete week 13, review cycle</li>
                        <li>STRATEGY â†’ Activate Next Cycle</li>
                        <li>VAULT â†’ EARN â†’ update Strategy rules for new dominant domain</li>
                        <li>BUILD â†’ Goals â†’ align goals with next cycle's objectives</li>
                    </ol>
                </div>

                <!-- TIPS -->
                <h3 style="color:var(--accent);font-size:15px;margin-bottom:10px;border-bottom:1px solid var(--border);padding-bottom:6px;">ðŸ’¡ Power Tips</h3>
                <div style="font-size:12px;color:var(--dim);line-height:2;">
                    <div>ðŸŽ¯ <strong>Max 3 Quick Tasks</strong> â€” forced prioritization, zero decision fatigue</div>
                    <div>ðŸ“Œ <strong>Pin a Strategy rule</strong> â€” locks it as today's Operating Rule on Execute + Strategy tabs</div>
                    <div>ðŸ”— <strong>Link EARN items to domains/goals</strong> â€” activates domain-aware Intelligence Brief</div>
                    <div>ðŸ‘¤ <strong>Set follow-up dates on Contacts</strong> â€” auto-creates Delegated Tasks on Execute</div>
                    <div>âš¡ <strong>Fulfill on Execute items</strong> â€” auto-closes linked cycle tasks simultaneously</div>
                    <div>ðŸ“Š <strong>Export weekly</strong> â€” BUILD â†’ Stats â†’ Export Blueprint (JSON backup)</div>
                    <div>ðŸ” <strong>Universal Search</strong> â€” faster than browsing tabs</div>
                    <div>âŒ¨ï¸ <strong>ESC</strong> closes any modal, <strong>Ctrl+Z</strong> undoes last action</div>
                    <div>ðŸ“± <strong>Install as PWA</strong> â€” Add to Home Screen for offline access</div>
                </div>

                <div style="background:rgba(255,215,0,0.06);border:1px solid rgba(255,215,0,0.2);border-radius:10px;padding:16px;text-align:center;margin-top:20px;">
                    <div style="font-size:16px;font-weight:700;color:var(--accent);margin-bottom:4px;">The System Decides. You Execute.</div>
                    <div style="font-size:12px;color:var(--dim);">Frictionless execution leads to inevitable success.</div>
                </div>
            </div>
        `;
        document.getElementById('modal').classList.add('open');
    },

    // UNIVERSAL SEARCH - Searches across all 15 data types including the 10 essential capture types
    // Accessible via header search button, provides real-time results
    // Coverage: Tasks, Quick Tasks, Goals, Timeblocks, Habits, Notes, Quotes, Ideas, Journal, 
    //           Reflections, Goal Stages, Affirmations, Books, Contacts, and more
    openUniversalSearch() {
        document.getElementById('modal-body').innerHTML = `
            <h3 style="margin-bottom:16px;color:var(--accent);">ðŸ” Universal Search</h3>
            <input type="text" id="universal-search-input" placeholder="Search across all data..." 
                   style="margin-bottom:16px;" oninput="App.performUniversalSearch(this.value)">
            <div id="universal-search-results" style="max-height:400px;overflow-y:auto;"></div>`;
        document.getElementById('modal').classList.add('open');
        setTimeout(() => document.getElementById('universal-search-input')?.focus(), 80);
    },

    // Performs real-time search across all data with minimum 2 character requirement
    // Results include smart navigation to source location and HTML-escaped output for security
    performUniversalSearch(query) {
        const resultsDiv = document.getElementById('universal-search-results');
        
        if (!query || query.trim().length < 2) {
            resultsDiv.innerHTML = `<div style="text-align:center;padding:40px;color:var(--dim);font-size:13px;">
                Type at least 2 characters to search
            </div>`;
            return;
        }
        
        const q = query.toLowerCase().trim();
        const results = [];
        
        // Search Tasks
        if (this.data.currentCycle?.tasks) {
            this.data.currentCycle.tasks.forEach(task => {
                if (task.title.toLowerCase().includes(q)) {
                    results.push({
                        type: 'Task',
                        icon: 'âœ“',
                        title: task.title,
                        meta: `Week ${task.week}${task.done ? ' â€¢ Done' : ''}`,
                        action: () => { this.closeModal(); this.navigate(2); }
                    });
                }
            });
        }
        
        // Search Quick Tasks
        if (this.data.tasks?.quick) {
            this.data.tasks.quick.forEach(task => {
                if (task.title.toLowerCase().includes(q)) {
                    results.push({
                        type: 'Quick Task',
                        icon: 'âš¡',
                        title: task.title,
                        meta: task.done ? 'Done' : 'Pending',
                        action: () => { this.closeModal(); this.navigate(0); }
                    });
                }
            });
        }
        
        // Search Goals
        if (this.data.goals) {
            this.data.goals.forEach(goal => {
                if (goal.title.toLowerCase().includes(q)) {
                    results.push({
                        type: 'Goal',
                        icon: 'ðŸŽ¯',
                        title: goal.title,
                        meta: goal.domain || '',
                        action: () => { this.closeModal(); this.sub.build = 'goals'; this.navigate(1); }
                    });
                }
            });
        }
        
        // Search Habits
        if (this.data.system?.habits) {
            this.data.system.habits.forEach(habit => {
                if (habit.title.toLowerCase().includes(q)) {
                    results.push({
                        type: 'Habit',
                        icon: 'ðŸ“‹',
                        title: habit.title,
                        meta: habit.timeBlock || '',
                        action: () => { this.closeModal(); this.sub.system = 'habits'; this.navigate(3); }
                    });
                }
            });
        }
        
        // Search Notes
        if (this.data.vault?.learnings?.notes) {
            this.data.vault.learnings.notes.forEach(note => {
                if (note.title.toLowerCase().includes(q) || note.content.toLowerCase().includes(q)) {
                    results.push({
                        type: 'Note',
                        icon: 'ðŸ“',
                        title: note.title,
                        meta: new Date(note.date).toLocaleDateString(),
                        action: () => { this.closeModal(); this.sub.vault = 'learnings'; this.sub._vaultL = 'notes'; this.navigate(4); }
                    });
                }
            });
        }
        
        // Search Quotes
        if (this.data.vault?.learnings?.quotes) {
            this.data.vault.learnings.quotes.forEach(quote => {
                if (quote.text.toLowerCase().includes(q) || (quote.author && quote.author.toLowerCase().includes(q))) {
                    results.push({
                        type: 'Quote',
                        icon: 'ðŸ’¬',
                        title: quote.text.substring(0, 60) + (quote.text.length > 60 ? '...' : ''),
                        meta: quote.author || '',
                        action: () => { this.closeModal(); this.sub.vault = 'learnings'; this.sub._vaultL = 'quotes'; this.navigate(4); }
                    });
                }
            });
        }
        
        // Search Book Summaries
        if (this.data.vault?.learnings?.bookSummaries) {
            this.data.vault.learnings.bookSummaries.forEach(book => {
                if (book.title.toLowerCase().includes(q) || (book.author && book.author.toLowerCase().includes(q)) || book.summary.toLowerCase().includes(q)) {
                    results.push({
                        type: 'Book Summary',
                        icon: 'ðŸ“–',
                        title: book.title,
                        meta: book.author || '',
                        action: () => { this.closeModal(); this.sub.vault = 'learnings'; this.sub._vaultL = 'books'; this.navigate(4); }
                    });
                }
            });
        }
        
        // Search Ideas
        if (this.data.vault?.resources?.ideas) {
            this.data.vault.resources.ideas.forEach(idea => {
                if (idea.title.toLowerCase().includes(q) || idea.description.toLowerCase().includes(q)) {
                    results.push({
                        type: 'Idea',
                        icon: 'ðŸ’¡',
                        title: idea.title,
                        meta: new Date(idea.date).toLocaleDateString(),
                        action: () => { this.closeModal(); this.sub.vault = 'resources'; this.sub._vaultR = 'ideas'; this.navigate(4); }
                    });
                }
            });
        }
        
        // Search Contacts
        if (this.data.vault?.resources?.contacts) {
            this.data.vault.resources.contacts.forEach(contact => {
                if (contact.name.toLowerCase().includes(q) || (contact.role && contact.role.toLowerCase().includes(q))) {
                    results.push({
                        type: 'Contact',
                        icon: 'ðŸ‘¤',
                        title: contact.name,
                        meta: contact.role || '',
                        action: () => { this.closeModal(); this.sub.vault = 'resources'; this.sub._vaultR = 'contacts'; this.navigate(4); }
                    });
                }
            });
        }
        
        // Search Journal
        if (this.data.system?.journal) {
            this.data.system.journal.forEach(entry => {
                if (entry.text.toLowerCase().includes(q)) {
                    results.push({
                        type: 'Journal',
                        icon: 'âœï¸',
                        title: entry.text.substring(0, 60) + (entry.text.length > 60 ? '...' : ''),
                        meta: new Date(entry.date).toLocaleDateString(),
                        action: () => { this.closeModal(); this.sub.system = 'journal'; this.navigate(3); }
                    });
                }
            });
        }
        
        // Search Reflections
        if (this.data.system?.reflections) {
            ['morning', 'evening'].forEach(type => {
                if (this.data.system.reflections[type]) {
                    this.data.system.reflections[type].forEach(ref => {
                        if (ref.text.toLowerCase().includes(q)) {
                            results.push({
                                type: type === 'morning' ? 'Morning Reflection' : 'Evening Reflection',
                                icon: type === 'morning' ? 'ðŸŒ…' : 'ðŸŒ™',
                                title: ref.text.substring(0, 60) + (ref.text.length > 60 ? '...' : ''),
                                meta: new Date(ref.date).toLocaleDateString(),
                                action: () => { this.closeModal(); this.sub.system = 'reflections'; this.sub._refType = type; this.navigate(3); }
                            });
                        }
                    });
                }
            });
        }
        
        // Search Timeblocks
        if (this.data.timeblocks) {
            this.data.timeblocks.forEach(tb => {
                if (tb.title.toLowerCase().includes(q) || (tb.notes && tb.notes.toLowerCase().includes(q))) {
                    results.push({
                        type: 'Timeblock',
                        icon: 'ðŸ“…',
                        title: tb.title,
                        meta: `${new Date(tb.date).toLocaleDateString()}${tb.time ? ' â€¢ ' + tb.time : ''}${tb.completed ? ' â€¢ Done' : ''}`,
                        action: () => { this.closeModal(); this.viewTimeblocks(); }
                    });
                }
            });
        }
        
        // Search Goal Stages
        if (this.data.goals) {
            this.data.goals.forEach(goal => {
                if (goal.stages && goal.stages.length > 0) {
                    goal.stages.forEach(stage => {
                        if (stage.title.toLowerCase().includes(q) || (stage.description && stage.description.toLowerCase().includes(q))) {
                            results.push({
                                type: 'Goal Stage',
                                icon: 'ðŸŽ¯',
                                title: `${esc(goal.title)}: ${stage.title}`,
                                meta: `${stage.target ? new Date(stage.target).toLocaleDateString() : ''}${stage.completed ? ' â€¢ Done' : ''}`,
                                action: () => { 
                                    this.closeModal(); 
                                    goal.expanded = true;
                                    this.sub.build = 'goals'; 
                                    this.navigate(1); 
                                }
                            });
                        }
                    });
                }
            });
        }
        
        // Search Affirmations
        if (this.data.plan?.affirmations) {
            this.data.plan.affirmations.forEach(aff => {
                if (aff.text.toLowerCase().includes(q)) {
                    results.push({
                        type: 'Affirmation',
                        icon: 'âœ¨',
                        title: aff.text,
                        meta: new Date(aff.date).toLocaleDateString(),
                        action: () => { this.closeModal(); this.sub.build = 'affirmations'; this.navigate(1); }
                    });
                }
            });
        }
        
        // Display results
        if (results.length === 0) {
            resultsDiv.innerHTML = `<div style="text-align:center;padding:40px;color:var(--dim);font-size:13px;">
                No results found for "${esc(query)}"
            </div>`;
        } else {
            resultsDiv.innerHTML = `
                <div style="font-size:11px;color:var(--dim);margin-bottom:12px;text-transform:uppercase;letter-spacing:1px;">
                    ${results.length} result${results.length !== 1 ? 's' : ''} found
                </div>
                ${results.map(r => `
                    <div class="card" onclick="(${r.action.toString()})()" style="cursor:pointer;margin-bottom:8px;padding:12px;">
                        <div style="display:flex;gap:12px;align-items:start;">
                            <div style="font-size:20px;">${r.icon}</div>
                            <div style="flex:1;min-width:0;">
                                <div style="font-size:10px;color:var(--accent);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px;">
                                    ${r.type}
                                </div>
                                <div style="font-weight:600;font-size:14px;margin-bottom:2px;word-break:break-word;">
                                    ${esc(r.title)}
                                </div>
                                ${r.meta ? `<div style="font-size:11px;color:var(--dim);">${esc(r.meta)}</div>` : ''}
                            </div>
                        </div>
                    </div>
                `).join('')}
            `;
        }
    },

    addQuickTask() {
        if (!this.data.tasks) this.data.tasks = {};
        if (!this.data.tasks.quick) this.data.tasks.quick = [];
        
        const pending = this.data.tasks.quick.filter(t => !t.done);
        if (pending.length >= 3) {
            this.toast('âš ï¸ Max 3 quick tasks');
            return;
        }
        
        document.getElementById('modal-body').innerHTML = `
            <h3 style="margin-bottom:12px;color:var(--accent);">âš¡ Quick Task</h3>
            <input id="qt-title" placeholder="Task title..." style="margin-bottom:12px;">
            <button class="btn" onclick="App.saveQuickTask()">Add Task</button>`;
        document.getElementById('modal').classList.add('open');
        setTimeout(() => document.getElementById('qt-title')?.focus(), 80);
    },

    saveQuickTask() {
        const title = document.getElementById('qt-title')?.value?.trim();
        if (!title) { this.toast('âš ï¸ Enter title'); return; }
        
        if (!this.data.tasks) this.data.tasks = {};
        if (!this.data.tasks.quick) this.data.tasks.quick = [];
        
        this.data.tasks.quick.push({
            id: this.genId(),
            title,
            done: false,
            created: new Date().toISOString()
        });
        
        this.save(); this.closeModal(); this.render();
        this.toast('âœ“ Quick task added');
    },

    toggleQuickTask(id) {
        const task = this.data.tasks.quick?.find(t => t.id === id);
        if (task) {
            task.done = true;
            task.completedAt = new Date().toISOString();
            this.save(); this.render();
            this.celebrate('âœ¨', 'Quick Win!', 'Task completed');
        }
    },

    deleteQuickTask(id) {
        if (!this.data.tasks.quick) return;
        this.data.tasks.quick = this.data.tasks.quick.filter(t => t.id !== id);
        this.save(); this.render();
    },

    // SCHEDULED TASK - Add a task with date/time to the timeline
    addScheduledTask() {
        if (!this.data.tasks) this.data.tasks = {};
        if (!this.data.tasks.scheduled) this.data.tasks.scheduled = [];
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('modal-body').innerHTML = `
            <h3 style="margin-bottom:12px;color:var(--accent);">ðŸ“… Scheduled Task</h3>
            <input id="st-title" placeholder="Task title..." style="margin-bottom:10px;">
            <input id="st-date" type="date" value="${today}" style="margin-bottom:10px;">
            <input id="st-time" type="time" placeholder="Time (optional)" style="margin-bottom:10px;">
            <input id="st-notes" placeholder="Notes (optional)..." style="margin-bottom:14px;">
            <button class="btn" onclick="App.saveScheduledTask()">Schedule Task</button>`;
        document.getElementById('modal').classList.add('open');
        setTimeout(() => document.getElementById('st-title')?.focus(), 80);
    },

    saveScheduledTask() {
        const title = document.getElementById('st-title')?.value?.trim();
        const date = document.getElementById('st-date')?.value;
        const time = document.getElementById('st-time')?.value;
        const notes = document.getElementById('st-notes')?.value?.trim();
        if (!title) { this.toast('âš ï¸ Enter task title'); return; }
        if (!this.data.tasks) this.data.tasks = {};
        if (!this.data.tasks.scheduled) this.data.tasks.scheduled = [];
        this.data.tasks.scheduled.push({
            id: this.genId(),
            title,
            scheduledDate: date || '',
            scheduledTime: time || '',
            notes: notes || '',
            done: false,
            created: new Date().toISOString()
        });
        this.save(); this.closeModal(); this.render();
        this.toast('âœ“ Task scheduled');
    },

    completeScheduledTask(id) {
        const task = this.data.tasks.scheduled?.find(t => t.id === id);
        if (task) {
            task.done = true;
            task.completedAt = new Date().toISOString();
            this.save(); this.render();
            this.celebrate('âœ…', 'Scheduled Task Done!', task.title);
        }
    },

    deleteScheduledTask(id) {
        if (!this.data.tasks.scheduled) return;
        this.data.tasks.scheduled = this.data.tasks.scheduled.filter(t => t.id !== id);
        this.save(); this.render();
    },

    // DELEGATED TASK - Track tasks given to others for follow-up
    addDelegatedTask() {
        if (!this.data.tasks) this.data.tasks = {};
        if (!this.data.tasks.delegated) this.data.tasks.delegated = [];
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('modal-body').innerHTML = `
            <h3 style="margin-bottom:12px;color:var(--accent);">ðŸ¤ Delegated Task</h3>
            <input id="dt-title" placeholder="Task description..." style="margin-bottom:10px;">
            <input id="dt-to" placeholder="Delegated to (name)..." style="margin-bottom:10px;">
            <label style="font-size:12px;color:var(--dim);display:block;margin-bottom:4px;">Follow-up date</label>
            <input id="dt-date" type="date" value="${today}" style="margin-bottom:10px;">
            <input id="dt-notes" placeholder="Notes (optional)..." style="margin-bottom:14px;">
            <button class="btn" onclick="App.saveDelegatedTask()">Add Delegated Task</button>`;
        document.getElementById('modal').classList.add('open');
        setTimeout(() => document.getElementById('dt-title')?.focus(), 80);
    },

    saveDelegatedTask() {
        const title = document.getElementById('dt-title')?.value?.trim();
        const delegatedTo = document.getElementById('dt-to')?.value?.trim();
        const followUpDate = document.getElementById('dt-date')?.value;
        const notes = document.getElementById('dt-notes')?.value?.trim();
        if (!title) { this.toast('âš ï¸ Enter task description'); return; }
        if (!this.data.tasks) this.data.tasks = {};
        if (!this.data.tasks.delegated) this.data.tasks.delegated = [];
        this.data.tasks.delegated.push({
            id: this.genId(),
            title,
            delegatedTo: delegatedTo || '',
            followUpDate: followUpDate || '',
            notes: notes || '',
            done: false,
            created: new Date().toISOString()
        });
        this.save(); this.closeModal(); this.render();
        this.toast('âœ“ Delegated task tracked');
    },

    completeDelegatedTask(id) {
        const task = this.data.tasks.delegated?.find(t => t.id === id);
        if (task) {
            task.done = true;
            task.completedAt = new Date().toISOString();
            this.save(); this.render();
            this.celebrate('ðŸŽ¯', 'Delegated Task Closed!', task.title);
        }
    },

    deleteDelegatedTask(id) {
        if (!this.data.tasks.delegated) return;
        this.data.tasks.delegated = this.data.tasks.delegated.filter(t => t.id !== id);
        this.save(); this.render();
    },

    // CYCLE TASK - Add task to current 90-day cycle
    addCycleTask() {
        if (!this.data.currentCycle) {
            this.toast('âš ï¸ No active cycle. Import a blueprint first.');
            return;
        }
        
        const domains = this.getAllDomains();
        const domainOptions = domains.map(d => `<option value="${esc(d)}">${esc(d)}</option>`).join('');
        
        document.getElementById('modal-body').innerHTML = `
            <h3 style="margin-bottom:12px;color:var(--accent);">âœ“ Add Cycle Task</h3>
            <input id="ct-title" placeholder="Task title..." style="margin-bottom:12px;">
            <select id="ct-week" style="margin-bottom:12px;">
                <option value="">Select Week (optional)</option>
                ${Array.from({length: 13}, (_, i) => i + 1).map(w => 
                    `<option value="${w}">Week ${w}</option>`
                ).join('')}
            </select>
            <select id="ct-domain" style="margin-bottom:12px;">
                <option value="">Domain (optional)</option>
                ${domainOptions}
            </select>
            <input id="ct-goal" placeholder="Related goal (optional)..." style="margin-bottom:12px;">
            <button class="btn" onclick="App.saveCycleTask()">Add to Cycle</button>`;
        document.getElementById('modal').classList.add('open');
        setTimeout(() => document.getElementById('ct-title')?.focus(), 80);
    },

    saveCycleTask() {
        const title = document.getElementById('ct-title')?.value?.trim();
        const week = document.getElementById('ct-week')?.value;
        const domain = document.getElementById('ct-domain')?.value;
        const goal = document.getElementById('ct-goal')?.value?.trim();
        
        if (!title) { this.toast('âš ï¸ Enter task title'); return; }
        
        // FIX: Use first available domain if none selected, don't hardcode 'Personal'
        let taskDomain = domain;
        if (!taskDomain) {
            const domains = this.getAllDomains();
            taskDomain = domains.length > 0 ? domains[0] : '';
        }
        
        // FIX: Validate week number is between 1-13
        let taskWeek = week ? parseInt(week) : 1;
        taskWeek = Math.max(1, Math.min(13, taskWeek));
        
        if (!this.data.currentCycle.tasks) this.data.currentCycle.tasks = [];
        this.data.currentCycle.tasks.push({
            id: this.genId(),
            title,
            week: taskWeek,
            domain: taskDomain,
            goal: goal || '',
            done: false,
            created: new Date().toISOString()
        });
        
        this.save(); this.closeModal(); this.render();
        this.toast('âœ“ Task added to cycle');
    },

    // TIMEBLOCK - Schedule focused time blocks
    addTimeblock() {
        document.getElementById('modal-body').innerHTML = `
            <h3 style="margin-bottom:12px;color:var(--accent);">ðŸ“… Schedule Timeblock</h3>
            <input id="tb-title" placeholder="What will you work on?" style="margin-bottom:12px;">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px;">
                <input type="date" id="tb-date" style="margin:0;">
                <input type="time" id="tb-time" style="margin:0;">
            </div>
            <input type="number" id="tb-duration" placeholder="Duration (minutes)" min="15" max="480" 
                   value="60" style="margin-bottom:12px;">
            <select id="tb-type" style="margin-bottom:12px;">
                <option value="Focus">ðŸŽ¯ Deep Focus</option>
                <option value="Meeting">ðŸ‘¥ Meeting</option>
                <option value="Learning">ðŸ“š Learning</option>
                <option value="Creative">ðŸŽ¨ Creative Work</option>
                <option value="Admin">ðŸ“‹ Admin</option>
            </select>
            <textarea id="tb-notes" placeholder="Notes or preparation needed..." rows="3" 
                      style="margin-bottom:12px;"></textarea>
            <button class="btn" onclick="App.saveTimeblock()">Schedule Block</button>`;
        document.getElementById('modal').classList.add('open');
        
        // Set default date to today
        const today = new Date().toISOString().split('T')[0];
        setTimeout(() => {
            document.getElementById('tb-date').value = today;
            document.getElementById('tb-title')?.focus();
        }, 80);
    },

    saveTimeblock() {
        const title = document.getElementById('tb-title')?.value?.trim();
        const date = document.getElementById('tb-date')?.value;
        const time = document.getElementById('tb-time')?.value;
        const duration = document.getElementById('tb-duration')?.value;
        const type = document.getElementById('tb-type')?.value;
        const notes = document.getElementById('tb-notes')?.value?.trim();
        
        if (!title) { this.toast('âš ï¸ Enter title'); return; }
        if (!date) { this.toast('âš ï¸ Select date'); return; }
        
        if (!this.data.timeblocks) this.data.timeblocks = [];
        this.data.timeblocks.push({
            id: this.genId(),
            title,
            date,
            time: time || '',
            duration: duration ? parseInt(duration) : 60,
            type: type || 'Focus',
            notes: notes || '',
            completed: false,
            created: new Date().toISOString()
        });
        
        this.save(); this.closeModal(); this.render();
        this.toast('âœ“ Timeblock scheduled');
    },

    // GOAL STAGE - Add milestone/stage to a goal
    addGoalStage() {
        if (!this.data.goals || this.data.goals.length === 0) {
            this.toast('âš ï¸ Create a goal first');
            return;
        }
        
        document.getElementById('modal-body').innerHTML = `
            <h3 style="margin-bottom:12px;color:var(--accent);">ðŸŽ¯ Add Goal Stage</h3>
            <select id="gs-goal" style="margin-bottom:12px;">
                <option value="">Select Goal</option>
                ${this.data.goals.map(g => `<option value="${g.id}">${esc(g.title)}</option>`).join('')}
            </select>
            <input id="gs-title" placeholder="Stage/milestone name..." style="margin-bottom:12px;">
            <input id="gs-target" type="date" placeholder="Target date" style="margin-bottom:12px;">
            <textarea id="gs-desc" placeholder="What needs to happen in this stage?" rows="4" 
                      style="margin-bottom:12px;"></textarea>
            <button class="btn" onclick="App.saveGoalStage()">Add Stage</button>`;
        document.getElementById('modal').classList.add('open');
        setTimeout(() => document.getElementById('gs-goal')?.focus(), 80);
    },

    saveGoalStage() {
        const goalId = document.getElementById('gs-goal')?.value;
        const title = document.getElementById('gs-title')?.value?.trim();
        const target = document.getElementById('gs-target')?.value;
        const description = document.getElementById('gs-desc')?.value?.trim();
        
        if (!goalId) { this.toast('âš ï¸ Select a goal'); return; }
        if (!title) { this.toast('âš ï¸ Enter stage name'); return; }
        
        const goal = this.data.goals.find(g => g.id === goalId);
        if (!goal) return;
        
        if (!goal.stages) goal.stages = [];
        goal.stages.push({
            id: this.genId(),
            title,
            target: target || '',
            description: description || '',
            completed: false,
            created: new Date().toISOString()
        });
        
        this.save(); this.closeModal(); this.render();
        this.toast('âœ“ Goal stage added');
    },

    // ========== WELCOME MODAL HANDLERS ==========
    
    chooseCreateCustom() {
        // FIX: Save any profile data entered in Step 1 before navigating
        this._welcomeSaveProfileData();
        
        // Mark welcome as seen
        localStorage.setItem('svkWelcomeSeen', 'true');
        
        // Hide welcome modal
        document.getElementById('welcome-overlay').style.display = 'none';
        
        // Navigate to Custom Blueprint tab
        this.sub.system = 'custom';
        this.navigate(3); // Navigate to SYSTEM tab (index 3)
        
        this.toast('âœ¨ Let\'s create your custom blueprint!');
    },

    chooseImport() {
        // FIX: Save any profile data entered in Step 1 before navigating
        this._welcomeSaveProfileData();
        
        // Mark welcome as seen
        localStorage.setItem('svkWelcomeSeen', 'true');
        
        // Hide welcome modal
        document.getElementById('welcome-overlay').style.display = 'none';
        
        // Navigate to BUILD > Stats tab for import
        this.sub.build = 'stats';
        this.navigate(1); // Navigate to BUILD tab (index 1)
        
        // Scroll to import section after render
        setTimeout(() => {
            this.toast('ðŸ“¥ Click "Import Blueprint" to upload your JSON file');
        }, 300);
    },

    // â”€â”€ WELCOME FLOW HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    _welcomePreviewAvatar() {
        const name = document.getElementById('welcome-name')?.value || '';
        const preview = document.getElementById('welcome-avatar-preview');
        if (!preview) return;
        const initials = this._getInitialsOrDefault(name);
        preview.textContent = initials;
        preview.style.fontSize = initials.length > 2 ? '20px' : '30px';
    },

    _welcomeSaveProfileData() {
        const name = (document.getElementById('welcome-name')?.value || '').trim();
        const tagline = (document.getElementById('welcome-tagline')?.value || '').trim();
        const vision = (document.getElementById('welcome-vision')?.value || '').trim();
        if (!this.data.userProfile) this.data.userProfile = {};
        if (name) this.data.userProfile.name = name;
        if (tagline) this.data.userProfile.tagline = tagline;
        if (vision) this.data.userProfile.vision = vision;
        this.save();
        this.updateHeaderProfile();
    },

    _welcomeStep1Next() {
        const name = (document.getElementById('welcome-name')?.value || '').trim();
        const vision = (document.getElementById('welcome-vision')?.value || '').trim();
        if (!name) {
            const inp = document.getElementById('welcome-name');
            inp.focus();
            inp.style.borderColor = 'var(--danger)';
            setTimeout(() => { inp.style.borderColor = ''; }, 1500);
            return;
        }
        if (!vision) {
            const inp = document.getElementById('welcome-vision');
            inp.focus();
            inp.style.borderColor = 'var(--danger)';
            setTimeout(() => { inp.style.borderColor = ''; }, 1500);
            return;
        }
        // Save profile and mark welcome seen so refresh goes past step 1
        this._welcomeSaveProfileData();
        localStorage.setItem('svkWelcomeSeen', 'true');
        // Advance to step 2
        document.getElementById('welcome-step-1').style.display = 'none';
        document.getElementById('welcome-step-2').style.display = 'block';
        // Update step 2 avatar + greeting
        const firstName = name.split(' ')[0];
        const avatarEl = document.getElementById('welcome-step2-avatar');
        if (avatarEl) avatarEl.textContent = this._getInitialsOrDefault(name);
        const titleEl = document.getElementById('welcome-step2-title');
        if (titleEl) titleEl.textContent = `Welcome, ${firstName}! Now set up your blueprint.`;
    },

    _welcomeSkipProfile() {
        // Mark welcome seen so step 2 is the entry point on refresh
        localStorage.setItem('svkWelcomeSeen', 'true');
        // Skip profile, go straight to blueprint step
        document.getElementById('welcome-step-1').style.display = 'none';
        document.getElementById('welcome-step-2').style.display = 'block';
    },

    _welcomeSkipBlueprint() {
        localStorage.setItem('svkWelcomeSeen', 'true');
        document.getElementById('welcome-overlay').style.display = 'none';
        this.render();
        this.toast('âœ“ Welcome! Set up your blueprint anytime from SYSTEM tab.');
    },

    // ============================================================================
    // VAULT ENHANCEMENTS - ALL 10 NEW FEATURES
    // ============================================================================

    // 1. TOGGLE ADVANCED FILTERS PANEL
    toggleVaultFilters() {
        this.data.vaultSettings.showFilters = !this.data.vaultSettings.showFilters;
        this.save();
        this.render();
    },

    // 2. TAG FILTER
    toggleTagFilter(tag, type, sub) {
        if (!this.data.vaultSettings.selectedTags) this.data.vaultSettings.selectedTags = [];
        const idx = this.data.vaultSettings.selectedTags.indexOf(tag);
        if (idx >= 0) {
            this.data.vaultSettings.selectedTags.splice(idx, 1);
        } else {
            this.data.vaultSettings.selectedTags.push(tag);
        }
        this.save();
        this.render();
    },

    // 3. IMPORTANCE FILTER
    toggleImportanceFilter(importance, type, sub) {
        if (!this.data.vaultSettings.importanceFilter) this.data.vaultSettings.importanceFilter = [];
        const idx = this.data.vaultSettings.importanceFilter.indexOf(importance);
        if (idx >= 0) {
            this.data.vaultSettings.importanceFilter.splice(idx, 1);
        } else {
            this.data.vaultSettings.importanceFilter.push(importance);
        }
        this.save();
        this.render();
    },

    // 4. STARRED ONLY FILTER
    toggleStarredFilter(type, sub) {
        this.data.vaultSettings.starredOnly = !this.data.vaultSettings.starredOnly;
        this.save();
        this.render();
    },

    // 5. PINNED ONLY FILTER
    togglePinnedFilter(type, sub) {
        this.data.vaultSettings.pinnedOnly = !this.data.vaultSettings.pinnedOnly;
        this.save();
        this.render();
    },

    // 6. CLEAR ALL FILTERS
    clearAllFilters(type, sub) {
        this.data.vaultSettings.searchQuery = '';
        this.data.vaultSettings.selectedTags = [];
        this.data.vaultSettings.importanceFilter = [];
        this.data.vaultSettings.starredOnly = false;
        this.data.vaultSettings.pinnedOnly = false;
        this.data.vaultSettings.dateRange = { start: null, end: null };
        this.save();
        this.render();
    },

    // 7. TOGGLE VIEW MODE (card/compact/timeline)
    toggleVaultView() {
        const modes = ['card', 'compact', 'timeline'];
        const current = this.data.vaultSettings.viewMode || 'card';
        const currentIdx = modes.indexOf(current);
        const nextIdx = (currentIdx + 1) % modes.length;
        this.data.vaultSettings.viewMode = modes[nextIdx];
        this.save();
        this.render();
        this.toast(`View: ${modes[nextIdx].toUpperCase()}`);
    },

    // 8. PIN/UNPIN ITEM
    togglePin(type, sub, itemId, event) {
        if (event) event.stopPropagation();
        const items = type === 'learn' ? this.data.vaultLearn[sub] : this.data.vaultEarn[sub];
        const item = items.find(i => i.id === itemId);
        if (!item) return;
        
        item.pinned = !item.pinned;
        item.modified = new Date().toISOString();
        this.save();
        this.render();
        this.toast(item.pinned ? 'ðŸ“Œ Pinned' : 'ðŸ“ Unpinned');
    },

    // 9. BATCH MODE TOGGLE
    toggleBatchMode(type, sub) {
        this.data.vaultSettings.batchMode = !this.data.vaultSettings.batchMode;
        if (!this.data.vaultSettings.batchMode) {
            this.data.vaultSettings.selectedItems = [];
        }
        this.save();
        this.render();
    },

    // 10. TOGGLE ITEM SELECTION (for batch operations)
    toggleItemSelection(itemId, event) {
        if (event) event.stopPropagation();
        if (!this.data.vaultSettings.batchMode) return;
        if (!this.data.vaultSettings.selectedItems) this.data.vaultSettings.selectedItems = [];
        
        const idx = this.data.vaultSettings.selectedItems.indexOf(itemId);
        if (idx >= 0) {
            this.data.vaultSettings.selectedItems.splice(idx, 1);
        } else {
            this.data.vaultSettings.selectedItems.push(itemId);
        }
        this.save();
        this.render();
    },

    // 11. CLEAR BATCH SELECTION
    clearBatchSelection() {
        this.data.vaultSettings.selectedItems = [];
        this.save();
        this.render();
    },

    // 12. BATCH EXPORT
    batchExportVault(type, sub) {
        const items = type === 'learn' ? this.data.vaultLearn[sub] : this.data.vaultEarn[sub];
        const selectedItems = items.filter(i => this.data.vaultSettings.selectedItems.includes(i.id));
        
        if (selectedItems.length === 0) {
            this.toast('âš ï¸ No items selected');
            return;
        }
        
        const blob = new Blob([JSON.stringify(selectedItems, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `vault-${sub}-batch-export-${Date.now()}.json`;
        a.click();
        this.toast(`âœ“ Exported ${selectedItems.length} items`);
    },

    // 13. BATCH TAG
    batchTagVault(type, sub) {
        const tags = prompt('Enter tags (comma-separated):');
        if (!tags) return;
        
        const tagArray = tags.split(',').map(t => t.trim()).filter(Boolean);
        if (tagArray.length === 0) return;
        
        const items = type === 'learn' ? this.data.vaultLearn[sub] : this.data.vaultEarn[sub];
        let count = 0;
        
        items.forEach(item => {
            if (this.data.vaultSettings.selectedItems.includes(item.id)) {
                if (!item.tags) item.tags = [];
                tagArray.forEach(tag => {
                    if (!item.tags.includes(tag)) {
                        item.tags.push(tag);
                    }
                });
                item.modified = new Date().toISOString();
                count++;
            }
        });
        
        this.save();
        this.render();
        this.toast(`âœ“ Tagged ${count} items`);
    },

    // 14. BATCH DELETE
    batchDeleteVault(type, sub) {
        const count = this.data.vaultSettings.selectedItems.length;
        this.confirm(`Delete ${count} selected items?`, () => this._doBatchDeleteVault(type, sub), 'Delete All');
    },
    _doBatchDeleteVault(type, sub) {
        
        if (type === 'learn') {
            this.data.vaultLearn[sub] = this.data.vaultLearn[sub].filter(i => 
                !this.data.vaultSettings.selectedItems.includes(i.id)
            );
        } else {
            this.data.vaultEarn[sub] = this.data.vaultEarn[sub].filter(i => 
                !this.data.vaultSettings.selectedItems.includes(i.id)
            );
        }
        
        this.data.vaultSettings.selectedItems = [];
        this.save();
        this.render();
        this.toast(`âœ“ Deleted ${count} items`);
    },

    // 15. LINK VAULT ITEM
    linkVaultItem(type, sub, itemId, event) {
        if (event) event.stopPropagation();
        
        const item = this.findVaultItemById(itemId);
        if (!item) return;
        
        // Get all vault items for linking
        const allItems = [];
        ['ideas', 'notes', 'books', 'skills'].forEach(s => {
            (this.data.vaultLearn[s] || []).forEach(i => {
                if (i.id !== itemId) allItems.push({ ...i, category: `LEARN:${s}` });
            });
        });
        ['strat', 'exec', 'leverage', 'contacts'].forEach(s => {
            (this.data.vaultEarn[s] || []).forEach(i => {
                if (i.id !== itemId) allItems.push({ ...i, category: `EARN:${s}` });
            });
        });
        
        if (allItems.length === 0) {
            this.toast('âš ï¸ No other items to link');
            return;
        }
        
        const options = allItems.map((i, idx) => 
            `${idx}. [${i.category}] ${i.title}`
        ).join('\n');
        
        const selection = prompt(`Link to (enter number):\n\n${options}`);
        if (selection === null) return;
        
        const selectedIdx = parseInt(selection);
        if (isNaN(selectedIdx) || selectedIdx < 0 || selectedIdx >= allItems.length) {
            this.toast('âš ï¸ Invalid selection');
            return;
        }
        
        const linkedItem = allItems[selectedIdx];
        if (!item.linkedTo) item.linkedTo = [];
        
        if (!item.linkedTo.includes(linkedItem.id)) {
            item.linkedTo.push(linkedItem.id);
            item.modified = new Date().toISOString();
            this.save();
            this.render();
            this.toast(`âœ“ Linked to: ${linkedItem.title}`);
        } else {
            this.toast('âš ï¸ Already linked');
        }
    },

    // 16. FIND VAULT ITEM BY ID (helper)
    findVaultItemById(itemId) {
        for (const sub of ['ideas', 'notes', 'books', 'skills']) {
            const item = (this.data.vaultLearn[sub] || []).find(i => i.id === itemId);
            if (item) return { ...item, type: 'learn', sub };
        }
        for (const sub of ['strat', 'exec', 'leverage', 'contacts']) {
            const item = (this.data.vaultEarn[sub] || []).find(i => i.id === itemId);
            if (item) return { ...item, type: 'earn', sub };
        }
        return null;
    },

    // 17. NAVIGATE TO LINKED ITEM
    navigateToVaultItem(itemId, event) {
        if (event) event.stopPropagation();
        const itemInfo = this.findVaultItemById(itemId);
        if (!itemInfo) return;
        
        this.vaultMainTab = itemInfo.type === 'learn' ? 'learn' : 'earn';
        this.sub.vault = itemInfo.sub;
        this.render();
        this.toast(`Jumped to: ${itemInfo.title}`);
    },

    // 18. BULK IMPORT
    bulkImportVault(type, sub) {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json,.csv';
        input.onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    let items = [];
                    
                    if (file.name.endsWith('.json')) {
                        items = JSON.parse(event.target.result);
                    } else if (file.name.endsWith('.csv')) {
                        // Simple CSV parser
                        const lines = event.target.result.split('\n');
                        const headers = lines[0].split(',').map(h => h.trim());
                        
                        for (let i = 1; i < lines.length; i++) {
                            if (!lines[i].trim()) continue;
                            const values = lines[i].split(',').map(v => v.trim());
                            const item = {
                                id: this.genId(),
                                title: values[headers.indexOf('title')] || values[0] || 'Untitled',
                                content: values[headers.indexOf('content')] || values[1] || '',
                                tags: values[headers.indexOf('tags')] ? values[headers.indexOf('tags')].split(';') : [],
                                importance: values[headers.indexOf('importance')] || 'low',
                                starred: false,
                                source: file.name,
                                created: new Date().toISOString(),
                                modified: null,
                                linkedTo: []
                            };
                            items.push(item);
                        }
                    }
                    
                    if (!Array.isArray(items)) items = [items];
                    
                    // Ensure each item has required fields
                    items = items.map(item => ({
                        id: item.id || this.genId(),
                        title: item.title || 'Untitled',
                        content: item.content || '',
                        tags: item.tags || [],
                        importance: item.importance || 'low',
                        starred: item.starred || false,
                        source: item.source || file.name,
                        created: item.created || new Date().toISOString(),
                        modified: null,
                        linkedTo: item.linkedTo || [],
                        pinned: false
                    }));
                    
                    // Add to vault
                    if (type === 'learn') {
                        if (!this.data.vaultLearn[sub]) this.data.vaultLearn[sub] = [];
                        this.data.vaultLearn[sub].push(...items);
                    } else {
                        if (!this.data.vaultEarn[sub]) this.data.vaultEarn[sub] = [];
                        this.data.vaultEarn[sub].push(...items);
                    }
                    
                    this.save();
                    this.render();
                    this.toast(`âœ“ Imported ${items.length} items`);
                } catch (err) {
                    this.toast('âš ï¸ Import failed: ' + err.message);
                    console.error('Import error:', err);
                }
            };
            reader.readAsText(file);
        };
        input.click();
    },

    // 19. RENDER MARKDOWN (Simple Implementation)
    renderMarkdown(text) {
        if (!text) return '';
        
        // Escape HTML first
        let html = text.replace(/&/g, '&amp;')
                      .replace(/</g, '&lt;')
                      .replace(/>/g, '&gt;');
        
        // Headers
        html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
        html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
        html = html.replace(/^# (.+)$/gm, '<h1>$1</h1>');
        
        // Bold
        html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
        
        // Italic
        html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
        
        // Code
        html = html.replace(/`(.+?)`/g, '<code>$1</code>');
        
        // Lists (simple)
        html = html.replace(/^- (.+)$/gm, '<li>$1</li>');
        const listItems = html.match(/<li>.*?<\/li>/g);
        if (listItems) {
            html = html.replace(/(<li>.*?<\/li>\s*)+/g, '<ul>$&</ul>');
        }
        
        // Blockquotes
        html = html.replace(/^> (.+)$/gm, '<blockquote>$1</blockquote>');
        
        return html;
    }
};

// ============================================================================
// PRODUCTION ERROR HANDLERS & SAFETY FEATURES
// ============================================================================

// Global error handler
window.addEventListener('error', (event) => {
    console.error('Global error caught:', event.error);
    
    // Log error details
    const errorLog = {
        message: event.message,
        filename: event.filename,
        lineno: event.lineno,
        colno: event.colno,
        stack: event.error?.stack,
        timestamp: new Date().toISOString()
    };
    
    // Store error log
    try {
        const errors = JSON.parse(localStorage.getItem('svk_error_log') || '[]');
        errors.push(errorLog);
        // Keep only last 10 errors
        if (errors.length > 10) errors.shift();
        localStorage.setItem('svk_error_log', JSON.stringify(errors));
    } catch (e) {
        console.error('Failed to log error:', e);
    }
    
    // Prevent default error handling for graceful degradation
    event.preventDefault();
});

// Unhandled promise rejection handler
window.addEventListener('unhandledrejection', (event) => {
    console.error('Unhandled promise rejection:', event.reason);
    
    try {
        const errors = JSON.parse(localStorage.getItem('svk_error_log') || '[]');
        errors.push({
            type: 'unhandledRejection',
            reason: event.reason?.toString(),
            timestamp: new Date().toISOString()
        });
        if (errors.length > 10) errors.shift();
        localStorage.setItem('svk_error_log', JSON.stringify(errors));
    } catch (e) {
        console.error('Failed to log rejection:', e);
    }
    
    event.preventDefault();
});

// Visibility change handler - save on tab close
document.addEventListener('visibilitychange', () => {
    if (document.hidden && App.data) {
        try {
            App.save();
        } catch (e) {
            console.error('Failed to save on visibility change:', e);
        }
    }
});

// Before unload - save data
window.addEventListener('beforeunload', (event) => {
    try {
        if (App.data) {
            App.save();
        }
    } catch (e) {
        console.error('Failed to save before unload:', e);
    }
});

// Page show - reload if from cache
window.addEventListener('pageshow', (event) => {
    if (event.persisted) {
        // Page was loaded from cache, reload to ensure fresh data
        console.log('Page loaded from cache, refreshing...');
        window.location.reload();
    }
});

// Initialize app when DOM is ready
document.addEventListener('DOMContentLoaded', () => {
    try {
        App.init();
        console.log('%câœ¨ SVK Blueprint v2.3.0 PRODUCTION', 'background: #ffd700; color: #000; font-weight: bold; padding: 8px 16px; border-radius: 4px;');
        console.log('%câ„¹ï¸ Full Bug Fix Release â€” PWA Confirm, MicroSteps, Habits', 'color: #888; font-size: 11px;');
        console.log('%câ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'color: #333;');
    } catch (initError) {
        console.error('Failed to initialize app:', initError);
        document.body.innerHTML = `
            <div style="display:flex;align-items:center;justify-content:center;height:100vh;
                        background:#0a0a0a;color:#ffd700;text-align:center;padding:20px;">
                <div>
                    <h1 style="font-size:48px;margin-bottom:20px;">âš ï¸</h1>
                    <h2 style="margin-bottom:10px;">SVK Blueprint Failed to Start</h2>
                    <p style="color:#888;margin-bottom:20px;">An error occurred during initialization.</p>
                    <button onclick="location.reload()" 
                            style="background:#ffd700;color:#000;border:none;padding:12px 24px;
                                   border-radius:8px;font-size:14px;font-weight:700;cursor:pointer;">
                        Reload App
                    </button>
                    <button onclick="localStorage.clear();location.reload()" 
                            style="background:#dc3545;color:#fff;border:none;padding:12px 24px;
                                   border-radius:8px;font-size:14px;font-weight:700;cursor:pointer;
                                   margin-left:10px;">
                        Clear Data & Restart
                    </button>
                </div>
            </div>
        `;
    }
});

</script>
</body>
</html>
