- üìä SORTING SYSTEM: 5 sort options (date, modified, length, tags)
- üè∑Ô∏è TAG SYSTEM: Categorize and organize all SYSTEM items
- üì¶ BULK OPERATIONS: Select multiple items for batch actions
- üì• EXPORT SYSTEM: JSON export for single items or entire sections
- üìã TEMPLATES: Pre-built templates for quick content creation
- üìà ANALYTICS: Detailed stats for reflections, journal, reviews, and notes
- üé® ENHANCED UI: Action buttons, modified timestamps, professional design

NEW IN v2.1.1 (CRITICAL BUGFIXES - February 9, 2026):
- üî¥ FIXED: Corrected this.esc() to esc() in 19 locations
  - Prevents JavaScript errors when editing items with special characters
  - Fixes display issues with HTML entities in content
- üõ°Ô∏è ADDED: Error handling for all export functions
  - Graceful failure with user notifications
  - Console error logging for debugging
- üßπ ADDED: URL.revokeObjectURL() to prevent memory leaks
  - Cleans up blob URLs after downloads
  - Improves long-term performance
- ‚å®Ô∏è ADDED: ESC key to close modals
  - Improved keyboard navigation
  - Better user experience

BUG FIXES FROM v2.0:
- ‚úÖ Fixed escapeHtml function reference in custom blueprint tab
- ‚úÖ Removed unnecessary view property assignments
- ‚úÖ Ensured proper navigation flow from welcome modal
- ‚úÖ Verified localStorage flag management for welcome modal
- ‚úÖ All debug statements removed
- ‚úÖ Production-ready code with no console.log or debugger statements

TECHNICAL DETAILS:
- Pure JavaScript (no dependencies)
- LocalStorage persistence
- Mobile-responsive design
- Dark theme optimized
- Security: HTML escaping for all user input
- Tested on Chrome 90+, Safari 14+, Firefox 88+

QUICK START:
1. Open file in modern browser (Chrome 90+, Safari 14+, Firefox 88+)
2. Welcome modal appears automatically for first-time users
3. Choose "Create Custom Blueprint" (recommended) or "Import Existing"
4. Follow the guided setup flow
5. Start executing your 15-year vision!

FIRST-TIME USER FLOW:
1. Welcome modal appears on first load
2. Option A: Click "Create Your Custom Blueprint"
   ‚Üí Navigates to SYSTEM ‚Üí Custom Blueprint
   ‚Üí Fill 12 fields ‚Üí Generate AI prompt ‚Üí Get JSON ‚Üí Import
3. Option B: Click "Import Existing Blueprint"
   ‚Üí Navigates to BUILD ‚Üí Stats
   ‚Üí Click Import Blueprint ‚Üí Upload JSON file ‚Üí Start executing

================================================================================
-->
-->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SVK Blueprint v2.2.1 | 15-Year Vision Execution System</title>
    
    <!-- PWA Configuration -->
    <meta name="description" content="Zen-inspired 15-year vision execution system with 90-day cycle methodology. Transform long-term goals into daily action with frictionless execution.">
    <meta name="theme-color" content="#8b5cf6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SVK Blueprint">
    <link rel="manifest" href="./manifest.json">
    
    <!-- iOS Splash Screens -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Crect width='192' height='192' fill='%238b5cf6'/%3E%3Ctext x='96' y='130' font-family='system-ui' font-size='80' font-weight='700' fill='white' text-anchor='middle'%3ESVK%3C/text%3E%3C/svg%3E">
    
    <style>
        :root {
            --void: #000000; --card: #1c1c1e; --sub: #2c2c2e; --text: #ffffff;
            --dim: #8e8e93; --accent: #ffd700; --border: #38383a;
            --success: #30d158; --warn: #ffd60a; --danger: #ff453a;
            --blue: #0a84ff; --purple: #bf5af2; --zen: #c0c0c0;
            --font: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background: var(--void); color: var(--text); font-family: var(--font); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* HEADER */
        .header {
            padding: max(env(safe-area-inset-top), 16px) 20px 14px;
            background: rgba(0,0,0,0.95); backdrop-filter: blur(20px);
            position: fixed; top: 0; width: 100%; z-index: 50;
            border-bottom: 0.5px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }
        .logo-svk { font-family: monospace; font-weight: 700; font-size: 26px; letter-spacing: 4px; color: var(--accent); text-shadow: 0 0 20px rgba(255,215,0,0.3); }
        .header-right { display: flex; gap: 12px; align-items: center; }
        .header-icon-btn {
            width: 32px; height: 32px; background: var(--sub); border: 1px solid var(--border);
            border-radius: 8px; display: flex; align-items: center; justify-content: center;
            color: var(--text); cursor: pointer; transition: all 0.2s;
        }
        .header-icon-btn:active { opacity: 0.7; transform: scale(0.95); }
        .cycle-badge {
            font-family: monospace; font-size: 11px; font-weight: 700;
            padding: 6px 12px; background: var(--sub); border-radius: 12px;
            border: 1px solid var(--border); color: var(--accent);
            text-transform: uppercase; letter-spacing: 1px; cursor: pointer;
        }
        .timer-badge {
            font-family: monospace; font-size: 11px; font-weight: 700;
            padding: 6px 12px; background: var(--success); color: var(--void);
            border-radius: 12px; cursor: pointer; display: none;
            animation: pulse-badge 2s infinite;
        }
        .timer-badge.active { display: block; }
        @keyframes pulse-badge { 0%,100%{opacity:1} 50%{opacity:0.7} }
        @keyframes countdown-tick { 
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        .countdown-ticking {
            animation: countdown-tick 1s ease-in-out infinite;
        }
        
        /* OFFLINE INDICATOR */
        .offline-badge {
            position: fixed; top: calc(env(safe-area-inset-top) + 70px); right: 20px;
            background: var(--danger); color: var(--text); padding: 8px 12px;
            border-radius: 8px; font-size: 11px; font-weight: 600;
            text-transform: uppercase; letter-spacing: 1px; z-index: 60;
            display: none; align-items: center; gap: 6px;
            box-shadow: 0 4px 12px rgba(255,69,58,0.3);
        }
        .offline-badge.show { display: flex; }
        
        /* BACKUP REMINDER BANNER */
        .backup-reminder {
            position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
            background: var(--warn); color: var(--void); padding: 12px 20px;
            border-radius: 12px; font-size: 13px; font-weight: 600;
            z-index: 60; display: none; align-items: center; gap: 12px;
            box-shadow: 0 4px 16px rgba(255,214,10,0.4); max-width: 90%;
        }
        .backup-reminder.show { display: flex; }
        .backup-reminder button {
            padding: 6px 12px; background: var(--void); color: var(--warn);
            border: none; border-radius: 6px; font-weight: 600; cursor: pointer;
        }
        
        /* UNDO TOAST */
        .undo-toast {
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
            background: var(--sub); color: var(--text); padding: 12px 16px;
            border-radius: 10px; font-size: 13px; z-index: 65;
            display: none; align-items: center; gap: 12px; border: 1px solid var(--border);
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        .undo-toast.show { display: flex; }
        .undo-toast button {
            padding: 6px 12px; background: var(--accent); color: var(--void);
            border: none; border-radius: 6px; font-weight: 600; cursor: pointer;
            font-size: 12px;
        }

        /* SCROLL */
        .content { flex: 1; overflow-y: auto; padding: calc(72px + env(safe-area-inset-top)) 20px calc(88px + env(safe-area-inset-bottom)); }
        .content::-webkit-scrollbar { width: 0; }

        /* NAV */
        .nav {
            position: fixed; bottom: 0; width: 100%;
            background: rgba(20,20,22,0.97); backdrop-filter: blur(24px);
            border-top: 0.5px solid var(--border);
            display: grid; grid-template-columns: repeat(5, 1fr);
            padding-bottom: env(safe-area-inset-bottom); z-index: 100;
        }
        .nav-btn {
            background: none; border: none; padding: 10px 0;
            color: var(--dim); display: flex; flex-direction: column;
            align-items: center; gap: 3px; font-size: 9px;
            font-weight: 600; cursor: pointer; transition: color 0.2s; letter-spacing: 0.5px;
        }
        .nav-btn.active { color: var(--accent); }
        .nav-icon { width: 22px; height: 22px; stroke-width: 2; }

        /* CARDS */
        .card { background: var(--card); border-radius: 14px; padding: 18px; margin-bottom: 10px; border: 0.5px solid var(--border); }
        .zen-quote { text-align: center; padding: 18px 12px; margin: 12px 0; font-style: italic; color: var(--zen); font-size: 14px; border-top: 1px solid var(--border); border-bottom: 1px solid var(--border); line-height: 1.5; }
        .btn {
            background: var(--accent); color: var(--void); border: none; border-radius: 10px;
            padding: 14px; font-weight: 700; font-size: 15px; width: 100%; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: opacity 0.2s; text-transform: uppercase; letter-spacing: 1px;
        }
        .btn:active { opacity: 0.8; }
        .btn-sec { background: var(--sub); color: var(--text); padding: 8px 14px; border-radius: 8px; border: none; font-weight: 600; font-size: 12px; cursor: pointer; white-space: nowrap; transition: opacity 0.15s; }
        .btn-sec:active { opacity: 0.7; }
        .btn-danger { background: var(--danger); color: #fff; }
        .btn-success { background: var(--success); color: var(--void); }

        /* TASKS */
        .task-row { display: flex; align-items: center; padding: 14px; background: var(--sub); border-radius: 10px; margin-bottom: 8px; border: 1px solid var(--border); gap: 12px; }
        .task-row.done { opacity: 0.4; }
        .task-title { font-weight: 600; word-break: break-word; }
        .task-row.done .task-title { text-decoration: line-through; }
        .task-meta { font-family: monospace; font-size: 10px; color: var(--dim); margin-top: 5px; display: flex; gap: 6px; align-items: center; flex-wrap: wrap; }
        .badge { font-size: 9px; font-weight: 800; padding: 2px 6px; border-radius: 4px; text-transform: uppercase; letter-spacing: 0.5px; }

        /* PROGRESS */
        .progress-bar { width: 100%; height: 6px; background: var(--sub); border-radius: 3px; overflow: hidden; margin: 10px 0; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent), #ff9f0a); border-radius: 3px; transition: width 0.6s; }

        /* STATS */
        .stat-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 16px; }
        .stat-box { background: var(--sub); border-radius: 10px; padding: 14px; text-align: center; border: 1px solid var(--border); }
        .stat-val { font-weight: 700; font-size: 22px; color: var(--accent); font-family: monospace; }
        .stat-label { font-size: 9px; color: var(--dim); text-transform: uppercase; margin-top: 3px; letter-spacing: 1px; }

        /* MODAL */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000; display: none; align-items: flex-end; backdrop-filter: blur(6px); }
        .modal.open { display: flex; }
        .modal-sheet {
            background: var(--card); width: 100%; border-radius: 20px 20px 0 0;
            padding: 20px; padding-bottom: max(32px, env(safe-area-inset-bottom));
            max-height: 88vh; overflow-y: auto;
            animation: slideUp 0.28s cubic-bezier(0.16,1,0.3,1);
            border-top: 1px solid var(--border);
        }
        .modal-handle { width: 36px; height: 4px; background: var(--border); border-radius: 2px; margin: 0 auto 16px; }
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0.6; } to { transform: translateY(0); opacity: 1; } }

        /* INPUTS */
        input, textarea, select {
            width: 100%; background: var(--sub); border: 1px solid var(--border);
            border-radius: 10px; padding: 12px; color: var(--text); font-size: 16px;
            margin-bottom: 12px; font-family: var(--font);
        }

        /* TOAST */
        .toast {
            position: fixed; top: max(env(safe-area-inset-top), 16px); left: 50%;
            transform: translateX(-50%) translateY(-8px); background: var(--card); color: var(--text);
            padding: 11px 22px; border-radius: 20px; font-size: 14px; font-weight: 600;
            z-index: 5000; border: 1px solid var(--border);
            box-shadow: 0 8px 32px rgba(0,0,0,0.5); opacity: 0;
            transition: opacity 0.25s, transform 0.25s; pointer-events: none;
        }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

        /* HABIT TIMER OVERLAY */
        .habit-timer-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 3000;
            display: none; align-items: center; justify-content: center; padding: 20px;
            backdrop-filter: blur(10px);
        }
        .habit-timer-overlay.active { display: flex; }
        .habit-timer-content { width: 100%; max-width: 480px; text-align: center; }
        
        /* ZEN MODE TIMER */
        .zen-timer-overlay {
            position: fixed; inset: 0; background: linear-gradient(135deg, #000000 0%, #0a0a0a 100%);
            z-index: 4000; display: none; align-items: center; justify-content: center;
            backdrop-filter: blur(20px);
        }
        .zen-timer-overlay.active { display: flex; }
        .zen-timer-content {
            width: 100%; max-width: 600px; padding: 40px 20px;
            text-align: center; animation: zenFadeIn 0.6s ease-out;
        }
        @keyframes zenFadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        
        .zen-title {
            font-size: 16px; font-weight: 600; color: var(--accent);
            text-transform: uppercase; letter-spacing: 2px; margin-bottom: 24px;
            opacity: 0.9;
        }
        
        .zen-intention {
            background: rgba(255, 215, 0, 0.05); padding: 20px;
            border-radius: 16px; margin-bottom: 32px;
            border: 1px solid rgba(255, 215, 0, 0.1);
        }
        .zen-intention-label {
            font-size: 10px; color: var(--dim); text-transform: uppercase;
            letter-spacing: 2px; margin-bottom: 8px;
        }
        .zen-intention-text {
            font-size: 15px; line-height: 1.6; color: rgba(255,255,255,0.9);
            font-weight: 400;
        }
        
        .zen-countdown {
            font-size: 96px; font-weight: 700; font-family: monospace;
            color: var(--text); margin: 32px 0;
            text-shadow: 0 0 40px rgba(255,215,0,0.2);
            animation: zenPulse 2s ease-in-out infinite;
        }
        @keyframes zenPulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.01); opacity: 0.95; }
        }
        
        .zen-step-card {
            background: var(--card); padding: 32px 24px; border-radius: 20px;
            margin: 40px 0; border: 1px solid var(--border);
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
        }
        
        .zen-step-number {
            display: inline-block; width: 32px; height: 32px;
            background: var(--accent); color: var(--void);
            border-radius: 50%; line-height: 32px; font-weight: 700;
            font-size: 14px; margin-bottom: 16px;
        }
        
        .zen-step-text {
            font-size: 24px; line-height: 1.5; color: var(--text);
            font-weight: 500; margin-bottom: 24px;
        }
        
        .zen-step-progress {
            font-size: 11px; color: var(--dim); text-transform: uppercase;
            letter-spacing: 2px; margin-top: 16px;
        }
        
        .zen-buttons {
            display: flex; gap: 16px; justify-content: center; margin-top: 32px;
        }
        
        .zen-btn {
            flex: 1; max-width: 200px; padding: 18px 24px;
            border: none; border-radius: 12px; font-size: 16px;
            font-weight: 600; cursor: pointer; transition: all 0.2s;
        }
        .zen-btn:active { transform: scale(0.96); }
        
        .zen-btn-skip {
            background: var(--sub); color: var(--dim);
            border: 1px solid var(--border);
        }
        .zen-btn-skip:hover { background: var(--border); color: var(--text); }
        
        .zen-btn-done {
            background: var(--success); color: var(--void);
            box-shadow: 0 4px 16px rgba(48, 209, 88, 0.3);
        }
        .zen-btn-done:hover { box-shadow: 0 6px 20px rgba(48, 209, 88, 0.4); }
        
        .zen-btn-pause {
            background: var(--warn); color: var(--void);
        }
        
        .zen-btn-stop {
            background: var(--danger); color: var(--text);
        }
        
        .zen-controls {
            display: flex; gap: 12px; justify-content: center;
            margin-top: 24px; padding-top: 24px;
            border-top: 1px solid var(--border);
        }
        
        .zen-control-btn {
            padding: 12px 20px; background: transparent;
            border: 1px solid var(--border); border-radius: 8px;
            color: var(--dim); font-size: 13px; font-weight: 600;
            cursor: pointer; transition: all 0.2s;
        }
        .zen-control-btn:hover { background: var(--sub); color: var(--text); }
        .habit-timer-title { font-size: 24px; font-weight: 700; color: var(--accent); margin-bottom: 12px; }
        .habit-timer-clock {
            font-size: 72px; font-weight: 700; font-family: monospace; color: var(--text);
            margin: 24px 0; text-shadow: 0 0 30px rgba(255,215,0,0.4);
        }
        .habit-timer-controls { display: flex; gap: 12px; margin-bottom: 32px; }
        .timer-control-btn {
            flex: 1; padding: 14px; background: var(--sub); border: 1px solid var(--border);
            border-radius: 10px; color: var(--text); font-weight: 600; font-size: 14px;
            cursor: pointer; transition: opacity 0.2s;
        }
        .timer-control-btn:active { opacity: 0.7; }
        .timer-control-btn.primary { background: var(--success); color: var(--void); }
        .timer-control-btn.danger { background: var(--danger); color: #fff; }
        .micro-steps-container {
            background: var(--card); border-radius: 14px; padding: 20px;
            margin-top: 24px; border: 1px solid var(--border);
        }
        .micro-steps-title {
            font-size: 14px; font-weight: 700; color: var(--accent);
            text-transform: uppercase; letter-spacing: 1px; margin-bottom: 16px; text-align: center;
        }
        .micro-step-item {
            background: var(--sub); padding: 16px; border-radius: 10px; margin-bottom: 10px;
            display: flex; align-items: center; justify-content: space-between; gap: 12px;
            border: 1px solid var(--border); transition: all 0.3s;
        }
        .micro-step-item.completed { opacity: 0.5; border-color: var(--success); }
        .micro-step-item.skipped { opacity: 0.3; border-color: var(--dim); }
        .micro-step-text { flex: 1; text-align: left; font-size: 15px; line-height: 1.4; }
        .micro-step-item.completed .micro-step-text { text-decoration: line-through; }
        .micro-step-actions { display: flex; gap: 8px; }
        .micro-step-btn {
            padding: 8px 16px; border-radius: 8px; font-size: 12px; font-weight: 700;
            border: none; cursor: pointer; transition: opacity 0.2s; white-space: nowrap;
        }
        .micro-step-btn:active { opacity: 0.7; }
        .micro-step-btn.skip { background: var(--sub); color: var(--dim); border: 1px solid var(--border); }
        .micro-step-btn.done { background: var(--success); color: var(--void); }
        .micro-progress { text-align: center; margin-top: 16px; font-size: 13px; color: var(--dim); }
        .micro-progress-bar {
            width: 100%; height: 8px; background: var(--sub); border-radius: 4px;
            overflow: hidden; margin: 8px 0;
        }
        .micro-progress-fill {
            height: 100%; background: linear-gradient(90deg, var(--success), #30d158);
            border-radius: 4px; transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* HABIT CARD ENHANCEMENTS */
        .habit-card {
            background: var(--card); border-radius: 10px; padding: 12px;
            margin-bottom: 8px; border: 1px solid var(--border);
        }
        .habit-header {
            display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;
        }
        .habit-info { flex: 1; }
        .habit-title { font-size: 14px; font-weight: 600; margin-bottom: 2px; }
        .habit-meta {
            font-size: 10px; color: var(--dim); display: flex; gap: 6px; align-items: center;
        }
        .habit-actions { display: flex; gap: 6px; }
        .habit-check-btn {
            width: 28px; height: 28px; border-radius: 50%; border: 2px solid var(--border);
            background: transparent; cursor: pointer; display: flex; align-items: center;
            justify-content: center; transition: all 0.2s;
        }
        .habit-check-btn.done { background: var(--success); border-color: var(--success); }
        .habit-start-btn {
            padding: 6px 10px; background: var(--accent); color: var(--void); border: none;
            border-radius: 6px; font-size: 11px; font-weight: 700; cursor: pointer;
            transition: opacity 0.2s;
        }
        .habit-start-btn:active { opacity: 0.8; }
        .streak-badge {
            font-family: monospace; font-size: 10px; font-weight: 700; padding: 3px 6px;
            background: var(--sub); border-radius: 4px; color: var(--accent);
        }

        /* FAB */
        .fab {
            position: fixed; bottom: calc(82px + env(safe-area-inset-bottom)); right: 20px;
            width: 54px; height: 54px; background: var(--accent); border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: var(--void); z-index: 90; box-shadow: 0 6px 20px rgba(255,215,0,0.35);
            cursor: pointer; border: none;
        }

        /* SEGMENT */
        .segment { display: flex; background: var(--sub); padding: 3px; border-radius: 10px; margin-bottom: 14px; gap: 2px; }
        .segment-btn { flex: 1; padding: 8px 10px; background: transparent; border: none; color: var(--dim); font-weight: 600; font-size: 12px; cursor: pointer; border-radius: 8px; }
        .segment-btn.active { background: var(--card); color: var(--text); box-shadow: 0 1px 4px rgba(0,0,0,0.3); }

        /* SECTION HEADER */
        .section-header {
            text-transform: uppercase; font-size: 10px; font-weight: 700; color: var(--accent);
            margin: 20px 0 10px; letter-spacing: 2px; display: flex;
            justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border); padding-bottom: 8px;
        }

        /* EMPTY STATE */
        .empty-state { text-align: center; padding: 48px 20px; color: var(--dim); font-size: 14px; }
        .empty-state-icon { font-size: 44px; margin-bottom: 12px; opacity: 0.6; }
        
        /* VAULT WORLD-CLASS STYLES */
        .vault-search-bar {
            position: sticky; top: 0; z-index: 10; background: var(--void);
            padding: 12px 0; margin-bottom: 16px;
        }
        .vault-search-input {
            width: 100%; padding: 12px 16px 12px 42px;
            background: var(--sub); border: 1px solid var(--border);
            border-radius: 12px; color: var(--text); font-size: 14px;
            transition: all 0.2s;
        }
        .vault-search-input:focus {
            border-color: var(--accent); background: var(--card);
            box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.1);
        }
        .vault-search-icon {
            position: absolute; left: 14px; top: 50%; transform: translateY(-50%);
            color: var(--dim); pointer-events: none;
        }
        .vault-filters {
            display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 16px;
            padding: 12px; background: var(--sub); border-radius: 12px;
        }
        .vault-filter-chip {
            padding: 6px 12px; background: var(--card); border: 1px solid var(--border);
            border-radius: 8px; font-size: 11px; cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; gap: 6px;
        }
        .vault-filter-chip:hover { background: var(--sub); border-color: var(--accent); }
        .vault-filter-chip.active { background: var(--accent); color: var(--void); border-color: var(--accent); }
        .vault-view-toggle {
            display: flex; gap: 4px; padding: 4px; background: var(--sub);
            border-radius: 10px; border: 1px solid var(--border);
        }
        .vault-view-btn {
            padding: 8px 12px; background: transparent; border: none;
            color: var(--dim); cursor: pointer; border-radius: 8px;
            transition: all 0.2s; font-size: 12px;
        }
        .vault-view-btn.active { background: var(--accent); color: var(--void); }
        .vault-item-card {
            background: var(--card); border: 1px solid var(--border);
            border-radius: 12px; padding: 16px; margin-bottom: 12px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative; overflow: hidden;
        }
        .vault-item-card::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0;
            height: 3px; background: linear-gradient(90deg, var(--accent), var(--purple));
            transform: scaleX(0); transform-origin: left;
            transition: transform 0.3s ease;
        }
        .vault-item-card:hover {
            border-color: var(--accent); transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(255, 215, 0, 0.15);
        }
        .vault-item-card:hover::before { transform: scaleX(1); }
        .vault-item-card.starred::after {
            content: '‚≠ê'; position: absolute; top: 12px; right: 12px;
            font-size: 18px; opacity: 0.8;
        }
        .vault-item-header {
            display: flex; justify-content: space-between; align-items: start;
            margin-bottom: 12px; gap: 12px;
        }
        .vault-item-title {
            font-weight: 700; font-size: 16px; line-height: 1.4;
            color: var(--text); flex: 1;
        }
        .vault-item-meta {
            display: flex; gap: 8px; align-items: center; flex-wrap: wrap;
            margin-bottom: 10px; font-size: 11px; color: var(--dim);
        }
        .vault-item-content {
            color: var(--dim); line-height: 1.7; font-size: 14px;
            margin-bottom: 12px; white-space: pre-wrap;
        }
        .vault-item-tags {
            display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 12px;
        }
        .vault-tag {
            padding: 4px 10px; background: var(--sub); border-radius: 6px;
            font-size: 10px; font-weight: 600; letter-spacing: 0.5px;
            border: 1px solid var(--border); transition: all 0.2s;
        }
        .vault-tag:hover { background: var(--accent); color: var(--void); border-color: var(--accent); }
        .vault-item-footer {
            display: flex; justify-content: space-between; align-items: center;
            padding-top: 12px; border-top: 1px solid var(--border);
        }
        .vault-item-actions {
            display: flex; gap: 6px;
        }
        .vault-action-btn {
            padding: 6px 10px; background: var(--sub); border: 1px solid var(--border);
            border-radius: 6px; font-size: 11px; cursor: pointer;
            transition: all 0.2s; color: var(--text);
        }
        .vault-action-btn:hover { background: var(--accent); color: var(--void); border-color: var(--accent); }
        .vault-action-btn.danger:hover { background: var(--danger); border-color: var(--danger); }
        .vault-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 16px; margin-bottom: 20px;
        }
        .vault-analytics {
            background: linear-gradient(135deg, var(--card), var(--sub));
            border: 1px solid var(--border); border-radius: 16px;
            padding: 20px; margin-bottom: 20px;
        }
        .vault-stat-row {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px; margin-top: 16px;
        }
        .vault-stat-mini {
            background: var(--void); border-radius: 10px; padding: 12px;
            border: 1px solid var(--border);
        }
        .vault-stat-mini-val {
            font-size: 24px; font-weight: 700; color: var(--accent);
            margin-bottom: 4px;
        }
        .vault-stat-mini-label {
            font-size: 10px; color: var(--dim); text-transform: uppercase;
            letter-spacing: 1px;
        }
        .vault-toolbar {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 16px; gap: 12px; flex-wrap: wrap;
        }
        .vault-sort-dropdown {
            padding: 8px 12px; background: var(--sub); border: 1px solid var(--border);
            border-radius: 8px; color: var(--text); font-size: 12px;
            cursor: pointer; transition: all 0.2s;
        }
        .vault-sort-dropdown:hover { border-color: var(--accent); }
        .vault-link-badge {
            display: inline-flex; align-items: center; gap: 4px;
            padding: 4px 8px; background: var(--purple); color: var(--text);
            border-radius: 6px; font-size: 10px; margin-right: 6px;
        }
        .vault-importance-high { border-left: 3px solid var(--danger); }
        .vault-importance-medium { border-left: 3px solid var(--warn); }
        .vault-importance-low { border-left: 3px solid var(--blue); }
        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .vault-item-card {
            animation: slideInUp 0.4s ease-out;
        }
        
        /* NEW VAULT ENHANCEMENTS */
        .vault-item-card.pinned {
            border: 2px solid var(--accent);
            background: linear-gradient(135deg, var(--card), var(--sub));
        }
        .vault-item-card.pinned::after {
            content: 'üìå';
            position: absolute;
            top: 12px;
            right: 12px;
            font-size: 18px;
        }
        .vault-item-card.selected {
            border-color: var(--purple);
            background: rgba(147, 51, 234, 0.1);
        }
        .vault-batch-bar {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--card);
            border: 2px solid var(--accent);
            border-radius: 16px;
            padding: 16px 24px;
            display: none;
            align-items: center;
            gap: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            z-index: 1000;
        }
        .vault-batch-bar.active {
            display: flex;
        }
        .vault-filters-panel {
            background: var(--sub);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            display: none;
        }
        .vault-filters-panel.active {
            display: block;
        }
        .vault-filter-group {
            margin-bottom: 12px;
        }
        .vault-filter-label {
            font-size: 11px;
            color: var(--dim);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
            display: block;
        }
        .vault-filter-chips {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        .vault-filter-chip {
            padding: 6px 12px;
            background: var(--void);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .vault-filter-chip:hover {
            border-color: var(--accent);
        }
        .vault-filter-chip.active {
            background: var(--accent);
            color: var(--void);
            border-color: var(--accent);
        }
        .vault-view-compact .vault-item-card {
            padding: 12px;
            margin-bottom: 8px;
        }
        .vault-view-compact .vault-item-title {
            font-size: 14px;
        }
        .vault-view-compact .vault-item-content {
            font-size: 12px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .vault-view-compact .vault-item-footer {
            padding-top: 8px;
        }
        .vault-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--accent);
        }
        .vault-link-item {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: var(--purple);
            color: var(--text);
            border-radius: 6px;
            font-size: 10px;
            margin-right: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .vault-link-item:hover {
            background: var(--accent);
            transform: scale(1.05);
        }
        .vault-timeline {
            position: relative;
            padding-left: 40px;
        }
        .vault-timeline::before {
            content: '';
            position: absolute;
            left: 15px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(180deg, var(--accent), var(--purple));
        }
        .vault-timeline-item {
            position: relative;
            margin-bottom: 24px;
        }
        .vault-timeline-item::before {
            content: '';
            position: absolute;
            left: -32px;
            top: 8px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--accent);
            border: 3px solid var(--void);
        }
        .vault-timeline-date {
            font-size: 11px;
            color: var(--dim);
            margin-bottom: 8px;
            font-weight: 600;
        }
        .vault-markdown h1, .vault-markdown h2, .vault-markdown h3 {
            color: var(--accent);
            margin: 16px 0 8px;
        }
        .vault-markdown code {
            background: var(--sub);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }
        .vault-markdown ul, .vault-markdown ol {
            margin-left: 20px;
            margin-bottom: 12px;
        }
        .vault-markdown blockquote {
            border-left: 3px solid var(--accent);
            padding-left: 12px;
            margin: 12px 0;
            color: var(--dim);
        }
        .vault-color-picker {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        .vault-color-option {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid var(--border);
            transition: all 0.2s;
        }
        .vault-color-option:hover {
            transform: scale(1.1);
            border-color: var(--text);
        }
        .vault-color-option.selected {
            border-color: var(--accent);
            border-width: 3px;
        }
        
        /* NEW VAULT ENHANCEMENTS */
        /* Pinned items */
        .vault-item-card.pinned {
            background: linear-gradient(135deg, var(--card), rgba(255, 215, 0, 0.05));
            border: 2px solid var(--accent);
        }
        .vault-item-card.pinned::after {
            content: 'üìå'; position: absolute; top: 12px; right: 42px;
            font-size: 16px; opacity: 0.9;
        }
        
        /* Batch selection mode */
        .vault-item-card.selectable {
            cursor: pointer;
            padding-left: 50px;
        }
        .vault-item-card.selectable::before {
            content: '';
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-radius: 4px;
            background: var(--void);
        }
        .vault-item-card.selectable.selected::before {
            background: var(--accent);
            border-color: var(--accent);
        }
        .vault-item-card.selectable.selected::after {
            content: '‚úì';
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--void);
            font-weight: 700;
            font-size: 14px;
        }
        
        /* Compact view */
        .vault-item-card.compact {
            padding: 10px 14px;
            margin-bottom: 6px;
        }
        .vault-item-card.compact .vault-item-title {
            font-size: 14px;
            margin-bottom: 4px;
        }
        .vault-item-card.compact .vault-item-content {
            font-size: 12px;
            margin-bottom: 6px;
            max-height: 40px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .vault-item-card.compact .vault-item-footer {
            padding-top: 8px;
        }
        
        /* Timeline view */
        .vault-timeline {
            position: relative;
            padding-left: 40px;
        }
        .vault-timeline::before {
            content: '';
            position: absolute;
            left: 20px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--border);
        }
        .vault-timeline-item {
            position: relative;
            margin-bottom: 24px;
        }
        .vault-timeline-item::before {
            content: '';
            position: absolute;
            left: -27px;
            top: 8px;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--accent);
            border: 3px solid var(--void);
            box-shadow: 0 0 0 2px var(--border);
        }
        .vault-timeline-date {
            font-size: 11px;
            color: var(--dim);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
            padding-top: 8px;
        }
        
        /* Advanced filter panel */
        .vault-filter-panel {
            background: var(--sub);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            display: none;
        }
        .vault-filter-panel.active {
            display: block;
        }
        .vault-filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 12px;
        }
        .vault-filter-label {
            font-size: 11px;
            color: var(--dim);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
            font-weight: 600;
        }
        
        /* Tag filter chips */
        .vault-tag-filters {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }
        .vault-tag-filter {
            padding: 6px 12px;
            background: var(--sub);
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .vault-tag-filter.active {
            background: var(--accent);
            color: var(--void);
            border-color: var(--accent);
        }
        .vault-tag-filter:hover {
            border-color: var(--accent);
        }
        
        /* Linked items visual */
        .vault-linked-items {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }
        .vault-linked-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: var(--sub);
            border: 1px solid var(--border);
            border-radius: 6px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 12px;
        }
        .vault-linked-item:hover {
            border-color: var(--accent);
            background: rgba(255, 215, 0, 0.05);
        }
        
        /* Batch actions bar */
        .vault-batch-bar {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--card);
            border: 2px solid var(--accent);
            border-radius: 16px;
            padding: 16px 24px;
            display: none;
            align-items: center;
            gap: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            z-index: 1000;
        }
        .vault-batch-bar.active {
            display: flex;
        }
        .vault-batch-count {
            font-weight: 700;
            color: var(--accent);
            margin-right: 12px;
        }
        
        /* Markdown content rendering */
        .vault-item-content.markdown h1,
        .vault-item-content.markdown h2,
        .vault-item-content.markdown h3 {
            color: var(--text);
            margin: 12px 0 8px;
        }
        .vault-item-content.markdown code {
            background: var(--sub);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .vault-item-content.markdown pre {
            background: var(--sub);
            padding: 12px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 8px 0;
        }
        .vault-item-content.markdown ul,
        .vault-item-content.markdown ol {
            margin: 8px 0 8px 20px;
        }
        .vault-item-content.markdown blockquote {
            border-left: 3px solid var(--accent);
            padding-left: 12px;
            margin: 8px 0;
            font-style: italic;
            color: var(--dim);
        }
        .vault-item-content.markdown a {
            color: var(--accent);
            text-decoration: underline;
        }
        
        /* Color theme badges */
        .vault-theme-badge {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid var(--border);
            cursor: pointer;
            transition: all 0.2s;
        }
        .vault-theme-badge:hover {
            transform: scale(1.2);
            border-color: var(--text);
        }
        .vault-theme-badge.active {
            border-width: 3px;
            border-color: var(--text);
        }
        
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(255, 215, 0, 0); }
        }

        /* CELEBRATION */
        .celebrate-overlay { position: fixed; inset: 0; z-index: 9999; background: rgba(0,0,0,0.92); display: none; align-items: center; justify-content: center; flex-direction: column; text-align: center; padding: 40px; animation: fadeIn 0.4s; }
        .celebrate-overlay.show { display: flex; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .celebrate-emoji { font-size: 72px; animation: bounce 0.6s ease; }
        @keyframes bounce { 0%{transform:scale(0.5)} 60%{transform:scale(1.2)} 100%{transform:scale(1)} }
        .celebrate-title { font-size: 28px; font-weight: 800; color: var(--accent); margin: 16px 0 8px; }
        .celebrate-sub { color: var(--dim); font-size: 15px; margin-bottom: 32px; }
        .celebrate-close { background: var(--accent); color: var(--void); border: none; padding: 14px 40px; border-radius: 12px; font-weight: 700; font-size: 16px; cursor: pointer; }

        /* HEATMAP - Compact single-row layout */
        .heatmap { display: flex; gap: 1.5px; margin: 6px 0; justify-content: center; }
        .heatmap-day { 
            width: 9px; 
            height: 9px; 
            background: var(--sub); 
            border-radius: 1.5px; 
            border: 1px solid var(--border);
            transition: all 0.2s;
        }
        .heatmap-day.done { background: var(--success); border-color: var(--success); }
        .heatmap-day:hover { transform: scale(1.2); }

        /* GOAL CARDS */
        .goal-card {
            background: var(--sub);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s;
        }
        .goal-card:hover {
            border-color: var(--accent);
        }
        .goal-card.expanded {
            background: var(--card);
            border-color: var(--accent);
        }

        /* CHECKBOX */
        .checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        .checkbox:hover {
            border-color: var(--accent);
        }
        .checkbox.checked {
            background: var(--success);
            border-color: var(--success);
            position: relative;
        }
        .checkbox.checked::after {
            content: '‚úì';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--void);
            font-size: 12px;
            font-weight: 700;
        }

        /* FILTER BUTTONS */
        .filter-btn {
            padding: 8px 12px;
            background: var(--sub);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            font-size: 11px;
            white-space: nowrap;
            color: var(--text);
            font-family: var(--font);
        }
        .filter-btn:hover {
            border-color: var(--accent);
        }

        /* ========== CUSTOM BLUEPRINT GENERATOR STYLES ========== */
        .step-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            background: var(--blue);
            color: white;
            border-radius: 50%;
            font-weight: 700;
            font-size: 16px;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .helper-text {
            font-size: 12px;
            color: var(--dim);
            margin-top: 4px;
            margin-bottom: 8px;
            line-height: 1.5;
        }

        .prompt-box {
            background: var(--sub);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            font-family: monospace;
            font-size: 11px;
            line-height: 1.6;
            color: var(--text);
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 12px;
        }

        .warning-box {
            background: rgba(255, 214, 10, 0.1);
            border: 1px solid var(--warn);
            border-radius: 12px;
            padding: 16px;
            margin-top: 16px;
        }

        .warning-box ol {
            margin: 0;
            padding-left: 20px;
        }

        .warning-box li {
            margin-bottom: 8px;
        }

        /* ========== WELCOME MODAL STYLES ========== */
        .welcome-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(10px);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }

        .welcome-modal {
            background: var(--card);
            border: 2px solid var(--accent);
            border-radius: 20px;
            padding: 40px 30px;
            max-width: 500px;
            width: 100%;
            text-align: center;
            box-shadow: 0 0 60px rgba(255, 215, 0, 0.3);
            animation: slideUp 0.4s ease;
        }

        .welcome-logo {
            font-family: monospace;
            font-weight: 700;
            font-size: 42px;
            letter-spacing: 8px;
            color: var(--accent);
            text-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
            margin-bottom: 10px;
        }

        .welcome-version {
            font-size: 13px;
            color: var(--dim);
            margin-bottom: 24px;
            letter-spacing: 1px;
        }

        .welcome-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 12px;
            line-height: 1.3;
        }

        .welcome-subtitle {
            font-size: 14px;
            color: var(--dim);
            line-height: 1.6;
            margin-bottom: 32px;
        }

        .welcome-options {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .welcome-option-btn {
            background: var(--sub);
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 24px 20px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
            position: relative;
            overflow: hidden;
        }

        .welcome-option-btn:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(255, 215, 0, 0.2);
        }

        .welcome-option-btn.primary {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.15), rgba(255, 215, 0, 0.05));
            border-color: var(--accent);
        }

        .welcome-option-icon {
            font-size: 32px;
            margin-bottom: 12px;
            display: block;
        }

        .welcome-option-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 6px;
        }

        .welcome-option-desc {
            font-size: 13px;
            color: var(--dim);
            line-height: 1.5;
        }

        .welcome-option-badge {
            display: inline-block;
            background: var(--accent);
            color: var(--void);
            font-size: 10px;
            font-weight: 700;
            padding: 4px 8px;
            border-radius: 6px;
            margin-top: 8px;
            letter-spacing: 0.5px;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 600px) {
            .welcome-modal {
                padding: 30px 20px;
            }
            .welcome-logo {
                font-size: 32px;
            }
            .welcome-title {
                font-size: 20px;
            }
            .welcome-option-btn {
                padding: 20px 16px;
            }
        }
        
        /* ===== SYSTEM TAB ENHANCEMENTS - v2.1 CSS ===== */
        
        /* Action Buttons Container */
        .action-btns { 
            display: flex; 
            gap: 8px; 
            margin-top: 12px; 
            padding-top: 12px; 
            border-top: 1px solid var(--border); 
        }
        .action-btn { 
            flex: 1; 
            padding: 8px; 
            background: var(--sub); 
            color: var(--dim); 
            border: none; 
            border-radius: 8px; 
            font-size: 12px; 
            font-weight: 500; 
            cursor: pointer; 
            transition: all 0.2s; 
        }
        .action-btn:hover { 
            background: var(--border); 
        }
        .action-btn.danger { 
            color: var(--danger); 
        }
        
        /* Tag Display */
        .tags { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 6px; 
            margin-top: 8px; 
        }
        .tag { 
            padding: 4px 10px; 
            background: var(--sub); 
            border-radius: 12px; 
            font-size: 11px; 
            color: var(--accent); 
        }
        
        /* Bulk Mode */
        .bulk-toolbar { 
            position: fixed; 
            bottom: 70px; 
            left: 0; 
            right: 0; 
            background: var(--card); 
            border-top: 1px solid var(--border); 
            padding: 12px 16px; 
            display: none; 
            z-index: 25; 
        }
        .bulk-toolbar.active { 
            display: flex; 
            gap: 8px; 
            align-items: center; 
            justify-content: space-between; 
        }
        
        /* Checkbox */
        .checkbox { 
            width: 20px; 
            height: 20px; 
            border: 2px solid var(--border); 
            border-radius: 4px; 
            margin-right: 12px; 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
        }
        .checkbox.checked { 
            background: var(--accent); 
            border-color: var(--accent); 
        }
        .checkbox.checked::after { 
            content: '‚úì'; 
            color: white; 
            font-size: 14px; 
            font-weight: bold; 
        }
        
        /* Sort Dropdown */
        .sort-bar { 
            display: flex; 
            gap: 8px; 
            margin-bottom: 16px; 
            align-items: center; 
        }
        .sort-select { 
            flex: 1; 
            padding: 10px; 
            background: var(--sub); 
            border: 1px solid var(--border); 
            border-radius: 8px; 
            color: var(--text); 
            font-size: 13px; 
        }
        
        /* ===== END SYSTEM TAB ENHANCEMENTS CSS ===== */
    </style>
</head>
<body>

<!-- WELCOME MODAL - Shows on first load -->
<div id="welcome-overlay" class="welcome-overlay" style="display: none;">
    <div class="welcome-modal">
        <div class="welcome-logo">SVK</div>
        <div class="welcome-version">Blueprint v2.2.1</div>
        <h1 class="welcome-title">Welcome to Your 15-Year Vision System</h1>
        <p class="welcome-subtitle">Transform your long-term goals into executable 90-day cycles with streamlined quick capture. Let's get started!</p>
        
        <div class="welcome-options">
            <div class="welcome-option-btn primary" onclick="App.chooseCreateCustom()">
                <span class="welcome-option-icon">‚ú®</span>
                <div class="welcome-option-title">Create Your Custom Blueprint</div>
                <div class="welcome-option-desc">Answer 12 questions and let AI generate your personalized 15-year plan with 60 cycles. Includes 10 streamlined capture types for daily use.</div>
                <span class="welcome-option-badge">RECOMMENDED</span>
            </div>
            
            <div class="welcome-option-btn" onclick="App.chooseImport()">
                <span class="welcome-option-icon">üì•</span>
                <div class="welcome-option-title">Import Existing Blueprint</div>
                <div class="welcome-option-desc">Already have a blueprint JSON file? Import it to start immediately with enhanced universal search.</div>
            </div>
        </div>
        
        <div style="margin-top: 24px; padding: 16px; background: rgba(139, 92, 246, 0.1); border-radius: 8px; border: 1px solid rgba(139, 92, 246, 0.2);">
            <div style="font-size: 11px; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">‚ú® What's New in v2.2.1</div>
            <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.6;">
                <strong style="color: var(--text);">10 Streamlined Quick Capture Types</strong> - Focused on short-lived, high-frequency items: Ideas, Quick Tasks, Notes, Cycle Tasks, Quotes, Timeblocks, Habits, Journal, Goals & Affirmations.<br>
                <strong style="color: var(--text);">Enhanced Universal Search</strong> - Search across all 15+ data types with instant results and navigation.
            </div>
        </div>
    </div>
</div>

<header class="header">
    <div class="logo-svk">SVK</div>
    <div class="header-right">
        <button class="header-icon-btn" onclick="App.openUserManual()" title="User Manual">
            <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2.5">
                <circle cx="9" cy="9" r="7"/>
                <path d="M9 6v3m0 3h.01"/>
            </svg>
        </button>
        <button class="header-icon-btn" onclick="App.openUniversalSearch()" title="Universal Search">
            <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2.5">
                <circle cx="8" cy="8" r="6"/>
                <path d="M12.5 12.5L16 16"/>
            </svg>
        </button>
        <div class="timer-badge" id="timer-badge">00:00</div>
        <div class="cycle-badge" id="cycle-indicator">NO CYCLE</div>
    </div>
</header>

<main id="app" class="content"></main>

<button class="fab" onclick="App.openCapture()">
    <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="3"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
</button>

<nav class="nav">
    <button class="nav-btn active" onclick="App.navigate(0)">
        <svg class="nav-icon" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="9"/><polyline points="12 6.5 12 12 15.5 14"/></svg>EXECUTE</button>
    <button class="nav-btn" onclick="App.navigate(1)">
        <svg class="nav-icon" fill="none" stroke="currentColor"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>BUILD</button>
    <button class="nav-btn" onclick="App.navigate(2)">
        <svg class="nav-icon" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="9"/><line x1="3" y1="12" x2="21" y2="12"/><path d="M12 3a15 15 0 0 1 4 9 15 15 0 0 1-4 9 15 15 0 0 1-4-9 15 15 0 0 1 4-9z"/></svg>STRATEGY</button>
    <button class="nav-btn" onclick="App.navigate(3)">
        <svg class="nav-icon" fill="none" stroke="currentColor"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>SYSTEM</button>
    <button class="nav-btn" onclick="App.navigate(4)">
        <svg class="nav-icon" fill="none" stroke="currentColor"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg>VAULT</button>
</nav>

<div id="modal" class="modal" onclick="if(event.target===this)App.closeModal()">
    <div class="modal-sheet">
        <div class="modal-handle"></div>
        <div id="modal-body"></div>
    </div>
</div>

<div class="habit-timer-overlay" id="habit-timer-overlay">
    <div class="habit-timer-content" id="habit-timer-content"></div>
</div>

<!-- NEW: Zen Mode Timer Overlay -->
<div class="zen-timer-overlay" id="zen-timer-overlay">
    <div class="zen-timer-content" id="zen-timer-content"></div>
</div>

<div id="toast" class="toast"></div>
<div class="bulk-toolbar" id="bulk-toolbar"></div>

<!-- NEW: Offline Indicator -->
<div class="offline-badge" id="offline-badge">
    <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M1 1L13 13M8 1C11.866 1 15 4.134 15 8M4 1C0.134 1 -3 4.134 -3 8"/>
    </svg>
    Offline Mode
</div>

<!-- NEW: Backup Reminder Banner -->
<div class="backup-reminder" id="backup-reminder">
    <span>‚ö†Ô∏è You haven't backed up your data in 7+ days</span>
    <button onclick="App.exportAllData()">Backup Now</button>
    <button onclick="App.dismissBackupReminder()" style="background:transparent;color:var(--void);">Dismiss</button>
</div>

<!-- NEW: Undo Toast -->
<div class="undo-toast" id="undo-toast">
    <span id="undo-message">Item deleted</span>
    <button onclick="App.performUndo()">Undo</button>
</div>

<div class="celebrate-overlay" id="celebrate">
    <div class="celebrate-emoji" id="celebrate-emoji">üéâ</div>
    <div class="celebrate-title" id="celebrate-title">Great Work!</div>
    <div class="celebrate-sub" id="celebrate-sub">Keep going.</div>
    <button class="celebrate-close" onclick="App.closeCelebrate()">Continue</button>
</div>

<script>
const DB_KEY = 'svk_blueprint_15year';
const SCHEMA = {
    blueprintMeta: null,
    allCycles: [],
    currentCycle: null,
    cycleHistory: [],
    tasks: { quick: [], scheduled: [], delegated: [] },
    system: { habits: [], reflections: { morning: [], evening: [] }, journal: [], reviews: [], labs: { experiments: [], newFailures: [], repeatedFailures: [] } },
    vault: { 
        learnings: { notes: [], quotes: [], bookSummaries: [], mindmaps: [] },
        growth: { books: [], courses: [], skills: [], mentors: [] },
        resources: { ideas: [], contacts: [], incomeStreams: [], assets: [] },
        reflections: { morning: [], evening: [] }, 
        journal: { morning: [], evening: [] } 
    },
    plan: { affirmations: [], bucketList: [] },
    goals: [],
    timeblocks: [],
    completed: []
};

const esc = s => {
    if (s === null || s === undefined) return '';
    if (typeof s !== 'string') s = String(s);
    return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
};

const App = {
    data: null,
    tab: 0,
    sub: {},
    
    // Custom Blueprint Generator state
    customBlueprintData: {},
    customPrompt: null,
    
    // Search state
    journalSearch: '',
    reflectionSearch: '',
    noteSearch: '',
    quoteSearch: '',
    
    // SYSTEM Tab Enhancement - Sorting states
    systemSort: { reflections: 'date-desc', journal: 'date-desc', reviews: 'date-desc' },
    
    // SYSTEM Tab Enhancement - Bulk mode states
    bulkMode: { reflections: false, journal: false, reviews: false },
    selectedItems: { reflections: new Set(), journal: new Set(), reviews: new Set() },
    
    // NEW: Undo/Redo system
    undoStack: [],
    redoStack: [],
    maxUndoSteps: 20,
    
    // NEW: Backup reminder system
    lastBackupReminder: null,
    backupReminderInterval: 7 * 24 * 60 * 60 * 1000, // 7 days in milliseconds
    
    // NEW: Performance - Lazy loading flags
    tabsLoaded: { execute: false, build: false, strategy: false, system: false, vault: false },
    
    // NEW: Online/Offline status
    isOnline: true,
    
    habitTimer: {
        habitId: null,
        startTime: null,
        duration: 0,
        interval: null,
        isPaused: false
    },
    
    // NEW: Zen Mode Timer state
    zenMode: {
        active: false,
        habitId: null,
        taskId: null,
        intention: '',
        currentStepIndex: 0,
        startTime: null,
        duration: 0,
        targetDuration: 0,
        interval: null,
        isPaused: false,
        steps: []
    },

    timer: {
        running: false,
        seconds: 1500, // 25 minutes
        maxSeconds: 1500,
        interval: null,
        phase: 'work', // work, shortBreak, longBreak
        
        show() {
            const modal = document.getElementById('modal');
            const body = document.getElementById('modal-body');
            
            body.innerHTML = `
                <h3 style="margin-bottom:20px;color:var(--accent);text-align:center;">Focus Timer</h3>
                
                <div style="position:relative;width:200px;height:200px;margin:20px auto;">
                    <svg style="position:absolute;top:0;left:0;width:100%;height:100%;transform:rotate(-90deg);" viewBox="0 0 200 200">
                        <circle cx="100" cy="100" r="90" fill="none" stroke="var(--sub)" stroke-width="8"/>
                        <circle id="timer-progress" cx="100" cy="100" r="90" fill="none" stroke="var(--success)" 
                                stroke-width="8" stroke-linecap="round" stroke-dasharray="565.48" stroke-dashoffset="0"
                                style="transition:stroke-dashoffset 1s linear;"/>
                    </svg>
                    <div id="timer-display" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
                         font-family:monospace;font-size:36px;font-weight:700;">25:00</div>
                </div>
                
                <div style="text-align:center;margin-bottom:20px;">
                    <div id="timer-phase" style="color:var(--dim);font-size:13px;">Work Phase - Stay Focused</div>
                </div>
                
                <div style="display:flex;gap:8px;justify-content:center;flex-wrap:wrap;">
                    <button class="btn-sec btn-success" id="timer-start" onclick="App.timer.start()">Start</button>
                    <button class="btn-sec" id="timer-pause" onclick="App.timer.pause()" style="display:none;">Pause</button>
                    <button class="btn-sec" onclick="App.timer.reset()">Reset</button>
                    <button class="btn-sec btn-danger" onclick="App.timer.skip()">Skip</button>
                </div>
                
                <div style="text-align:center;margin-top:16px;font-size:11px;color:var(--dim);">
                    Work: 25 min | Short Break: 5 min | Long Break: 15 min
                </div>
            `;
            
            modal.classList.add('open');
            this.updateDisplay();
        },
        
        start() {
            if (this.running) return;
            
            this.running = true;
            document.getElementById('timer-start').style.display = 'none';
            document.getElementById('timer-pause').style.display = 'block';
            
            this.interval = setInterval(() => {
                if (this.seconds > 0) {
                    this.seconds--;
                    this.updateDisplay();
                } else {
                    this.complete();
                }
            }, 1000);
        },
        
        pause() {
            this.running = false;
            document.getElementById('timer-start').style.display = 'block';
            document.getElementById('timer-pause').style.display = 'none';
            
            if (this.interval) {
                clearInterval(this.interval);
                this.interval = null;
            }
        },
        
        reset() {
            this.pause();
            this.seconds = this.maxSeconds;
            this.updateDisplay();
        },
        
        skip() {
            if (!confirm('Skip this phase?')) return;
            this.seconds = 0;
            this.complete();
        },
        
        complete() {
            this.pause();
            
            // Play sound
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.frequency.value = 800;
                osc.type = 'sine';
                gain.gain.value = 0.3;
                osc.start();
                osc.stop(ctx.currentTime + 0.2);
            } catch(e) {}
            
            const phaseComplete = this.phase === 'work' ? 'Work session' : 'Break';
            App.toast(`‚úì ${phaseComplete} complete!`);
            
            // Switch phases
            if (this.phase === 'work') {
                this.phase = 'shortBreak';
                this.maxSeconds = 300; // 5 min
            } else {
                this.phase = 'work';
                this.maxSeconds = 1500; // 25 min
            }
            
            this.seconds = this.maxSeconds;
            this.updateDisplay();
        },
        
        updateDisplay() {
            const mins = Math.floor(this.seconds / 60);
            const secs = this.seconds % 60;
            const display = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            
            const timerDisplay = document.getElementById('timer-display');
            const phaseLabel = document.getElementById('timer-phase');
            const progress = document.getElementById('timer-progress');
            
            if (timerDisplay) timerDisplay.textContent = display;
            
            if (phaseLabel) {
                const labels = {
                    'work': 'Work Phase - Stay Focused',
                    'shortBreak': 'Short Break - Rest & Recharge',
                    'longBreak': 'Long Break - Deep Rest'
                };
                phaseLabel.textContent = labels[this.phase];
            }
            
            if (progress) {
                const percentage = this.seconds / this.maxSeconds;
                const circumference = 565.48;
                const offset = circumference * (1 - percentage);
                progress.style.strokeDashoffset = offset;
                progress.style.stroke = this.phase === 'work' ? 'var(--success)' : 'var(--blue)';
            }
        }
    },

    init() {
        // ERROR BOUNDARY: Wrap entire initialization in try-catch
        try {
            const saved = localStorage.getItem(DB_KEY);
            const hasSeenWelcome = localStorage.getItem('svkWelcomeSeen');
            
            if (saved) {
                try { 
                    this.data = JSON.parse(saved);
                    // Validate data structure
                    if (!this.data || typeof this.data !== 'object') {
                        throw new Error('Invalid data structure');
                    }
                    // SYSTEM Tab Enhancement - Ensure IDs on all items for backward compatibility
                    this.ensureIds(this.data);
                }
                catch(e) { 
                    console.error('Data parse error:', e);
                    // Backup corrupted data
                    const corrupted = localStorage.getItem(DB_KEY);
                    if (corrupted) {
                        localStorage.setItem('svk_corrupted_backup_' + Date.now(), corrupted);
                    }
                    this.data = JSON.parse(JSON.stringify(SCHEMA));
                    this.toast('‚ö†Ô∏è Data restored from backup');
                }
            } else {
                this.data = JSON.parse(JSON.stringify(SCHEMA));
            }
        
        // BUG FIX: Ensure ALL data structures exist, including vault sub-properties
        if (!this.data.blueprintMeta) this.data.blueprintMeta = null;
        if (!this.data.allCycles) this.data.allCycles = [];
        if (!this.data.cycleHistory) this.data.cycleHistory = [];
        if (!this.data.tasks) this.data.tasks = { quick: [], scheduled: [], delegated: [] };
        if (!this.data.tasks.quick) this.data.tasks.quick = [];
        if (!this.data.system) this.data.system = { habits: [], reflections: { morning: [], evening: [] }, journal: [], reviews: [] };
        if (!this.data.system.habits) this.data.system.habits = [];
        if (!this.data.system.reflections) this.data.system.reflections = { morning: [], evening: [] };
        if (!this.data.system.journal) this.data.system.journal = [];
        if (!this.data.vault) this.data.vault = { learnings: {}, growth: {}, resources: {} };
        
        // Initialize learnings sub-properties
        if (!this.data.vault.learnings) this.data.vault.learnings = {};
        if (!this.data.vault.learnings.notes) this.data.vault.learnings.notes = [];
        if (!this.data.vault.learnings.quotes) this.data.vault.learnings.quotes = [];
        if (!this.data.vault.learnings.bookSummaries) this.data.vault.learnings.bookSummaries = [];
        if (!this.data.vault.learnings.mindmaps) this.data.vault.learnings.mindmaps = [];
        
        // BUG FIX: Initialize growth sub-properties (was missing)
        if (!this.data.vault.growth) this.data.vault.growth = {};
        if (!this.data.vault.growth.books) this.data.vault.growth.books = [];
        if (!this.data.vault.growth.courses) this.data.vault.growth.courses = [];
        if (!this.data.vault.growth.skills) this.data.vault.growth.skills = [];
        if (!this.data.vault.growth.mentors) this.data.vault.growth.mentors = [];
        
        // BUG FIX: Initialize resources sub-properties (was missing)
        if (!this.data.vault.resources) this.data.vault.resources = {};
        if (!this.data.vault.resources.ideas) this.data.vault.resources.ideas = [];
        if (!this.data.vault.resources.contacts) this.data.vault.resources.contacts = [];
        if (!this.data.vault.resources.incomeStreams) this.data.vault.resources.incomeStreams = [];
        if (!this.data.vault.resources.assets) this.data.vault.resources.assets = [];
        
        // Enhanced Vault LEARN/EARN structures
        if (!this.data.vaultLearn) this.data.vaultLearn = { ideas: [], notes: [], books: [], skills: [] };
        if (!this.data.vaultLearn.ideas) this.data.vaultLearn.ideas = [];
        if (!this.data.vaultLearn.notes) this.data.vaultLearn.notes = [];
        if (!this.data.vaultLearn.books) this.data.vaultLearn.books = [];
        if (!this.data.vaultLearn.skills) this.data.vaultLearn.skills = [];
        
        if (!this.data.vaultEarn) this.data.vaultEarn = { strat: [], exec: [], leverage: [], contacts: [] };
        if (!this.data.vaultEarn.strat) this.data.vaultEarn.strat = [];
        if (!this.data.vaultEarn.exec) this.data.vaultEarn.exec = [];
        if (!this.data.vaultEarn.leverage) this.data.vaultEarn.leverage = [];
        if (!this.data.vaultEarn.contacts) this.data.vaultEarn.contacts = [];
        
        // Vault metadata and settings
        if (!this.data.vaultPromotions) this.data.vaultPromotions = [];
        if (!this.data.vaultSettings) this.data.vaultSettings = {
            viewMode: 'card', // 'card', 'compact', 'timeline'
            sortBy: 'recent',
            showAnalytics: true,
            searchQuery: '',
            activeFilters: [],
            selectedTags: [],
            dateRange: { start: null, end: null },
            importanceFilter: [],
            starredOnly: false,
            pinnedOnly: false,
            batchMode: false,
            selectedItems: [],
            categoryColors: {},
            showFilters: false
        };
        
        // Ensure enhanced settings exist for existing users
        if (!this.data.vaultSettings.selectedTags) this.data.vaultSettings.selectedTags = [];
        if (!this.data.vaultSettings.dateRange) this.data.vaultSettings.dateRange = { start: null, end: null };
        if (!this.data.vaultSettings.importanceFilter) this.data.vaultSettings.importanceFilter = [];
        if (this.data.vaultSettings.starredOnly === undefined) this.data.vaultSettings.starredOnly = false;
        if (this.data.vaultSettings.pinnedOnly === undefined) this.data.vaultSettings.pinnedOnly = false;
        if (this.data.vaultSettings.batchMode === undefined) this.data.vaultSettings.batchMode = false;
        if (!this.data.vaultSettings.selectedItems) this.data.vaultSettings.selectedItems = [];
        if (!this.data.vaultSettings.categoryColors) this.data.vaultSettings.categoryColors = {};
        if (this.data.vaultSettings.showFilters === undefined) this.data.vaultSettings.showFilters = false;
        
        if (!this.data.plan) this.data.plan = { affirmations: [], bucketList: [] };
        if (!this.data.goals) this.data.goals = [];
        if (!this.data.timeblocks) this.data.timeblocks = [];
        
        // Load custom blueprint data
        try {
            const storedCustom = localStorage.getItem('svkCustomBlueprintData');
            if (storedCustom) {
                this.customBlueprintData = JSON.parse(storedCustom);
            } else {
                this.customBlueprintData = this.getEmptyCustomBlueprintData();
            }
        } catch (e) {
            this.customBlueprintData = this.getEmptyCustomBlueprintData();
        }
        
        this.updateCycleIndicator();
        this.navigate(0);
        
        // Add keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // ESC to close modal
            if (e.key === 'Escape' && document.getElementById('modal').classList.contains('open')) {
                this.closeModal();
            }
            
            // Ctrl+Z / Cmd+Z for Undo
            if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
                e.preventDefault();
                this.performUndo();
            }
            
            // Ctrl+Shift+Z / Cmd+Shift+Z for Redo
            if ((e.ctrlKey || e.metaKey) && e.key === 'z' && e.shiftKey) {
                e.preventDefault();
                this.performRedo();
            }
        });
        
        // NEW: Online/Offline detection
        window.addEventListener('online', () => {
            this.isOnline = true;
            document.getElementById('offline-badge').classList.remove('show');
            this.toast('‚úì Back online');
        });
        
        window.addEventListener('offline', () => {
            this.isOnline = false;
            document.getElementById('offline-badge').classList.add('show');
        });
        
        // Check initial online status
        this.isOnline = navigator.onLine;
        if (!this.isOnline) {
            document.getElementById('offline-badge').classList.add('show');
        }
        
        // NEW: Check for backup reminder on load
        this.checkBackupReminder();
        
        // Show welcome modal for first-time users
        // Only show if: (1) hasn't seen welcome AND (2) no blueprint data exists
        if (!hasSeenWelcome && !this.data.blueprintMeta && (!this.data.allCycles || this.data.allCycles.length === 0)) {
            setTimeout(() => {
                document.getElementById('welcome-overlay').style.display = 'flex';
            }, 300);
        }
        
        // PWA: Register service worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./service-worker.js')
                .then(registration => {
                    console.log('SVK Blueprint: Service Worker registered', registration.scope);
                    // Check for updates
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        if (newWorker) {
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New version available
                                    if (confirm('üì± New version available! Reload to update?')) {
                                        window.location.reload();
                                    }
                                }
                            });
                        }
                    });
                })
                .catch(err => {
                    console.log('Service Worker registration failed:', err);
                });
        }
        } catch (initError) {
            // CRITICAL ERROR HANDLER
            console.error('Critical initialization error:', initError);
            alert('‚ö†Ô∏è App failed to start. Please refresh the page. If this persists, clear your browser data.');
            // Attempt emergency data export
            try {
                const emergencyData = localStorage.getItem(DB_KEY);
                if (emergencyData) {
                    const blob = new Blob([emergencyData], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `svk_emergency_backup_${Date.now()}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                }
            } catch (e) {
                console.error('Emergency export failed:', e);
            }
        }
    },

    save() {
        try {
            // Create auto-backup every 10 saves
            if (!this.saveCount) this.saveCount = 0;
            this.saveCount++;
            
            if (this.saveCount % 10 === 0) {
                try {
                    const backupKey = 'svk_auto_backup';
                    const backups = JSON.parse(localStorage.getItem(backupKey) || '[]');
                    backups.push({
                        timestamp: Date.now(),
                        data: this.data
                    });
                    // Keep only last 3 backups
                    if (backups.length > 3) backups.shift();
                    localStorage.setItem(backupKey, JSON.stringify(backups));
                } catch (backupError) {
                    console.warn('Auto-backup failed:', backupError);
                }
            }
            
            localStorage.setItem(DB_KEY, JSON.stringify(this.data)); 
            localStorage.setItem('svkCustomBlueprintData', JSON.stringify(this.customBlueprintData));
            
            // Update last save timestamp
            localStorage.setItem('svk_last_save', Date.now().toString());
        }
        catch(e) { 
            if (e.name === 'QuotaExceededError') {
                // Try to free up space
                try {
                    localStorage.removeItem('svk_auto_backup');
                    localStorage.setItem(DB_KEY, JSON.stringify(this.data));
                    this.toast('‚ö†Ô∏è Storage full - auto-backups cleared');
                } catch (retryError) {
                    this.toast('‚ùå Storage critically full - export your data NOW');
                    // Trigger emergency export
                    setTimeout(() => this.exportData(), 2000);
                }
            } else {
                this.toast('‚ö†Ô∏è Save failed: ' + e.message);
            }
            console.error('Save error:', e);
        }
    },
    
    // NEW: Undo/Redo System
    saveToUndoStack(action, data) {
        // Save current state before making changes
        this.undoStack.push({
            action: action,
            data: JSON.parse(JSON.stringify(data)), // Deep clone
            timestamp: Date.now()
        });
        
        // Limit undo stack size
        if (this.undoStack.length > this.maxUndoSteps) {
            this.undoStack.shift();
        }
        
        // Clear redo stack when new action is performed
        this.redoStack = [];
    },
    
    performUndo() {
        if (this.undoStack.length === 0) {
            this.toast('‚ö†Ô∏è Nothing to undo');
            return;
        }
        
        const lastAction = this.undoStack.pop();
        
        // Save current state to redo stack
        this.redoStack.push({
            action: lastAction.action,
            data: JSON.parse(JSON.stringify(this.data)),
            timestamp: Date.now()
        });
        
        // Restore previous state
        this.data = lastAction.data;
        this.save();
        this.render();
        
        // Show undo toast with action description
        this.showUndoToast(`Undone: ${lastAction.action}`, false);
    },
    
    performRedo() {
        if (this.redoStack.length === 0) {
            this.toast('‚ö†Ô∏è Nothing to redo');
            return;
        }
        
        const lastRedo = this.redoStack.pop();
        
        // Save current state back to undo stack
        this.undoStack.push({
            action: lastRedo.action,
            data: JSON.parse(JSON.stringify(this.data)),
            timestamp: Date.now()
        });
        
        // Restore redo state
        this.data = lastRedo.data;
        this.save();
        this.render();
        
        this.toast(`‚úì Redone: ${lastRedo.action}`);
    },
    
    showUndoToast(message, showUndo = true) {
        const undoToast = document.getElementById('undo-toast');
        const undoMessage = document.getElementById('undo-message');
        
        undoMessage.textContent = message;
        undoToast.classList.add('show');
        
        if (!showUndo) {
            undoToast.querySelector('button').style.display = 'none';
        }
        
        setTimeout(() => {
            undoToast.classList.remove('show');
            if (!showUndo) {
                undoToast.querySelector('button').style.display = 'block';
            }
        }, 3000);
    },
    
    // NEW: Backup Reminder System
    checkBackupReminder() {
        const lastReminder = localStorage.getItem('svkLastBackupReminder');
        const lastBackupTime = lastReminder ? parseInt(lastReminder) : 0;
        const now = Date.now();
        
        // Show reminder if more than 7 days since last backup
        if (now - lastBackupTime > this.backupReminderInterval) {
            setTimeout(() => {
                document.getElementById('backup-reminder').classList.add('show');
            }, 5000); // Show 5 seconds after app loads
        }
    },
    
    dismissBackupReminder() {
        localStorage.setItem('svkLastBackupReminder', Date.now().toString());
        document.getElementById('backup-reminder').classList.remove('show');
    },
    
    exportAllData() {
        try {
            const exportData = {
                version: '2.1.3',
                exportDate: new Date().toISOString(),
                data: this.data,
                customBlueprint: this.customBlueprintData
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `svk-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            // Update last backup time
            localStorage.setItem('svkLastBackupReminder', Date.now().toString());
            document.getElementById('backup-reminder').classList.remove('show');
            
            this.toast('‚úì Backup downloaded');
        } catch (e) {
            console.error('Export error:', e);
            this.toast('‚ö†Ô∏è Export failed');
        }
    },

    getEmptyCustomBlueprintData() {
        return {
            name: '',
            vision: '',
            years: '15',
            domain1: '',
            domain2: '',
            domain3: '',
            milestone1: '',
            milestone2: '',
            milestone3: '',
            habit1: '',
            habit2: '',
            habit3: ''
        };
    },

    navigate(i) {
        this.tab = i;
        document.querySelectorAll('.nav-btn').forEach((b, idx) => b.classList.toggle('active', idx === i));
        
        // NEW: Mark tab as loaded for lazy loading
        const tabNames = ['execute', 'build', 'strategy', 'system', 'vault'];
        this.tabsLoaded[tabNames[i]] = true;
        
        this.render();
    },

    render() {
        // NEW: Lazy loading - only render if tab has been visited
        const views = [this.viewExecute, this.viewBuild, this.viewStrategy, this.viewSystem, this.viewVault];
        
        // For performance: check if we should use pagination
        const shouldPaginate = this.shouldUsePagination();
        
        if (shouldPaginate) {
            // If large dataset, add pagination note
            console.log('Large dataset detected - consider pagination');
        }
        
        document.getElementById('app').innerHTML = views[this.tab].call(this);
    },
    
    // NEW: Check if data is large enough to warrant pagination
    shouldUsePagination() {
        const habitCount = this.data.system?.habits?.length || 0;
        const journalCount = this.data.system?.journal?.length || 0;
        const notesCount = this.data.vault?.learnings?.notes?.length || 0;
        const goalsCount = this.data.goals?.length || 0;
        
        // Consider pagination if any collection has 100+ items
        return habitCount > 100 || journalCount > 100 || notesCount > 100 || goalsCount > 100;
    },

    toast(msg) {
        const t = document.getElementById('toast');
        t.textContent = msg;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 2200);
    },

    celebrate(emoji, title, sub) {
        document.getElementById('celebrate-emoji').textContent = emoji;
        document.getElementById('celebrate-title').textContent = title;
        document.getElementById('celebrate-sub').textContent = sub;
        document.getElementById('celebrate').classList.add('show');
    },
    closeCelebrate() { document.getElementById('celebrate').classList.remove('show'); },

    // VIEW: EXECUTE
    viewExecute() {
        const quotes = ["The obstacle is the path.", "One breath. One task. Full presence.", "Empty your cup to receive."];
        const quote = quotes[Math.floor(Math.random() * quotes.length)];
        
        let html = `<div class="zen-quote">"${quote}"</div>`;
        
        // QUICK TASKS - Max 3 urgent items
        if (!this.data.tasks) this.data.tasks = { quick: [] };
        if (!this.data.tasks.quick) this.data.tasks.quick = [];
        const quickTasks = this.data.tasks.quick || [];
        const canAddQuick = quickTasks.length < 3;
        
        html += `<div class="section-header">
            <span>‚ö° Quick Tasks (${quickTasks.length}/3)</span>
            ${canAddQuick ? `<button class="btn-sec" onclick="App.addQuickTask()">+ Add</button>` : ''}
        </div>`;
        
        if (quickTasks.length > 0) {
            quickTasks.forEach(task => {
                html += `<div class="task-row ${task.done ? 'done' : ''}">
                    <div style="flex:1;min-width:0;">
                        <div class="task-title">${esc(task.title)}</div>
                    </div>
                    <div style="display:flex;gap:8px;align-items:center;">
                        ${!task.done ? `<button class="btn-sec btn-success" onclick="App.toggleQuickTask('${task.id}')" style="font-size:12px;padding:6px 12px;">‚úì</button>` : ''}
                        <button class="btn-sec" onclick="App.deleteQuickTask('${task.id}')" style="font-size:11px;padding:4px 10px;opacity:0.6;">‚úï</button>
                    </div>
                </div>`;
            });
        }
        
        if (!canAddQuick) {
            html += `<div style="text-align:center;margin-top:8px;font-size:11px;color:var(--dim);">
                Max 3 quick tasks. Complete or delete to add more.
            </div>`;
        }
        
        // MEDITATIVE FIGURE - Empty Cup (shown when no quick tasks)
        if (quickTasks.length === 0) {
            html += `<div style="margin-top:32px;text-align:center;padding:40px 20px;background:var(--sub);border-radius:12px;">
                <div style="font-size:14px;color:var(--accent);margin-bottom:20px;letter-spacing:1px;text-transform:uppercase;">
                    The Empty Cup
                </div>
                <div style="font-size:80px;line-height:1;margin-bottom:16px;">üßò</div>
                <div style="font-size:13px;color:var(--dim);max-width:280px;margin:0 auto;line-height:1.6;">
                    Your mind is clear, ready to receive.<br>
                    Tasks will appear when needed.
                </div>
            </div>`;
        }
        
        // ACTIVE CYCLE TASKS
        if (!this.data.currentCycle) {
            html += `<div class="section-header" style="margin-top:24px;"><span>üìã Active Cycle</span></div>`;
            html += `<div class="card" style="text-align:center;padding:40px 20px;">
                <div style="font-size:48px;margin-bottom:20px;">üéØ</div>
                <div style="font-size:20px;font-weight:700;margin-bottom:12px;">No Blueprint Yet</div>
                <p style="color:var(--dim);margin-bottom:24px;line-height:1.5;">
                    Create your personalized 15-year blueprint with AI or import an existing one.
                </p>
                <button class="btn" style="margin-bottom:12px;" onclick="App.tab=3;App.sub.system='custom';App.render()">
                    ü§ñ Create Custom Blueprint
                </button>
                <button class="btn-sec" onclick="App.tab=1;App.sub.build='stats';App.render()">
                    üì§ Import Blueprint
                </button>
            </div>`;
        } else {
            const tasks = this.data.currentCycle.tasks || [];
            const week = this.getCurrentWeek();
            const weekTasks = tasks.filter(t => t.week === week && !t.done);
            
            html += `<div class="section-header" style="margin-top:24px;">
                <span>üìÖ This Week (Week ${week}/13)</span>
                <span style="font-size:10px;color:var(--dim);font-weight:400;">${weekTasks.length} pending</span>
            </div>`;
            
            if (weekTasks.length === 0) {
                html += `<div class="card" style="text-align:center;padding:20px;background:var(--sub);">
                    <div style="font-size:13px;color:var(--dim);">All tasks completed for this week! üéâ</div>
                </div>`;
            } else {
                // Show first 5 pending tasks
                weekTasks.slice(0, 5).forEach(task => {
                    html += `<div class="task-row" onclick="App.startTask('${task.id}')">
                        <div style="flex:1;min-width:0;">
                            <div style="font-weight:600;">${esc(task.title)}</div>
                            <div class="task-meta">
                                ${task.duration ? `‚è± ${task.duration}m` : ''}
                                <span>Week ${task.week}</span>
                            </div>
                        </div>
                        <button class="btn-sec btn-success" onclick="event.stopPropagation();App.toggleTask('${task.id}')">‚úì</button>
                    </div>`;
                });
                
                if (weekTasks.length > 5) {
                    html += `<div style="text-align:center;margin-top:12px;">
                        <button class="btn-sec" onclick="App.navigate(2)" style="font-size:12px;">
                            View All ${weekTasks.length} Tasks ‚Üí
                        </button>
                    </div>`;
                }
            }
        }
        
        // TODAY'S TIMEBLOCKS
        const today = new Date().toISOString().split('T')[0];
        const todayTimeblocks = (this.data.timeblocks || []).filter(tb => tb.date === today && !tb.completed);
        
        if (todayTimeblocks.length > 0) {
            html += `<div class="section-header" style="margin-top:24px;">
                <span>‚è∞ Today's Timeblocks</span>
                <button class="btn-sec" onclick="App.viewTimeblocks()" style="font-size:11px;padding:4px 10px;">View All</button>
            </div>`;
            
            todayTimeblocks.slice(0, 3).forEach(tb => {
                html += `<div class="card" style="border-left:4px solid var(--accent);">
                    <div style="display:flex;justify-content:space-between;align-items:start;">
                        <div style="flex:1;">
                            <div style="font-weight:700;">${esc(tb.title)}</div>
                            <div style="font-size:12px;color:var(--dim);margin-top:4px;">
                                ${tb.time || 'Anytime'} ‚Ä¢ ${tb.duration || 60} min ‚Ä¢ ${tb.type || 'Focus'}
                            </div>
                        </div>
                        <button class="btn-sec btn-success" onclick="App.toggleTimeblock('${tb.id}')" 
                                style="font-size:12px;padding:6px 12px;">‚úì</button>
                    </div>
                </div>`;
            });
        }
        
        return html;
    },

    // VIEW: BUILD
    viewBuild() {
        if (!this.data.blueprintMeta) {
            return `<div class="card" style="text-align:center;padding:40px 20px;">
                <div style="font-size:48px;margin-bottom:12px;">üìú</div>
                <div style="font-size:20px;font-weight:700;margin-bottom:8px;color:var(--accent);">Load Your 15-Year Vision</div>
                <div style="font-size:13px;color:var(--dim);margin-bottom:24px;">Import your master blueprint to begin execution.</div>
                <input type="file" id="bp-file" accept=".json" onchange="App.importBlueprint(event)" style="display:none;">
                <button class="btn" onclick="document.getElementById('bp-file').click()">Import Blueprint JSON</button>
            </div>`;
        }
        
        const meta = this.data.blueprintMeta;
        const sub = this.sub.build || 'aim';
        
        let html = `<div class="segment">
            <button class="segment-btn ${sub==='aim'?'active':''}" onclick="App.sub.build='aim';App.render()">Chief Aim</button>
            <button class="segment-btn ${sub==='goals'?'active':''}" onclick="App.sub.build='goals';App.render()">Goals</button>
            <button class="segment-btn ${sub==='affirmations'?'active':''}" onclick="App.sub.build='affirmations';App.render()">Affirmations</button>
            <button class="segment-btn ${sub==='bucketlist'?'active':''}" onclick="App.sub.build='bucketlist';App.render()">Bucket List</button>
            <button class="segment-btn ${sub==='stats'?'active':''}" onclick="App.sub.build='stats';App.render()">Stats</button>
        </div>`;
        
        if (sub === 'aim') {
            // FULL SCREEN CHIEF AIM
            html += `
                <div style="min-height:calc(100vh - 200px);display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;padding:0 20px;">
                    <div style="font-size:11px;color:var(--accent);text-transform:uppercase;letter-spacing:3px;margin-bottom:16px;font-weight:700;">DEFINITE CHIEF AIM</div>
                    <div style="font-size:18px;line-height:1.8;color:var(--zen);max-width:600px;white-space:pre-wrap;font-weight:400;">${esc(meta.vision)}</div>
                    <div style="margin-top:40px;font-size:12px;color:var(--dim);">‚Üì Scroll for Blueprint Details</div>
                </div>
                
                <!-- BLUEPRINT DETAILS BELOW FOLD -->
                <div style="margin-top:60px;">
                    <div class="section-header"><span>Blueprint Overview</span></div>
                    <div class="card" style="border-left:4px solid var(--accent);">
                        <div style="font-size:18px;font-weight:700;color:var(--accent);margin-bottom:8px;">${esc(meta.name)}</div>
                        <div style="font-size:13px;color:var(--dim);">${meta.years} Years | ${meta.totalCycles} Cycles</div>
                    </div>
                    
                    <div class="stat-grid">
                        <div class="stat-box"><div class="stat-val">${this.data.allCycles.length}</div><div class="stat-label">Total Cycles</div></div>
                        <div class="stat-box"><div class="stat-val">${this.data.currentCycle?.number || 0}</div><div class="stat-label">Current Cycle</div></div>
                        <div class="stat-box"><div class="stat-val">${this.data.cycleHistory?.length || 0}</div><div class="stat-label">Completed</div></div>
                        <div class="stat-box"><div class="stat-val">${meta.totalCycles - (this.data.currentCycle?.number || 0)}</div><div class="stat-label">Remaining</div></div>
                    </div>
                    
                    <div class="section-header"><span>Domains</span></div>
                    ${Object.entries(meta.domains || {}).map(([key, domain]) => `
                        <div class="card" style="border-left:4px solid ${domain.color};">
                            <div style="font-weight:700;color:${domain.color};">${esc(domain.name)}</div>
                            ${domain.description ? `<div style="font-size:13px;color:var(--dim);margin-top:4px;">${esc(domain.description)}</div>` : ''}
                        </div>
                    `).join('')}
                </div>
            `;
        } else if (sub === 'goals') {
            html += `<div class="section-header"><span>Goals</span></div>`;
            
            // Goals UI
            if (!this.data.goals || this.data.goals.length === 0) {
                html += `
                    <div class="empty-state">
                        <div class="empty-state-icon">üéØ</div>
                        <p>No goals yet. Set 3-5 major goals aligned with your Chief Aim.</p>
                        <button class="btn" onclick="App.addGoal()" style="max-width:240px;margin:20px auto 0;">
                            Add First Goal
                        </button>
                    </div>
                `;
            } else {
                html += `
                    <button class="btn mb-2" onclick="App.addGoal()">+ Add Goal</button>
                    <div style="font-size:12px;color:var(--dim);margin-bottom:16px;">
                        Add 3-5 major long-term goals aligned with your Chief Aim
                    </div>
                `;
                
                this.data.goals.forEach(goal => {
                    const expanded = goal.expanded || false;
                    const subgoals = goal.subgoals || [];
                    const completedSubs = subgoals.filter(s => s.done).length;
                    
                    html += `
                        <div class="goal-card ${expanded ? 'expanded' : ''}" onclick="App.toggleGoal('${goal.id}')">
                            <div style="display:flex;justify-content:space-between;align-items:flex-start;">
                                <div style="font-weight:700;font-size:16px;line-height:1.4;flex:1;">${esc(goal.title)}</div>
                                <div style="font-size:20px;color:${expanded ? 'var(--accent)' : 'var(--dim)'};
                                     transition:transform 0.2s;transform:rotate(${expanded ? '180deg' : '0deg'});">‚ñº</div>
                            </div>
                            
                            ${expanded ? `
                                <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border);">
                                    <div style="display:flex;gap:12px;margin:12px 0;flex-wrap:wrap;">
                                        ${goal.timeline ? `
                                            <div style="min-width:120px;">
                                                <div style="font-size:10px;color:var(--dim);text-transform:uppercase;
                                                     letter-spacing:1px;margin-bottom:4px;">Timeline</div>
                                                <div style="font-weight:600;font-size:14px;">${esc(goal.timeline)}</div>
                                            </div>
                                        ` : ''}
                                        ${goal.domain ? `
                                            <div style="min-width:120px;">
                                                <div style="font-size:10px;color:var(--dim);text-transform:uppercase;
                                                     letter-spacing:1px;margin-bottom:4px;">Domain</div>
                                                <div style="font-weight:600;font-size:14px;">${esc(goal.domain)}</div>
                                            </div>
                                        ` : ''}
                                        ${goal.metrics ? `
                                            <div style="min-width:120px;">
                                                <div style="font-size:10px;color:var(--dim);text-transform:uppercase;
                                                     letter-spacing:1px;margin-bottom:4px;">Success Metric</div>
                                                <div style="font-weight:600;font-size:14px;">${esc(goal.metrics)}</div>
                                            </div>
                                        ` : ''}
                                    </div>
                                    
                                    <div style="margin-top:16px;">
                                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                                            <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;">
                                                Subgoals (${completedSubs}/${subgoals.length})
                                            </div>
                                            <button class="btn-sec" onclick="event.stopPropagation();App.addSubgoal('${goal.id}')">
                                                + Add
                                            </button>
                                        </div>
                                        ${subgoals.length > 0 ? `
                                            <div style="margin-top:12px;">
                                                ${subgoals.map(sub => `
                                                    <div style="padding:10px;background:var(--void);border-radius:8px;
                                                         margin-bottom:6px;display:flex;justify-content:space-between;
                                                         align-items:center;gap:8px;">
                                                        <div class="checkbox ${sub.done ? 'checked' : ''}" 
                                                             onclick="event.stopPropagation();App.toggleSubgoal('${goal.id}','${sub.id}')">
                                                        </div>
                                                        <div style="flex:1;${sub.done ? 'text-decoration:line-through;opacity:0.5;' : ''}">${esc(sub.title)}</div>
                                                        <button class="btn-sec btn-danger" style="padding:4px 8px;" 
                                                                onclick="event.stopPropagation();App.deleteSubgoal('${goal.id}','${sub.id}')">
                                                            &times;
                                                        </button>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        ` : `
                                            <div style="text-align:center;padding:12px;color:var(--dim);font-size:13px;">
                                                No subgoals yet
                                            </div>
                                        `}
                                    </div>
                                    
                                    <!-- GOAL STAGES SECTION -->
                                    ${goal.stages && goal.stages.length > 0 ? `
                                        <div style="margin-top:20px;padding-top:16px;border-top:1px solid var(--border);">
                                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                                                <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;">
                                                    Stages (${goal.stages.filter(s => s.completed).length}/${goal.stages.length})
                                                </div>
                                            </div>
                                            <div style="margin-top:12px;">
                                                ${goal.stages.map(stage => `
                                                    <div style="padding:12px;background:var(--void);border-radius:8px;
                                                         margin-bottom:8px;border-left:3px solid ${stage.completed ? 'var(--success)' : 'var(--accent)'};">
                                                        <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:6px;">
                                                            <div style="flex:1;">
                                                                <div style="font-weight:600;${stage.completed ? 'text-decoration:line-through;opacity:0.6;' : ''}">${esc(stage.title)}</div>
                                                                ${stage.target ? `<div style="font-size:11px;color:var(--dim);margin-top:4px;">üéØ Target: ${new Date(stage.target).toLocaleDateString()}</div>` : ''}
                                                                ${stage.description ? `<div style="font-size:12px;color:var(--dim);margin-top:6px;">${esc(stage.description)}</div>` : ''}
                                                            </div>
                                                        </div>
                                                        <div style="display:flex;gap:6px;margin-top:8px;">
                                                            <button class="btn-sec ${stage.completed ? '' : 'btn-success'}" 
                                                                    onclick="event.stopPropagation();App.toggleGoalStage('${goal.id}','${stage.id}')"
                                                                    style="font-size:11px;padding:4px 10px;">
                                                                ${stage.completed ? '‚óØ Reopen' : '‚úì Complete'}
                                                            </button>
                                                            <button class="btn-sec btn-danger" style="padding:4px 10px;font-size:11px;" 
                                                                    onclick="event.stopPropagation();App.deleteGoalStage('${goal.id}','${stage.id}')">
                                                                Delete
                                                            </button>
                                                        </div>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    ` : ''}
                                    
                                    <div style="display:flex;gap:8px;margin-top:16px;">
                                        <button class="btn-sec" onclick="event.stopPropagation();App.editGoal('${goal.id}')">
                                            Edit
                                        </button>
                                        <button class="btn-sec btn-danger" onclick="event.stopPropagation();App.deleteGoal('${goal.id}')">
                                            Delete
                                        </button>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
            }
        } else if (sub === 'affirmations') {
            html += `<div class="section-header"><span>Affirmations</span><button class="btn-sec" onclick="App.addAffirmation()">+</button></div>`;
            const affs = this.data.plan.affirmations || [];
            if (affs.length === 0) {
                html += `<div class="empty-state"><div class="empty-state-icon">‚ú®</div><p>No affirmations yet</p></div>`;
            } else {
                affs.forEach(aff => {
                    html += `<div class="card" style="border-left:3px solid var(--accent);">
                        <div style="font-weight:700;">${esc(aff.text)}</div>
                        ${aff.timestamp ? `<div class="task-meta" style="margin-top:8px;">${new Date(aff.timestamp).toLocaleDateString()}</div>` : ''}
                        <button class="btn-sec btn-danger" onclick="App.deleteAffirmation('${aff.id}')" style="margin-top:8px;font-size:11px;">Delete</button>
                    </div>`;
                });
            }
        } else if (sub === 'bucketlist') {
            html += `<div class="section-header"><span>Bucket List</span><button class="btn-sec" onclick="App.addBucketItem()">+</button></div>`;
            const items = this.data.plan.bucketList || [];
            if (items.length === 0) {
                html += `<div class="empty-state"><div class="empty-state-icon">ü™£</div><p>No bucket list items yet</p></div>`;
            } else {
                items.forEach(item => {
                    html += `<div class="card" style="border-left:3px solid ${item.done?'var(--success)':'var(--blue)'};">
                        <div style="display:flex;justify-content:space-between;align-items:start;">
                            <div style="flex:1;">
                                <div style="font-weight:700;${item.done?'text-decoration:line-through;color:var(--dim);':''}">${esc(item.title)}</div>
                                ${item.description ? `<div style="color:var(--dim);font-size:13px;margin-top:4px;">${esc(item.description)}</div>` : ''}
                            </div>
                            ${item.done ? `<span style="color:var(--success);font-size:18px;">‚úì</span>` : ''}
                        </div>
                        <div style="display:flex;gap:6px;margin-top:8px;">
                            ${!item.done ? `<button class="btn-sec btn-success" onclick="App.toggleBucketItem('${item.id}')">‚úì Done</button>` : `<button class="btn-sec" onclick="App.toggleBucketItem('${item.id}')">Undo</button>`}
                            <button class="btn-sec btn-danger" onclick="App.deleteBucketItem('${item.id}')" style="margin-left:auto;">Delete</button>
                        </div>
                    </div>`;
                });
            }
        } else if (sub === 'stats') {
            html += `<div class="section-header"><span>Blueprint Stats</span></div>`;
            html += `<div class="card">
                <div style="font-size:16px;font-weight:700;margin-bottom:8px;">Export / Import</div>
                <button class="btn" onclick="App.exportData()" style="margin-bottom:8px;">üì• Export All Data (JSON)</button>
                <button class="btn btn-danger" onclick="App.resetBlueprint()">üîÑ Reset Blueprint</button>
            </div>`;
            
            html += `<div class="card" style="background:linear-gradient(135deg,rgba(10,132,255,0.1),rgba(10,132,255,0.05));border:1px solid rgba(10,132,255,0.3);">
                <div style="font-size:16px;font-weight:700;margin-bottom:12px;color:var(--blue);">ü§ñ Create Custom Blueprint</div>
                <p style="font-size:13px;color:var(--dim);margin-bottom:16px;line-height:1.5;">
                    Use AI to generate your personalized 15-year blueprint with 60 cycles, tasks, habits, and milestones. 
                    Takes just 5 minutes!
                </p>
                <button class="btn" style="background:var(--blue);color:var(--text);" 
                    onclick="App.tab=3;App.sub.system='custom';App.render()">
                    ‚ú® Generate with AI
                </button>
            </div>`;
        }
        
        return html;
    },

    // VIEW: STRATEGY
    viewStrategy() {
        if (!this.data.currentCycle) {
            return `<div class="card" style="text-align:center;padding:36px 20px;">
                <div style="font-size:14px;margin-bottom:16px;color:var(--dim);">No active cycle</div>
                ${this.data.allCycles && this.data.allCycles.length > 0 ? 
                    `<button class="btn" onclick="App.loadNextCycle()">‚ö° Start First Cycle</button>` : 
                    `<p style="color:var(--dim);margin-bottom:16px;">Import blueprint first from BUILD tab</p>
                    <input type="file" id="bp-file-2" accept=".json" onchange="App.importBlueprint(event)" style="display:none;">
                    <button class="btn" onclick="document.getElementById('bp-file-2').click()">Import Blueprint</button>`}
            </div>`;
        }
        
        const c = this.data.currentCycle;
        const tasks = c.tasks || [];
        const week = this.sub._viewedWeek || this.getCurrentWeek();
        let weekTasks = tasks.filter(t => t.week === week);
        
        // Apply filters
        weekTasks = this.filterTasks(weekTasks);
        
        const weekPending = weekTasks.filter(t => !t.done);
        const weekDone = weekTasks.filter(t => t.done);
        const allDone = tasks.filter(t => t.done).length;
        const pct = tasks.length > 0 ? Math.round((allDone / tasks.length) * 100) : 0;
        
        let html = `
            <div class="card" style="background:linear-gradient(135deg,#1c1c1e,#252527);">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                    <div>
                        <div style="font-size:10px;color:var(--accent);text-transform:uppercase;letter-spacing:1px;">Current Cycle</div>
                        <div style="font-size:18px;font-weight:700;color:var(--accent);">${esc(c.title)}</div>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-size:10px;color:var(--accent);text-transform:uppercase;letter-spacing:1px;">Week</div>
                        <div style="font-size:18px;font-weight:700;">${week}<span style="color:var(--dim);font-size:14px;">/13</span></div>
                    </div>
                </div>
                <div class="progress-bar"><div class="progress-fill" style="width:${(week/13)*100}%"></div></div>
            </div>
            
            <div class="stat-grid">
                <div class="stat-box"><div class="stat-val">${weekPending.length}</div><div class="stat-label">This Week</div></div>
                <div class="stat-box"><div class="stat-val" style="color:var(--success)">${pct}%</div><div class="stat-label">Cycle Done</div></div>
            </div>
            
            <div class="section-header">
                <span>Focus ‚Ä¢ Week ${week}</span>
                <div style="display:flex;gap:6px;">
                    <button class="btn-sec" onclick="App.changeWeek(-1)" ${week <= 1 ? 'disabled style="opacity:0.3;"' : ''}>‚óÄ</button>
                    <button class="btn-sec" onclick="App.changeWeek(1)" ${week >= 13 ? 'disabled style="opacity:0.3;"' : ''}>‚ñ∂</button>
                </div>
            </div>
            
            ${this.renderTaskFilters()}
        `;
        
        if (weekPending.length === 0 && weekDone.length === 0) {
            html += `<div class="empty-state">
                <div class="empty-state-icon">‚ú®</div>
                <p>No tasks for week ${week}</p>
                <button class="btn-sec" onclick="App.addWeekTask(${week})" style="margin-top:12px;">+ Add Task</button>
            </div>`;
        } else {
            // PENDING TASKS
            if (weekPending.length > 0) {
                weekPending.forEach(task => {
                    html += `<div class="task-row" onclick="App.viewTaskDetail('${task.id}')">
                        <div style="flex:1;min-width:0;">
                            <div style="font-weight:600;word-break:break-word;">${esc(task.title)}</div>
                            <div class="task-meta">
                                ${task.duration ? `‚è± ${task.duration}m` : ''}
                                <span>Week ${task.week}</span>
                            </div>
                        </div>
                        <button class="btn-sec btn-success" onclick="event.stopPropagation();App.toggleTask('${task.id}')">‚úì</button>
                    </div>`;
                });
            }
            
            // COMPLETED TASKS
            if (weekDone.length > 0) {
                html += `<div class="section-header" style="margin-top:18px;"><span>Completed</span></div>`;
                weekDone.forEach(task => {
                    html += `<div class="task-row done">
                        <div style="flex:1;min-width:0;">
                            <div style="font-weight:600;color:var(--dim);">${esc(task.title)}</div>
                        </div>
                        <span style="color:var(--success);font-size:16px;">‚úì</span>
                    </div>`;
                });
            }
            
            html += `<button class="btn-sec" onclick="App.addWeekTask(${week})" style="width:100%;margin-top:12px;">+ Add Task to Week ${week}</button>`;
        }
        
        // DOMAIN FOCUS VISUALIZATION
        html += this.renderDomainFocus();
        
        // CYCLE ACTIONS
        html += `
            <div style="margin-top:24px;padding-top:24px;border-top:1px solid var(--border);">
                <div class="section-header"><span>Cycle Management</span></div>
                
                ${c.milestones && c.milestones.length > 0 ? `
                <div class="card" style="margin-bottom:12px;">
                    <div style="font-size:10px;color:var(--accent);text-transform:uppercase;margin-bottom:8px;letter-spacing:1px;">Milestones</div>
                    ${c.milestones.map(m => `<div style="padding:8px 10px;background:var(--sub);border-radius:8px;margin-top:6px;font-size:13px;border-left:3px solid var(--accent);">‚úì ${esc(m)}</div>`).join('')}
                </div>` : ''}
                
                <div style="display:flex;gap:8px;flex-wrap:wrap;">
                    ${this.data.allCycles && c.number > 1 ? `<button class="btn-sec" onclick="App.jumpToCycle(${c.number - 1})">‚Üê Prev Cycle</button>` : ''}
                    <button class="btn-sec" onclick="App.showAllCycles()">All Cycles</button>
                    ${this.data.allCycles && c.number < this.data.blueprintMeta.totalCycles ? `<button class="btn-sec" style="background:var(--accent);color:var(--void);" onclick="App.loadNextCycle()">Next Cycle ‚Üí</button>` : ''}
                    <button class="btn-sec btn-danger" onclick="App.completeCycle()" style="margin-left:auto;">Complete Cycle</button>
                </div>
            </div>
        `;
        
        // CYCLE HISTORY
        if (this.data.cycleHistory && this.data.cycleHistory.length > 0) {
            html += `<div class="section-header" style="margin-top:24px;"><span>History</span></div>`;
            this.data.cycleHistory.slice(0, 3).forEach(ch => {
                const rate = ch.tasks?.length > 0 ? Math.round((ch.tasks.filter(t=>t.done).length||0)/ch.tasks.length*100) : 0;
                html += `<div class="card" style="border-left:3px solid var(--success);">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <div>
                            <div style="font-size:10px;color:var(--dim);">Cycle #${ch.number}</div>
                            <div style="font-size:16px;font-weight:700;">${esc(ch.title)}</div>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-size:20px;font-weight:700;color:var(--success);">${rate}%</div>
                            <div style="font-size:10px;color:var(--dim);">complete</div>
                        </div>
                    </div>
                </div>`;
            });
        }
        
        return html;
    },

    // VIEW: SYSTEM
    viewSystem() {
        if (!this.data.system) this.data.system = { habits: [], reflections: { morning: [], evening: [] }, journal: [], reviews: [] };
        
        const sub = this.sub.system || 'habits';
        let html = `<div class="segment">
            <button class="segment-btn ${sub === 'habits' ? 'active' : ''}" onclick="App.sub.system='habits';App.render()">Habits</button>
            <button class="segment-btn ${sub === 'reflections' ? 'active' : ''}" onclick="App.sub.system='reflections';App.render()">Reflect</button>
            <button class="segment-btn ${sub === 'journal' ? 'active' : ''}" onclick="App.sub.system='journal';App.render()">Journal</button>
            <button class="segment-btn ${sub === 'reviews' ? 'active' : ''}" onclick="App.sub.system='reviews';App.render()">Reviews</button>
            <button class="segment-btn ${sub === 'custom' ? 'active' : ''}" onclick="App.sub.system='custom';App.render()">Custom Blueprint</button>
        </div>`;
        
        if (sub === 'habits') {
            const habits = this.data.system.habits || [];
            html += `<div class="section-header">
